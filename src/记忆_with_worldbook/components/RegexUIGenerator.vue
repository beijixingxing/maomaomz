<template>
  <div class="regex-ui-generator" style="padding: 25px !important; background: #1a1a1a !important">
    <!-- æ ‡é¢˜ -->
    <div
      style="
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 20px;
        border: 1px solid rgba(102, 126, 234, 0.2);
      "
    >
      <h3 style="color: #4a9eff; margin: 0 0 10px 0; font-size: 20px; font-weight: 600">ğŸ”§ é…’é¦†æ­£åˆ™ç•Œé¢ç”Ÿæˆå™¨</h3>
      <p style="color: #888; margin: 0; font-size: 14px; line-height: 1.6">
        AI è¾…åŠ©ç”Ÿæˆé…’é¦†æ­£åˆ™æ›¿æ¢ç•Œé¢ï¼Œç”¨è‡ªç„¶è¯­è¨€æè¿°å³å¯ç”Ÿæˆå®Œæ•´çš„ HTML/CSS/JS ä»£ç 
      </p>
    </div>

    <!-- æ–°æ‰‹ä½¿ç”¨æµç¨‹ -->
    <div
      style="
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
      "
    >
      <h4 style="color: #ffc107; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px">
        <i class="fa-solid fa-lightbulb"></i>
        æ–°æ‰‹ä½¿ç”¨æµç¨‹ï¼ˆè¶…ç®€å•ï¼ï¼‰ï¼š
      </h4>
      <ol style="margin: 0; padding-left: 20px; color: #ccc; line-height: 2">
        <li>
          <strong style="color: #fff">ç¬¬1æ­¥ï¼š</strong> è¾“å…¥è§¦å‘è¯ï¼ˆæ¯”å¦‚
          <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px; color: #4a9eff">ã€çŠ¶æ€æ ã€‘</code>
          ï¼‰
        </li>
        <li><strong style="color: #fff">ç¬¬2æ­¥ï¼š</strong> ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼ˆçœç•¥æŠ€æœ¯ç»†èŠ‚ï¼‰</li>
        <li><strong style="color: #fff">ç¬¬3æ­¥ï¼š</strong> ç‚¹å‡»"AI ç”Ÿæˆ"ï¼Œç­‰å‡ ç§’é’Ÿï¼ŒAI è‡ªåŠ¨ç”Ÿæˆä»£ç </li>
        <li>
          <strong style="color: #fff">ç¬¬4æ­¥ï¼š</strong> çœ‹å³ä¾§<strong style="color: #51cf66">å®æ—¶é¢„è§ˆ</strong
          >ï¼Œä¸æ»¡æ„å°±ç‚¹"AI ä¿®æ”¹"ç»§ç»­è°ƒæ•´
        </li>
        <li><strong style="color: #fff">ç¬¬5æ­¥ï¼š</strong> ç‚¹å‡»"å¤åˆ¶æ­£åˆ™"ï¼Œç›´æ¥ç²˜è´´åˆ°é…’é¦†æ­£åˆ™é‡Œå°±å®Œäº†ï¼</li>
        <li>
          <strong style="color: #fff">å®Œæˆï¼</strong> ç°åœ¨åœ¨èŠå¤©ä¸­è¾“å…¥
          <code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px; color: #51cf66">ã€çŠ¶æ€æ ã€‘</code>
          å°±ä¼šæ˜¾ç¤ºä½ çš„ç•Œé¢äº†ï¼
        </li>
      </ol>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸï¼šå·¦å³åˆ†æ  -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
      <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
      <div style="display: flex; flex-direction: column; gap: 20px">
        <!-- è§¦å‘å…³é”®è¯ -->
        <div style="background: #2a2a2a; padding: 20px; border-radius: 8px">
          <h4 style="color: #4a9eff; margin: 0 0 15px 0; font-size: 16px">
            <i class="fa-solid fa-key"></i>
            è§¦å‘å…³é”®è¯:
          </h4>
          <input
            v-model="triggerKeyword"
            type="text"
            placeholder="è¾“å…¥è§¦å‘è¯ï¼Œä¾‹å¦‚ï¼šã€å¼€åœºç™½ã€‘"
            style="
              width: 100%;
              background: #1a1a1a;
              color: #e0e0e0;
              border: 1px solid #444;
              border-radius: 4px;
              padding: 12px;
              font-size: 14px;
            "
          />
        </div>

        <!-- ç•Œé¢æè¿°ï¼ˆAI ç”Ÿæˆï¼‰ -->
        <div
          style="background: #2a2a2a; padding: 20px; border-radius: 8px; flex: 1; display: flex; flex-direction: column"
        >
          <h4 style="color: #4a9eff; margin: 0 0 15px 0; font-size: 16px">
            <i class="fa-solid fa-magic"></i>
            ç•Œé¢æè¿°ï¼ˆAI ç”Ÿæˆï¼‰:
          </h4>
          <p style="color: #888; margin: 0 0 10px 0; font-size: 13px">
            ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªRPGæ¸¸æˆé£æ ¼çš„çŠ¶æ€æ ï¼Œæ˜¾ç¤ºç”Ÿå‘½å€¼ã€é­”åŠ›å€¼ã€ç»éªŒå€¼...
          </p>
          <textarea
            v-model="interfaceDescription"
            placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦çš„ç•Œé¢ï¼ˆè¶Šè¯¦ç»†è¶Šå¥½ï¼‰ï¼š&#10;- è¯´æ¸…æ¥šä½ æƒ³è¦ä»€ä¹ˆåŠŸèƒ½ï¼ˆå¦‚ï¼šç”Ÿå‘½å€¼ã€é­”åŠ›å€¼ã€ç»éªŒå€¼ï¼‰&#10;- è¯´æ¸…æ¥šä½ æƒ³è¦ä»€ä¹ˆæ ·å¼ï¼ˆå¦‚ï¼šRPGæ¸¸æˆé£æ ¼ã€èµ›åšæœ‹å…‹ã€å¯çˆ±é£ç­‰ï¼‰&#10;- å¦‚æœæƒ³è¦ç‰¹æ®Šæ•ˆæœï¼ˆå¦‚ï¼šè¿›åº¦æ¡ã€åŠ¨ç”»ã€æŒ‰é’®ï¼‰ï¼Œä¹Ÿå†™æ¸…æ¥š&#10;&#10;ä¾‹å¦‚ï¼š&#10;æˆ‘æƒ³è¦ä¸€ä¸ªç°ä»£ç®€æ´é£æ ¼çš„çŠ¶æ€æ ï¼Œæ˜¾ç¤ºå½“å‰æ—¥æœŸã€æ—¶é—´ã€åœ°ç‚¹ã€å¤©æ°”æ¸©åº¦ã€‚"
            style="
              width: 100%;
              flex: 1;
              min-height: 200px;
              background: #1a1a1a;
              color: #e0e0e0;
              border: 1px solid #444;
              border-radius: 4px;
              padding: 12px;
              font-size: 14px;
              font-family: 'Consolas', monospace;
              resize: none;
              line-height: 1.6;
            "
          />

          <!-- AI ç”Ÿæˆ/ä¿®æ”¹æŒ‰é’® -->
          <div style="display: flex; gap: 12px; margin-top: 15px">
            <button
              :disabled="!triggerKeyword || !interfaceDescription || isGenerating"
              style="
                flex: 1;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
              "
              :style="{ opacity: !triggerKeyword || !interfaceDescription || isGenerating ? 0.5 : 1 }"
              @click="generateWithAI"
            >
              <i class="fa-solid fa-wand-magic-sparkles"></i>
              {{ isGenerating ? 'AI ç”Ÿæˆä¸­...' : generatedCode ? 'AI é‡æ–°ç”Ÿæˆ' : 'AI ç”Ÿæˆç•Œé¢' }}
            </button>
            <button
              v-if="generatedCode"
              :disabled="isModifying"
              style="
                flex: 1;
                background: #ffc107;
                color: #000;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
              "
              :style="{ opacity: isModifying ? 0.5 : 1 }"
              @click="showModifyDialog"
            >
              <i class="fa-solid fa-edit"></i>
              {{ isModifying ? 'ä¿®æ”¹ä¸­...' : 'AI ä¿®æ”¹ç•Œé¢' }}
            </button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆ -->
      <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; display: flex; flex-direction: column">
        <h4 style="color: #51cf66; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px">
          <i class="fa-solid fa-eye"></i>
          å®æ—¶é¢„è§ˆ
          <span
            v-if="generatedCode"
            style="
              margin-left: auto;
              background: #51cf66;
              color: white;
              padding: 4px 12px;
              border-radius: 16px;
              font-size: 12px;
            "
            >å·²ç”Ÿæˆ</span
          >
        </h4>
        <div
          style="
            flex: 1;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
          "
        >
          <div v-if="!generatedCode" style="text-align: center; color: #666; padding: 40px">
            <i class="fa-solid fa-image" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3"></i>
            <p style="font-size: 16px; margin: 0">ç­‰å¾…ç”Ÿæˆ...</p>
            <p style="font-size: 14px; margin: 10px 0 0 0">ç‚¹å‡»"AI ç”Ÿæˆç•Œé¢"åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
          </div>
          <iframe
            v-else
            ref="previewFrame"
            :srcdoc="generatedCode"
            sandbox="allow-scripts allow-same-origin"
            style="width: 100%; height: 100%; border: none; background: white"
          ></iframe>
        </div>

        <!-- å¤åˆ¶æ­£åˆ™æŒ‰é’® -->
        <button
          v-if="generatedCode"
          style="
            margin-top: 15px;
            background: #51cf66;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
          "
          @click="copyRegex"
        >
          <i class="fa-solid fa-copy"></i> å¤åˆ¶æ­£åˆ™ä»£ç 
        </button>
      </div>
    </div>

    <!-- ç”Ÿæˆçš„æ­£åˆ™ä»£ç ï¼ˆå¯æŠ˜å ï¼‰ -->
    <div v-if="generatedRegex" style="background: #2a2a2a; padding: 20px; border-radius: 8px">
      <div
        style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px"
        @click="showCode = !showCode"
      >
        <h4 style="color: #4a9eff; margin: 0">
          <i class="fa-solid fa-code"></i>
          ç”Ÿæˆçš„æ­£åˆ™ä»£ç 
        </h4>
        <i
          :class="showCode ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"
          style="color: #888; transition: transform 0.3s"
        ></i>
      </div>
      <div
        v-if="showCode"
        style="
          background: #1a1a1a;
          padding: 15px;
          border-radius: 4px;
          border: 1px solid #444;
          max-height: 300px;
          overflow-y: auto;
        "
      >
        <pre
          style="
            margin: 0;
            color: #e0e0e0;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
          "
          >{{ generatedRegex }}</pre
        >
      </div>
    </div>

    <!-- AI ä¿®æ”¹å¯¹è¯æ¡† -->
    <div
      v-if="showModify"
      style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      "
      @click.self="showModify = false"
    >
      <div
        style="
          background: #2a2a2a;
          border: 2px solid #ffc107;
          border-radius: 16px;
          padding: 30px;
          max-width: 600px;
          width: 100%;
        "
        @click.stop
      >
        <h3 style="color: #ffc107; margin: 0 0 20px 0">
          <i class="fa-solid fa-edit"></i>
          AI ä¿®æ”¹ç•Œé¢
        </h3>
        <p style="color: #888; margin: 0 0 15px 0; line-height: 1.6">
          æè¿°ä½ æƒ³è¦ä¿®æ”¹çš„åœ°æ–¹ï¼ŒAI ä¼šåœ¨å½“å‰ç•Œé¢çš„åŸºç¡€ä¸Šè¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š
        </p>
        <ul style="color: #888; margin: 0 0 20px 0; padding-left: 20px; line-height: 1.8">
          <li>æŠŠç”Ÿå‘½å€¼è¿›åº¦æ¡æ”¹æˆçº¢è‰²</li>
          <li>å¢åŠ ä¸€ä¸ªé‡‘å¸æ˜¾ç¤º</li>
          <li>è°ƒæ•´æ•´ä½“å¸ƒå±€ï¼Œæ”¹æˆç«–å‘æ’åˆ—</li>
          <li>æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»åæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯</li>
        </ul>
        <textarea
          v-model="modifyInstruction"
          placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®..."
          style="
            width: 100%;
            min-height: 150px;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            margin-bottom: 20px;
            resize: vertical;
          "
        ></textarea>
        <div style="display: flex; gap: 12px">
          <button
            :disabled="!modifyInstruction || isModifying"
            style="
              flex: 1;
              background: #ffc107;
              color: #000;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            "
            :style="{ opacity: !modifyInstruction || isModifying ? 0.5 : 1 }"
            @click="modifyWithAI"
          >
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            {{ isModifying ? 'ä¿®æ”¹ä¸­...' : 'ç¡®è®¤ä¿®æ”¹' }}
          </button>
          <button
            style="
              flex: 1;
              background: #666;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
            "
            @click="showModify = false"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { watchDebounced } from '@vueuse/core';
import { klona } from 'klona';
import { storeToRefs } from 'pinia';
import { onMounted, ref } from 'vue';
import { normalizeApiEndpoint, useSettingsStore } from '../settings';
import { useTaskStore } from '../taskStore';
import { copyToClipboard, getScriptIdSafe } from '../utils';

const settingsStore = useSettingsStore();
const { settings } = storeToRefs(settingsStore);
const taskStore = useTaskStore();

const triggerKeyword = ref('ã€å¼€åœºç™½ã€‘');
const interfaceDescription = ref('');
const generatedCode = ref('');
const generatedRegex = ref('');
const isGenerating = ref(false);
const isModifying = ref(false);
const showCode = ref(false);
const showModify = ref(false);
const modifyInstruction = ref('');
const previewFrame = ref<HTMLIFrameElement | null>(null);

// ä» localStorage åŠ è½½æ•°æ®ï¼ˆæ’ä»¶ç¯å¢ƒï¼‰
const loadData = () => {
  try {
    const scriptId = getScriptIdSafe();
    if (!scriptId) return;

    const storageKey = `${scriptId}_regex_ui_generator`;
    const savedDataString = localStorage.getItem(storageKey);

    if (savedDataString) {
      try {
        const savedData = JSON.parse(savedDataString);
      triggerKeyword.value = savedData.triggerKeyword || 'ã€å¼€åœºç™½ã€‘';
      interfaceDescription.value = savedData.interfaceDescription || '';
      generatedCode.value = savedData.generatedCode || '';
      generatedRegex.value = savedData.generatedRegex || '';
        console.log('âœ… [ç•Œé¢ç”Ÿæˆå™¨] æ•°æ®å·²ä» localStorage åŠ è½½');
      } catch (parseError) {
        console.error('âŒ [ç•Œé¢ç”Ÿæˆå™¨] è§£ææ•°æ®å¤±è´¥:', parseError);
      }
    }
  } catch (error) {
    console.error('âŒ [ç•Œé¢ç”Ÿæˆå™¨] åŠ è½½æ•°æ®å¤±è´¥:', error);
  }
};

// ä¿å­˜æ•°æ®åˆ° localStorageï¼ˆæ’ä»¶ç¯å¢ƒï¼‰
const saveData = () => {
  try {
    const scriptId = getScriptIdSafe();
    if (!scriptId) return;

    const dataToSave = {
      triggerKeyword: triggerKeyword.value,
      interfaceDescription: interfaceDescription.value,
      generatedCode: generatedCode.value,
      generatedRegex: generatedRegex.value,
    };

    const storageKey = `${scriptId}_regex_ui_generator`;
    localStorage.setItem(storageKey, JSON.stringify(dataToSave));
    console.log('ğŸ’¾ [ç•Œé¢ç”Ÿæˆå™¨] æ•°æ®å·²ä¿å­˜åˆ° localStorage');
  } catch (error) {
    console.error('âŒ [ç•Œé¢ç”Ÿæˆå™¨] ä¿å­˜æ•°æ®å¤±è´¥:', error);
  }
};

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
onMounted(() => {
  loadData();
});

// ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
// ä½¿ç”¨é˜²æŠ–ç›‘å¬ï¼Œé¿å…é¢‘ç¹ä¿å­˜
watchDebounced(
  [triggerKeyword, interfaceDescription, generatedCode, generatedRegex],
  () => {
    saveData();
  },
  { debounce: 500 },
);

// AI ç”Ÿæˆç•Œé¢ä»£ç 
const generateWithAI = async () => {
  if (!triggerKeyword.value || !interfaceDescription.value) {
    window.toastr.warning('è¯·å¡«å†™è§¦å‘å…³é”®è¯å’Œç•Œé¢æè¿°');
    return;
  }

  // åˆ›å»ºä»»åŠ¡
  const taskId = taskStore.createTask('ui_generate', `ç”Ÿæˆç•Œé¢ï¼š${triggerKeyword.value}`);
  isGenerating.value = true;

  try {
    taskStore.updateTaskProgress(taskId, 10, 'æ­£åœ¨æ„å»ºæç¤ºè¯...');

    const systemPrompt = `ä½ æ˜¯ä¸“ä¸šçš„å‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ“…é•¿ç”Ÿæˆå®Œæ•´çš„å•æ–‡ä»¶ HTML åº”ç”¨ã€‚

# æ ¸å¿ƒä»»åŠ¡
æ ¹æ®ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œç”Ÿæˆ**å®Œæ•´**çš„ HTML ä»£ç ï¼ˆåŒ…å« CSS å’Œ JSï¼‰ã€‚

# ä»£ç ç»“æ„è¦æ±‚
1. **å¿…é¡»æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£**ï¼šä» \`<!DOCTYPE html>\` å¼€å§‹åˆ° \`</html>\` ç»“æŸ
2. **æ‰€æœ‰æ ·å¼å†…åµŒ**ï¼šä½¿ç”¨ \`<style>\` æ ‡ç­¾ï¼Œä¸è¦å¤–éƒ¨CSS
3. **æ‰€æœ‰è„šæœ¬å†…åµŒ**ï¼šä½¿ç”¨ \`<script>\` æ ‡ç­¾ï¼Œä¸è¦å¤–éƒ¨JS
4. **æ— å¤–éƒ¨ä¾èµ–**ï¼šä¸è¦å¼•å…¥ CDN æˆ–å¤–éƒ¨åº“ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰

# å…³é”®åŸåˆ™
1. **å®Œæ•´æ€§ç¬¬ä¸€**ï¼šç¡®ä¿ç”Ÿæˆçš„ä»£ç æ˜¯å®Œæ•´çš„ï¼Œä¸è¦æˆªæ–­
2. **ç¾è§‚ç°ä»£**ï¼šä½¿ç”¨ç°ä»£ CSS ç‰¹æ€§ï¼ˆflexbox, grid, åŠ¨ç”»ç­‰ï¼‰
3. **ç¬¦åˆæè¿°**ï¼šä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·çš„é£æ ¼éœ€æ±‚å’ŒåŠŸèƒ½éœ€æ±‚
4. **å¯ç›´æ¥è¿è¡Œ**ï¼šä»£ç å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€ä¿®æ”¹

# ç¦æ­¢äº‹é¡¹
âŒ ä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šã€è¯´æ˜ã€æ³¨é‡Š
âŒ ä¸è¦ä½¿ç”¨ markdown ä»£ç å—ï¼ˆ\`\`\`htmlï¼‰
âŒ ä¸è¦ç”Ÿæˆä¸å®Œæ•´çš„ä»£ç 
âŒ ä¸è¦çœç•¥ä»»ä½•éƒ¨åˆ†ï¼ˆå¦‚"...çœç•¥..."ï¼‰
âŒ ä¸è¦å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰

# è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºå®Œæ•´çš„ HTML ä»£ç ï¼Œä» \`<!DOCTYPE html>\` å¼€å§‹ã€‚`;

    const userPrompt = `**è§¦å‘å…³é”®è¯**ï¼š${triggerKeyword.value}

**ç•Œé¢éœ€æ±‚**ï¼š
${interfaceDescription.value}

---

**ç”Ÿæˆè¦æ±‚**ï¼š
1. ç”Ÿæˆå®Œæ•´çš„å•æ–‡ä»¶ HTMLï¼ˆåŒ…å« <style> å’Œ <script>ï¼‰
2. é£æ ¼ï¼š${interfaceDescription.value.includes('é£æ ¼') ? 'æŒ‰æè¿°é£æ ¼' : 'ç°ä»£ç®€æ´é£æ ¼'}
3. ç¡®ä¿ä»£ç å®Œæ•´ï¼Œä¸è¦æˆªæ–­
4. å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

ç«‹å³ç”Ÿæˆå®Œæ•´çš„HTMLä»£ç ï¼š`;

    taskStore.updateTaskProgress(taskId, 20, 'æ­£åœ¨å‘é€è¯·æ±‚åˆ° AI æœåŠ¡å™¨...');
    taskStore.addTaskDetail(taskId, `è§¦å‘è¯: ${triggerKeyword.value}`);

    const apiUrl = normalizeApiEndpoint(settings.value.api_endpoint);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model,
        messages: [
          {
            role: 'system',
            content: systemPrompt,
          },
          { role: 'user', content: userPrompt },
        ],
        temperature: settings.value.temperature || 0.7,
        max_tokens: settings.value.max_tokens || 16000,
        top_p: settings.value.top_p,
        presence_penalty: settings.value.presence_penalty,
        frequency_penalty: settings.value.frequency_penalty,
      }),
    });

    taskStore.updateTaskProgress(taskId, 40, 'ç­‰å¾…AIå“åº”...');

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    taskStore.updateTaskProgress(taskId, 50, 'æ­£åœ¨ç­‰å¾… AI ç”Ÿæˆä»£ç ...');
    taskStore.addTaskDetail(taskId, 'AI æ­£åœ¨æ€è€ƒå¹¶ç”Ÿæˆå®Œæ•´çš„HTMLä»£ç ...');

    const data = await response.json();
    let result = data.choices?.[0]?.message?.content || '';

    taskStore.updateTaskProgress(taskId, 70, 'æ­£åœ¨å¤„ç† AI è¿”å›çš„ä»£ç ...');

    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] AI åŸå§‹è¿”å›é•¿åº¦:', result.length);
    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] AI åŸå§‹è¿”å›å‰500å­—ç¬¦:', result.substring(0, 500));

    // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
    result = result
      .replace(/```html\n?/g, '')
      .replace(/```\n?/g, '')
      .trim();

    // å°è¯•æå–HTMLä»£ç ï¼ˆå¤„ç†AIæ¨ç†è¿‡ç¨‹ï¼‰
    // 1. å…ˆæŸ¥æ‰¾ <!DOCTYPE html å¼€å¤´çš„å®Œæ•´æ–‡æ¡£
    const doctypeMatch = result.match(/<!DOCTYPE html>[\s\S]*/i);
    if (doctypeMatch) {
      result = doctypeMatch[0].trim();
      console.log('âœ… [ç•Œé¢ç”Ÿæˆ] æå–åˆ°å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆå«DOCTYPEï¼‰');
    } else {
      // 2. å¦‚æœæ²¡æœ‰DOCTYPEï¼ŒæŸ¥æ‰¾ <html å¼€å¤´çš„éƒ¨åˆ†
      const htmlMatch = result.match(/<html[\s\S]*/i);
      if (htmlMatch) {
        result = htmlMatch[0].trim();
        console.log('âœ… [ç•Œé¢ç”Ÿæˆ] æå–åˆ°HTMLæ–‡æ¡£ï¼ˆä¸å«DOCTYPEï¼‰');
      } else if (result.includes('<') && result.includes('>')) {
        // 3. å¦‚æœæ²¡æœ‰å®Œæ•´çš„htmlæ ‡ç­¾ï¼Œä½†åŒ…å«HTMLæ ‡ç­¾
        console.log('âš ï¸ [ç•Œé¢ç”Ÿæˆ] åŒ…å«HTMLæ ‡ç­¾ä½†æ ¼å¼ä¸æ ‡å‡†ï¼Œå°è¯•åŒ…è£…');
        // å°è¯•åŒ…è£…æˆå®Œæ•´æ–‡æ¡£
        if (!result.includes('<html')) {
          result = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
${result}
</body>
</html>`;
          console.log('âœ… [ç•Œé¢ç”Ÿæˆ] å·²è‡ªåŠ¨åŒ…è£…ä¸ºå®Œæ•´HTMLæ–‡æ¡£');
        }
      } else {
        // 4. å¦‚æœå®Œå…¨æ²¡æœ‰HTMLæ ‡ç­¾ï¼Œè¯´æ˜AIè¿”å›çš„æ˜¯çº¯æ–‡æœ¬æˆ–æ¨ç†è¿‡ç¨‹
        console.error('âŒ [ç•Œé¢ç”Ÿæˆ] AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ');
        console.error('AIè¿”å›å†…å®¹:', result);
        throw new Error('AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„ç•Œé¢æè¿°æˆ–æ›´æ¢æ¨¡å‹');
      }
    }

    console.log('ğŸ“ [ç•Œé¢ç”Ÿæˆ] æœ€ç»ˆHTMLé•¿åº¦:', result.length);

    taskStore.updateTaskProgress(taskId, 85, 'æ­£åœ¨ç”Ÿæˆæ­£åˆ™é…ç½®...');

    generatedCode.value = result;

    // ç”Ÿæˆæ­£åˆ™é…ç½®ï¼ˆç¬¦åˆé…’é¦†æ­£åˆ™æ ¼å¼ï¼‰
    const findRegex = triggerKeyword.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regexJson = {
      id: `regex_ui_${Date.now()}`,
      scriptName: `ç•Œé¢_${triggerKeyword.value}`,
      findRegex: findRegex,
      replaceString: result,
      trimStrings: [],
      placement: [2], // AIè¾“å‡ºåå¤„ç†
      disabled: false,
      markdownOnly: true,
      promptOnly: false,
      runOnEdit: true,
      substituteRegex: 0,
      minDepth: null,
      maxDepth: null,
    };
    generatedRegex.value = JSON.stringify(regexJson, null, 2);

    taskStore.addTaskDetail(taskId, `âœ… HTMLä»£ç é•¿åº¦: ${result.length} å­—ç¬¦`);
    taskStore.completeTask(taskId, { code: result, regex: generatedRegex.value });

    window.toastr.success('AI ç”ŸæˆæˆåŠŸï¼');
  } catch (error) {
    console.error('AI ç”Ÿæˆå¤±è´¥:', error);
    taskStore.failTask(taskId, (error as Error).message);
    window.toastr.error('AI ç”Ÿæˆå¤±è´¥: ' + (error as Error).message);
  } finally {
    isGenerating.value = false;
  }
};

// æ˜¾ç¤ºä¿®æ”¹å¯¹è¯æ¡†
const showModifyDialog = () => {
  modifyInstruction.value = '';
  showModify.value = true;
};

// AI ä¿®æ”¹ç•Œé¢ï¼ˆå¢é‡ä¿®æ”¹ï¼‰
const modifyWithAI = async () => {
  if (!modifyInstruction.value) {
    window.toastr.warning('è¯·è¾“å…¥ä¿®æ”¹å»ºè®®');
    return;
  }

  // åˆ›å»ºä»»åŠ¡
  const taskId = taskStore.createTask('ui_modify', `ä¿®æ”¹ç•Œé¢ï¼š${triggerKeyword.value}`);
  isModifying.value = true;

  try {
    taskStore.updateTaskProgress(taskId, 10, 'æ­£åœ¨æ„å»ºä¿®æ”¹æç¤ºè¯...');

    const systemPrompt = `ä½ æ˜¯ä¸“ä¸šçš„å‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®ç”¨æˆ·åé¦ˆä¿®æ”¹å’Œä¼˜åŒ–ç•Œé¢ä»£ç ã€‚

# æ ¸å¿ƒä»»åŠ¡
æ ¹æ®ç”¨æˆ·çš„åŸå§‹éœ€æ±‚å’Œä¿®æ”¹å»ºè®®ï¼Œç”Ÿæˆ**å®Œæ•´**çš„ä¼˜åŒ–åçš„ HTML ä»£ç ã€‚

# ä¿®æ”¹åŸåˆ™
1. **ä¿æŒåŸæœ‰é£æ ¼**ï¼šä¸è¦æ”¹å˜åŸå§‹æè¿°ä¸­çš„æ ¸å¿ƒé£æ ¼
2. **ç²¾å‡†ä¿®æ”¹**ï¼šåªä¿®æ”¹ç”¨æˆ·æ˜ç¡®è¦æ±‚ä¿®æ”¹çš„éƒ¨åˆ†
3. **å®Œæ•´è¾“å‡º**ï¼šç¡®ä¿ä¿®æ”¹åçš„ä»£ç æ˜¯å®Œæ•´çš„ï¼Œä¸è¦æˆªæ–­
4. **å‘ä¸‹å…¼å®¹**ï¼šç¡®ä¿ä¿®æ”¹ä¸ä¼šç ´ååŸæœ‰åŠŸèƒ½

# ç¦æ­¢äº‹é¡¹
âŒ ä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šã€è¯´æ˜ã€æ³¨é‡Š
âŒ ä¸è¦ä½¿ç”¨ markdown ä»£ç å—ï¼ˆ\`\`\`htmlï¼‰
âŒ ä¸è¦ç”Ÿæˆä¸å®Œæ•´çš„ä»£ç 
âŒ ä¸è¦çœç•¥ä»»ä½•éƒ¨åˆ†

# è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºå®Œæ•´çš„ HTML ä»£ç ï¼Œä» \`<!DOCTYPE html>\` å¼€å§‹ã€‚`;

    const userPrompt = `**è§¦å‘å…³é”®è¯**ï¼š${triggerKeyword.value}

**åŸå§‹ç•Œé¢éœ€æ±‚**ï¼š
${interfaceDescription.value}

**ç”¨æˆ·ä¿®æ”¹å»ºè®®**ï¼š
${modifyInstruction.value}

---

**ä¿®æ”¹è¦æ±‚**ï¼š
1. åœ¨åŸå§‹éœ€æ±‚çš„åŸºç¡€ä¸Šï¼Œç²¾å‡†åº”ç”¨ä¿®æ”¹å»ºè®®
2. ä¿æŒä»£ç å®Œæ•´æ€§ï¼Œä¸è¦æˆªæ–­
3. ç¡®ä¿å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

ç«‹å³ç”Ÿæˆä¿®æ”¹åçš„å®Œæ•´HTMLä»£ç ï¼š`;

    taskStore.updateTaskProgress(taskId, 20, 'æ­£åœ¨å‘é€ä¿®æ”¹è¯·æ±‚...');
    taskStore.addTaskDetail(taskId, `ä¿®æ”¹å»ºè®®: ${modifyInstruction.value}`);

    const apiUrl = normalizeApiEndpoint(settings.value.api_endpoint);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model,
        messages: [
          {
            role: 'system',
            content: systemPrompt,
          },
          { role: 'user', content: userPrompt },
        ],
        temperature: settings.value.temperature || 0.7,
        max_tokens: settings.value.max_tokens || 16000,
        top_p: settings.value.top_p,
        presence_penalty: settings.value.presence_penalty,
        frequency_penalty: settings.value.frequency_penalty,
      }),
    });

    taskStore.updateTaskProgress(taskId, 40, 'ç­‰å¾…AIå“åº”...');

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    taskStore.updateTaskProgress(taskId, 50, 'æ­£åœ¨ç­‰å¾… AI ä¿®æ”¹ä»£ç ...');
    taskStore.addTaskDetail(taskId, 'AI æ­£åœ¨æ ¹æ®ä¿®æ”¹å»ºè®®é‡æ–°ç”Ÿæˆä»£ç ...');

    const data = await response.json();
    let result = data.choices?.[0]?.message?.content || '';

    taskStore.updateTaskProgress(taskId, 70, 'æ­£åœ¨å¤„ç†ä¿®æ”¹åçš„ä»£ç ...');

    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] AI åŸå§‹è¿”å›é•¿åº¦:', result.length);
    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] AI åŸå§‹è¿”å›å‰500å­—ç¬¦:', result.substring(0, 500));

    // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
    result = result
      .replace(/```html\n?/g, '')
      .replace(/```\n?/g, '')
      .trim();

    // å°è¯•æå–HTMLä»£ç ï¼ˆå¤„ç†AIæ¨ç†è¿‡ç¨‹ï¼‰
    // 1. å…ˆæŸ¥æ‰¾ <!DOCTYPE html å¼€å¤´çš„å®Œæ•´æ–‡æ¡£
    const doctypeMatch = result.match(/<!DOCTYPE html>[\s\S]*/i);
    if (doctypeMatch) {
      result = doctypeMatch[0].trim();
      console.log('âœ… [ç•Œé¢ä¿®æ”¹] æå–åˆ°å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆå«DOCTYPEï¼‰');
    } else {
      // 2. å¦‚æœæ²¡æœ‰DOCTYPEï¼ŒæŸ¥æ‰¾ <html å¼€å¤´çš„éƒ¨åˆ†
      const htmlMatch = result.match(/<html[\s\S]*/i);
      if (htmlMatch) {
        result = htmlMatch[0].trim();
        console.log('âœ… [ç•Œé¢ä¿®æ”¹] æå–åˆ°HTMLæ–‡æ¡£ï¼ˆä¸å«DOCTYPEï¼‰');
      } else if (result.includes('<') && result.includes('>')) {
        // 3. å¦‚æœæ²¡æœ‰å®Œæ•´çš„htmlæ ‡ç­¾ï¼Œä½†åŒ…å«HTMLæ ‡ç­¾
        console.log('âš ï¸ [ç•Œé¢ä¿®æ”¹] åŒ…å«HTMLæ ‡ç­¾ä½†æ ¼å¼ä¸æ ‡å‡†ï¼Œå°è¯•åŒ…è£…');
        // å°è¯•åŒ…è£…æˆå®Œæ•´æ–‡æ¡£
        if (!result.includes('<html')) {
          result = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
${result}
</body>
</html>`;
          console.log('âœ… [ç•Œé¢ä¿®æ”¹] å·²è‡ªåŠ¨åŒ…è£…ä¸ºå®Œæ•´HTMLæ–‡æ¡£');
        }
      } else {
        // 4. å¦‚æœå®Œå…¨æ²¡æœ‰HTMLæ ‡ç­¾ï¼Œè¯´æ˜AIè¿”å›çš„æ˜¯çº¯æ–‡æœ¬æˆ–æ¨ç†è¿‡ç¨‹
        console.error('âŒ [ç•Œé¢ä¿®æ”¹] AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ');
        console.error('AIè¿”å›å†…å®¹:', result);
        throw new Error('AIæœªè¿”å›æœ‰æ•ˆçš„HTMLä»£ç ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„ä¿®æ”¹å»ºè®®æˆ–æ›´æ¢æ¨¡å‹');
      }
    }

    console.log('ğŸ“ [ç•Œé¢ä¿®æ”¹] æœ€ç»ˆHTMLé•¿åº¦:', result.length);

    taskStore.updateTaskProgress(taskId, 85, 'æ­£åœ¨æ›´æ–°æ­£åˆ™é…ç½®...');

    generatedCode.value = result;

    // æ›´æ–°æ­£åˆ™é…ç½®ï¼ˆç¬¦åˆé…’é¦†æ­£åˆ™æ ¼å¼ï¼‰
    const findRegex = triggerKeyword.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regexJson = {
      id: `regex_ui_${Date.now()}`,
      scriptName: `ç•Œé¢_${triggerKeyword.value}`,
      findRegex: findRegex,
      replaceString: result,
      trimStrings: [],
      placement: [2], // AIè¾“å‡ºåå¤„ç†
      disabled: false,
      markdownOnly: true,
      promptOnly: false,
      runOnEdit: true,
      substituteRegex: 0,
      minDepth: null,
      maxDepth: null,
    };
    generatedRegex.value = JSON.stringify(regexJson, null, 2);

    // æ›´æ–°ç•Œé¢æè¿°ï¼ˆå°†ä¿®æ”¹å»ºè®®åˆå¹¶åˆ°åŸæè¿°ä¸­ï¼Œç”¨äºä¸‹æ¬¡ä¿®æ”¹ï¼‰
    interfaceDescription.value = `${interfaceDescription.value}\n\nã€å·²åº”ç”¨çš„ä¿®æ”¹ã€‘ï¼š\n${modifyInstruction.value}`;

    taskStore.addTaskDetail(taskId, `âœ… ä¿®æ”¹åä»£ç é•¿åº¦: ${result.length} å­—ç¬¦`);
    taskStore.completeTask(taskId, { code: result, regex: generatedRegex.value });

    window.toastr.success('AI ä¿®æ”¹æˆåŠŸï¼');
    showModify.value = false;
  } catch (error) {
    console.error('AI ä¿®æ”¹å¤±è´¥:', error);
    taskStore.failTask(taskId, (error as Error).message);
    window.toastr.error('AI ä¿®æ”¹å¤±è´¥: ' + (error as Error).message);
  } finally {
    isModifying.value = false;
  }
};

// å¤åˆ¶æ­£åˆ™ä»£ç 
const copyRegex = () => {
  copyToClipboard(generatedRegex.value, 'æ­£åˆ™ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};
</script>

<style scoped>
.regex-ui-generator {
  height: 100%;
  overflow-y: auto;
}

button:disabled {
  cursor: not-allowed !important;
  opacity: 0.5 !important;
}

button:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

code {
  background: #1a1a1a;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Consolas', monospace;
}

pre::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

pre::-webkit-scrollbar-track {
  background: #1a1a1a;
  border-radius: 3px;
}

pre::-webkit-scrollbar-thumb {
  background: #4a9eff;
  border-radius: 3px;
}

pre::-webkit-scrollbar-thumb:hover {
  background: #5ab0ff;
}
</style>
