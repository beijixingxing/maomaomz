const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["index.js","index.css"])))=>i.map(i=>d[i]);
import{d as e,r as n,w as t,_ as a,c as o,a as r,o as i,b as s,e as l,f as d,t as c,v as p,g as u,n as g,h as f,F as m,i as x,j as h,u as b,s as y,k as v,l as w,m as k,p as T,q as S,x as I,y as A,z as C,A as E,B as P,C as M,D as O,E as j,G as D,H as R,I as N,J as H,K as L,L as F,M as V,N as U,O as J,P as B,Q as W}from'./index.js';function G(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,'default')?e.default:e}var Y,Z;const q=G(Z?Y:(Z=1,Y=toastr));function X(e,n,t){function a(t,a){var o;Object.defineProperty(t,'_zod',{value:t._zod??{},enumerable:!1}),(o=t._zod).traits??(o.traits=new Set),t._zod.traits.add(e),n(t,a);for(const e in _.prototype)e in t||Object.defineProperty(t,e,{value:_.prototype[e].bind(t)});t._zod.constr=_,t._zod.def=a}const o=t?.Parent??Object;class r extends o{}function _(e){var n;const o=t?.Parent?new r:this;a(o,e),(n=o._zod).deferred??(n.deferred=[]);for(const t of o._zod.deferred)t();return o}return Object.defineProperty(r,'name',{value:e}),Object.defineProperty(_,'init',{value:a}),Object.defineProperty(_,Symbol.hasInstance,{value:n=>!!(t?.Parent&&n instanceof t.Parent)||n?._zod?.traits?.has(e)}),Object.defineProperty(_,'name',{value:e}),_}class K extends Error{constructor(){super('Encountered Promise during synchronous parse. Use .parseAsync() instead.')}}class Q extends Error{constructor(e){super(`Encountered unidirectional transform during encode: ${e}`),this.name='ZodEncodeError'}}const ee={};function ne(e){return ee}function te(_,e){return'bigint'==typeof e?e.toString():e}function ae(e){return{get value(){{const n=e();return Object.defineProperty(this,'value',{value:n}),n}}}}function oe(e){return null==e}function re(e){const n=e.startsWith('^')?1:0,t=e.endsWith('$')?e.length-1:e.length;return e.slice(n,t)}const ie=Symbol('evaluating');function se(e,n,t){let a;Object.defineProperty(e,n,{get(){if(a!==ie)return void 0===a&&(a=ie,a=t()),a},set(t){Object.defineProperty(e,n,{value:t})},configurable:!0})}function le(e,n,t){Object.defineProperty(e,n,{value:t,writable:!0,enumerable:!0,configurable:!0})}function de(...e){const n={};for(const t of e){const e=Object.getOwnPropertyDescriptors(t);Object.assign(n,e)}return Object.defineProperties({},n)}function ce(e){return JSON.stringify(e)}const pe='captureStackTrace'in Error?Error.captureStackTrace:(...e)=>{};function ue(e){return'object'==typeof e&&null!==e&&!Array.isArray(e)}const ge=ae(()=>{if('undefined'!=typeof navigator&&navigator?.userAgent?.includes('Cloudflare'))return!1;try{return new Function(''),!0}catch(_){return!1}});function fe(e){if(!1===ue(e))return!1;const n=e.constructor;if(void 0===n)return!0;const t=n.prototype;return!1!==ue(t)&&!1!==Object.prototype.hasOwnProperty.call(t,'isPrototypeOf')}function me(e){return fe(e)?{...e}:Array.isArray(e)?[...e]:e}const xe=new Set(['string','number','symbol']);function he(e){return e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}function be(e,n,t){const a=new e._zod.constr(n??e._zod.def);return n&&!t?.parent||(a._zod.parent=e),a}function ye(e){const n=e;if(!n)return{};if('string'==typeof n)return{error:()=>n};if(void 0!==n?.message){if(void 0!==n?.error)throw new Error('Cannot specify both `message` and `error` params');n.error=n.message}return delete n.message,'string'==typeof n.error?{...n,error:()=>n.error}:n}function ve(e,n=0){if(!0===e.aborted)return!0;for(let t=n;t<e.issues.length;t++)if(!0!==e.issues[t]?.continue)return!0;return!1}function we(e,n){return n.map(n=>{var t;return(t=n).path??(t.path=[]),n.path.unshift(e),n})}function ke(e){return'string'==typeof e?e:e?.message}function _e(e,n,t){const a={...e,path:e.path??[]};if(!e.message){const o=ke(e.inst?._zod.def?.error?.(e))??ke(n?.error?.(e))??ke(t.customError?.(e))??ke(t.localeError?.(e))??'Invalid input';a.message=o}return delete a.inst,delete a.continue,n?.reportInput||delete a.input,a}function Te(e){return Array.isArray(e)?'array':'string'==typeof e?'string':'unknown'}function Se(...e){const[n,t,a]=e;return'string'==typeof n?{message:n,code:'custom',input:t,inst:a}:{...n}}const Ie=(e,n)=>{e.name='$ZodError',Object.defineProperty(e,'_zod',{value:e._zod,enumerable:!1}),Object.defineProperty(e,'issues',{value:n,enumerable:!1}),e.message=JSON.stringify(n,te,2),Object.defineProperty(e,'toString',{value:()=>e.message,enumerable:!1})},Ae=X('$ZodError',Ie),ze=X('$ZodError',Ie,{Parent:Error});const Ce=e=>(n,t,a,o)=>{const r=a?Object.assign(a,{async:!1}):{async:!1},i=n._zod.run({value:t,issues:[]},r);if(i instanceof Promise)throw new K;if(i.issues.length){const n=new(o?.Err??e)(i.issues.map(e=>_e(e,r,ne())));throw pe(n,o?.callee),n}return i.value},$e=e=>async(n,t,a,o)=>{const r=a?Object.assign(a,{async:!0}):{async:!0};let i=n._zod.run({value:t,issues:[]},r);if(i instanceof Promise&&(i=await i),i.issues.length){const n=new(o?.Err??e)(i.issues.map(e=>_e(e,r,ne())));throw pe(n,o?.callee),n}return i.value},Ee=e=>(n,t,a)=>{const o=a?{...a,async:!1}:{async:!1},r=n._zod.run({value:t,issues:[]},o);if(r instanceof Promise)throw new K;return r.issues.length?{success:!1,error:new(e??Ae)(r.issues.map(e=>_e(e,o,ne())))}:{success:!0,data:r.value}},Pe=Ee(ze),Me=e=>async(n,t,a)=>{const o=a?Object.assign(a,{async:!0}):{async:!0};let r=n._zod.run({value:t,issues:[]},o);return r instanceof Promise&&(r=await r),r.issues.length?{success:!1,error:new e(r.issues.map(e=>_e(e,o,ne())))}:{success:!0,data:r.value}},Oe=Me(ze),je=e=>(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Ce(e)(n,t,o)},De=e=>(n,t,a)=>Ce(e)(n,t,a),Re=e=>async(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return $e(e)(n,t,o)},Ne=e=>async(n,t,a)=>$e(e)(n,t,a),He=e=>(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Ee(e)(n,t,o)},Le=e=>(n,t,a)=>Ee(e)(n,t,a),Fe=e=>async(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Me(e)(n,t,o)},Ve=e=>async(n,t,a)=>Me(e)(n,t,a),Ue=/^[cC][^\s-]{8,}$/,Je=/^[0-9a-z]+$/,Be=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,We=/^[0-9a-vA-V]{20}$/,Ge=/^[A-Za-z0-9]{27}$/,Ye=/^[a-zA-Z0-9_-]{21}$/,Ze=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,qe=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Xe=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,Ke=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;const Qe=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,en=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,nn=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,tn=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,an=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,on=/^[A-Za-z0-9_-]*$/,rn=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,sn=/^\+(?:[0-9]){6,14}[0-9]$/,ln='(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))',dn=new RegExp(`^${ln}$`);function cn(e){const n='(?:[01]\\d|2[0-3]):[0-5]\\d';return'number'==typeof e.precision?-1===e.precision?`${n}`:0===e.precision?`${n}:[0-5]\\d`:`${n}:[0-5]\\d\\.\\d{${e.precision}}`:`${n}(?::[0-5]\\d(?:\\.\\d+)?)?`}const pn=/^[^A-Z]*$/,un=/^[^a-z]*$/,gn=X('$ZodCheck',(e,n)=>{var t;e._zod??(e._zod={}),e._zod.def=n,(t=e._zod).onattach??(t.onattach=[])}),fn=X('$ZodCheckMaxLength',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag.maximum??Number.POSITIVE_INFINITY;n.maximum<t&&(e._zod.bag.maximum=n.maximum)}),e._zod.check=t=>{const a=t.value;if(a.length<=n.maximum)return;const o=Te(a);t.issues.push({origin:o,code:'too_big',maximum:n.maximum,inclusive:!0,input:a,inst:e,continue:!n.abort})}}),mn=X('$ZodCheckMinLength',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;n.minimum>t&&(e._zod.bag.minimum=n.minimum)}),e._zod.check=t=>{const a=t.value;if(a.length>=n.minimum)return;const o=Te(a);t.issues.push({origin:o,code:'too_small',minimum:n.minimum,inclusive:!0,input:a,inst:e,continue:!n.abort})}}),xn=X('$ZodCheckLengthEquals',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag;t.minimum=n.length,t.maximum=n.length,t.length=n.length}),e._zod.check=t=>{const a=t.value,o=a.length;if(o===n.length)return;const r=Te(a),i=o>n.length;t.issues.push({origin:r,...i?{code:'too_big',maximum:n.length}:{code:'too_small',minimum:n.length},inclusive:!0,exact:!0,input:t.value,inst:e,continue:!n.abort})}}),hn=X('$ZodCheckStringFormat',(e,n)=>{var t,a;gn.init(e,n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.format=n.format,n.pattern&&(t.patterns??(t.patterns=new Set),t.patterns.add(n.pattern))}),n.pattern?(t=e._zod).check??(t.check=t=>{n.pattern.lastIndex=0,n.pattern.test(t.value)||t.issues.push({origin:'string',code:'invalid_format',format:n.format,input:t.value,...n.pattern?{pattern:n.pattern.toString()}:{},inst:e,continue:!n.abort})}):(a=e._zod).check??(a.check=()=>{})}),bn=X('$ZodCheckRegex',(e,n)=>{hn.init(e,n),e._zod.check=t=>{n.pattern.lastIndex=0,n.pattern.test(t.value)||t.issues.push({origin:'string',code:'invalid_format',format:'regex',input:t.value,pattern:n.pattern.toString(),inst:e,continue:!n.abort})}}),yn=X('$ZodCheckLowerCase',(e,n)=>{n.pattern??(n.pattern=pn),hn.init(e,n)}),vn=X('$ZodCheckUpperCase',(e,n)=>{n.pattern??(n.pattern=un),hn.init(e,n)}),wn=X('$ZodCheckIncludes',(e,n)=>{gn.init(e,n);const t=he(n.includes),a=new RegExp('number'==typeof n.position?`^.{${n.position}}${t}`:t);n.pattern=a,e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(a)}),e._zod.check=t=>{t.value.includes(n.includes,n.position)||t.issues.push({origin:'string',code:'invalid_format',format:'includes',includes:n.includes,input:t.value,inst:e,continue:!n.abort})}}),kn=X('$ZodCheckStartsWith',(e,n)=>{gn.init(e,n);const t=new RegExp(`^${he(n.prefix)}.*`);n.pattern??(n.pattern=t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(t)}),e._zod.check=t=>{t.value.startsWith(n.prefix)||t.issues.push({origin:'string',code:'invalid_format',format:'starts_with',prefix:n.prefix,input:t.value,inst:e,continue:!n.abort})}}),_n=X('$ZodCheckEndsWith',(e,n)=>{gn.init(e,n);const t=new RegExp(`.*${he(n.suffix)}$`);n.pattern??(n.pattern=t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(t)}),e._zod.check=t=>{t.value.endsWith(n.suffix)||t.issues.push({origin:'string',code:'invalid_format',format:'ends_with',suffix:n.suffix,input:t.value,inst:e,continue:!n.abort})}}),Tn=X('$ZodCheckOverwrite',(e,n)=>{gn.init(e,n),e._zod.check=e=>{e.value=n.tx(e.value)}});class Sn{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if('function'==typeof e)return e(this,{execution:'sync'}),void e(this,{execution:'async'});const n=e.split('\n').filter(e=>e),t=Math.min(...n.map(e=>e.length-e.trimStart().length)),a=n.map(e=>e.slice(t)).map(e=>' '.repeat(2*this.indent)+e);for(const o of a)this.content.push(o)}compile(){const e=Function,n=this?.args;return new e(...n,[...(this?.content??['']).map(e=>`  ${e}`)].join('\n'))}}const In={major:4,minor:1,patch:12},An=X('$ZodType',(e,n)=>{var t;e??(e={}),e._zod.def=n,e._zod.bag=e._zod.bag||{},e._zod.version=In;const a=[...e._zod.def.checks??[]];e._zod.traits.has('$ZodCheck')&&a.unshift(e);for(const o of a)for(const n of o._zod.onattach)n(e);if(0===a.length)(t=e._zod).deferred??(t.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const n=(e,n,t)=>{let a,o=ve(e);for(const r of n){if(r._zod.def.when){if(!r._zod.def.when(e))continue}else if(o)continue;const n=e.issues.length,_=r._zod.check(e);if(_ instanceof Promise&&!1===t?.async)throw new K;if(a||_ instanceof Promise)a=(a??Promise.resolve()).then(async()=>{await _;e.issues.length!==n&&(o||(o=ve(e,n)))});else{if(e.issues.length===n)continue;o||(o=ve(e,n))}}return a?a.then(()=>e):e},t=(t,o,r)=>{if(ve(t))return t.aborted=!0,t;const i=n(o,a,r);if(i instanceof Promise){if(!1===r.async)throw new K;return i.then(n=>e._zod.parse(n,r))}return e._zod.parse(i,r)};e._zod.run=(o,r)=>{if(r.skipChecks)return e._zod.parse(o,r);if('backward'===r.direction){const n=e._zod.parse({value:o.value,issues:[]},{...r,skipChecks:!0});return n instanceof Promise?n.then(e=>t(e,o,r)):t(n,o,r)}const i=e._zod.parse(o,r);if(i instanceof Promise){if(!1===r.async)throw new K;return i.then(e=>n(e,a,r))}return n(i,a,r)}}e['~standard']={validate:n=>{try{const t=Pe(e,n);return t.success?{value:t.data}:{issues:t.error?.issues}}catch(_){return Oe(e,n).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:'zod',version:1}}),zn=X('$ZodString',(e,n)=>{var t;An.init(e,n),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(t=e._zod.bag,new RegExp(`^${t?`[\\s\\S]{${t?.minimum??0},${t?.maximum??''}}`:'[\\s\\S]*'}$`)),e._zod.parse=(t,_)=>{if(n.coerce)try{t.value=String(t.value)}catch(_){}return'string'==typeof t.value||t.issues.push({expected:'string',code:'invalid_type',input:t.value,inst:e}),t}}),Cn=X('$ZodStringFormat',(e,n)=>{hn.init(e,n),zn.init(e,n)}),$n=X('$ZodGUID',(e,n)=>{n.pattern??(n.pattern=qe),Cn.init(e,n)}),En=X('$ZodUUID',(e,n)=>{if(n.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[n.version];if(void 0===e)throw new Error(`Invalid UUID version: "${n.version}"`);n.pattern??(n.pattern=Xe(e))}else n.pattern??(n.pattern=Xe());Cn.init(e,n)}),Pn=X('$ZodEmail',(e,n)=>{n.pattern??(n.pattern=Ke),Cn.init(e,n)}),Mn=X('$ZodURL',(e,n)=>{Cn.init(e,n),e._zod.check=t=>{try{const a=t.value.trim(),o=new URL(a);return n.hostname&&(n.hostname.lastIndex=0,n.hostname.test(o.hostname)||t.issues.push({code:'invalid_format',format:'url',note:'Invalid hostname',pattern:rn.source,input:t.value,inst:e,continue:!n.abort})),n.protocol&&(n.protocol.lastIndex=0,n.protocol.test(o.protocol.endsWith(':')?o.protocol.slice(0,-1):o.protocol)||t.issues.push({code:'invalid_format',format:'url',note:'Invalid protocol',pattern:n.protocol.source,input:t.value,inst:e,continue:!n.abort})),void(n.normalize?t.value=o.href:t.value=a)}catch(_){t.issues.push({code:'invalid_format',format:'url',input:t.value,inst:e,continue:!n.abort})}}}),On=X('$ZodEmoji',(e,n)=>{n.pattern??(n.pattern=new RegExp('^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$','u')),Cn.init(e,n)}),jn=X('$ZodNanoID',(e,n)=>{n.pattern??(n.pattern=Ye),Cn.init(e,n)}),Dn=X('$ZodCUID',(e,n)=>{n.pattern??(n.pattern=Ue),Cn.init(e,n)}),Rn=X('$ZodCUID2',(e,n)=>{n.pattern??(n.pattern=Je),Cn.init(e,n)}),Nn=X('$ZodULID',(e,n)=>{n.pattern??(n.pattern=Be),Cn.init(e,n)}),Hn=X('$ZodXID',(e,n)=>{n.pattern??(n.pattern=We),Cn.init(e,n)}),Ln=X('$ZodKSUID',(e,n)=>{n.pattern??(n.pattern=Ge),Cn.init(e,n)}),Fn=X('$ZodISODateTime',(e,n)=>{n.pattern??(n.pattern=function(e){const n=cn({precision:e.precision}),t=['Z'];e.local&&t.push(''),e.offset&&t.push('([+-](?:[01]\\d|2[0-3]):[0-5]\\d)');const a=`${n}(?:${t.join('|')})`;return new RegExp(`^${ln}T(?:${a})$`)}(n)),Cn.init(e,n)}),Vn=X('$ZodISODate',(e,n)=>{n.pattern??(n.pattern=dn),Cn.init(e,n)}),Un=X('$ZodISOTime',(e,n)=>{n.pattern??(n.pattern=new RegExp(`^${cn(n)}$`)),Cn.init(e,n)}),Jn=X('$ZodISODuration',(e,n)=>{n.pattern??(n.pattern=Ze),Cn.init(e,n)}),Bn=X('$ZodIPv4',(e,n)=>{n.pattern??(n.pattern=Qe),Cn.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.format='ipv4'})}),Wn=X('$ZodIPv6',(e,n)=>{n.pattern??(n.pattern=en),Cn.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.format='ipv6'}),e._zod.check=t=>{try{new URL(`http://[${t.value}]`)}catch{t.issues.push({code:'invalid_format',format:'ipv6',input:t.value,inst:e,continue:!n.abort})}}}),Gn=X('$ZodCIDRv4',(e,n)=>{n.pattern??(n.pattern=nn),Cn.init(e,n)}),Yn=X('$ZodCIDRv6',(e,n)=>{n.pattern??(n.pattern=tn),Cn.init(e,n),e._zod.check=t=>{const a=t.value.split('/');try{if(2!==a.length)throw new Error;const[e,n]=a;if(!n)throw new Error;const t=Number(n);if(`${t}`!==n)throw new Error;if(t<0||t>128)throw new Error;new URL(`http://[${e}]`)}catch{t.issues.push({code:'invalid_format',format:'cidrv6',input:t.value,inst:e,continue:!n.abort})}}});function Zn(e){if(''===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const qn=X('$ZodBase64',(e,n)=>{n.pattern??(n.pattern=an),Cn.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding='base64'}),e._zod.check=t=>{Zn(t.value)||t.issues.push({code:'invalid_format',format:'base64',input:t.value,inst:e,continue:!n.abort})}});const Xn=X('$ZodBase64URL',(e,n)=>{n.pattern??(n.pattern=on),Cn.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding='base64url'}),e._zod.check=t=>{(function(e){if(!on.test(e))return!1;const n=e.replace(/[-_]/g,e=>'-'===e?'+':'/');return Zn(n.padEnd(4*Math.ceil(n.length/4),'='))})(t.value)||t.issues.push({code:'invalid_format',format:'base64url',input:t.value,inst:e,continue:!n.abort})}}),Kn=X('$ZodE164',(e,n)=>{n.pattern??(n.pattern=sn),Cn.init(e,n)});const Qn=X('$ZodJWT',(e,n)=>{Cn.init(e,n),e._zod.check=t=>{(function(e,n=null){try{const t=e.split('.');if(3!==t.length)return!1;const[a]=t;if(!a)return!1;const o=JSON.parse(atob(a));return!('typ'in o&&'JWT'!==o?.typ||!o.alg||n&&(!('alg'in o)||o.alg!==n))}catch{return!1}})(t.value,n.alg)||t.issues.push({code:'invalid_format',format:'jwt',input:t.value,inst:e,continue:!n.abort})}}),et=X('$ZodUnknown',(e,n)=>{An.init(e,n),e._zod.parse=e=>e}),nt=X('$ZodNever',(e,n)=>{An.init(e,n),e._zod.parse=(n,t)=>(n.issues.push({expected:'never',code:'invalid_type',input:n.value,inst:e}),n)});function tt(e,n,t){e.issues.length&&n.issues.push(...we(t,e.issues)),n.value[t]=e.value}const at=X('$ZodArray',(e,n)=>{An.init(e,n),e._zod.parse=(t,a)=>{const o=t.value;if(!Array.isArray(o))return t.issues.push({expected:'array',code:'invalid_type',input:o,inst:e}),t;t.value=Array(o.length);const r=[];for(let e=0;e<o.length;e++){const i=o[e],s=n.element._zod.run({value:i,issues:[]},a);s instanceof Promise?r.push(s.then(n=>tt(n,t,e))):tt(s,t,e)}return r.length?Promise.all(r).then(()=>t):t}});function ot(e,n,t,a){e.issues.length&&n.issues.push(...we(t,e.issues)),void 0===e.value?t in a&&(n.value[t]=void 0):n.value[t]=e.value}function rt(e){const n=Object.keys(e.shape);for(const o of n)if(!e.shape?.[o]?._zod?.traits?.has('$ZodType'))throw new Error(`Invalid element at key "${o}": expected a Zod schema`);const t=(a=e.shape,Object.keys(a).filter(e=>'optional'===a[e]._zod.optin&&'optional'===a[e]._zod.optout));var a;return{...e,keys:n,keySet:new Set(n),numKeys:n.length,optionalKeys:new Set(t)}}function it(e,n,t,a,o,r){const i=[],s=o.keySet,l=o.catchall._zod,d=l.def.type;for(const c of Object.keys(n)){if(s.has(c))continue;if('never'===d){i.push(c);continue}const o=l.run({value:n[c],issues:[]},a);o instanceof Promise?e.push(o.then(e=>ot(e,t,c,n))):ot(o,t,c,n)}return i.length&&t.issues.push({code:'unrecognized_keys',keys:i,input:n,inst:r}),e.length?Promise.all(e).then(()=>t):t}const st=X('$ZodObject',(e,n)=>{An.init(e,n);const t=Object.getOwnPropertyDescriptor(n,'shape');if(!t?.get){const e=n.shape;Object.defineProperty(n,'shape',{get:()=>{const t={...e};return Object.defineProperty(n,'shape',{value:t}),t}})}const a=ae(()=>rt(n));se(e._zod,'propValues',()=>{const e=n.shape,t={};for(const n in e){const a=e[n]._zod;if(a.values){t[n]??(t[n]=new Set);for(const e of a.values)t[n].add(e)}}return t});const o=ue,r=n.catchall;let i;e._zod.parse=(n,t)=>{i??(i=a.value);const s=n.value;if(!o(s))return n.issues.push({expected:'object',code:'invalid_type',input:s,inst:e}),n;n.value={};const l=[],d=i.shape;for(const e of i.keys){const a=d[e]._zod.run({value:s[e],issues:[]},t);a instanceof Promise?l.push(a.then(t=>ot(t,n,e,s))):ot(a,n,e,s)}return r?it(l,s,n,t,a.value,e):l.length?Promise.all(l).then(()=>n):n}}),lt=X('$ZodObjectJIT',(e,n)=>{st.init(e,n);const t=e._zod.parse,a=ae(()=>rt(n));let o;const r=ue,i=!ee.jitless,s=i&&ge.value,l=n.catchall;let d;e._zod.parse=(c,p)=>{d??(d=a.value);const u=c.value;return r(u)?i&&s&&!1===p?.async&&!0!==p.jitless?(o||(o=(e=>{const n=new Sn(['shape','payload','ctx']),t=a.value,o=e=>{const n=ce(e);return`shape[${n}]._zod.run({ value: input[${n}], issues: [] }, ctx)`};n.write('const input = payload.value;');const r=Object.create(null);let i=0;for(const a of t.keys)r[a]='key_'+i++;n.write('const newResult = {};');for(const a of t.keys){const e=r[a],t=ce(a);n.write(`const ${e} = ${o(a)};`),n.write(`\n        if (${e}.issues.length) {\n          payload.issues = payload.issues.concat(${e}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${t}, ...iss.path] : [${t}]\n          })));\n        }\n        \n        \n        if (${e}.value === undefined) {\n          if (${t} in input) {\n            newResult[${t}] = undefined;\n          }\n        } else {\n          newResult[${t}] = ${e}.value;\n        }\n        \n      `)}n.write('payload.value = newResult;'),n.write('return payload;');const s=n.compile();return(n,t)=>s(e,n,t)})(n.shape)),c=o(c,p),l?it([],u,c,p,d,e):c):t(c,p):(c.issues.push({expected:'object',code:'invalid_type',input:u,inst:e}),c)}});function dt(e,n,t,a){for(const r of e)if(0===r.issues.length)return n.value=r.value,n;const o=e.filter(e=>!ve(e));return 1===o.length?(n.value=o[0].value,o[0]):(n.issues.push({code:'invalid_union',input:n.value,inst:t,errors:e.map(e=>e.issues.map(e=>_e(e,a,ne())))}),n)}const ct=X('$ZodUnion',(e,n)=>{An.init(e,n),se(e._zod,'optin',()=>n.options.some(e=>'optional'===e._zod.optin)?'optional':void 0),se(e._zod,'optout',()=>n.options.some(e=>'optional'===e._zod.optout)?'optional':void 0),se(e._zod,'values',()=>{if(n.options.every(e=>e._zod.values))return new Set(n.options.flatMap(e=>Array.from(e._zod.values)))}),se(e._zod,'pattern',()=>{if(n.options.every(e=>e._zod.pattern)){const e=n.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>re(e.source)).join('|')})$`)}});const t=1===n.options.length,a=n.options[0]._zod.run;e._zod.parse=(o,r)=>{if(t)return a(o,r);let i=!1;const s=[];for(const e of n.options){const n=e._zod.run({value:o.value,issues:[]},r);if(n instanceof Promise)s.push(n),i=!0;else{if(0===n.issues.length)return n;s.push(n)}}return i?Promise.all(s).then(n=>dt(n,o,e,r)):dt(s,o,e,r)}}),pt=X('$ZodIntersection',(e,n)=>{An.init(e,n),e._zod.parse=(e,t)=>{const a=e.value,o=n.left._zod.run({value:a,issues:[]},t),r=n.right._zod.run({value:a,issues:[]},t);return o instanceof Promise||r instanceof Promise?Promise.all([o,r]).then(([n,t])=>gt(e,n,t)):gt(e,o,r)}});function ut(e,n){if(e===n)return{valid:!0,data:e};if(e instanceof Date&&n instanceof Date&&+e===+n)return{valid:!0,data:e};if(fe(e)&&fe(n)){const t=Object.keys(n),a=Object.keys(e).filter(e=>-1!==t.indexOf(e)),o={...e,...n};for(const r of a){const t=ut(e[r],n[r]);if(!t.valid)return{valid:!1,mergeErrorPath:[r,...t.mergeErrorPath]};o[r]=t.data}return{valid:!0,data:o}}if(Array.isArray(e)&&Array.isArray(n)){if(e.length!==n.length)return{valid:!1,mergeErrorPath:[]};const t=[];for(let a=0;a<e.length;a++){const o=ut(e[a],n[a]);if(!o.valid)return{valid:!1,mergeErrorPath:[a,...o.mergeErrorPath]};t.push(o.data)}return{valid:!0,data:t}}return{valid:!1,mergeErrorPath:[]}}function gt(e,n,t){if(n.issues.length&&e.issues.push(...n.issues),t.issues.length&&e.issues.push(...t.issues),ve(e))return e;const a=ut(n.value,t.value);if(!a.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(a.mergeErrorPath)}`);return e.value=a.data,e}const ft=X('$ZodEnum',(e,n)=>{An.init(e,n);const t=function(e){const n=Object.values(e).filter(e=>'number'==typeof e);return Object.entries(e).filter(([e,_])=>-1===n.indexOf(+e)).map(([_,e])=>e)}(n.entries),a=new Set(t);e._zod.values=a,e._zod.pattern=new RegExp(`^(${t.filter(e=>xe.has(typeof e)).map(e=>'string'==typeof e?he(e):e.toString()).join('|')})$`),e._zod.parse=(n,o)=>{const r=n.value;return a.has(r)||n.issues.push({code:'invalid_value',values:t,input:r,inst:e}),n}}),mt=X('$ZodTransform',(e,n)=>{An.init(e,n),e._zod.parse=(t,a)=>{if('backward'===a.direction)throw new Q(e.constructor.name);const o=n.transform(t.value,t);if(a.async){return(o instanceof Promise?o:Promise.resolve(o)).then(e=>(t.value=e,t))}if(o instanceof Promise)throw new K;return t.value=o,t}});function xt(e,n){return e.issues.length&&void 0===n?{issues:[],value:void 0}:e}const ht=X('$ZodOptional',(e,n)=>{An.init(e,n),e._zod.optin='optional',e._zod.optout='optional',se(e._zod,'values',()=>n.innerType._zod.values?new Set([...n.innerType._zod.values,void 0]):void 0),se(e._zod,'pattern',()=>{const e=n.innerType._zod.pattern;return e?new RegExp(`^(${re(e.source)})?$`):void 0}),e._zod.parse=(e,t)=>{if('optional'===n.innerType._zod.optin){const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(n=>xt(n,e.value)):xt(a,e.value)}return void 0===e.value?e:n.innerType._zod.run(e,t)}}),bt=X('$ZodNullable',(e,n)=>{An.init(e,n),se(e._zod,'optin',()=>n.innerType._zod.optin),se(e._zod,'optout',()=>n.innerType._zod.optout),se(e._zod,'pattern',()=>{const e=n.innerType._zod.pattern;return e?new RegExp(`^(${re(e.source)}|null)$`):void 0}),se(e._zod,'values',()=>n.innerType._zod.values?new Set([...n.innerType._zod.values,null]):void 0),e._zod.parse=(e,t)=>null===e.value?e:n.innerType._zod.run(e,t)}),yt=X('$ZodDefault',(e,n)=>{An.init(e,n),e._zod.optin='optional',se(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);if(void 0===e.value)return e.value=n.defaultValue,e;const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(e=>vt(e,n)):vt(a,n)}});function vt(e,n){return void 0===e.value&&(e.value=n.defaultValue),e}const wt=X('$ZodPrefault',(e,n)=>{An.init(e,n),e._zod.optin='optional',se(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>('backward'===t.direction||void 0===e.value&&(e.value=n.defaultValue),n.innerType._zod.run(e,t))}),kt=X('$ZodNonOptional',(e,n)=>{An.init(e,n),se(e._zod,'values',()=>{const e=n.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(t,a)=>{const o=n.innerType._zod.run(t,a);return o instanceof Promise?o.then(n=>_t(n,e)):_t(o,e)}});function _t(e,n){return e.issues.length||void 0!==e.value||e.issues.push({code:'invalid_type',expected:'nonoptional',input:e.value,inst:n}),e}const Tt=X('$ZodCatch',(e,n)=>{An.init(e,n),se(e._zod,'optin',()=>n.innerType._zod.optin),se(e._zod,'optout',()=>n.innerType._zod.optout),se(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(a=>(e.value=a.value,a.issues.length&&(e.value=n.catchValue({...e,error:{issues:a.issues.map(e=>_e(e,t,ne()))},input:e.value}),e.issues=[]),e)):(e.value=a.value,a.issues.length&&(e.value=n.catchValue({...e,error:{issues:a.issues.map(e=>_e(e,t,ne()))},input:e.value}),e.issues=[]),e)}}),St=X('$ZodPipe',(e,n)=>{An.init(e,n),se(e._zod,'values',()=>n.in._zod.values),se(e._zod,'optin',()=>n.in._zod.optin),se(e._zod,'optout',()=>n.out._zod.optout),se(e._zod,'propValues',()=>n.in._zod.propValues),e._zod.parse=(e,t)=>{if('backward'===t.direction){const a=n.out._zod.run(e,t);return a instanceof Promise?a.then(e=>It(e,n.in,t)):It(a,n.in,t)}const a=n.in._zod.run(e,t);return a instanceof Promise?a.then(e=>It(e,n.out,t)):It(a,n.out,t)}});function It(e,n,t){return e.issues.length?(e.aborted=!0,e):n._zod.run({value:e.value,issues:e.issues},t)}const At=X('$ZodReadonly',(e,n)=>{An.init(e,n),se(e._zod,'propValues',()=>n.innerType._zod.propValues),se(e._zod,'values',()=>n.innerType._zod.values),se(e._zod,'optin',()=>n.innerType._zod.optin),se(e._zod,'optout',()=>n.innerType._zod.optout),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(zt):zt(a)}});function zt(e){return e.value=Object.freeze(e.value),e}const Ct=X('$ZodCustom',(e,n)=>{gn.init(e,n),An.init(e,n),e._zod.parse=(e,_)=>e,e._zod.check=t=>{const a=t.value,o=n.fn(a);if(o instanceof Promise)return o.then(n=>$t(n,t,a,e));$t(o,t,a,e)}});function $t(e,n,t,a){if(!e){const e={code:'custom',input:t,inst:a,path:[...a._zod.def.path??[]],continue:!a._zod.def.abort};a._zod.def.params&&(e.params=a._zod.def.params),n.issues.push(Se(e))}}class Et{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...n){const t=n[0];if(this._map.set(e,t),t&&'object'==typeof t&&'id'in t){if(this._idmap.has(t.id))throw new Error(`ID ${t.id} already exists in the registry`);this._idmap.set(t.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){const n=this._map.get(e);return n&&'object'==typeof n&&'id'in n&&this._idmap.delete(n.id),this._map.delete(e),this}get(e){const n=e._zod.parent;if(n){const t={...this.get(n)??{}};delete t.id;const a={...t,...this._map.get(e)};return Object.keys(a).length?a:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function Pt(){return new Et}const Mt=Pt();function Ot(e,n){return new e({type:'string',format:'guid',check:'string_format',abort:!1,...ye(n)})}function jt(e,n){return new fn({check:'max_length',...ye(n),maximum:e})}function Dt(e,n){return new mn({check:'min_length',...ye(n),minimum:e})}function Rt(e,n){return new xn({check:'length_equals',...ye(n),length:e})}function Nt(e){return new Tn({check:'overwrite',tx:e})}function Ht(e){const n=function(e,n){const t=new gn({check:'custom',...ye(n)});return t._zod.check=e,t}(t=>(t.addIssue=e=>{if('string'==typeof e)t.issues.push(Se(e,t.value,n._zod.def));else{const a=e;a.fatal&&(a.continue=!1),a.code??(a.code='custom'),a.input??(a.input=t.value),a.inst??(a.inst=n),a.continue??(a.continue=!n._zod.def.abort),t.issues.push(Se(a))}},e(t.value,t)));return n}const Lt=X('ZodISODateTime',(e,n)=>{Fn.init(e,n),pa.init(e,n)});function Ft(e){return function(e,n){return new e({type:'string',format:'datetime',check:'string_format',offset:!1,local:!1,precision:null,...ye(n)})}(Lt,e)}const Vt=X('ZodISODate',(e,n)=>{Vn.init(e,n),pa.init(e,n)});function Ut(e){return function(e,n){return new e({type:'string',format:'date',check:'string_format',...ye(n)})}(Vt,e)}const Jt=X('ZodISOTime',(e,n)=>{Un.init(e,n),pa.init(e,n)});function Bt(e){return function(e,n){return new e({type:'string',format:'time',check:'string_format',precision:null,...ye(n)})}(Jt,e)}const Wt=X('ZodISODuration',(e,n)=>{Jn.init(e,n),pa.init(e,n)});function Gt(e){return function(e,n){return new e({type:'string',format:'duration',check:'string_format',...ye(n)})}(Wt,e)}const Yt=X('ZodError',(e,n)=>{Ae.init(e,n),e.name='ZodError',Object.defineProperties(e,{format:{value:n=>function(e,n=e=>e.message){const t={_errors:[]},a=e=>{for(const o of e.issues)if('invalid_union'===o.code&&o.errors.length)o.errors.map(e=>a({issues:e}));else if('invalid_key'===o.code)a({issues:o.issues});else if('invalid_element'===o.code)a({issues:o.issues});else if(0===o.path.length)t._errors.push(n(o));else{let e=t,a=0;for(;a<o.path.length;){const t=o.path[a];a===o.path.length-1?(e[t]=e[t]||{_errors:[]},e[t]._errors.push(n(o))):e[t]=e[t]||{_errors:[]},e=e[t],a++}}};return a(e),t}(e,n)},flatten:{value:n=>function(e,n=e=>e.message){const t={},a=[];for(const o of e.issues)o.path.length>0?(t[o.path[0]]=t[o.path[0]]||[],t[o.path[0]].push(n(o))):a.push(n(o));return{formErrors:a,fieldErrors:t}}(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,te,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,te,2)}},isEmpty:{get:()=>0===e.issues.length}})},{Parent:Error}),Zt=Ce(Yt),qt=$e(Yt),Xt=Ee(Yt),Kt=Me(Yt),Qt=je(Yt),ea=De(Yt),na=Re(Yt),ta=Ne(Yt),aa=He(Yt),oa=Le(Yt),ra=Fe(Yt),ia=Ve(Yt),sa=X('ZodType',(e,n)=>(An.init(e,n),e.def=n,e.type=n.type,Object.defineProperty(e,'_def',{value:n}),e.check=(...t)=>e.clone(de(n,{checks:[...n.checks??[],...t.map(e=>'function'==typeof e?{_zod:{check:e,def:{check:'custom'},onattach:[]}}:e)]})),e.clone=(n,t)=>be(e,n,t),e.brand=()=>e,e.register=(n,t)=>(n.add(e,t),e),e.parse=(n,t)=>Zt(e,n,t,{callee:e.parse}),e.safeParse=(n,t)=>Xt(e,n,t),e.parseAsync=async(n,t)=>qt(e,n,t,{callee:e.parseAsync}),e.safeParseAsync=async(n,t)=>Kt(e,n,t),e.spa=e.safeParseAsync,e.encode=(n,t)=>Qt(e,n,t),e.decode=(n,t)=>ea(e,n,t),e.encodeAsync=async(n,t)=>na(e,n,t),e.decodeAsync=async(n,t)=>ta(e,n,t),e.safeEncode=(n,t)=>aa(e,n,t),e.safeDecode=(n,t)=>oa(e,n,t),e.safeEncodeAsync=async(n,t)=>ra(e,n,t),e.safeDecodeAsync=async(n,t)=>ia(e,n,t),e.refine=(n,t)=>e.check(function(e,n={}){return function(e,n,t){return new e({type:'custom',check:'custom',fn:n,...ye(t)})}(Qa,e,n)}(n,t)),e.superRefine=n=>e.check(Ht(n)),e.overwrite=n=>e.check(Nt(n)),e.optional=()=>Ua(e),e.nullable=()=>Ba(e),e.nullish=()=>Ua(Ba(e)),e.nonoptional=n=>function(e,n){return new Ya({type:'nonoptional',innerType:e,...ye(n)})}(e,n),e.array=()=>{return function(e,n,t){return new e({type:'array',element:n,...ye(t)})}(ja,e,n);var n},e.or=n=>{return new Na({type:'union',options:[e,n],...ye(t)});var t},e.and=n=>new Ha({type:'intersection',left:e,right:n}),e.transform=n=>Xa(e,new Fa({type:'transform',transform:n})),e.default=n=>{return t=n,new Wa({type:'default',innerType:e,get defaultValue(){return'function'==typeof t?t():me(t)}});var t},e.prefault=n=>{return t=n,new Ga({type:'prefault',innerType:e,get defaultValue(){return'function'==typeof t?t():me(t)}});var t},e.catch=n=>{return new Za({type:'catch',innerType:e,catchValue:'function'==typeof(t=n)?t:()=>t});var t},e.pipe=n=>Xa(e,n),e.readonly=()=>new Ka({type:'readonly',innerType:e}),e.describe=n=>{const t=e.clone();return Mt.add(t,{description:n}),t},Object.defineProperty(e,'description',{get:()=>Mt.get(e)?.description,configurable:!0}),e.meta=(...n)=>{if(0===n.length)return Mt.get(e);const t=e.clone();return Mt.add(t,n[0]),t},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),la=X('_ZodString',(e,n)=>{zn.init(e,n),sa.init(e,n);const t=e._zod.bag;e.format=t.format??null,e.minLength=t.minimum??null,e.maxLength=t.maximum??null,e.regex=(...n)=>e.check(function(e,n){return new bn({check:'string_format',format:'regex',...ye(n),pattern:e})}(...n)),e.includes=(...n)=>e.check(function(e,n){return new wn({check:'string_format',format:'includes',...ye(n),includes:e})}(...n)),e.startsWith=(...n)=>e.check(function(e,n){return new kn({check:'string_format',format:'starts_with',...ye(n),prefix:e})}(...n)),e.endsWith=(...n)=>e.check(function(e,n){return new _n({check:'string_format',format:'ends_with',...ye(n),suffix:e})}(...n)),e.min=(...n)=>e.check(Dt(...n)),e.max=(...n)=>e.check(jt(...n)),e.length=(...n)=>e.check(Rt(...n)),e.nonempty=(...n)=>e.check(Dt(1,...n)),e.lowercase=n=>e.check(function(e){return new yn({check:'string_format',format:'lowercase',...ye(e)})}(n)),e.uppercase=n=>e.check(function(e){return new vn({check:'string_format',format:'uppercase',...ye(e)})}(n)),e.trim=()=>e.check(Nt(e=>e.trim())),e.normalize=(...n)=>e.check(function(e){return Nt(n=>n.normalize(e))}(...n)),e.toLowerCase=()=>e.check(Nt(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(Nt(e=>e.toUpperCase()))}),da=X('ZodString',(e,n)=>{zn.init(e,n),la.init(e,n),e.email=n=>e.check(function(e,n){return new e({type:'string',format:'email',check:'string_format',abort:!1,...ye(n)})}(ua,n)),e.url=n=>e.check(function(e,n){return new e({type:'string',format:'url',check:'string_format',abort:!1,...ye(n)})}(ma,n)),e.jwt=n=>e.check(function(e,n){return new e({type:'string',format:'jwt',check:'string_format',abort:!1,...ye(n)})}($a,n)),e.emoji=n=>e.check(function(e,n){return new e({type:'string',format:'emoji',check:'string_format',abort:!1,...ye(n)})}(xa,n)),e.guid=n=>e.check(Ot(ga,n)),e.uuid=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,...ye(n)})}(fa,n)),e.uuidv4=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v4',...ye(n)})}(fa,n)),e.uuidv6=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v6',...ye(n)})}(fa,n)),e.uuidv7=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v7',...ye(n)})}(fa,n)),e.nanoid=n=>e.check(function(e,n){return new e({type:'string',format:'nanoid',check:'string_format',abort:!1,...ye(n)})}(ha,n)),e.guid=n=>e.check(Ot(ga,n)),e.cuid=n=>e.check(function(e,n){return new e({type:'string',format:'cuid',check:'string_format',abort:!1,...ye(n)})}(ba,n)),e.cuid2=n=>e.check(function(e,n){return new e({type:'string',format:'cuid2',check:'string_format',abort:!1,...ye(n)})}(ya,n)),e.ulid=n=>e.check(function(e,n){return new e({type:'string',format:'ulid',check:'string_format',abort:!1,...ye(n)})}(va,n)),e.base64=n=>e.check(function(e,n){return new e({type:'string',format:'base64',check:'string_format',abort:!1,...ye(n)})}(Aa,n)),e.base64url=n=>e.check(function(e,n){return new e({type:'string',format:'base64url',check:'string_format',abort:!1,...ye(n)})}(za,n)),e.xid=n=>e.check(function(e,n){return new e({type:'string',format:'xid',check:'string_format',abort:!1,...ye(n)})}(wa,n)),e.ksuid=n=>e.check(function(e,n){return new e({type:'string',format:'ksuid',check:'string_format',abort:!1,...ye(n)})}(ka,n)),e.ipv4=n=>e.check(function(e,n){return new e({type:'string',format:'ipv4',check:'string_format',abort:!1,...ye(n)})}(_a,n)),e.ipv6=n=>e.check(function(e,n){return new e({type:'string',format:'ipv6',check:'string_format',abort:!1,...ye(n)})}(Ta,n)),e.cidrv4=n=>e.check(function(e,n){return new e({type:'string',format:'cidrv4',check:'string_format',abort:!1,...ye(n)})}(Sa,n)),e.cidrv6=n=>e.check(function(e,n){return new e({type:'string',format:'cidrv6',check:'string_format',abort:!1,...ye(n)})}(Ia,n)),e.e164=n=>e.check(function(e,n){return new e({type:'string',format:'e164',check:'string_format',abort:!1,...ye(n)})}(Ca,n)),e.datetime=n=>e.check(Ft(n)),e.date=n=>e.check(Ut(n)),e.time=n=>e.check(Bt(n)),e.duration=n=>e.check(Gt(n))});function ca(e){return function(e,n){return new e({type:'string',...ye(n)})}(da,e)}const pa=X('ZodStringFormat',(e,n)=>{Cn.init(e,n),la.init(e,n)}),ua=X('ZodEmail',(e,n)=>{Pn.init(e,n),pa.init(e,n)}),ga=X('ZodGUID',(e,n)=>{$n.init(e,n),pa.init(e,n)}),fa=X('ZodUUID',(e,n)=>{En.init(e,n),pa.init(e,n)}),ma=X('ZodURL',(e,n)=>{Mn.init(e,n),pa.init(e,n)}),xa=X('ZodEmoji',(e,n)=>{On.init(e,n),pa.init(e,n)}),ha=X('ZodNanoID',(e,n)=>{jn.init(e,n),pa.init(e,n)}),ba=X('ZodCUID',(e,n)=>{Dn.init(e,n),pa.init(e,n)}),ya=X('ZodCUID2',(e,n)=>{Rn.init(e,n),pa.init(e,n)}),va=X('ZodULID',(e,n)=>{Nn.init(e,n),pa.init(e,n)}),wa=X('ZodXID',(e,n)=>{Hn.init(e,n),pa.init(e,n)}),ka=X('ZodKSUID',(e,n)=>{Ln.init(e,n),pa.init(e,n)}),_a=X('ZodIPv4',(e,n)=>{Bn.init(e,n),pa.init(e,n)}),Ta=X('ZodIPv6',(e,n)=>{Wn.init(e,n),pa.init(e,n)}),Sa=X('ZodCIDRv4',(e,n)=>{Gn.init(e,n),pa.init(e,n)}),Ia=X('ZodCIDRv6',(e,n)=>{Yn.init(e,n),pa.init(e,n)}),Aa=X('ZodBase64',(e,n)=>{qn.init(e,n),pa.init(e,n)}),za=X('ZodBase64URL',(e,n)=>{Xn.init(e,n),pa.init(e,n)}),Ca=X('ZodE164',(e,n)=>{Kn.init(e,n),pa.init(e,n)}),$a=X('ZodJWT',(e,n)=>{Qn.init(e,n),pa.init(e,n)}),Ea=X('ZodUnknown',(e,n)=>{et.init(e,n),sa.init(e,n)});function Pa(){return new Ea({type:'unknown'})}const Ma=X('ZodNever',(e,n)=>{nt.init(e,n),sa.init(e,n)});function Oa(e){return function(e,n){return new e({type:'never',...ye(n)})}(Ma,e)}const ja=X('ZodArray',(e,n)=>{at.init(e,n),sa.init(e,n),e.element=n.element,e.min=(n,t)=>e.check(Dt(n,t)),e.nonempty=n=>e.check(Dt(1,n)),e.max=(n,t)=>e.check(jt(n,t)),e.length=(n,t)=>e.check(Rt(n,t)),e.unwrap=()=>e.element});const Da=X('ZodObject',(e,n)=>{lt.init(e,n),sa.init(e,n),se(e,'shape',()=>n.shape),e.keyof=()=>function(e,n){const t=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new La({type:'enum',entries:t,...ye(n)})}(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:Pa()}),e.loose=()=>e.clone({...e._zod.def,catchall:Pa()}),e.strict=()=>e.clone({...e._zod.def,catchall:Oa()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>function(e,n){if(!fe(n))throw new Error('Invalid input to extend: expected a plain object');const t=e._zod.def.checks;if(t&&t.length>0)throw new Error('Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.');const a=de(e._zod.def,{get shape(){const t={...e._zod.def.shape,...n};return le(this,'shape',t),t},checks:[]});return be(e,a)}(e,n),e.safeExtend=n=>function(e,n){if(!fe(n))throw new Error('Invalid input to safeExtend: expected a plain object');const t={...e._zod.def,get shape(){const t={...e._zod.def.shape,...n};return le(this,'shape',t),t},checks:e._zod.def.checks};return be(e,t)}(e,n),e.merge=n=>function(e,n){const t=de(e._zod.def,{get shape(){const t={...e._zod.def.shape,...n._zod.def.shape};return le(this,'shape',t),t},get catchall(){return n._zod.def.catchall},checks:[]});return be(e,t)}(e,n),e.pick=n=>function(e,n){const t=e._zod.def;return be(e,de(e._zod.def,{get shape(){const e={};for(const a in n){if(!(a in t.shape))throw new Error(`Unrecognized key: "${a}"`);n[a]&&(e[a]=t.shape[a])}return le(this,'shape',e),e},checks:[]}))}(e,n),e.omit=n=>function(e,n){const t=e._zod.def,a=de(e._zod.def,{get shape(){const a={...e._zod.def.shape};for(const e in n){if(!(e in t.shape))throw new Error(`Unrecognized key: "${e}"`);n[e]&&delete a[e]}return le(this,'shape',a),a},checks:[]});return be(e,a)}(e,n),e.partial=(...n)=>function(e,n,t){const a=de(n._zod.def,{get shape(){const a=n._zod.def.shape,o={...a};if(t)for(const n in t){if(!(n in a))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(o[n]=e?new e({type:'optional',innerType:a[n]}):a[n])}else for(const n in a)o[n]=e?new e({type:'optional',innerType:a[n]}):a[n];return le(this,'shape',o),o},checks:[]});return be(n,a)}(Va,e,n[0]),e.required=(...n)=>function(e,n,t){const a=de(n._zod.def,{get shape(){const a=n._zod.def.shape,o={...a};if(t)for(const n in t){if(!(n in o))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(o[n]=new e({type:'nonoptional',innerType:a[n]}))}else for(const n in a)o[n]=new e({type:'nonoptional',innerType:a[n]});return le(this,'shape',o),o},checks:[]});return be(n,a)}(Ya,e,n[0])});function Ra(e,n){const t={type:'object',shape:e??{},...ye(n)};return new Da(t)}const Na=X('ZodUnion',(e,n)=>{ct.init(e,n),sa.init(e,n),e.options=n.options});const Ha=X('ZodIntersection',(e,n)=>{pt.init(e,n),sa.init(e,n)});const La=X('ZodEnum',(e,n)=>{ft.init(e,n),sa.init(e,n),e.enum=n.entries,e.options=Object.values(n.entries);const t=new Set(Object.keys(n.entries));e.extract=(e,a)=>{const o={};for(const r of e){if(!t.has(r))throw new Error(`Key ${r} not found in enum`);o[r]=n.entries[r]}return new La({...n,checks:[],...ye(a),entries:o})},e.exclude=(e,a)=>{const o={...n.entries};for(const n of e){if(!t.has(n))throw new Error(`Key ${n} not found in enum`);delete o[n]}return new La({...n,checks:[],...ye(a),entries:o})}});const Fa=X('ZodTransform',(e,n)=>{mt.init(e,n),sa.init(e,n),e._zod.parse=(t,a)=>{if('backward'===a.direction)throw new Q(e.constructor.name);t.addIssue=a=>{if('string'==typeof a)t.issues.push(Se(a,t.value,n));else{const n=a;n.fatal&&(n.continue=!1),n.code??(n.code='custom'),n.input??(n.input=t.value),n.inst??(n.inst=e),t.issues.push(Se(n))}};const o=n.transform(t.value,t);return o instanceof Promise?o.then(e=>(t.value=e,t)):(t.value=o,t)}});const Va=X('ZodOptional',(e,n)=>{ht.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType});function Ua(e){return new Va({type:'optional',innerType:e})}const Ja=X('ZodNullable',(e,n)=>{bt.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType});function Ba(e){return new Ja({type:'nullable',innerType:e})}const Wa=X('ZodDefault',(e,n)=>{yt.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});const Ga=X('ZodPrefault',(e,n)=>{wt.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Ya=X('ZodNonOptional',(e,n)=>{kt.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Za=X('ZodCatch',(e,n)=>{Tt.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});const qa=X('ZodPipe',(e,n)=>{St.init(e,n),sa.init(e,n),e.in=n.in,e.out=n.out});function Xa(e,n){return new qa({type:'pipe',in:e,out:n})}const Ka=X('ZodReadonly',(e,n)=>{At.init(e,n),sa.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Qa=X('ZodCustom',(e,n)=>{Ct.init(e,n),sa.init(e,n)});const eo=e({__name:'AIGenerateDialog',props:{show:{type:Boolean},title:{},description:{},placeholder:{},isGenerating:{type:Boolean},showInput:{type:Boolean},progress:{}},emits:['close','confirm'],setup(e,{expose:a,emit:o}){a();const r=e,i=o,s=n('');t(()=>r.show,e=>{e&&(s.value='')});const l={props:r,emit:i,localInput:s,handleConfirm:()=>{r.isGenerating||(r.showInput?i('confirm',s.value):i('confirm'))},handleClose:()=>{r.isGenerating||i('close')}};return Object.defineProperty(l,'__isScriptSetup',{enumerable:!1,value:!0}),l}}),no={style:{color:'#667eea',margin:'0 0 15px 0'}},to={style:{color:'#888',margin:'0 0 25px 0','line-height':'1.6'}},ao=['placeholder'],oo={key:1,style:{'margin-bottom':'25px'}},ro={key:0,style:{'margin-top':'20px',padding:'15px',background:'#1a1a1a','border-radius':'8px',border:'1px solid #444'}},io={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'10px'}},so={style:{color:'#667eea','font-size':'13px','font-weight':'600'}},lo={style:{color:'#e0e0e0','font-size':'14px','font-weight':'700'}},co={style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden','margin-bottom':'10px'}},po={style:{display:'flex','justify-content':'space-between','align-items':'center'}},uo={style:{color:'#888','font-size':'12px'}},go={key:0,style:{color:'#888','font-size':'12px'}},fo={style:{display:'flex',gap:'12px'}},mo=['disabled'],xo=['disabled'];const ho=a(eo,[['render',function(e,n,t,a,m,x){return t.show?(i(),o('div',{key:0,onClick:f(a.handleClose,['self']),style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'}},[s('div',{style:{background:'#2a2a2a',border:'2px solid #667eea','border-radius':'12px',padding:'30px','max-width':'500px',width:'100%','text-align':'center'},onClick:n[1]||(n[1]=f(()=>{},['stop']))},[s('h3',no,[n[2]||(n[2]=s('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(t.title||'AI 生成'),1)]),s('p',to,c(t.description||'AI 正在为你生成内容...'),1),t.showInput?l((i(),o('textarea',{key:0,'onUpdate:modelValue':n[0]||(n[0]=e=>a.localInput=e),placeholder:t.placeholder||'输入你的需求...',style:{width:'100%','min-height':'120px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical','box-sizing':'border-box'}},null,8,ao)),[[p,a.localInput]]):r('',!0),t.isGenerating?(i(),o('div',oo,[n[3]||(n[3]=u('<div style="position:relative;display:inline-block;width:80px;height:80px;" data-v-9c81d390><div style="position:absolute;width:100%;height:100%;border:3px solid rgba(102, 126, 234, 0.1);border-radius:50%;" data-v-9c81d390></div><div style="position:absolute;width:100%;height:100%;border:4px solid transparent;border-top-color:#667eea;border-right-color:#764ba2;border-radius:50%;animation:spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;" data-v-9c81d390></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:40%;height:40%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:50%;animation:pulse 1.5s ease-in-out infinite;" data-v-9c81d390></div></div><p style="color:#888;margin-top:20px;font-size:14px;font-weight:500;" data-v-9c81d390><span style="background:linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:gradient-shift 2s linear infinite;" data-v-9c81d390> 正在生成中，请稍候... </span></p><div style="display:flex;justify-content:center;gap:8px;margin-top:10px;" data-v-9c81d390><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0s infinite;" data-v-9c81d390></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0.2s infinite;" data-v-9c81d390></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0.4s infinite;" data-v-9c81d390></div></div>',3)),t.progress?(i(),o('div',ro,[s('div',io,[s('span',so,' 步骤 '+c(t.progress.step)+'/'+c(t.progress.total)+': '+c(t.progress.stepName),1),s('span',lo,c(t.progress.percentage)+'% ',1)]),s('div',co,[s('div',{style:g([{height:'100%',background:'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',transition:'width 0.4s ease','box-shadow':'0 0 10px rgba(102, 126, 234, 0.5)'},{width:t.progress.percentage+'%'}])},null,4)]),s('div',po,[s('span',uo,c(t.progress.message),1),t.progress.elapsedTime?(i(),o('span',go,' 已耗时: '+c(t.progress.elapsedTime)+'秒 ',1)):r('',!0)])])):r('',!0)])):r('',!0),s('div',fo,[t.isGenerating?r('',!0):(i(),o('button',{key:0,onClick:a.handleConfirm,disabled:t.showInput&&!a.localInput,style:g([{flex:'1',background:'#667eea',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:t.showInput&&!a.localInput?.5:1}])},[...n[4]||(n[4]=[s('i',{class:'fa-solid fa-check'},null,-1),d(' 确认生成 ',-1)])],12,mo)),s('button',{onClick:a.handleClose,disabled:t.isGenerating,style:g([{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:t.isGenerating?.5:1}])},c(t.isGenerating?'生成中...':'取消'),13,xo)])])])):r('',!0)}],['__scopeId','data-v-9c81d390'],['__file','AIGenerateDialog.vue']]),bo=e({__name:'AIModifyDialog',props:{show:{type:Boolean},title:{},description:{},examples:{},placeholder:{},isModifying:{type:Boolean},progress:{}},emits:['close','confirm'],setup(e,{expose:a,emit:o}){a();const r=e,i=o,s=n('');t(()=>r.show,e=>{e&&(s.value='')});const l={props:r,emit:i,localInstruction:s,handleConfirm:()=>{s.value&&!r.isModifying&&i('confirm',s.value)}};return Object.defineProperty(l,'__isScriptSetup',{enumerable:!1,value:!0}),l}}),yo={style:{color:'#ffc107',margin:'0 0 20px 0'}},vo={style:{color:'#888',margin:'0 0 15px 0','line-height':'1.6'}},wo={key:0,style:{color:'#888',margin:'0 0 20px 0','padding-left':'20px','line-height':'1.8'}},ko=['placeholder'],_o={key:1,style:{'margin-bottom':'20px',background:'#1a1a1a','border-radius':'8px',padding:'15px',border:'1px solid #444'}},To={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'8px'}},So={style:{color:'#ffc107','font-size':'13px','font-weight':'600'}},Io={style:{color:'#e0e0e0','font-size':'14px','font-weight':'700'}},Ao={style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden','margin-bottom':'8px'}},zo={style:{display:'flex','justify-content':'space-between','align-items':'center'}},Co={style:{color:'#888','font-size':'12px'}},$o={key:0,style:{color:'#888','font-size':'12px'}},Eo={style:{display:'flex',gap:'12px'}},Po=['disabled'],Mo=['disabled'];const Oo=a(bo,[['render',function(e,n,t,a,u,b){return t.show?(i(),o('div',{key:0,onClick:n[3]||(n[3]=f(n=>e.$emit('close'),['self'])),style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'}},[s('div',{style:{background:'#2a2a2a',border:'2px solid #ffc107','border-radius':'12px',padding:'30px','max-width':'600px',width:'100%','max-height':'80vh','overflow-y':'auto'},onClick:n[2]||(n[2]=f(()=>{},['stop']))},[s('h3',yo,[n[4]||(n[4]=s('i',{class:'fa-solid fa-edit'},null,-1)),d(' '+c(t.title||'AI 修改'),1)]),s('p',vo,c(t.description||'描述你想要修改的地方，AI 会在当前基础上进行调整。'),1),t.examples&&t.examples.length>0?(i(),o('ul',wo,[(i(!0),o(m,null,x(t.examples,(e,n)=>(i(),o('li',{key:n},c(e),1))),128))])):r('',!0),l(s('textarea',{'onUpdate:modelValue':n[0]||(n[0]=e=>a.localInstruction=e),placeholder:t.placeholder||'输入修改建议...',style:{width:'100%','min-height':'150px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical','box-sizing':'border-box'}},null,8,ko),[[p,a.localInstruction]]),t.isModifying?(i(),o('div',_o,[n[7]||(n[7]=s('div',{style:{display:'flex','align-items':'center',gap:'12px','margin-bottom':'10px'}},[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{color:'#ffc107','font-size':'18px',animation:'pulse 1.5s infinite'}}),s('span',{style:{color:'#ffc107','font-weight':'600','font-size':'14px'}},'AI 正在生成中...')],-1)),t.progress?(i(),o(m,{key:0},[s('div',To,[s('span',So,' 步骤 '+c(t.progress.step)+'/'+c(t.progress.total)+': '+c(t.progress.stepName),1),s('span',Io,c(t.progress.percentage)+'% ',1)]),s('div',Ao,[s('div',{style:g([{height:'100%',background:'linear-gradient(90deg, #ffc107 0%, #ffb300 100%)',transition:'width 0.4s ease','box-shadow':'0 0 10px rgba(255, 193, 7, 0.5)'},{width:t.progress.percentage+'%'}])},null,4)]),s('div',zo,[s('span',Co,c(t.progress.message),1),t.progress.elapsedTime?(i(),o('span',$o,' 已耗时: '+c(t.progress.elapsedTime)+'秒 ',1)):r('',!0)])],64)):(i(),o(m,{key:1},[n[5]||(n[5]=s('div',{style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden',position:'relative'}},[s('div',{class:'progress-bar'})],-1)),n[6]||(n[6]=s('p',{style:{color:'#888','font-size':'12px',margin:'8px 0 0 0','text-align':'center'}},'请稍候，这可能需要几秒钟',-1))],64))])):r('',!0),s('div',Eo,[s('button',{onClick:a.handleConfirm,disabled:!a.localInstruction||t.isModifying,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s',position:'relative',overflow:'hidden'},{opacity:!a.localInstruction||t.isModifying?.5:1}])},[s('i',{class:h(['fa-solid fa-wand-magic-sparkles',{'icon-spin':t.isModifying}])},null,2),d(' '+c(t.isModifying?'生成中...':'确认生成'),1)],12,Po),s('button',{onClick:n[1]||(n[1]=n=>e.$emit('close')),disabled:t.isModifying,style:g([{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:t.isModifying?.5:1}])},' 取消 ',12,Mo)])])])):r('',!0)}],['__scopeId','data-v-386271e6'],['__file','AIModifyDialog.vue']]),jo={class:'greetings-tab',style:{display:'flex','flex-direction':'column',height:'100%',background:'#1a1a1a !important'}},Do={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a'}},Ro={class:'header-actions',style:{display:'flex','align-items':'center',gap:'10px'}},No={key:0,class:'count-badge',style:{background:'#667eea',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},Ho={style:{flex:'1',display:'flex',gap:'20px',padding:'20px',overflow:'hidden'}},Lo={style:{flex:'1','overflow-y':'auto','padding-right':'10px'}},Fo={key:0,style:{display:'flex','flex-direction':'column','align-items':'center','justify-content':'center',padding:'60px 20px','text-align':'center',color:'#888'}},Vo={key:1,style:{background:'#2a2a2a',border:'1px solid #667eea','border-radius':'8px',padding:'20px','margin-bottom':'20px'}},Uo={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'15px'}},Jo={key:2,style:{display:'flex','flex-direction':'column',gap:'15px'}},Bo={style:{display:'flex','align-items':'center',gap:'10px','margin-bottom':'12px','padding-bottom':'10px','border-bottom':'1px solid #3a3a3a'}},Wo={style:{background:'#667eea',color:'white',padding:'4px 10px','border-radius':'6px','font-size':'12px','font-weight':'bold','min-width':'35px','text-align':'center'}},Go=['onUpdate:modelValue'],Yo=['onUpdate:modelValue','placeholder'],Zo=['onClick'],qo=['onClick'],Xo=['onUpdate:modelValue'],Ko=['onClick'],Qo={key:3,style:{position:'sticky',bottom:'0',padding:'20px',background:'linear-gradient(to top, #1a1a1a 80%, transparent)','border-top':'1px solid #3a3a3a',display:'flex','justify-content':'center',gap:'15px','margin-top':'20px'}},er={style:{flex:'1',display:'flex','flex-direction':'column',background:'#2a2a2a','border-radius':'16px',overflow:'hidden',border:'1px solid #3a3a3a','box-shadow':'0 4px 12px rgba(0, 0, 0, 0.3)'}},nr={style:{padding:'15px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},tr={style:{flex:'1',position:'relative',overflow:'hidden',background:'#1e1e1e'}},ar=['srcdoc'],or={key:1,style:{width:'100%',height:'100%',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px',padding:'20px','text-align':'center','line-height':'1.8'}},rr={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'16px'}},ir={style:{background:'#1a1a1a','border-radius':'8px',padding:'16px',color:'#e0e0e0','font-size':'14px','line-height':'1.6','overflow-y':'auto',flex:'1','white-space':'pre-wrap','word-wrap':'break-word'}},sr={style:{display:'flex','justify-content':'flex-end','margin-top':'16px'}},lr={style:{padding:'20px','overflow-y':'auto',flex:'1'}},dr={style:{background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px','max-height':'400px','overflow-y':'auto','margin-bottom':'15px'}},cr={style:{margin:'0','white-space':'pre-wrap','word-wrap':'break-word'}},pr={style:{color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.6'}};const ur=a(e({__name:'GreetingsTab',setup(e,{expose:t}){t();const a=Ra({icon:ca().default(''),title:ca().default(''),description:ca().default('')}),o=Ra({customHtml:ca().default('')}),r=b(),{settings:i}=y(r),s=v(),l=n([]),d=n(o.parse({})),c=n(!1),p=n(''),u=n('复制代码'),g=n(!1),f=n(!1),m=n(!1),x=n(!1),h=n(-1),C=n(!1),E=n(''),P=n(null),M=n(!1),O=n(''),j=n(!1),D=n(!1),R=n({step:0,total:4,stepName:'',percentage:0,message:'',startTime:0});let N=null;function H(e,n,t){R.value.step=e,R.value.stepName=n,R.value.message=t,R.value.percentage=Math.round(e/R.value.total*100),console.log(`📊 [进度 ${R.value.percentage}%] ${n}: ${t}`)}function L(){N&&clearInterval(N),R.value.startTime=Date.now(),N=setInterval(()=>{Math.round((Date.now()-R.value.startTime)/1e3),R.value={...R.value}},1e3)}function F(){N&&(clearInterval(N),N=null)}const V=w(()=>{const e=Math.round((Date.now()-R.value.startTime)/1e3);return{...R.value,elapsedTime:e}});function U(){try{if(void 0!==window.TavernHelper){const e=window.TavernHelper.getCharData('current');if(e)return console.log('找到角色卡 (TavernHelper):',e.name),e}if('undefined'!=typeof SillyTavern){const e=SillyTavern.getContext?.()?.characters?.[0];if(e)return console.log('找到角色卡 (SillyTavern):',e.name),e}return console.log('未找到角色卡'),null}catch(e){return console.error('获取角色卡失败:',e),null}}async function J(){try{const t=U();if(!t)return l.value=[],void console.log('未找到角色卡');console.log('当前角色卡:',t.name);const r=[t.first_mes,...t.data?.alternate_greetings||[]];console.log('找到',r.length,'个开场白');const i=`${T()}_greetings_${t.avatar}`;let s=[],c=null;const p=localStorage.getItem(i);if(p)try{const e=JSON.parse(p);s=e?.greetings_config||[],c=e?.ui_config,console.log('✅ 从 localStorage 加载开场白配置')}catch(e){console.error('解析开场白配置失败:',e)}l.value=r.map((_,e)=>{const n=s[e];try{return a.parse(n||{})}catch(t){return console.warn('解析开场白配置失败，使用默认值:',t),a.parse({})}});try{const e=c||{};d.value=o.parse(e)}catch(n){console.warn('解析UI配置失败，使用默认值:',n),d.value=o.parse({})}console.log('开场白配置已加载:',l.value.length,'个'),console.log('UI配置已加载, 自定义HTML长度:',d.value.customHtml.length),P.value=t,G()}catch(n){console.error('加载配置失败:',n),q.error('加载配置失败: '+n.message)}}function B(){try{const e=U();if(!e)return void console.warn('无法保存：未找到角色卡');const n=`${T()}_greetings_${e.avatar}`,t={greetings_config:S(l.value),ui_config:S(d.value)};localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 已保存开场白配置到 localStorage'),G()}catch(e){console.error('保存配置失败:',e)}}async function W(){if(U())return d.value.customHtml&&d.value.customHtml.trim()?(p.value=d.value.customHtml,void(c.value=!0)):void q.warning('请先使用"AI生成界面样式"功能生成自定义HTML');q.warning('未找到角色卡')}function G(){if(0!==l.value.length)if(d.value.customHtml&&d.value.customHtml.trim()){console.log('🎨 使用AI生成的自定义HTML预览');try{const e=l.value.map((e,n)=>{const t=e.icon||'💬',a=e.title||(0===n?'默认开场白':`开场白 ${n}`),o=e.description||'点击开始对话';return`\n            <div class="scene-card" onclick="switchGreeting(${n})">\n              <span class="card-badge">${0===n?'默认':String(n).padStart(2,'0')}</span>\n              <div class="card-icon">${t}</div>\n              <h3 class="card-title">${a}</h3>\n              <p class="card-desc">${o}</p>\n            </div>\n          `.trim()}).join('\n          ');let n=d.value.customHtml;n=n.replace(/<div class="scenes-grid">[\s\S]*?<\/div>/,`<div class="scenes-grid">\n          ${e}\n        </div>`),E.value=n,console.log('✅ 预览更新成功')}catch(e){console.error('❌ 预览更新失败:',e),E.value=''}}else E.value='';else E.value=''}k(()=>{J()});const Y={GreetingConfig:a,UIConfig:o,settingsStore:r,settings:i,taskStore:s,greetings:l,uiConfig:d,showCodeDialog:c,generatedCode:p,copyButtonText:u,showAiGenerateDialog:g,showAiEditDialog:f,isGeneratingAi:m,isEditingAi:x,currentEditingIndex:h,showHelp:C,previewHtml:E,currentCharacter:P,showOriginalDialog:M,originalGreetingContent:O,showAiStyleDialog:j,isGeneratingStyle:D,aiProgress:R,get elapsedTimer(){return N},set elapsedTimer(e){N=e},updateProgress:H,startElapsedTimer:L,stopElapsedTimer:F,progressWithElapsedTime:V,getCurrentCharacter:U,loadConfig:J,saveConfig:B,clearAllConfig:function(){if(confirm(`确定要清空所有开场白的配置吗？\n\n当前共有 ${l.value.length} 个开场白，清空后所有图标、标题、描述都将恢复默认。\n\n⚠️ 此操作不会删除角色卡的开场白原文，只清空显示配置！`))try{l.value=l.value.map(()=>a.parse({icon:'',title:'',description:''})),d.value.customHtml='',B(),G(),q.success('已清空所有开场白配置，预览已恢复默认样式')}catch(e){console.error('清空配置失败:',e),q.error('清空失败: '+e.message)}},viewOriginalGreeting:function(e){try{const n=U();if(!n)return void q.error('未找到角色卡');const t=[n.first_mes,...n.data?.alternate_greetings||[]][e]||'';if(!t.trim())return void q.warning('该开场白内容为空');O.value=t,M.value=!0}catch(n){console.error('查看开场白失败:',n),q.error('查看开场白失败: '+n.message)}},closeAiGenerateDialog:function(){m.value||(g.value=!1)},generateDescription:async function(e){h.value=e;const n=s.createTask('ui_generate',`生成开场白#${e}描述`);R.value.startTime=Date.now(),R.value.total=4,H(0,'准备中','正在初始化 AI 生成任务...'),L(),g.value=!0,m.value=!0;const t=e;if(t<0||t>=l.value.length)return m.value=!1,g.value=!1,void s.failTask(n,'无效的开场白索引');try{if(H(1,'检查配置','正在验证 API 配置和权限...'),s.updateTaskProgress(n,10,'检查配置'),!i.value.api_endpoint||!i.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),g.value=!1,m.value=!1,void s.failTask(n,'API 未配置');H(2,'读取数据',`正在读取开场白 #${t} 的内容...`),s.updateTaskProgress(n,30,'读取开场白内容');const e=U();if(!e)return q.error('未找到角色卡'),g.value=!1,m.value=!1,void s.failTask(n,'未找到角色卡');const a=[e.first_mes,...e.data?.alternate_greetings||[]][t]||'';if(!a.trim())return q.warning('该开场白内容为空'),g.value=!1,m.value=!1,void s.failTask(n,'开场白内容为空');H(3,'调用 AI',`正在请求 ${i.value.model} 生成描述...`),s.updateTaskProgress(n,50,`调用 AI (${i.value.model})`);const o='你是一个专业的文案编辑助手，擅长为小说、游戏等创作简洁吸引人的开场白描述。\n\n要求：\n1. 描述要简洁有力，控制在 20-50 字以内\n2. 突出开场白的核心场景、情感或冲突点\n3. 使用吸引人的语言，让读者产生阅读兴趣\n4. 不要使用"这是一个..."、"在这个开场白中..."等冗余表述\n5. 直接输出描述文本，不要添加引号或其他标记',r=`请为以下开场白内容生成一个简洁吸引人的描述：\n\n${a}\n\n直接输出描述文本：`;console.log('🚀 直接调用 AI API (插件环境)...');const{filterApiParams:d}=await I(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),c=d({model:i.value.model,messages:[{role:'system',content:o},{role:'user',content:r}],temperature:i.value.temperature,max_tokens:i.value.max_tokens,top_p:i.value.top_p,presence_penalty:i.value.presence_penalty,frequency_penalty:i.value.frequency_penalty},i.value.api_endpoint),p=await fetch(i.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${i.value.api_key}`},body:JSON.stringify(c)});if(!p.ok)throw new Error(`API 调用失败: ${p.status} ${p.statusText}`);const u=await p.json();let f=u.choices?.[0]?.message?.content;if(console.log('📝 [生成] AI 原始返回:',f),!f||!f.trim())throw new Error('AI 未返回有效内容，请检查：\n1. API Key 是否有效\n2. 模型是否可用\n3. 账户余额');if(H(4,'处理结果','正在清理和应用生成的描述...'),s.updateTaskProgress(n,80,'处理结果'),f=f.replace(/^["']|["']$/g,''),f=f.replace(/^```.*?\n?|```$/g,'').trim(),!f)throw new Error('AI 返回内容清理后为空');console.log('✨ [生成] AI 清理后的描述:',f),l.value[t].description=f,B();const x=((Date.now()-R.value.startTime)/1e3).toFixed(1);q.success(`描述生成成功！耗时 ${x} 秒`,'',{timeOut:3e3}),s.completeTask(n,{description:f}),setTimeout(()=>{g.value=!1},500)}catch(a){console.error('❌ [生成] AI 生成失败:',a);const e='生成失败: '+a.message;q.error(e),s.failTask(n,e),setTimeout(()=>{},5e3)}finally{F(),m.value=!1}},editDescription:function(e){h.value=e,f.value=!0},confirmEditDescription:async function(e){const n=h.value;if(n<0||n>=l.value.length)return;const t=s.createTask('ui_modify',`编辑开场白#${n}描述`);R.value.startTime=Date.now(),R.value.total=4,H(0,'准备中','正在初始化 AI 编辑任务...'),L(),x.value=!0;try{if(H(1,'检查配置','正在验证 API 配置和权限...'),s.updateTaskProgress(t,10,'检查配置'),!i.value.api_endpoint||!i.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),f.value=!1,x.value=!1,F(),void s.failTask(t,'API 未配置');H(2,'读取数据','正在读取当前描述内容...'),s.updateTaskProgress(t,30,'读取当前描述');const a=l.value[n].description;if(!a.trim())return q.warning('当前描述为空，请先使用 AI 生成'),f.value=!1,x.value=!1,F(),void s.failTask(t,'当前描述为空');H(3,'调用 AI',`正在请求 ${i.value.model} 编辑描述...`),s.updateTaskProgress(t,50,`调用 AI (${i.value.model})`);const o='你是一个专业的文案编辑助手，擅长根据用户需求修改文案。\n\n要求：\n1. 根据用户的修改需求调整描述\n2. 保持描述简洁有力，控制在 20-50 字以内\n3. 保留原描述的核心信息，只进行必要的调整\n4. 直接输出修改后的描述文本，不要添加引号或其他标记',r=`当前描述：\n${a}\n\n修改需求：\n${e}\n\n请输出修改后的描述：`;console.log('🚀 直接调用 AI API (插件环境)...');const{filterApiParams:d}=await I(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),c=d({model:i.value.model,messages:[{role:'system',content:o},{role:'user',content:r}],temperature:i.value.temperature,max_tokens:i.value.max_tokens,top_p:i.value.top_p,presence_penalty:i.value.presence_penalty,frequency_penalty:i.value.frequency_penalty},i.value.api_endpoint),p=await fetch(i.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${i.value.api_key}`},body:JSON.stringify(c)});if(!p.ok)throw new Error(`API 调用失败: ${p.status} ${p.statusText}`);const u=await p.json();let g=u.choices?.[0]?.message?.content;if(console.log('📝 [编辑] AI 原始返回:',g),!g||!g.trim())throw new Error('AI 未返回有效内容，请检查：\n1. API Key 是否有效\n2. 模型是否可用\n3. 账户余额');if(H(4,'处理结果','正在清理和应用编辑后的描述...'),s.updateTaskProgress(t,80,'处理结果'),g=g.replace(/^["']|["']$/g,''),g=g.replace(/^```.*?\n?|```$/g,'').trim(),!g)throw new Error('AI 返回内容清理后为空');console.log('✨ [编辑] AI 清理后的描述:',g),l.value[n].description=g,B();const m=((Date.now()-R.value.startTime)/1e3).toFixed(1);q.success(`描述修改成功！耗时 ${m} 秒`,'',{timeOut:3e3}),s.completeTask(t,{description:g}),setTimeout(()=>{f.value=!1},500)}catch(a){console.error('❌ [编辑] AI 编辑失败:',a);const e='编辑失败: '+a.message;q.error(e),s.failTask(t,e)}finally{F(),x.value=!1}},generateStyleWithAI:async function(e){if(!e.trim())return void q.warning('请输入界面风格描述');const n=s.createTask('ui_generate','生成开场白界面样式');if(R.value.startTime=Date.now(),R.value.total=5,H(0,'准备中','正在初始化界面样式生成任务...'),L(),!i.value.api_endpoint||!i.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),j.value=!1,F(),void s.failTask(n,'API 未配置');D.value=!0;try{H(1,'准备数据','正在收集开场白卡片信息...'),s.updateTaskProgress(n,10,'准备数据');const t=l.value.map((e,n)=>{const t=e.icon||'💬',a=e.title||(0===n?'默认开场白':`开场白 ${n}`),o=e.description||'点击开始对话';return'      <div class="scene-card" onclick="switchGreeting('+n+')"><div class="card-badge">'+(0===n?'默认':String(n).padStart(2,'0'))+'</div><div class="card-icon">'+t+'</div><div class="card-title">'+a+'</div><div class="card-desc">'+o+'</div></div>'}).join('\n'),a='你是一个专业的前端开发专家，擅长创建美观的HTML/CSS界面。\n\n任务：根据用户的风格描述，生成一个完整的HTML页面代码，用于展示开场白选择界面。\n\n要求：\n1. 包含完整的 HTML 结构（<html>、<head>、<body>）\n2. 在 <head> 中包含 Font Awesome 图标库：<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">\n3. 所有样式写在 <style> 标签内，不要使用外部 CSS 文件\n4. 必须包含以下HTML结构（保持类名不变）：\n   - body（页面背景）\n   - .container（主容器）\n   - .header（标题区域）\n     - h1（主标题）\n     - p（副标题）\n   - .scene-grid（卡片网格容器）\n   - .scene-card（单个卡片，需要 onclick 属性）\n   - .card-badge（序号徽章）\n   - .card-icon（图标）\n   - .card-title（卡片标题）\n   - .card-desc（卡片描述）\n   - .loading（加载提示）\n5. 必须包含 switchGreeting(id) 函数的完整 JavaScript 代码\n6. 根据用户的风格描述设计颜色、字体、布局、动画等样式\n7. 确保响应式设计，在不同屏幕尺寸下都好看\n8. 直接输出完整的HTML代码，不要添加任何解释文字或markdown标记\n\n【重要】样式要求：\n- body 必须使用 "min-height: 100vh; height: auto;" 而不是固定高度\n- body 必须使用 "display: flex; align-items: center; justify-content: center;" 来居中内容\n- .container 不要设置固定高度，使用 "height: auto;" 让内容自适应\n- .scene-card 卡片必须使用 "min-height" 而不是固定 "height"，让卡片自适应内容\n- .card-desc 描述文字要完整显示，可以使用 line-clamp 限制行数但要显示省略号\n- 不要在卡片上使用 "overflow: hidden" 除非配合 line-clamp 使用\n- 确保所有内容都能完整显示，不会被截断\n\n【重要】HTML结构必须严格遵守：\n- 必须有一个 class="scene-grid" 的div作为卡片容器\n- 所有卡片必须在 scene-grid 容器内\n- 不要改变scene-grid这个类名，不要用grid-container、cards-grid等其他名字',o=`风格描述：${e}\n\n以下是需要展示的开场白卡片（每个卡片需要有 onclick="switchGreeting(序号)" 属性）：\n${t}\n\n【重要】必须在 </body> 前添加以下 JavaScript 代码：\n<script>\n${'async function switchGreeting(id) {\n      try {\n        const loading = document.getElementById("loading");\n        const mainContainer = document.getElementById("mainContainer");\n        if (loading) loading.classList.add("active");\n        if (mainContainer) mainContainer.style.display = "none";\n\n        if (typeof window.getChatMessages !== "function") {\n          alert("请在酒馆环境中使用此功能");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        // 使用 TavernHelper 获取消息\n        let messages;\n        if (typeof (window as any).TavernHelper !== \'undefined\' && \n            typeof (window as any).TavernHelper.getChatMessages === \'function\') {\n          messages = (window as any).TavernHelper.getChatMessages(\'0\');\n        } else {\n          alert("TavernHelper 不可用");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n        \n        if (!messages || messages.length === 0) {\n          alert("未找到消息");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        const content = messages[0].swipes[id];\n        if (!content) {\n          alert("该开场白暂无内容");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        await window.setChatMessage(content, 0, { swipe_id: id, refresh: "display_and_render_current" });\n\n        setTimeout(() => {\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n        }, 500);\n      } catch (err) {\n        console.error("切换失败:", err);\n        alert("切换失败: " + err.message);\n        const loading = document.getElementById("loading");\n        const mainContainer = document.getElementById("mainContainer");\n        if (loading) loading.classList.remove("active");\n        if (mainContainer) mainContainer.style.display = "block";\n      }\n    }'}\n<\/script>\n\n【重要】每个 .scene-card 必须添加 onclick="switchGreeting(序号)" 属性，例如：\n<div class="scene-card" onclick="switchGreeting(0)">\n\n【重要】必须包含一个 loading 提示元素：\n<div class="loading" id="loading" style="display: none; text-align: center; padding: 40px;">\n  <p style="color: #888; font-size: 18px;">切换中...</p>\n</div>\n\n请生成完整的HTML代码，确保包含以上所有要求：`;H(2,'构建提示','正在准备 AI 提示词和示例代码...'),s.updateTaskProgress(n,30,'构建提示'),console.log('🚀 直接调用 AI API (插件环境)...'),H(3,'调用 AI',`正在请求 ${i.value.model} 生成界面样式...`),s.updateTaskProgress(n,50,`调用 AI (${i.value.model})`);const{filterApiParams:r}=await I(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),c=r({model:i.value.model,messages:[{role:'system',content:a},{role:'user',content:o}],temperature:i.value.temperature,max_tokens:i.value.max_tokens,top_p:i.value.top_p,presence_penalty:i.value.presence_penalty,frequency_penalty:i.value.frequency_penalty},i.value.api_endpoint),p=await fetch(i.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${i.value.api_key}`},body:JSON.stringify(c)});if(!p.ok)throw new Error(`API 调用失败: ${p.status} ${p.statusText}`);const u=await p.json();let g=u.choices?.[0]?.message?.content;if(console.log('📝 [样式生成] AI 原始返回:',g?g.substring(0,500):'(空)'),!g||!g.trim())throw new Error('AI 未返回有效内容，请检查 API 配置和模型是否支持该任务');if(H(4,'处理结果','正在清理和验证生成的代码...'),s.updateTaskProgress(n,75,'处理结果'),g=g.replace(/^```html\n?|^```\n?|```$/gm,'').trim(),!g)throw new Error('AI 返回内容清理后为空');console.log('✨ [样式生成] AI 清理后的HTML长度:',g.length),H(5,'保存配置','正在保存生成的界面样式...'),s.updateTaskProgress(n,90,'保存配置'),d.value.customHtml=g,B(),G();const f=((Date.now()-R.value.startTime)/1e3).toFixed(1);q.success(`界面样式生成成功！耗时 ${f} 秒`,'',{timeOut:3e3}),s.completeTask(n,{htmlLength:g.length}),setTimeout(()=>{j.value=!1},500)}catch(t){console.error('❌ [样式生成] AI 生成失败:',t),q.error('生成失败: '+t.message,'',{timeOut:5e3}),s.failTask(n,t.message)}finally{F(),D.value=!1}},generateFrontendCode:W,copyCode:async function(){await A(p.value,'✅ 代码已复制到剪贴板')&&(u.value='✓ 已复制',setTimeout(()=>{u.value='复制代码'},2e3))},updatePreview:G,closeCodeDialog:function(){c.value=!1},openPreviewInNewWindow:function(){if(!E.value)return void q.error('没有可预览的内容');const e=U(),n=e?`${e.name} - 开场白选择`:'开场白预览',t=window.open('','_blank','width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');t?(t.document.write(E.value),t.document.close(),t.document.title=n,q.success('已在新窗口打开预览')):q.error('无法打开新窗口，请检查浏览器弹窗设置')},downloadAsJson:async function(){try{if(await W(),!p.value)return void q.error('请先生成代码');const e=U(),n=e?.name||'角色',t={id:crypto.randomUUID(),scriptName:`${n}-开场白前端`,disabled:!1,runOnEdit:!0,findRegex:'/【开场白】/g',replaceString:'```html\n'+p.value+'\n```',trimStrings:[],placement:[1,2],substituteRegex:0,minDepth:null,maxDepth:null,markdownOnly:!0,promptOnly:!1},a=JSON.stringify(t,null,4),o=new Blob([a],{type:'application/json'}),r=URL.createObjectURL(o),i=document.createElement('a');i.href=r,i.download=`${n}-开场白前端.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),q.success('已生成并下载JSON文件')}catch(e){console.error('下载失败:',e),q.error('下载失败: '+e.message)}},AIGenerateDialog:ho,AIModifyDialog:Oo};return Object.defineProperty(Y,'__isScriptSetup',{enumerable:!1,value:!0}),Y}}),[['render',function(e,n,t,a,h,b){return i(),o('div',jo,[s('div',Do,[n[32]||(n[32]=s('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-comments',style:{color:'#667eea'}}),d(' 开场白管理器 ')],-1)),s('div',Ro,[a.greetings.length>0?(i(),o('span',No,c(a.greetings.length)+' 个开场白 ',1)):r('',!0),a.greetings.length>0?(i(),o('button',{key:1,class:'mini-button',style:g([{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},{color:a.showHelp?'#667eea':'#e0e0e0',borderColor:a.showHelp?'#667eea':'#3a3a3a'}]),onClick:n[0]||(n[0]=e=>a.showHelp=!a.showHelp)},[n[28]||(n[28]=s('i',{class:'fa-solid fa-circle-question'},null,-1)),d(' '+c(a.showHelp?'隐藏帮助':'显示帮助'),1)],4)):r('',!0),a.greetings.length>0?(i(),o('button',{key:2,class:'mini-button',style:{padding:'6px 12px',background:'#dc2626',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:a.clearAllConfig,onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[29]||(n[29]=[s('i',{class:'fa-solid fa-eraser'},null,-1),d(' 清空配置 ',-1)])],32)):r('',!0),a.greetings.length>0?(i(),o('button',{key:3,class:'mini-button',style:{padding:'6px 12px',background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:n[3]||(n[3]=e=>a.showAiStyleDialog=!0),onMouseenter:n[4]||(n[4]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[5]||(n[5]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[30]||(n[30]=[s('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1),d(' AI生成界面样式 ',-1)])],32)):r('',!0),s('button',{class:'mini-button refresh-button',style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:a.loadConfig},[...n[31]||(n[31]=[s('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新 ',-1)])])])]),s('div',Ho,[s('div',Lo,[0===a.greetings.length?(i(),o('div',Fo,[...n[33]||(n[33]=[s('i',{class:'fa-solid fa-comment-dots',style:{'font-size':'64px','margin-bottom':'20px',opacity:'0.3'}},null,-1),s('div',{style:{'font-size':'18px','font-weight':'600',color:'#e0e0e0','margin-bottom':'10px'}},'暂无开场白',-1),s('div',{style:{'font-size':'14px',color:'#888','max-width':'400px','line-height':'1.6'}},' 请在酒馆中选择一个有开场白的角色卡，或点击上方的刷新按钮 ',-1)])])):a.showHelp?(i(),o('div',Vo,[s('div',Uo,[n[35]||(n[35]=s('h4',{style:{color:'#667eea',margin:'0',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-circle-info'}),d(' 使用说明 ')],-1)),s('button',{style:{background:'transparent',border:'none',color:'#888',cursor:'pointer','font-size':'18px',padding:'4px'},onClick:n[6]||(n[6]=e=>a.showHelp=!1)},[...n[34]||(n[34]=[s('i',{class:'fa-solid fa-times'},null,-1)])])]),n[36]||(n[36]=u('<ol style="color:#ccc;margin:0;padding-left:20px;line-height:1.8;" data-v-5041ebab><li data-v-5041ebab>工具会自动读取当前角色卡的所有开场白</li><li data-v-5041ebab>为每个开场白设置图标、标题和描述</li><li data-v-5041ebab>使用AI生成描述功能，根据开场白内容自动生成吸引人的描述</li><li data-v-5041ebab>点击&quot;AI生成界面样式&quot;按钮，描述你想要的风格（如：深蓝色背景、金色标题）</li><li data-v-5041ebab>AI会根据你的描述生成完整的HTML样式代码</li><li data-v-5041ebab>右侧实时预览生成的界面样式效果</li><li data-v-5041ebab>点击&quot;生成前端选择界面代码&quot;查看完整代码</li><li data-v-5041ebab>点击&quot;下载为STScript JSON&quot;导出配置文件</li><li data-v-5041ebab>在酒馆中导入JSON文件，输入 /【开场白】 使用</li></ol><div style="margin-top:15px;padding-top:15px;border-top:1px solid #3a3a3a;" data-v-5041ebab><p style="color:#888;font-size:13px;margin:0;" data-v-5041ebab><i class="fa-solid fa-lightbulb" style="color:#ffc107;" data-v-5041ebab></i><strong data-v-5041ebab>提示：</strong>生成的序号对应角色卡中的开场白序号（0为默认开场白） </p></div>',2))])):(i(),o('div',Jo,[(i(!0),o(m,null,x(a.greetings,(e,t)=>(i(),o('div',{key:t,class:'greeting-item',style:{background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[s('div',Bo,[s('span',Wo,' #'+c(t),1),l(s('input',{'onUpdate:modelValue':n=>e.icon=n,style:{width:'60px','text-align':'center','font-size':'20px',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'6px',color:'#e0e0e0'},placeholder:'图标',maxlength:'4',onInput:a.saveConfig},null,40,Go),[[p,e.icon]]),l(s('input',{'onUpdate:modelValue':n=>e.title=n,style:{flex:'1',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'8px 12px',color:'#e0e0e0','font-size':'14px'},placeholder:0===t?'默认开场白':'开场白 '+t,onInput:a.saveConfig},null,40,Yo),[[p,e.title]]),s('button',{style:{background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none',color:'white',padding:'8px 16px','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center',gap:'6px','font-size':'13px','font-weight':'600','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.3)'},title:'根据开场白内容自动生成描述',onClick:e=>a.generateDescription(t),onMouseenter:n[7]||(n[7]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.5)'}),onMouseleave:n[8]||(n[8]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.3)'})},[...n[37]||(n[37]=[s('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1),s('span',null,'AI 生成描述',-1)])],40,Zo),e.description?(i(),o('button',{key:0,style:{background:'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',border:'none',color:'white',padding:'8px 16px','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center',gap:'6px','font-size':'13px','font-weight':'600','box-shadow':'0 2px 8px rgba(59, 130, 246, 0.3)'},title:'根据需求修改已有描述',onClick:e=>a.editDescription(t),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.5)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'})},[...n[38]||(n[38]=[s('i',{class:'fa-solid fa-edit'},null,-1),s('span',null,'AI 编辑描述',-1)])],40,qo)):r('',!0)]),l(s('textarea',{'onUpdate:modelValue':n=>e.description=n,style:{width:'100%',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'10px',color:'#e0e0e0','font-size':'13px','font-family':'inherit',resize:'vertical','min-height':'60px'},placeholder:'输入简短描述...',onInput:a.saveConfig},'            ',40,Xo),[[p,e.description]]),s('button',{style:{width:'100%',padding:'10px',background:'transparent',border:'1px solid #667eea','border-radius':'6px',color:'#667eea','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center','justify-content':'center',gap:'6px','margin-top':'10px'},onClick:e=>a.viewOriginalGreeting(t),onMouseenter:n[11]||(n[11]=e=>e.currentTarget.style.background='rgba(102, 126, 234, 0.1)'),onMouseleave:n[12]||(n[12]=e=>e.currentTarget.style.background='transparent')},[...n[39]||(n[39]=[s('i',{class:'fa-solid fa-file-lines'},null,-1),s('span',null,'查看角色卡中的开场白原文',-1)])],40,Ko)]))),128))])),a.greetings.length>0?(i(),o('div',Qo,[s('button',{style:{padding:'15px 35px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'10px',color:'white','font-size':'15px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'10px','box-shadow':'0 4px 15px rgba(102, 126, 234, 0.4)'},onClick:a.generateFrontendCode,onMouseenter:n[13]||(n[13]=e=>{e.currentTarget.style.transform='translateY(-3px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'}),onMouseleave:n[14]||(n[14]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'})},[...n[40]||(n[40]=[s('i',{class:'fa-solid fa-code',style:{'font-size':'16px'}},null,-1),d(' 生成HTML代码 ',-1)])],32),s('button',{style:{padding:'15px 35px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'10px',color:'white','font-size':'15px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'10px','box-shadow':'0 4px 15px rgba(16, 185, 129, 0.4)'},onClick:a.downloadAsJson,onMouseenter:n[15]||(n[15]=e=>{e.currentTarget.style.transform='translateY(-3px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.6)'}),onMouseleave:n[16]||(n[16]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.4)'})},[...n[41]||(n[41]=[s('i',{class:'fa-solid fa-download',style:{'font-size':'16px'}},null,-1),d(' 下载为STScript JSON ',-1)])],32)])):r('',!0)]),s('div',er,[s('div',nr,[n[43]||(n[43]=s('h4',{style:{margin:'0',color:'white','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-eye'}),d(' 实时预览 ')],-1)),a.previewHtml?(i(),o('button',{key:0,title:'新窗口打开',style:{width:'32px',height:'32px',background:'rgba(255, 255, 255, 0.2)',border:'none','border-radius':'6px',color:'white','font-size':'14px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center'},onClick:a.openPreviewInNewWindow},[...n[42]||(n[42]=[s('i',{class:'fa-solid fa-external-link-alt'},null,-1)])])):r('',!0)]),s('div',tr,[a.previewHtml?(i(),o('iframe',{key:0,srcdoc:a.previewHtml,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,ar)):(i(),o('div',or,[...n[44]||(n[44]=[s('div',null,[s('i',{class:'fa-solid fa-eye-slash',style:{'font-size':'48px','margin-bottom':'15px',opacity:'0.3'}}),s('p',{style:{margin:'0'}},'配置开场白后将显示预览')],-1)])]))])])]),C(a.AIGenerateDialog,{show:a.showAiGenerateDialog,'is-generating':a.isGeneratingAi,title:'AI 生成简短描述',description:'AI 正在根据开场白的实际内容自动生成吸引人的简短描述（20-50字）...','show-input':!1,progress:a.isGeneratingAi?a.progressWithElapsedTime:void 0,onClose:a.closeAiGenerateDialog,onConfirm:()=>{}},null,8,['show','is-generating','progress']),C(a.AIModifyDialog,{show:a.showAiEditDialog,'is-modifying':a.isEditingAi,title:'AI 编辑简短描述',description:'描述你想要修改的地方，AI 会在当前描述的基础上进行调整。注意：仅修改描述，不会改变开场白内容本身。',progress:a.isEditingAi?a.progressWithElapsedTime:void 0,examples:['更简洁一些','更文艺一些','更活泼一些','添加情感色彩'],onClose:n[17]||(n[17]=e=>a.showAiEditDialog=!1),onConfirm:a.confirmEditDescription},null,8,['show','is-modifying','progress']),C(a.AIModifyDialog,{show:a.showAiStyleDialog,'is-modifying':a.isGeneratingStyle,title:'AI 生成开场白界面样式',description:'描述你想要的界面风格，AI 会生成完整的HTML样式代码。例如：深蓝色背景、金色标题、圆角卡片等。',progress:a.isGeneratingStyle?a.progressWithElapsedTime:void 0,examples:['深蓝色渐变背景，白色圆角卡片，金色标题','粉色可爱风格，带阴影的卡片','深色科技风格，霓虹灯效果','典雅金色风格，高贵大气','游戏像素风格，方形卡片'],onClose:n[18]||(n[18]=e=>a.showAiStyleDialog=!1),onConfirm:a.generateStyleWithAI},null,8,['show','is-modifying','progress']),a.showOriginalDialog?(i(),o('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:n[26]||(n[26]=f(e=>a.showOriginalDialog=!1,['self']))},[s('div',{style:{background:'linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%)','border-radius':'16px',padding:'24px','max-width':'700px',width:'100%','max-height':'80vh',display:'flex','flex-direction':'column','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'},onClick:n[25]||(n[25]=f(()=>{},['stop']))},[s('div',rr,[n[46]||(n[46]=s('h3',{style:{margin:'0',color:'white',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-file-lines'}),s('span',null,'开场白原文')],-1)),s('button',{style:{background:'transparent',border:'none',color:'rgba(255, 255, 255, 0.7)',cursor:'pointer','font-size':'20px',padding:'4px 8px',transition:'all 0.2s'},onClick:n[19]||(n[19]=e=>a.showOriginalDialog=!1),onMouseenter:n[20]||(n[20]=e=>e.currentTarget.style.color='white'),onMouseleave:n[21]||(n[21]=e=>e.currentTarget.style.color='rgba(255, 255, 255, 0.7)')},[...n[45]||(n[45]=[s('i',{class:'fa-solid fa-times'},null,-1)])],32)]),s('div',ir,c(a.originalGreetingContent),1),s('div',sr,[s('button',{style:{padding:'10px 24px',background:'white',border:'none','border-radius':'6px',color:'#1e3a8a','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.2s'},onClick:n[22]||(n[22]=e=>a.showOriginalDialog=!1),onMouseenter:n[23]||(n[23]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[24]||(n[24]=e=>e.currentTarget.style.transform='translateY(0)')},' 关闭 ',32)])])])):r('',!0),a.showCodeDialog?(i(),o('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000','backdrop-filter':'blur(5px)'},onClick:a.closeCodeDialog},[s('div',{style:{background:'#2a2a2a','border-radius':'15px','max-width':'800px',width:'90%','max-height':'80vh',display:'flex','flex-direction':'column','box-shadow':'0 20px 60px rgba(0, 0, 0, 0.5)'},onClick:n[27]||(n[27]=f(()=>{},['stop']))},[s('div',{style:{padding:'20px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},[n[48]||(n[48]=s('h3',{style:{color:'#e0e0e0','font-size':'18px',margin:'0',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-code'}),d(' 生成的前端代码 ')],-1)),s('button',{style:{background:'transparent',border:'none',color:'#888','font-size':'20px',cursor:'pointer',padding:'5px 10px',transition:'color 0.2s ease'},onClick:a.closeCodeDialog},[...n[47]||(n[47]=[s('i',{class:'fa-solid fa-times'},null,-1)])])]),s('div',lr,[n[50]||(n[50]=s('div',{style:{background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px','margin-bottom':'20px',color:'#e0e0e0'}},[s('p',{style:{'margin-bottom':'10px','font-weight':'600'}},[s('strong',null,'使用方法：')]),s('ol',{style:{'margin-left':'20px',color:'#aaa','line-height':'1.8'}},[s('li',null,'复制下面的代码'),s('li',null,[d(' 在消息中输入占位符（如 '),s('code',{style:{background:'#2a2a2a',padding:'2px 6px','border-radius':'4px',color:'#667eea'}},'【开场白】'),d('） ')]),s('li',null,'创建正则脚本，将占位符替换为此代码')])],-1)),s('div',dr,[s('pre',cr,[s('code',pr,c(a.generatedCode),1)])]),s('button',{style:{width:'100%',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',padding:'12px','border-radius':'8px','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center','justify-content':'center',gap:'8px'},onClick:a.copyCode},[n[49]||(n[49]=s('i',{class:'fa-solid fa-copy'},null,-1)),d(' '+c(a.copyButtonText),1)])])])])):r('',!0)])}],['__scopeId','data-v-5041ebab'],['__file','GreetingsTab.vue']]),gr={class:'help-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},fr={style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','margin-bottom':'20px','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},mr={style:{color:'#e0e0e0','font-size':'14px','line-height':'1.8',animation:'fadeIn 0.3s ease-in'}},xr={style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','margin-bottom':'20px','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},hr={style:{color:'#e0e0e0','font-size':'14px','line-height':'1.8',animation:'fadeIn 0.3s ease-in'}};const br=a(e({__name:'HelpTab',setup(e,{expose:n}){n();const t=E({usageGuide:!0,changelog:!0}),a={expandedSections:t,toggleSection:e=>{t[e]=!t[e]}};return Object.defineProperty(a,'__isScriptSetup',{enumerable:!1,value:!0}),a}}),[['render',function(e,n,t,a,r,c){return i(),o('div',gr,[n[8]||(n[8]=u('<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:35px 30px;border-radius:20px;margin-bottom:25px;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);text-align:center;position:relative;overflow:hidden;" data-v-e8f4bfa8><div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255, 255, 255, 0.1);border-radius:50%;" data-v-e8f4bfa8></div><div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:rgba(255, 255, 255, 0.1);border-radius:50%;" data-v-e8f4bfa8></div><div style="position:relative;z-index:1;" data-v-e8f4bfa8><div style="font-size:48px;margin-bottom:10px;" data-v-e8f4bfa8>🐱</div><h2 style="margin:0 0 10px 0;color:white;font-size:24px;font-weight:600;" data-v-e8f4bfa8>mzrodyu猫猫的小破烂</h2><div style="color:rgba(255, 255, 255, 0.9);font-size:14px;" class="version-info" data-v-e8f4bfa8>版本 v1.36</div><div style="margin-top:25px;padding:20px;background:rgba(220, 53, 69, 0.15);border:2px solid rgba(220, 53, 69, 0.3);border-radius:12px;backdrop-filter:blur(10px);" data-v-e8f4bfa8><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;justify-content:center;" data-v-e8f4bfa8><i class="fa-solid fa-shield-halved" style="color:#ffc107;font-size:16px;" data-v-e8f4bfa8></i><span style="color:white;font-weight:600;font-size:14px;" data-v-e8f4bfa8>版权声明</span></div><div style="color:rgba(255, 255, 255, 0.95);font-size:13px;line-height:1.8;text-align:left;" data-v-e8f4bfa8><div style="margin-bottom:5px;" data-v-e8f4bfa8>📌 本脚本仅发布在类脑/旅程</div><div style="margin-bottom:5px;" data-v-e8f4bfa8>🚫 禁止二传</div><div style="margin-bottom:5px;" data-v-e8f4bfa8>⚠️ 二改需要获得作者允许</div><div data-v-e8f4bfa8>❌ 商业化绝对禁止</div></div></div></div></div>',1)),s('div',fr,[s('h3',{onClick:n[0]||(n[0]=e=>a.toggleSection('usageGuide')),style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px',cursor:'pointer','user-select':'none'}},[n[2]||(n[2]=s('i',{class:'fa-solid fa-book',style:{color:'#17a2b8','font-size':'18px'}},null,-1)),n[3]||(n[3]=d(' 使用说明 ',-1)),s('i',{class:h([a.expandedSections.usageGuide?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{'margin-left':'auto','font-size':'14px',transition:'transform 0.3s',color:'#888'}},null,2)]),l(s('div',mr,[...n[4]||(n[4]=[u('<div style="margin-bottom:20px;" data-v-e8f4bfa8><h4 style="color:#4a9eff;margin-bottom:12px;font-size:16px;" data-v-e8f4bfa8>📋 功能简介</h4><ul style="list-style:none;padding:0;margin:0;" data-v-e8f4bfa8><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>总结：</strong>自动/手动总结对话，存入世界书</li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>写卡辅助：</strong>生成角色卡、世界书条目，支持流式传输和 AI 修改 </li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>状态栏生成：</strong>可视化配置状态栏，生成正则 JSON 和世界书条目 </li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>MVU Beta：</strong>生成变量结构、提示词模板、meta 配置</li><li data-v-e8f4bfa8><strong data-v-e8f4bfa8>其他：</strong>去八股、正则界面生成、前端项目管理、表格生成</li></ul></div><div data-v-e8f4bfa8><h4 style="color:#ffc107;margin-bottom:12px;font-size:16px;" data-v-e8f4bfa8>💡 使用方法</h4><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ff6b6b;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>⚠️ API 配置</div><div style="margin-bottom:10px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>支持的格式：</strong><ul style="margin:8px 0;padding-left:20px;" data-v-e8f4bfa8><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://api.openai.com</code> → 自动补全为 <code data-v-e8f4bfa8>/v1</code></li><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://api.openai.com/v1</code> → 直接使用</li><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://your-proxy.com/v1/chat/completions</code> → 直接使用</li></ul></div></div><ul style="list-style:disc;padding-left:20px;margin:0;" data-v-e8f4bfa8><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>导入：</strong>酒馆助手 → 脚本库 → 导入 → 全局脚本</li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>首次使用：</strong>先去&quot;设置&quot;页配置 API</li><li data-v-e8f4bfa8><strong data-v-e8f4bfa8>自动总结：</strong>建议开启，每 20-30 楼自动生成一次</li></ul></div>',2)])],512),[[P,a.expandedSections.usageGuide]])]),s('div',xr,[s('h3',{onClick:n[1]||(n[1]=e=>a.toggleSection('changelog')),style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px',cursor:'pointer','user-select':'none'}},[n[5]||(n[5]=s('i',{class:'fa-solid fa-clock-rotate-left',style:{color:'#28a745','font-size':'18px'}},null,-1)),n[6]||(n[6]=d(' 更新日志 ',-1)),s('i',{class:h([a.expandedSections.changelog?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{'margin-left':'auto','font-size':'14px',transition:'transform 0.3s',color:'#888'}},null,2)]),l(s('div',hr,[...n[7]||(n[7]=[u('<div style="padding:20px;background:rgba(76, 175, 80, 0.05);border-left:4px solid #4caf50;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#4caf50;display:flex;align-items:center;gap:8px;" data-v-e8f4bfa8> v1.34 </div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月8日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>🐛 修复：移除 vue-i18n 国际化系统，改为直接使用中文</li><li class="update-item" data-v-e8f4bfa8>🔧 优化：精简代码，提高加载速度</li><li class="update-item" data-v-e8f4bfa8>✨ 改进：界面显示更加稳定</li></ul></div><div style="padding:20px;background:rgba(255, 152, 0, 0.05);border-left:4px solid #ff9800;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#ff9800;display:flex;align-items:center;gap:8px;" data-v-e8f4bfa8> v1.33 - 🎨 开场白管理器 </div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月5日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>新增：开场白美化选择器工具</li><li class="update-item" data-v-e8f4bfa8>自动读取角色卡的所有开场白</li><li class="update-item" data-v-e8f4bfa8>为每个开场白配置美化样式（图标、标题、描述）</li><li class="update-item" data-v-e8f4bfa8>AI 生成描述：根据开场白原文内容自动生成吸引人的描述</li><li class="update-item" data-v-e8f4bfa8>AI 编辑描述：根据需求快速修改描述</li><li class="update-item" data-v-e8f4bfa8>⭐ AI 生成界面样式：直接告诉AI你想要什么风格，自动生成完整HTML界面</li><li class="update-item" data-v-e8f4bfa8>实时预览生成的美化界面样式效果</li><li class="update-item" data-v-e8f4bfa8>一键导出为 STScript JSON 格式</li><li class="update-item" data-v-e8f4bfa8>配置自动保存到角色卡变量</li></ul></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.32</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月2日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>最小化图标支持拖动，可随意调整位置</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.31</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月30日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ffc107;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>✨ 新功能</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>同层对话：AI 回复直接显示在面板内，支持流式传输和正则过滤</li><li class="update-item" data-v-e8f4bfa8>状态栏生成器新增 AI 解析 XML 和自然语言生成字段功能</li></ul></div><div data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>完整的移动端适配：响应式布局、标签栏滚动、滑动切换</li><li class="update-item" data-v-e8f4bfa8>所有 AI 功能统一使用设置页的 API 配置</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.30</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月26日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ffc107;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>✨ 新功能</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>新增 MVU Beta 标签页：变量结构、提示词模板、meta 配置生成</li><li class="update-item" data-v-e8f4bfa8>新增状态栏生成器：可视化配置状态栏，生成正则 JSON 和世界书条目</li><li class="update-item" data-v-e8f4bfa8>状态栏生成器支持 ABO 模板快速加载</li></ul></div><div data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>所有 AI 工具统一从设置页读取 max_tokens 和 temperature</li><li class="update-item" data-v-e8f4bfa8>MVU Beta 和状态栏生成器支持数据持久化</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.00</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月20日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>🎉 初始版本发布</li><li class="update-item" data-v-e8f4bfa8>支持自动/手动总结、表格生成、反八股、世界书条目管理、楼层隐藏/显示</li></ul></div>',6)])],512),[[P,a.expandedSections.changelog]])]),n[9]||(n[9]=s('div',{style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','text-align':'center','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},[s('div',{style:{color:'#888','font-size':'13px','line-height':'1.8'}},[s('p',{style:{margin:'0 0 8px 0'}},'Made with ❤️ by mzrodyu'),s('p',{style:{margin:'0'}},'基于 Vue 和 Pinia')])],-1))])}],['__scopeId','data-v-e8f4bfa8'],['__file','HelpTab.vue']]),yr=e({__name:'MvuBetaTab',setup(e,{expose:a}){a();const o=b(),{settings:r}=y(o),i=n({structure:!0,prompt:!1});const s=n(''),l=n(!1),d=n(''),c=n(!1),p=n(''),u=n(''),g=n(!1),f=n(!1),m=n(!1),x=n(!1),h=n(''),v=n(''),w=n(''),S=n(''),I=n('');function A(e){navigator.clipboard.writeText(e).then(()=>{window.toastr.success('已复制到剪贴板')})}function C(){const e=v.value.split('\n').filter(e=>e.trim()),n={};return e.forEach(e=>{const t=e.split(':').map(e=>e.trim()),a=t[0],o=t[1]||'string',r=t[2]||'描述...';a&&(n[a]='number'===o?[0,r]:'string'===o?['',r]:'array'===o?[[],r]:'object'===o?[{},r]:[null,r])}),n}function E(){if(w.value)try{const e=JSON.parse(w.value),n=Object.keys(e).find(e=>'$meta'!==e)||'myVar',t=e[n]||{};let a=0;for(const o in t)'$meta'!==o&&a++;S.value=`${n} - ${a} fields`,i.value.prompt=!0,P(),window.toastr.success('已基于结构自动生成 COT 提示词'),setTimeout(()=>{const e=document.querySelector('.tool-section:nth-child(2)');e?.scrollIntoView({behavior:'smooth',block:'nearest'})},100)}catch(e){console.error('生成提示词失败:',e),window.toastr.error('生成失败，请检查变量结构格式')}else window.toastr.error('请先生成 [InitVar] 结构')}function P(){const e=`<%_ setLocalVar('initialized_lorebooks.-YourLorebook[0]', true); _%>\n【变量更新】\n在所有文本的最后，进行变量更新。\n\n以下是故事中需要追踪的关键变量，当前状态以这些变量的值为准。\n\n<status_current_variables>\n{{get_message_variable::stat_data}}\n</status_current_variables>\n\n严格按照以下规则和格式进行输出，并确定每一个变量是否需要更新，不要遗漏：\n\nrule:\n  description:\n    - Output update analysis at the end of response\n    - Variable updates are omitted in context but you must still add them\n    - **CRITICAL**: For MVU format [value, description], ALWAYS use [0] suffix to access the value part\n    - 4 commands available: \\\`_.set\\\` (2-3 args), \\\`_.insert\\\` (2-3 args), \\\`_.remove\\\` (1-2 args), \\\`_.add\\\` (2 args)\n    - **RECOMMENDED**: Use \\\`_.insert\\\` instead of \\\`_.assign\\\`\n    - strictSet enabled: [0] suffix is mandatory for all value access\n\n  command_usage:\n    - \\\`_.set('path[0]', old?, new);//reason\\\` - Replace value\n    - \\\`_.add('path[0]', delta);//reason\\\` - Add/subtract numbers only\n    - \\\`_.insert('path[0]', value);//reason\\\` - Add to array end\n    - \\\`_.insert('path[0]', index, value);//reason\\\` - Insert to array at position\n    - \\\`_.insert('path', key, value);//reason\\\` - Add key-value to object\n    - \\\`_.remove('path[0]', value);//reason\\\` - Remove from array/object\n\n  analysis:\n    You MUST follow this Chain-of-Thought (COT) analysis process step by step:\n\n    **STEP 1: Scene Analysis (50 words max, IN ENGLISH)**\n    - Identify current scene/stage/phase\n    - Describe what happened\n    - Determine what changes occurred (time/location/status/progress)\n\n    **STEP 2: Time & Key Status Check**\n    - Extract current time/status from story context\n    - Read key variables from <status_current_variables>\n    - Calculate changes\n    - Decision: What needs to be updated?\n\n    **STEP 3: Systematic Variable Review (check EVERY variable category)**\n    Go through each variable category systematically and mark Y or N:\n\n    ${S.value.trim()||'变量分类 - X fields'}:\n      - 变量1[0]: [Y/N] - explain\n      - 变量2[0]: [Y/N] - explain\n\n    **STEP 4: Command Selection**\n    For each variable marked Y, determine which command to use\n\n    **STEP 5: Analyze Other Variable Systems**\n    - stat_data detailed COT: COMPLETED\n    - Other variable groups? [YES/NO]\n\n    **STEP 6: Final Validation Checklist**\n    - All [0] suffixes present? [YES/NO]\n    - All Y variables have corresponding commands? [YES/NO]\n    - All commands have clear Chinese comments? [YES/NO]\n\n  format: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            [50 words]\n\n            **STEP 2: Time & Key Status Check**\n            - Current status: ...\n            - Stored variable[0]: ...\n            - Changes: ...\n            - Update decision: ...\n\n            **STEP 3: Variable Review (stat_data)**\n            [List categories with Y/N]\n\n            **STEP 4: Command Selection**\n            [For each Y variable, state which command]\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set('path[0]', old?, new);//reason\n        _.add('path[0]', delta);//reason\n        _.insert('path[0]', value);//reason\n        _.remove('path[0]', value);//reason\n    </UpdateVariable>\n\n  example: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            User and character had conversation at library. User helped find a book. Time advanced from 10:00 to 10:30. Character's impression improved.\n\n            **STEP 2: Time & Key Status Check**\n            - Current time: 10:30\n            - Stored 时间[0]: "10:00"\n            - Time passed: 30 minutes\n            - Update decision: Time, Favor\n\n            **STEP 3: Variable Review (stat_data)**\n            基础信息 - 3 fields:\n              - 时间[0]: Y - Time advanced\n              - 日期[0]: N - Same day\n              - 当前位置[0]: N - Still at library\n\n            人物关系 - 1 field:\n              - 好感度[0]: Y - Positive interaction\n\n            **STEP 4: Command Selection**\n            - 时间: use _.set\n            - 好感度: use _.add\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set('时间[0]', '10:00', '10:30');//时间推进30分钟\n        _.add('角色.好感度[0]', 3);//愉快的交流，好感度小幅提升\n    </UpdateVariable>\n\n  specific_rules:\n    - 时间推进：每次互动后更新具体时间，使用 _.set 更新\n    - 状态切换：当状态/阶段切换时，必须更新对应的状态变量\n    - 计数器：使用 _.add 增加或减少计数\n    - 数组操作：添加元素必须用 _.insert，删除元素必须用 _.remove\n    - [0]后缀：所有变量访问都必须加[0]后缀\n    - 扩展数组：带有 $__META_EXTENSIBLE__$ 标记的数组使用 _.insert 添加元素\n    - 对象添加键值：使用 _.insert('路径', 键名, 值) 向对象添加新的键值对`;I.value=e}function O(){if(!w.value||!I.value)return void window.toastr.error('请先生成 [InitVar] 结构和 COT 提示词');let e='myVar';try{const n=JSON.parse(w.value);e=Object.keys(n).find(e=>'$meta'!==e)||'myVar'}catch(i){console.error('解析变量名失败:',i)}const n=[{uid:j(),key:[],keysecondary:[],comment:'[InitVar]',content:w.value,constant:!1,vectorized:!1,selective:!0,selectiveLogic:0,addMemo:!1,order:100,position:0,disable:!1,excludeRecursion:!1,delayUntilRecursion:!1,probability:100,useProbability:!0,depth:4,group:'',groupOverride:!1,groupWeight:100,scanDepth:null,caseSensitive:null,matchWholeWords:null,useGroupScoring:!1,automationId:'',role:0,sticky:0,cooldown:0,delay:0},{uid:j(),key:[],keysecondary:[],comment:'变量',content:I.value,constant:!0,vectorized:!1,selective:!1,selectiveLogic:0,addMemo:!1,order:100,position:1,disable:!1,excludeRecursion:!1,delayUntilRecursion:!1,probability:100,useProbability:!0,depth:0,group:'',groupOverride:!1,groupWeight:100,scanDepth:null,caseSensitive:null,matchWholeWords:null,useGroupScoring:!1,automationId:'',role:0,sticky:0,cooldown:0,delay:0}],t=JSON.stringify(n,null,2),a=new Blob([t],{type:'application/json'}),o=URL.createObjectURL(a),r=document.createElement('a');r.href=o,r.download=`${e}_MVU_worldbook.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),window.toastr.success('✅ 已导出世界书 JSON：[InitVar] + 变量规则')}function j(){return Date.now()+Math.floor(1e3*Math.random())}function D(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法加载 MVU 配置');const n=`${e}_mvu_beta_config`,t=localStorage.getItem(n);if(t){const e=JSON.parse(t);e.varName&&(h.value=e.varName),e.subFields&&(v.value=e.subFields),e.generatedStructure&&(w.value=e.generatedStructure),e.variableCategories&&(S.value=e.variableCategories),e.generatedPrompt&&(I.value=e.generatedPrompt),console.log('✅ 已加载保存的 MVU Beta 配置')}}catch(e){console.error('加载 MVU Beta 配置失败:',e)}}function R(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存 MVU 配置');const n=`${e}_mvu_beta_config`,t={varName:h.value,subFields:v.value,generatedStructure:w.value,variableCategories:S.value,generatedPrompt:I.value};localStorage.setItem(n,JSON.stringify(t))}catch(e){console.error('保存 MVU Beta 配置失败:',e)}}k(()=>{D()});let N=null;t([h,v,w,S,I],()=>{N&&clearTimeout(N),N=window.setTimeout(()=>{R()},1e3)});const H={settingsStore:o,settings:r,expanded:i,toggleExpanded:function(e){i.value[e]=!i.value[e]},aiStructurePrompt:s,isGeneratingAI:l,aiPromptDescription:d,isGeneratingPrompt:c,originalStructurePrompt:p,originalPromptDescription:u,showStructureModifyDialog:g,isModifyingStructure:f,showPromptModifyDialog:m,isModifyingPrompt:x,varName:h,subFields:v,generatedStructure:w,variableCategories:S,generatedPrompt:I,copyToClipboard:A,generateStructure:function(){if(!h.value.trim())return void window.toastr.error('请输入变量名称');const e={$meta:{extensible:!1,strictSet:!0}};e[h.value]=C(),w.value=JSON.stringify(e,null,2)},parseSubFields:C,copyGenerated:function(){A(w.value)},handleAIGenerateStructure:async function(){if(s.value.trim())if(r.value.api_endpoint&&r.value.api_key){p.value=s.value,l.value=!0;try{const n='你是 MVU Beta 变量系统专家，负责生成精确、实用的 [InitVar] 初始化数据。\n\n# 核心格式规范\n\n## ⚠️ 关键规则（必须严格遵守）\n1. **不包含 "stat_data" 根节点**（系统会自动添加）\n2. **所有字段格式**: `[默认值, "描述"]`（数组格式，两个元素）\n3. **$meta 位置**: 必须在 JSON 根级别（与变量名同级）\n4. **字符串要求**: 必须在一行内，不能换行\n5. **描述长度**: 15-20字以内，简洁准确\n\n## JSON 结构模板\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "变量分组名": {\n    "字段名1": [默认值, "字段用途说明"],\n    "字段名2": [默认值, "字段用途说明"]\n  }\n}\n```\n\n---\n\n# 类型选择指南\n\n## 1️⃣ number（数字）\n**何时使用**：\n- 计数、等级、属性值（如：好感度、金币）\n- 时间戳、进度值\n- 任何需要加减运算的值\n\n**格式**: `[初始数字, "描述"]`\n**示例**:\n- `"好感度": [0, "与角色的亲密程度，-30到100"]`\n- `"等级": [1, "当前等级，影响解锁内容"]`\n- `"金币": [100, "可用于购买物品"]`\n\n## 2️⃣ string（字符串）\n**何时使用**：\n- 名称、状态、描述性文本\n- 时间（如 "10:00"）、地点\n- 单选状态（如 "进行中"/"已完成"）\n\n**格式**: `["初始文本", "描述"]`\n**示例**:\n- `"当前状态": ["空闲", "角色当前的行为状态"]`\n- `"时间": ["09:00", "故事中的当前时间"]`\n- `"关系": ["陌生人", "与user的关系定位"]`\n\n## 3️⃣ array（数组）\n**何时使用**：\n- 列表、集合（如：背包、成就列表）\n- 需要添加/删除元素的内容\n- 多个同类型数据\n\n**格式**: `[[], "描述"]` 或 `[[示例项], "描述"]`\n**示例**:\n- `"背包": [[], "角色拥有的物品列表"]`\n- `"成就": [["新手"], "已解锁的成就"]`\n- `"记忆片段": [[], "重要的记忆事件"]`\n\n## 4️⃣ object（对象）\n**何时使用**：\n- 键值对数据（如：物品→数量）\n- 复杂的嵌套数据\n- 需要动态添加属性的结构\n\n**格式**: `[{}, "描述"]` 或 `[{"示例键": "示例值"}, "描述"]`\n**示例**:\n- `"物品数量": [{"苹果": 3}, "物品名与数量的映射"]`\n- `"关系网": [{}, "NPC名与好感度的映射"]`\n\n---\n\n# 命名规范\n\n## ✅ 好的命名\n- **简洁明确**: "好感度"、"时间"、"背包"\n- **中文优先**: 便于理解和使用\n- **符合语境**: 与角色卡/游戏设定一致\n\n## ❌ 避免的命名\n- 过于抽象: "数据1"、"值A"\n- 过长: "角色与玩家之间的好感度数值"\n- 英文混杂: "favor_value"（除非必要）\n\n---\n\n# 描述编写规范\n\n## ✅ 好的描述（15-20字）\n- "与角色的亲密程度，-30到100"\n- "故事中的当前时间，格式HH:MM"\n- "角色拥有的物品列表，可增删"\n- "当前所在位置，影响剧情走向"\n\n## ❌ 避免的描述\n- 太短: "好感度"（无信息量）\n- 太长: "这是一个用于记录玩家与角色之间的情感联系强度的数值变量，范围..."\n- 无意义: "描述..."、"数据"\n\n---\n\n# 完整示例\n\n## 示例1：角色属性系统\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "角色": {\n    "姓名": ["未命名", "角色的名字"],\n    "等级": [1, "当前等级，影响技能解锁"],\n    "好感度": [0, "与user的亲密度，-30到100"],\n    "状态": ["正常", "当前的身体/精神状态"],\n    "背包": [[], "拥有的物品列表"],\n    "成就": [{}, "已解锁成就与解锁时间"]\n  }\n}\n```\n\n## 示例2：时间与地点系统\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "世界": {\n    "时间": ["09:00", "故事中的当前时间"],\n    "日期": ["2024年1月1日", "当前日期"],\n    "地点": ["起始镇", "角色所在的位置"],\n    "天气": ["晴朗", "当前天气状况"],\n    "已完成任务": [[], "完成的任务列表"]\n  }\n}\n```\n\n---\n\n# 最终要求\n\n1. **只输出 JSON**，不要任何解释或注释\n2. **确保格式正确**：字符串在一行内，无尾随逗号\n3. **变量名有意义**：符合用户需求的实际场景\n4. **类型选择准确**：根据用途选择最合适的类型\n5. **描述精准简洁**：15-20字，说清楚用途和变化规则\n\n现在开始根据用户需求生成 [InitVar] JSON。',t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:`需求：${s.value}\n\n请生成 [InitVar] JSON。`}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||4e3})}),o=await a.text();if(!a.ok){let t=`API 错误: ${a.status}`;try{const e=JSON.parse(o);t=e.error?`${t} - ${e.error.message||JSON.stringify(e.error)}`:e.message?`${t} - ${e.message}`:`${t} - ${JSON.stringify(e)}`}catch(e){t=`${t} - ${o.slice(0,200)}`}throw console.error('API 请求失败:',t),console.error('请求 URL:',r.value.api_endpoint),console.error('请求体:',JSON.stringify({model:r.value.model,messages:[{role:'system',content:n.substring(0,100)+'...'},{role:'user',content:`需求：${s.value.substring(0,100)}...`}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||4e3},null,2)),new Error(t)}const i=JSON.parse(o);let l='';i.choices&&i.choices[0]&&i.choices[0].message?l=i.choices[0].message.content||'':i.data&&i.data.choices&&i.data.choices[0]?l=i.data.choices[0].message?.content||'':i.content&&(l='string'==typeof i.content?i.content:JSON.stringify(i.content)),console.log('AI 返回内容:',l);let d=l;d=d.replace(/```json\s*/gi,'').replace(/```\s*$/g,'');const c=d.match(/\{[\s\S]*$/);if(!c)throw new Error('未找到 JSON 对象');d=c[0];let p,u=0,g=!1,f=!1,m=d.length;for(let e=0;e<d.length;e++){const n=d[e];if(f)f=!1;else if('\\'!==n)if('"'!==n||g){if('"'===n&&g)g=!1;else if(!g&&('{'===n?u++:'}'===n&&u--,0===u)){m=e+1;break}}else g=!0;else f=!0}d=d.substring(0,m),u>0&&(console.warn(`JSON 不完整，缺少 ${u} 个闭合括号，尝试补全...`),d+='}'.repeat(u)),d=d.replace(/,(\s*[}\]])/g,'$1'),d=d.replace(/\/\/[^\n]*/g,''),d=d.replace(/\/\*[\s\S]*?\*\//g,'');try{p=JSON.parse(d)}catch(e){throw console.error('JSON 解析失败，原始内容:',d),new Error(`JSON 解析失败: ${e.message}。请让 AI 输出正确的 JSON（字符串在一行内，无尾随逗号）`)}const x=Object.keys(p).find(e=>'$meta'!==e)||'myVar';h.value=x;const b=p[x]||{},y=[];for(const e in b){if('$meta'===e)continue;const n=b[e];if(Array.isArray(n)&&2===n.length){const t=n[0],a='number'==typeof t?'number':'string'==typeof t?'string':Array.isArray(t)?'array':'object',o=n[1]||'描述...';y.push(`${e}:${a}:${o}`)}}v.value=y.join('\n'),w.value=JSON.stringify(p,null,2),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI生成失败:',n),window.toastr.error(`AI生成失败: ${n.message}`)}finally{l.value=!1}}else window.toastr.error('请先在设置页面配置 API 端点和 API Key');else window.toastr.error('请输入需求描述')},autoGeneratePrompt:E,generatePrompt:P,copyPrompt:function(){A(I.value)},handleAIGeneratePrompt:async function(){if(d.value.trim())if(r.value.api_endpoint&&r.value.api_key){u.value=d.value,c.value=!0;try{const n='你是 MVU Beta COT（思维链）提示词专家，负责生成完整、规范的 6 步分析流程提示词。\n\n# 核心要求\n\n## ⚠️ 必须包含的元素\n1. **变量读取**: `{{get_message_variable::stat_data}}`\n2. **[0] 后缀**: 所有MVU变量访问必须加 `[0]` 后缀\n3. **推荐命令**: 优先使用 `_.insert` 而非 `_.assign`\n4. **6步COT**: 完整的思维链分析流程\n\n## 提示词结构\n\n```ejs\n<%_ setLocalVar(\'initialized_lorebooks.-YourLorebook[0]\', true); _%>\n【变量更新】\n在所有文本的最后，进行变量更新。\n\n以下是故事中需要追踪的关键变量，当前状态以这些变量的值为准。\n\n<status_current_variables>\n{{get_message_variable::stat_data}}\n</status_current_variables>\n\n严格按照以下规则和格式进行输出，并确定每一个变量是否需要更新，不要遗漏：\n\nrule:\n  description:\n    - Output update analysis at the end of response\n    - Variable updates are omitted in context but you must still add them\n    - **CRITICAL**: For MVU format [value, description], ALWAYS use [0] suffix to access the value part\n    - 4 commands available: _.set (2-3 args), _.insert (2-3 args), _.remove (1-2 args), _.add (2 args)\n    - **RECOMMENDED**: Use _.insert instead of _.assign\n    - strictSet enabled: [0] suffix is mandatory for all value access\n\n  command_usage:\n    - _.set(\'path[0]\', old?, new);//reason - Replace value\n    - _.add(\'path[0]\', delta);//reason - Add/subtract numbers only\n    - _.insert(\'path[0]\', value);//reason - Add to array end\n    - _.insert(\'path[0]\', index, value);//reason - Insert to array at position\n    - _.insert(\'path\', key, value);//reason - Add key-value to object\n    - _.remove(\'path[0]\', value);//reason - Remove from array/object\n\n  analysis:\n    You MUST follow this Chain-of-Thought (COT) analysis process step by step:\n\n    **STEP 1: Scene Analysis (50 words max, IN ENGLISH)**\n    - Identify current scene/stage/phase\n    - Describe what happened\n    - Determine what changes occurred (time/location/status/progress)\n\n    **STEP 2: Time & Key Status Check**\n    - Extract current time/status from story context\n    - Read key variables from <status_current_variables>\n    - Calculate changes\n    - Decision: What needs to be updated?\n\n    **STEP 3: Systematic Variable Review (check EVERY variable category)**\n    Go through each variable category systematically and mark Y or N:\n\n    [基于用户需求生成的变量分类]:\n      - 变量1[0]: [Y/N] - explain\n      - 变量2[0]: [Y/N] - explain\n\n    **STEP 4: Command Selection**\n    For each variable marked Y, determine which command to use\n\n    **STEP 5: Analyze Other Variable Systems**\n    - stat_data detailed COT: COMPLETED\n    - Other variable groups? [YES/NO]\n\n    **STEP 6: Final Validation Checklist**\n    - All [0] suffixes present? [YES/NO]\n    - All Y variables have corresponding commands? [YES/NO]\n    - All commands have clear Chinese comments? [YES/NO]\n\n  format: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            [50 words]\n\n            **STEP 2: Time & Key Status Check**\n            - Current status: ...\n            - Stored variable[0]: ...\n            - Changes: ...\n            - Update decision: ...\n\n            **STEP 3: Variable Review (stat_data)**\n            [List categories with Y/N]\n\n            **STEP 4: Command Selection**\n            [For each Y variable, state which command]\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set(\'path[0]\', old?, new);//reason\n        _.add(\'path[0]\', delta);//reason\n        _.insert(\'path[0]\', value);//reason\n        _.remove(\'path[0]\', value);//reason\n    </UpdateVariable>\n\n  specific_rules:\n    - 时间推进：每次互动后更新具体时间，使用 _.set 更新\n    - 状态切换：当状态/阶段切换时，必须更新对应的状态变量\n    - 计数器：使用 _.add 增加或减少计数\n    - 数组操作：添加元素必须用 _.insert，删除元素必须用 _.remove\n    - [0]后缀：所有变量访问都必须加[0]后缀\n    - 扩展数组：带有 $__META_EXTENSIBLE__$ 标记的数组使用 _.insert 添加元素\n    - 对象添加键值：使用 _.insert(\'路径\', 键名, 值) 向对象添加新的键值对\n```\n\n---\n\n# 生成要求\n\n1. **完整性**: 包含所有必需部分（变量读取、6步COT、命令示例）\n2. **准确性**: 变量名与用户的InitVar结构一致\n3. **实用性**: 具体规则要符合用户的实际使用场景\n4. **格式**: 直接输出EJS格式，可直接使用\n\n直接输出完整的 COT 提示词内容。',t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:`场景：${d.value}\n\n请生成 COT 提示词。`}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||3e3})}),o=await a.text();if(!a.ok){let t=`API 错误: ${a.status}`;try{const e=JSON.parse(o);t=e.error?`${t} - ${e.error.message||JSON.stringify(e.error)}`:e.message?`${t} - ${e.message}`:`${t} - ${JSON.stringify(e)}`}catch(e){t=`${t} - ${o.slice(0,200)}`}throw console.error('API 请求失败:',t),console.error('请求 URL:',r.value.api_endpoint),console.error('请求体:',JSON.stringify({model:r.value.model,messages:[{role:'system',content:n.substring(0,100)+'...'},{role:'user',content:`场景：${d.value.substring(0,100)}...`}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||3e3},null,2)),new Error(t)}const i=JSON.parse(o);let s='';i.choices&&i.choices[0]&&i.choices[0].message?s=i.choices[0].message.content||'':i.data&&i.data.choices&&i.data.choices[0]?s=i.data.choices[0].message?.content||'':i.content&&(s='string'==typeof i.content?i.content:JSON.stringify(i.content)),I.value=s.trim(),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI生成失败:',n),window.toastr.error(`AI生成失败: ${n.message}`)}finally{c.value=!1}}else window.toastr.error('请先在设置页面配置 API 端点和 API Key');else window.toastr.error('请输入场景描述')},modifyStructureWithAI:async function(e){if(p.value){f.value=!0;try{window.toastr.info('AI 正在修改中...');const n='你是 MVU Beta 变量系统专家。基于原始需求，应用用户的修改建议，生成更新后的 [InitVar] JSON。\n\n# 核心原则\n1. **保持原有结构**：除非明确要求改动，否则保留原有字段\n2. **精确修改**：只修改用户明确指出的部分\n3. **格式一致**：`[默认值, "描述"]`，$meta在根级别\n4. **字符串在一行内**，无尾随逗号\n\n# 修改类型\n\n## 1️⃣ 添加字段\n用户说"增加XX字段"时：\n- 选择合适的类型（number/string/array/object）\n- 设置合理的默认值\n- 写清楚15-20字的描述\n\n## 2️⃣ 删除字段\n用户说"删除XX字段"时：\n- 直接从JSON中移除该字段\n- 不要留下任何痕迹\n\n## 3️⃣ 修改描述\n用户说"改描述"时：\n- 保持字段名和默认值不变\n- 只更新描述部分\n- 保持15-20字长度\n\n## 4️⃣ 调整顺序\n用户说"调整顺序"时：\n- 按要求重新排列字段\n- 内容不变，只改顺序\n\n## 5️⃣ 修改默认值/类型\n用户说"改初始值"或"改类型"时：\n- 更新默认值或更改数据类型\n- 确保新值合理\n\n---\n\n只输出更新后的 JSON，不要解释。',t=`# 原始需求：\n${p.value}\n\n# 修改建议：\n${e}\n\n请根据原始需求和修改建议，重新生成 [InitVar] JSON。`,a=M(r.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||4e3})});if(!o.ok)throw new Error(`API 错误: ${o.status}`);const i=await o.json();let s=(i.choices?.[0]?.message?.content||'').replace(/```json\s*/gi,'').replace(/```\s*$/g,'');const l=s.match(/\{[\s\S]*$/);l&&(s=l[0]),s=s.replace(/,(\s*[}\]])/g,'$1');const d=JSON.parse(s),c=Object.keys(d).find(e=>'$meta'!==e)||'myVar';h.value=c;const u=d[c]||{},f=[];for(const e in u){if('$meta'===e)continue;const n=u[e];if(Array.isArray(n)&&2===n.length){const t=n[0],a='number'==typeof t?'number':'string'==typeof t?'string':Array.isArray(t)?'array':'object',o=n[1]||'描述...';f.push(`${e}:${a}:${o}`)}}v.value=f.join('\n'),w.value=JSON.stringify(d,null,2),p.value+=`\n\n【已应用的修改】：${e}`,window.toastr.success('✅ AI 修改完成！'),g.value=!1}catch(n){console.error('AI 修改失败:',n),window.toastr.error('AI 修改失败: '+n.message)}finally{f.value=!1}}else window.toastr.warning('请先生成结构')},modifyPromptWithAI:async function(e){if(u.value){x.value=!0;try{window.toastr.info('AI 正在修改中...');const n='你是 MVU Beta COT（思维链）提示词专家。基于原始场景描述，应用用户的修改建议，生成更新后的 6 步思维链提示词。\n\n# 核心原则\n1. **保持原有结构**：除非明确要求改动，否则保留原有内容\n2. **精确修改**：只修改用户明确指出的部分\n3. **格式一致**：EJS格式，包含所有必需元素\n4. **6步完整**：确保6步COT流程不缺失\n\n# 修改类型\n\n## 1️⃣ 修改STEP内容\n用户说"修改STEP X"时：\n- 保持其他STEP不变\n- 只更新指定的STEP内容\n- 保持逻辑连贯性\n\n## 2️⃣ 添加/删除规则\n用户说"添加/删除XX规则"时：\n- 在specific_rules部分操作\n- 保持规则格式一致\n\n## 3️⃣ 调整变量分类\n用户说"修改变量分类"时：\n- 更新STEP 3中的分类\n- 保持所有字段都被覆盖\n\n## 4️⃣ 强化某个方面\n用户说"强调XX"时：\n- 在相应STEP中增加说明\n- 或在specific_rules中添加规则\n\n---\n\n必须包含的元素：\n- `{{get_message_variable::stat_data}}`\n- [0] 后缀说明\n- 6步完整COT流程\n- 命令使用示例\n\n直接输出完整的 EJS 格式提示词。',t=`# 原始场景描述：\n${u.value}\n\n# 修改建议：\n${e}\n\n请根据原始场景描述和修改建议，重新生成 COT 提示词。`,a=M(r.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||3e3})});if(!o.ok)throw new Error(`API 错误: ${o.status}`);const i=await o.json();let s=i.choices?.[0]?.message?.content||'';I.value=s.trim(),u.value+=`\n\n【已应用的修改】：${e}`,window.toastr.success('✅ AI 修改完成！'),m.value=!1}catch(n){console.error('AI 修改失败:',n),window.toastr.error('AI 修改失败: '+n.message)}finally{x.value=!1}}else window.toastr.warning('请先生成提示词')},exportWorldbook:function(){w.value?(I.value||E(),setTimeout(()=>{O()},100)):window.toastr.error('请先生成 [InitVar] 结构')},exportAsWorldbook:O,generateUID:j,loadSavedData:D,saveData:R,get saveTimer(){return N},set saveTimer(e){N=e},AIModifyDialog:Oo};return Object.defineProperty(H,'__isScriptSetup',{enumerable:!1,value:!0}),H}}),vr={class:'tools-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},wr={class:'tool-section'},kr={key:0,class:'tool-content'},_r={style:{background:'linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08))',border:'1px solid rgba(102, 126, 234, 0.3)','border-radius':'8px',padding:'15px','margin-bottom':'20px'}},Tr={class:'form-group',style:{margin:'0 0 12px 0'}},Sr=['disabled'],Ir={style:{position:'relative','z-index':'1'}},Ar={class:'form-group',style:{margin:'15px 0'}},zr={class:'form-group',style:{margin:'15px 0'}},Cr={key:0,class:'output-section'},$r={class:'code-output'},Er={style:{'margin-top':'15px',padding:'12px',background:'rgba(74, 158, 255, 0.05)',border:'1px solid rgba(74, 158, 255, 0.2)','border-radius':'8px'}},Pr={style:{display:'flex',gap:'10px','flex-wrap':'wrap'}},Mr={class:'tool-section'},Or={key:0,class:'tool-content'},jr={style:{background:'linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(245, 158, 11, 0.08))',border:'1px solid rgba(251, 191, 36, 0.3)','border-radius':'8px',padding:'15px','margin-bottom':'20px'}},Dr={class:'form-group',style:{margin:'0 0 12px 0'}},Rr=['disabled'],Nr={style:{position:'relative','z-index':'1'}},Hr={key:0,class:'form-group',style:{margin:'15px 0'}},Lr={key:1,class:'output-section'},Fr={class:'code-output'};const Vr=a(yr,[['render',function(e,n,t,a,f,x){return i(),o(m,null,[s('div',vr,[s('div',wr,[s('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'16px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>a.toggleExpanded('structure')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[n[41]||(n[41]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-database',style:{color:'#4a9eff','font-size':'18px'}}),d(' [InitVar] 变量结构生成器 ')],-1)),s('i',{class:h(a.expanded.structure?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),a.expanded.structure?(i(),o('div',kr,[n[57]||(n[57]=u('<div class="tool-instructions" style="margin-bottom:15px;" data-v-27231230><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-27231230><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-27231230></i> 生成符合 MVU Beta 规范的 <strong style="color:#4a9eff;" data-v-27231230>[InitVar]</strong> 初始化数据。 </p><p style="margin:0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-27231230> ⚠️ 重要：InitVar JSON 中<strong data-v-27231230>不要包含 &quot;stat_data&quot; 根节点</strong>，系统会自动添加 </p></div>',1)),s('div',_r,[n[46]||(n[46]=s('h4',{style:{color:'#667eea','font-size':'14px',margin:'0 0 12px 0',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-wand-magic-sparkles'}),d(' AI 智能生成（推荐） ')],-1)),s('div',Tr,[n[42]||(n[42]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 描述你的变量需求： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>a.aiStructurePrompt=e),placeholder:'例如：我需要一个角色属性系统，包含名字（字符串）、等级（数字，初始为1）、好感度（数字，范围-30到100）、背包（可扩展数组）、成就（可扩展对象）',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[4]||(n[4]=e=>e.target.style.borderColor='#667eea'),onBlur:n[5]||(n[5]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,a.aiStructurePrompt]])]),s('button',{class:'ai-generate-btn',disabled:a.isGeneratingAI||!a.aiStructurePrompt.trim(),style:g([{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},{opacity:a.isGeneratingAI||!a.aiStructurePrompt.trim()?.6:1,cursor:a.isGeneratingAI||!a.aiStructurePrompt.trim()?'not-allowed':'pointer'}]),onClick:a.handleAIGenerateStructure,onMouseenter:n[6]||(n[6]=e=>{!a.isGeneratingAI&&a.aiStructurePrompt.trim()&&(e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)')}),onMouseleave:n[7]||(n[7]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[n[43]||(n[43]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[44]||(n[44]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1)),s('span',Ir,c(a.isGeneratingAI?'AI 生成中...':'AI 智能生成'),1)],44,Sr),a.generatedStructure&&a.originalStructurePrompt?(i(),o('button',{key:0,style:{'margin-left':'12px',padding:'10px 20px',background:'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',border:'1px solid rgba(251, 191, 36, 0.4)','border-radius':'8px',color:'#fbbf24','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.2)'},onClick:n[8]||(n[8]=e=>a.showStructureModifyDialog=!0),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.35), rgba(245, 158, 11, 0.45))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.6)',e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.35)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.4)',e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.2)'})},[...n[45]||(n[45]=[s('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1),d(' AI 修改 ',-1)])],32)):r('',!0),n[47]||(n[47]=s('p',{style:{color:'#888','font-size':'11px',margin:'8px 0 0 0'}},' 💡 AI 会根据你的描述自动生成结构、选择类型、配置 $meta ',-1))]),n[58]||(n[58]=s('div',{style:{'text-align':'center',margin:'20px 0',position:'relative'}},[s('span',{style:{background:'#1a1a1a',padding:'0 12px',color:'#666','font-size':'12px',position:'relative','z-index':'1'}},'或手动配置'),s('div',{style:{position:'absolute',top:'50%',left:'0',right:'0',height:'1px',background:'rgba(255, 255, 255, 0.1)','z-index':'0'}})],-1)),s('div',Ar,[n[48]||(n[48]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 变量名称： ',-1)),l(s('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>a.varName=e),type:'text',placeholder:'例如：角色、背包、技能',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'all 0.2s ease'},onFocus:n[12]||(n[12]=e=>e.target.style.borderColor='#4a9eff'),onBlur:n[13]||(n[13]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,a.varName]])]),s('div',zr,[n[49]||(n[49]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 子字段（每行一个，格式：字段名:类型:描述）： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[14]||(n[14]=e=>a.subFields=e),placeholder:'例如：\n好感度:number:[-30,100]之间，与角色交流时变化\n名字:string:角色名称\n背包:array:获得或使用物品时更新',rows:'5',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'\'Courier New\', monospace','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[15]||(n[15]=e=>e.target.style.borderColor='#4a9eff'),onBlur:n[16]||(n[16]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,a.subFields]]),n[50]||(n[50]=s('p',{style:{color:'#888','font-size':'11px',margin:'6px 0 0 0'}},'💡 支持类型：number、string、array、object',-1))]),s('button',{class:'generate-btn',style:{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:a.generateStructure,onMouseenter:n[17]||(n[17]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'}),onMouseleave:n[18]||(n[18]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[...n[51]||(n[51]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1),s('span',{style:{position:'relative','z-index':'1'}},'生成 [InitVar] 结构',-1)])],32),a.generatedStructure?(i(),o('div',Cr,[n[56]||(n[56]=s('h4',{style:{color:'#4a9eff','font-size':'14px','margin-bottom':'10px'}},'生成的 [InitVar] 结构：',-1)),s('div',$r,[s('pre',null,c(a.generatedStructure),1),s('button',{class:'copy-btn-abs',onClick:a.copyGenerated},[...n[52]||(n[52]=[s('i',{class:'fa-solid fa-copy'},null,-1)])])]),s('div',Er,[n[55]||(n[55]=s('p',{style:{margin:'0 0 10px 0',color:'#4a9eff','font-size':'12px','font-weight':'600'}},[s('i',{class:'fa-solid fa-link'}),d(' 基于此结构继续生成： ')],-1)),s('div',Pr,[s('button',{style:{flex:'1','min-width':'140px',padding:'8px 16px',background:'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3))',color:'#10b981',border:'1px solid rgba(16, 185, 129, 0.4)','border-radius':'6px','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:a.autoGeneratePrompt,onMouseenter:n[19]||(n[19]=e=>{e.currentTarget.style.transform='translateY(-1px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'}),onMouseleave:n[20]||(n[20]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='none'})},[...n[53]||(n[53]=[s('i',{class:'fa-solid fa-file-alt'},null,-1),d(' 生成 COT 提示词 ',-1)])],32),s('button',{style:{flex:'1','min-width':'140px',padding:'8px 16px',background:'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3))',color:'#f59e0b',border:'1px solid rgba(245, 158, 11, 0.4)','border-radius':'6px','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:a.exportWorldbook,onMouseenter:n[21]||(n[21]=e=>{e.currentTarget.style.transform='translateY(-1px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'}),onMouseleave:n[22]||(n[22]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='none'})},[...n[54]||(n[54]=[s('i',{class:'fa-solid fa-book'},null,-1),d(' 导出世界书 JSON ',-1)])],32)])])])):r('',!0)])):r('',!0)]),s('div',Mr,[s('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'16px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[23]||(n[23]=e=>a.toggleExpanded('prompt')),onMouseenter:n[24]||(n[24]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[25]||(n[25]=e=>e.currentTarget.style.transform='translateY(0)')},[n[59]||(n[59]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-file-code',style:{color:'#fbbf24','font-size':'18px'}}),d(' COT 提示词生成器（6 步思维链） ')],-1)),s('i',{class:h(a.expanded.prompt?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),a.expanded.prompt?(i(),o('div',Or,[n[71]||(n[71]=s('div',{class:'tool-instructions',style:{'margin-bottom':'15px'}},[s('p',{style:{margin:'0 0 8px 0',color:'#ccc','font-size':'12px'}},[s('i',{class:'fa-solid fa-info-circle',style:{'margin-right':'6px',color:'#17a2b8'}}),d(' 生成适用于 MVU Beta 的 '),s('strong',{style:{color:'#fbbf24'}},'COT（思维链）提示词模板'),d('，包含 6 步分析流程。 ')])],-1)),s('div',jr,[n[64]||(n[64]=s('h4',{style:{color:'#fbbf24','font-size':'14px',margin:'0 0 12px 0',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-wand-magic-sparkles'}),d(' AI 智能生成（推荐） ')],-1)),s('div',Dr,[n[60]||(n[60]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 描述你的变量系统和使用场景： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[26]||(n[26]=e=>a.aiPromptDescription=e),placeholder:'例如：我的角色卡有一个好感度系统和时间系统，需要 AI 在每次互动后更新时间和好感度',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[27]||(n[27]=e=>e.target.style.borderColor='#fbbf24'),onBlur:n[28]||(n[28]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,a.aiPromptDescription]])]),s('button',{class:'ai-generate-btn',disabled:a.isGeneratingPrompt||!a.aiPromptDescription.trim(),style:g([{padding:'12px 24px',background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(251, 191, 36, 0.3)',position:'relative',overflow:'hidden'},{opacity:a.isGeneratingPrompt||!a.aiPromptDescription.trim()?.6:1,cursor:a.isGeneratingPrompt||!a.aiPromptDescription.trim()?'not-allowed':'pointer'}]),onClick:a.handleAIGeneratePrompt,onMouseenter:n[29]||(n[29]=e=>{!a.isGeneratingPrompt&&a.aiPromptDescription.trim()&&(e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.4)')}),onMouseleave:n[30]||(n[30]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(251, 191, 36, 0.3)'})},[n[61]||(n[61]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[62]||(n[62]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1)),s('span',Nr,c(a.isGeneratingPrompt?'AI 生成中...':'AI 智能生成'),1)],44,Rr),a.generatedPrompt&&a.originalPromptDescription?(i(),o('button',{key:0,style:{'margin-left':'12px',padding:'10px 20px',background:'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',border:'1px solid rgba(251, 191, 36, 0.4)','border-radius':'8px',color:'#fbbf24','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.2)'},onClick:n[31]||(n[31]=e=>a.showPromptModifyDialog=!0),onMouseenter:n[32]||(n[32]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.35), rgba(245, 158, 11, 0.45))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.6)',e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.35)'}),onMouseleave:n[33]||(n[33]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.4)',e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.2)'})},[...n[63]||(n[63]=[s('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1),d(' AI 修改 ',-1)])],32)):r('',!0),n[65]||(n[65]=s('p',{style:{color:'#888','font-size':'11px',margin:'8px 0 0 0'}},' 💡 AI 会根据你的描述自动生成完整的 6 步 COT 提示词 ',-1))]),n[72]||(n[72]=s('div',{style:{'text-align':'center',margin:'20px 0',position:'relative'}},[s('span',{style:{background:'#1a1a1a',padding:'0 12px',color:'#666','font-size':'12px',position:'relative','z-index':'1'}},'或手动配置'),s('div',{style:{position:'absolute',top:'50%',left:'0',right:'0',height:'1px',background:'rgba(255, 255, 255, 0.1)','z-index':'0'}})],-1)),a.generatedStructure?(i(),o('div',Hr,[n[66]||(n[66]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 变量分类（用于 STEP 3，每行一个分类）： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[34]||(n[34]=e=>a.variableCategories=e),placeholder:'例如：\n基础信息 - 3 fields\n人物关系 - 2 fields\n重要记忆 - 1 field',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'\'Courier New\', monospace','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[35]||(n[35]=e=>e.target.style.borderColor='#fbbf24'),onBlur:n[36]||(n[36]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,a.variableCategories]]),n[67]||(n[67]=s('p',{style:{color:'#888','font-size':'11px',margin:'6px 0 0 0'}},'💡 AI 会在 STEP 3 中按照这些分类逐个检查变量',-1))])):r('',!0),s('button',{class:'generate-btn',style:{'margin-top':'10px',padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:a.generatePrompt,onMouseenter:n[37]||(n[37]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'}),onMouseleave:n[38]||(n[38]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[...n[68]||(n[68]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1),s('span',{style:{position:'relative','z-index':'1'}},'生成 COT 提示词',-1)])],32),a.generatedPrompt?(i(),o('div',Lr,[n[70]||(n[70]=s('h4',{style:{color:'#fbbf24','font-size':'14px','margin-bottom':'10px'}},'生成的 COT 提示词：',-1)),s('div',Fr,[s('pre',null,c(a.generatedPrompt),1),s('button',{class:'copy-btn-abs',onClick:a.copyPrompt},[...n[69]||(n[69]=[s('i',{class:'fa-solid fa-copy'},null,-1)])])])])):r('',!0)])):r('',!0)])]),C(a.AIModifyDialog,{show:a.showStructureModifyDialog,'is-modifying':a.isModifyingStructure,title:'AI 修改 [InitVar] 结构',description:'告诉 AI 你想如何修改当前的 MVU 结构',examples:['增加一个【健康值】字段，类型为 number','删除【背包】字段','将【好感度】的描述改为更详细的说明','调整字段顺序，把【时间】放到最前面'],onClose:n[39]||(n[39]=e=>a.showStructureModifyDialog=!1),onConfirm:a.modifyStructureWithAI},null,8,['show','is-modifying']),C(a.AIModifyDialog,{show:a.showPromptModifyDialog,'is-modifying':a.isModifyingPrompt,title:'AI 修改 COT 提示词',description:'告诉 AI 你想如何修改当前的提示词',examples:['在 STEP 2 中添加对场景变化的检查','强调时间必须精确到分钟','增加对特殊状态的处理说明','简化 STEP 3 的分析步骤'],onClose:n[40]||(n[40]=e=>a.showPromptModifyDialog=!1),onConfirm:a.modifyPromptWithAI},null,8,['show','is-modifying'])],64)}],['__scopeId','data-v-27231230'],['__file','MvuBetaTab.vue']]),Ur=e({__name:'ProgressDialog',props:{show:{type:Boolean},title:{default:'AI 正在处理'},initialMessage:{default:'正在准备...'},cancellable:{type:Boolean,default:!1}},emits:['cancel'],setup(e,{expose:a}){const o=e,r=n(0),i=n(0),s=n(o.initialMessage),l=n([]),d=n(0),c=n(0);let p=null,u=null;function g(e){r.value=Math.min(100,Math.max(0,e))}function f(e){s.value=e}function m(e){l.value.push(e),setTimeout(()=>{const e=document.querySelector('.details-area');e&&(e.scrollTop=e.scrollHeight)},50)}function x(){l.value=[]}function h(){r.value=100,s.value='完成！'}t(()=>o.show,e=>{e?(r.value=0,i.value=0,s.value=o.initialMessage,l.value=[],d.value=Date.now(),c.value=0,p&&clearInterval(p),p=window.setInterval(()=>{c.value=Math.floor((Date.now()-d.value)/1e3)},1e3),u&&clearInterval(u),u=window.setInterval(()=>{if(i.value<r.value){const e=r.value-i.value;i.value+=Math.max(.5,.1*e),i.value>r.value&&(i.value=r.value)}else r.value<95&&i.value>=r.value-.5&&(i.value+=.2,i.value>r.value+5&&(i.value=r.value+5))},100)):(p&&(clearInterval(p),p=null),u&&(clearInterval(u),u=null))}),O(()=>{p&&clearInterval(p),u&&clearInterval(u)}),a({setProgress:g,setMessage:f,addDetail:m,clearDetails:x,complete:h});const b={props:o,progress:r,displayProgress:i,currentMessage:s,details:l,startTime:d,elapsedSeconds:c,get elapsedInterval(){return p},set elapsedInterval(e){p=e},get smoothProgressInterval(){return u},set smoothProgressInterval(e){u=e},setProgress:g,setMessage:f,addDetail:m,clearDetails:x,complete:h};return Object.defineProperty(b,'__isScriptSetup',{enumerable:!1,value:!0}),b}}),Jr={key:0,class:'progress-overlay',style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.85)',display:'flex','align-items':'center','justify-content':'center','z-index':'999999',animation:'fadeIn 0.2s ease'}},Br={class:'progress-card',style:{background:'linear-gradient(145deg, #2a2a2a, #1e1e1e)','border-radius':'16px',padding:'35px',width:'520px','max-width':'90vw','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',border:'1px solid #3a3a3a',animation:'slideUp 0.3s ease'}},Wr={style:{display:'flex','align-items':'center',gap:'12px','margin-bottom':'24px'}},Gr={style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600'}},Yr={class:'progress-bar-container',style:{width:'100%',height:'10px',background:'rgba(30, 30, 30, 0.8)','border-radius':'5px',overflow:'hidden','margin-bottom':'20px','box-shadow':'inset 0 1px 3px rgba(0, 0, 0, 0.3)'}},Zr={class:'current-stage',style:{color:'#e0e0e0','font-size':'14px','margin-bottom':'12px','min-height':'20px'}},qr={key:0,class:'details-area',style:{'max-height':'150px','overflow-y':'auto',background:'rgba(10, 10, 10, 0.5)','border-radius':'8px',padding:'12px','margin-bottom':'16px','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'11px',color:'#a0a0a0','line-height':'1.6'}},Xr={style:{display:'flex','justify-content':'space-between','align-items':'center'}},Kr={class:'progress-percent',style:{color:'#4a9eff','font-size':'16px','font-weight':'600'}},Qr={class:'elapsed-time',style:{color:'#888','font-size':'12px'}};const ei=a(Ur,[['render',function(e,n,t,a,l,p){return t.show?(i(),o('div',Jr,[s('div',Br,[s('div',Wr,[n[3]||(n[3]=s('div',{class:'spinner',style:{width:'28px',height:'28px',border:'3px solid #3a3a3a','border-top-color':'#4a9eff','border-radius':'50%',animation:'spin 0.8s linear infinite'}},null,-1)),s('h3',Gr,c(t.title),1)]),s('div',Yr,[s('div',{class:'progress-bar',style:g({width:a.displayProgress+'%',height:'100%',background:'#4a9eff',transition:'width 0.5s ease-out',boxShadow:'0 0 10px rgba(74, 158, 255, 0.5)'})},null,4)]),s('div',Zr,c(a.currentMessage),1),a.details.length>0?(i(),o('div',qr,[(i(!0),o(m,null,x(a.details,(e,t)=>(i(),o('div',{key:t,style:{'margin-bottom':'4px'}},[n[4]||(n[4]=s('span',{style:{color:'#4a9eff'}},'•',-1)),d(' '+c(e),1)]))),128))])):r('',!0),s('div',Xr,[s('div',Kr,c(Math.round(a.displayProgress))+'% ',1),s('div',Qr,'已耗时: '+c(a.elapsedSeconds)+'秒',1)]),t.cancellable?(i(),o('button',{key:1,style:{width:'100%','margin-top':'20px',padding:'10px',background:'#3a3a3a',border:'1px solid #4a4a4a','border-radius':'8px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s'},onMouseenter:n[0]||(n[0]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[1]||(n[1]=e=>e.currentTarget.style.background='#3a3a3a'),onClick:n[2]||(n[2]=n=>e.$emit('cancel'))},' 取消 ',32)):r('',!0)])])):r('',!0)}],['__scopeId','data-v-e188e1f6'],['__file','ProgressDialog.vue']]),ni=e({__name:'ProjectManager',setup(e,{expose:a}){a();const o=n([]),r=n(''),i=n(''),s=n(''),l=n(''),d=n(!1),c=n(''),p=n(!1),u=n(!1),g=n(''),f=n(!1),m=n([]),x=n('after'),h=n(!1),y=n({}),k=n(!1),I=n(null),A=v(),C=n(!1),E=n(!1),P=n(''),O=n(''),N=n(''),H=n(null),L=w(()=>o.value.find(e=>e.id===r.value)),F=w(()=>y.value[r.value]||[]),V=w(()=>{if(0===m.value.length)return'';const e=L.value;if(!e)return'';return J(e.files.map(e=>{const n=m.value.find(n=>n.path===e.path);return{...e,content:n?'after'===x.value?n.newContent:n.oldContent:e.content}}))}),U={'同层对话界面':{name:'同层对话界面',description:'流式对话、消息历史、正则清理',icon:'💬',color:'#4a9eff',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>同层对话界面</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="chat-container">\n      <div class="message-list" id="messageList"></div>\n      <div class="input-area">\n        <textarea id="userInput" placeholder="输入消息..."></textarea>\n        <button id="sendBtn">发送</button>\n      </div>\n    </div>\n  </div>\n  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"><\/script>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n}\n\n.chat-container {\n  max-width: 800px;\n  margin: 20px auto;\n  height: calc(100vh - 40px);\n  display: flex;\n  flex-direction: column;\n  background: #2a2a2a;\n  border-radius: 12px;\n  overflow: hidden;\n}\n\n.message-list {\n  flex: 1;\n  padding: 20px;\n  overflow-y: auto;\n}\n\n.message {\n  margin-bottom: 15px;\n  padding: 10px 15px;\n  border-radius: 8px;\n  max-width: 70%;\n}\n\n.message.user {\n  background: #4a9eff;\n  margin-left: auto;\n  text-align: right;\n}\n\n.message.assistant {\n  background: #3a3a3a;\n}\n\n.input-area {\n  padding: 15px;\n  background: #2a2a2a;\n  border-top: 1px solid #3a3a3a;\n  display: flex;\n  gap: 10px;\n}\n\n#userInput {\n  flex: 1;\n  padding: 10px;\n  background: #1a1a1a;\n  border: 1px solid #3a3a3a;\n  border-radius: 6px;\n  color: #e0e0e0;\n  resize: none;\n  height: 60px;\n}\n\n#sendBtn {\n  padding: 10px 20px;\n  background: #4a9eff;\n  border: none;\n  border-radius: 6px;\n  color: white;\n  cursor: pointer;\n  font-weight: 600;\n}\n\n#sendBtn:hover {\n  background: #357abd;\n}','script.js':'// 聊天历史\nlet chatHistory = [];\n\n// 从 localStorage 加载历史\nfunction loadHistory() {\n  try {\n    const saved = localStorage.getItem(\'chat_history_demo\');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } catch (e) {\n    console.error(\'加载历史失败:\', e);\n    chatHistory = [];\n  }\n  renderMessages();\n}\n\n// 保存到 localStorage\nfunction saveHistory() {\n  try {\n    localStorage.setItem(\'chat_history_demo\', JSON.stringify(chatHistory));\n  } catch (e) {\n    console.error(\'保存历史失败:\', e);\n  }\n}\n\n// 渲染消息\nfunction renderMessages() {\n  const list = document.getElementById(\'messageList\');\n  list.innerHTML = \'\';\n  chatHistory.forEach(msg => {\n    const div = document.createElement(\'div\');\n    div.className = \'message \' + msg.sender;\n    div.textContent = msg.content;\n    list.appendChild(div);\n  });\n  list.scrollTop = list.scrollHeight;\n}\n\n// 发送消息\nasync function sendMessage() {\n  const input = document.getElementById(\'userInput\');\n  const text = input.value.trim();\n  if (!text) return;\n\n  // 添加用户消息\n  chatHistory.push({\n    id: Date.now(),\n    sender: \'user\',\n    content: text,\n    timestamp: new Date().toLocaleTimeString()\n  });\n  input.value = \'\';\n  renderMessages();\n  saveHistory();\n\n  // 调用 AI（流式）\n  const prompt = \'【对话历史】\\n\' + chatHistory.map(m => m.sender + \': \' + m.content).join(\'\\n\');\n\n  let aiText = \'\';\n  await generate({\n    should_stream: true,\n    prompt: prompt,\n    on_stream_chunk: (chunk) => {\n      aiText += chunk;\n      // 实时显示\n      const tempMsg = { id: \'temp\', sender: \'assistant\', content: aiText };\n      const tempIndex = chatHistory.findIndex(m => m.id === \'temp\');\n      if (tempIndex >= 0) {\n        chatHistory[tempIndex] = tempMsg;\n      } else {\n        chatHistory.push(tempMsg);\n      }\n      renderMessages();\n    },\n    on_stream_end: () => {\n      // 完成，替换为正式消息\n      const tempIndex = chatHistory.findIndex(m => m.id === \'temp\');\n      if (tempIndex >= 0) {\n        chatHistory[tempIndex] = {\n          id: Date.now(),\n          sender: \'assistant\',\n          content: aiText,\n          timestamp: new Date().toLocaleTimeString()\n        };\n      }\n      renderMessages();\n      saveHistory();\n    }\n  });\n}\n\n// 初始化\n$(() => {\n  loadHistory();\n  document.getElementById(\'sendBtn\').addEventListener(\'click\', sendMessage);\n  document.getElementById(\'userInput\').addEventListener(\'keydown\', (e) => {\n    if (e.key === \'Enter\' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n});'}},'状态栏面板':{name:'状态栏面板',description:'HP/MP/经验值，进度条动画',icon:'📊',color:'#10b981',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>状态栏</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="status-panel">\n      <h2>角色状态</h2>\n      <div class="stat-item">\n        <label>生命值 (HP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill hp" id="hpBar"></div>\n        </div>\n        <span id="hpText">0/0</span>\n      </div>\n      <div class="stat-item">\n        <label>魔法值 (MP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill mp" id="mpBar"></div>\n        </div>\n        <span id="mpText">0/0</span>\n      </div>\n      <div class="stat-item">\n        <label>经验值 (EXP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill exp" id="expBar"></div>\n        </div>\n        <span id="expText">0/0</span>\n      </div>\n    </div>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n  padding: 20px;\n}\n\n.status-panel {\n  max-width: 500px;\n  margin: 0 auto;\n  background: #2a2a2a;\n  border-radius: 12px;\n  padding: 25px;\n  border: 1px solid #3a3a3a;\n}\n\nh2 {\n  margin-bottom: 20px;\n  color: #4a9eff;\n}\n\n.stat-item {\n  margin-bottom: 20px;\n}\n\n.stat-item label {\n  display: block;\n  margin-bottom: 8px;\n  font-weight: 600;\n  font-size: 14px;\n}\n\n.progress-bar {\n  width: 100%;\n  height: 24px;\n  background: #1a1a1a;\n  border-radius: 12px;\n  overflow: hidden;\n  margin-bottom: 5px;\n}\n\n.progress-fill {\n  height: 100%;\n  transition: width 0.5s ease;\n  border-radius: 12px;\n}\n\n.progress-fill.hp {\n  background: linear-gradient(90deg, #ef4444, #10b981);\n}\n\n.progress-fill.mp {\n  background: linear-gradient(90deg, #3b82f6, #06b6d4);\n}\n\n.progress-fill.exp {\n  background: linear-gradient(90deg, #fbbf24, #f59e0b);\n}\n\n.stat-item span {\n  font-size: 13px;\n  color: #94a3b8;\n}','script.js':'// 从 localStorage 加载数据\nfunction loadStats() {\n  const saved = localStorage.getItem(\'rpg_stats_demo\');\n  const data = saved ? JSON.parse(saved) : {};\n\n  const hp = data.hp || 850;\n  const maxHp = data.maxHp || 1000;\n  const mp = data.mp || 340;\n  const maxMp = data.maxMp || 500;\n  const exp = data.exp || 1250;\n  const maxExp = data.maxExp || 2000;\n\n  // 更新进度条\n  updateBar(\'hp\', hp, maxHp);\n  updateBar(\'mp\', mp, maxMp);\n  updateBar(\'exp\', exp, maxExp);\n}\n\nfunction updateBar(type, current, max) {\n  const percent = (current / max) * 100;\n  document.getElementById(type + \'Bar\').style.width = percent + \'%\';\n  document.getElementById(type + \'Text\').textContent = current + \'/\' + max;\n}\n\n// 初始化\ndocument.addEventListener(\'DOMContentLoaded\', loadStats);'}},'好感度面板':{name:'好感度面板',description:'多角色卡片，爱心图标，好感度展示',icon:'💝',color:'#ec4899',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>好感度面板</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="affection-container">\n      <h2>角色好感度</h2>\n      <div class="character-grid" id="characterGrid"></div>\n    </div>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n  padding: 20px;\n}\n\n.affection-container {\n  max-width: 900px;\n  margin: 0 auto;\n}\n\nh2 {\n  margin-bottom: 25px;\n  color: #ec4899;\n  text-align: center;\n}\n\n.character-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n  gap: 20px;\n}\n\n.character-card {\n  background: #2a2a2a;\n  border-radius: 12px;\n  padding: 20px;\n  border: 2px solid #3a3a3a;\n  transition: all 0.3s ease;\n}\n\n.character-card:hover {\n  transform: translateY(-5px);\n  border-color: #ec4899;\n  box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3);\n}\n\n.character-name {\n  font-size: 18px;\n  font-weight: 600;\n  margin-bottom: 15px;\n  color: #e0e0e0;\n}\n\n.affection-bar {\n  width: 100%;\n  height: 20px;\n  background: #1a1a1a;\n  border-radius: 10px;\n  overflow: hidden;\n  margin-bottom: 8px;\n}\n\n.affection-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #ec4899, #f472b6);\n  transition: width 0.5s ease;\n  border-radius: 10px;\n}\n\n.affection-text {\n  font-size: 13px;\n  color: #94a3b8;\n}','script.js':'// 从 localStorage 加载角色数据\nfunction loadCharacters() {\n  const saved = localStorage.getItem(\'characters_affection_demo\');\n  const data = saved ? JSON.parse(saved) : {};\n  const characters = data.characters || [\n    { name: \'角色 A\', affection: 75 },\n    { name: \'角色 B\', affection: 50 },\n    { name: \'角色 C\', affection: 90 }\n  ];\n\n  const grid = document.getElementById(\'characterGrid\');\n  grid.innerHTML = \'\';\n\n  characters.forEach(char => {\n    const card = document.createElement(\'div\');\n    card.className = \'character-card\';\n    card.innerHTML = `\n      <div class="character-name">${char.name}</div>\n      <div class="affection-bar">\n        <div class="affection-fill" style="width: ${char.affection}%"></div>\n      </div>\n      <div class="affection-text">好感度: ${char.affection}/100</div>\n    `;\n    grid.appendChild(card);\n  });\n}\n\n// 初始化\ndocument.addEventListener(\'DOMContentLoaded\', loadCharacters);'}}};function J(e){const n=e.find(e=>e.path.endsWith('.html')),t=e.find(e=>e.path.endsWith('.css')),a=e.find(e=>e.path.endsWith('.js'));if(!n)return'';const o=n.content,r='head',i='body',s=o.match(new RegExp(`<${r}[^>]*>([\\s\\S]*?)</${r}>`,'i')),l=o.match(new RegExp(`<${i}[^>]*>([\\s\\S]*?)</${i}>`,'i'));let d=s?s[1]:'',c=l?l[1]:o;const p=new RegExp('<script[^>]*><\/script>','gi');d=d.replace(/<link[^>]*rel=["']stylesheet["'][^>]*>/gi,''),c=c.replace(p,'');const u='script',g='style';return`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  ${d}\n  <${g}>\n    html, body {\n      margin: 0 !important;\n      padding: 0 !important;\n      width: 100% !important;\n      height: auto !important;\n      min-height: 800px !important;\n      overflow: visible !important;\n    }\n    ${t?.content||''}\n  </${g}>\n  <${u} src="https://code.jquery.com/jquery-3.7.1.min.js"></${u}>\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></${u}>\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></${u}>\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></${u}>\n</head>\n<body>\n  ${c}\n  <${u}>${a?.content||''}</${u}>\n</body>\n</html>`}function B(){const e=L.value;l.value=e?J(e.files):''}function W(){try{const e=SillyTavern.chatId;console.log('保存数据到 localStorage，聊天 ID:',e);const n={frontend_projects_files:o.value,frontend_ai_history:y.value},t=T(),a=e?`${t}_frontend_projects_${e}`:`${t}_frontend_projects_global`;localStorage.setItem(a,JSON.stringify(n)),console.log('保存成功到 localStorage！',n.frontend_projects_files.length,'个项目')}catch(e){console.error('保存失败:',e)}}function G(){try{const n=R();console.log('正在从 localStorage 加载数据，聊天 ID:',n);const t=T(),a=n?`${t}_frontend_projects_${n}`:`${t}_frontend_projects_global`,r=localStorage.getItem(a);let i=null;if(r)try{i=JSON.parse(r),console.log('从 localStorage 读取到的数据:',i)}catch(e){console.error('解析 localStorage 数据失败:',e)}i?.frontend_projects_files&&Array.isArray(i.frontend_projects_files)?(o.value=i.frontend_projects_files,console.log('成功加载项目:',o.value.length,'个')):(console.log('没有找到已保存的项目数据'),o.value=[]),i?.frontend_ai_history?(y.value=i.frontend_ai_history,console.log('成功加载历史记录')):y.value={}}catch(n){console.error('加载失败:',n)}}G(),t(()=>R(),()=>{G(),r.value='',i.value='',s.value='',l.value=''});let Y=null;j(()=>{if(i.value&&void 0!==s.value){const e=L.value;if(e){const n=e.files.find(e=>e.path===i.value);n&&n.content!==s.value&&(n.content=s.value,Y&&clearTimeout(Y),Y=setTimeout(()=>{W(),console.log('自动保存:',i.value)},1e3))}}});let Z=null;function q(){d.value=!1,c.value=''}function X(){h.value=!1}t(()=>[i.value,s.value],()=>{Z&&clearTimeout(Z),Z=setTimeout(B,500)},{deep:!0}),D(()=>{if(console.log('组件卸载，保存数据...'),Y&&clearTimeout(Y),Z&&clearTimeout(Z),i.value&&void 0!==s.value){const e=L.value;if(e){const n=e.files.find(e=>e.path===i.value);n&&(n.content=s.value)}}W(),console.log('数据已保存')});const K={projects:o,currentId:r,currentFile:i,code:s,previewHtml:l,showAI:d,aiPrompt:c,aiGenerating:p,enableStream:u,streamingText:g,showComparison:f,aiChanges:m,previewMode:x,showHistory:h,aiHistory:y,quickSuggestions:['添加响应式布局，支持移动端和桌面端','添加深色/浅色主题切换功能','优化代码结构，提取可复用组件','添加加载动画和骨架屏','添加表单验证和错误提示','优化性能，减少不必要的渲染','添加键盘快捷键支持','改进无障碍访问（ARIA）'],showProgress:k,progressDialogRef:I,taskStore:A,showProjectTemplate:C,showBugFix:E,bugDescription:P,consoleError:O,bugFile:N,folderInputRef:H,currentProject:L,currentProjectHistory:F,comparisonPreviewHtml:V,projectTemplates:U,showProjectTemplateDialog:function(){C.value=!0},createProjectFromTemplate:function(e){const n=U[e];if(!n)return;const t=prompt('项目名称:',n.name);if(!t||!t.trim())return;const a={id:Date.now().toString(),name:t.trim(),files:Object.entries(n.files).map(([e,n])=>({path:e,name:e,content:n}))};o.value.push(a),r.value=a.id,i.value=a.files[0]?.name||'',s.value=a.files[0]?.content||'',W(),C.value=!1,window.toastr.success('✅ 项目"'+t.trim()+'"创建成功！')},triggerFolderImport:function(){H.value&&(H.value.value='',H.value.click())},handleFolderImport:async function(e){const n=e.target.files;if(n&&0!==n.length)try{const e=n[0],t=e.webkitRelativePath.split('/')[0]||'导入的项目',a=prompt('项目名称:',t);if(!a||!a.trim())return;const l=['.html','.css','.js','.ts','.scss','.sass','.json','.txt','.md'],d=[],c=[];for(let o=0;o<n.length;o++){const e=n[o],t=e.webkitRelativePath.split('/').slice(1).join('/');if(!t||t.startsWith('.')||t.includes('/.'))continue;if(t.includes('node_modules/')||t.includes('dist/')||t.includes('.git/')||t.includes('build/'))continue;const a='.'+t.split('.').pop()?.toLowerCase();if(!l.includes(a))continue;const r=new Promise((n,a)=>{const o=new FileReader;o.onload=e=>{const a=e.target?.result,o=t.split('/').pop()||t;d.push({path:t,name:o,content:a||''}),n()},o.onerror=()=>a(new Error(`读取文件失败: ${t}`)),o.readAsText(e)});c.push(r)}if(await Promise.all(c),0===d.length)return void window.toastr.warning('未找到可导入的文件（支持的格式：HTML、CSS、JS、TS、SCSS 等）');const p={id:Date.now().toString(),name:a.trim(),files:d};o.value.push(p),r.value=p.id,i.value=p.files[0]?.path||'',s.value=p.files[0]?.content||'',W(),B(),window.toastr.success(`成功导入项目"${a}"，共 ${d.length} 个文件`)}catch(t){console.error('导入文件夹失败:',t),window.toastr.error('导入文件夹失败: '+t.message)}},createProject:function(){const e=prompt('项目名称:');if(!e||!e.trim())return;const n=`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${e.trim()}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div class="container">\n    <h1>欢迎来到 ${e.trim()}!</h1>\n    <p>开始你的创作之旅</p>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>`,t={id:Date.now().toString(),name:e.trim(),files:[{path:'index.html',name:'index.html',content:n},{path:'style.css',name:'style.css',content:'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: #333;\n  min-height: 100vh;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.container {\n  background: white;\n  padding: 60px 40px;\n  border-radius: 20px;\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n  text-align: center;\n  max-width: 600px;\n}\n\nh1 {\n  font-size: 2.5em;\n  color: #667eea;\n  margin-bottom: 20px;\n}\n\np {\n  font-size: 1.2em;\n  color: #666;\n  line-height: 1.6;\n}'},{path:'script.js',name:'script.js',content:'console.log(\'项目已启动！\');\n\n// 使用 jQuery 确保 DOM 加载完成\n$(function() {\n  console.log(\'页面加载完成\');\n\n  // ========== 检测是否在酒馆环境中 ==========\n  const isInTavern = typeof SillyTavern !== \'undefined\';\n\n  if (!isInTavern) {\n    console.log(\'预览模式：当前在预览窗口中，酒馆 API 不可用\');\n  }\n\n  // ========== 数据持久化示例（使用 localStorage）==========\n  const storageKey = \'my_project_data\'; // 自定义存储键名\n\n  // 加载数据\n  function loadData() {\n    try {\n      const stored = localStorage.getItem(storageKey);\n      return stored ? JSON.parse(stored) : { count: 0 };\n    } catch (e) {\n      console.error(\'加载数据失败:\', e);\n      return { count: 0 };\n    }\n  }\n\n  // 保存数据到 localStorage\n  function saveData(data) {\n    try {\n      localStorage.setItem(storageKey, JSON.stringify(data));\n      console.log(\'数据已保存到 localStorage:\', data);\n    } catch (e) {\n      console.error(\'保存数据失败:\', e);\n    }\n  }\n\n  // 初始化\n  let myData = loadData();\n  console.log(\'加载的数据:\', myData);\n\n  // ========== 示例：点击计数器 ==========\n  const container = $(\'.container\');\n  if (container.length) {\n    container.on(\'click\', function() {\n      myData.count++;\n      saveData(myData);\n      if (typeof toastr !== \'undefined\') {\n        toastr.success(`点击次数: ${myData.count}`);\n      } else {\n        alert(`点击次数: ${myData.count}`);\n      }\n    });\n  }\n\n  // 页面卸载时保存（可选）\n  $(window).on(\'pagehide\', function() {\n    saveData(myData);\n  });\n});'}]};o.value.push(t),console.log('新建项目:',t.name,'项目总数:',o.value.length),W(),r.value=t.id,i.value='index.html',s.value=n,B(),toastr.success(`项目 "${t.name}" 已创建并保存`)},selectProject:function(e){r.value=e;const n=L.value;n&&n.files.length>0?(i.value=n.files[0].path,s.value=n.files[0].content,B()):(i.value='',s.value='',l.value='')},selectFile:function(e){i.value=e;const n=L.value;if(n){const t=n.files.find(n=>n.path===e);t&&(s.value=t.content)}},saveCode:function(){const e=L.value;if(!e||!i.value)return void toastr.error('请先选择一个文件');const n=e.files.find(e=>e.path===i.value);n&&(n.content=s.value,Y&&(clearTimeout(Y),Y=null),W(),B(),toastr.success('已保存'))},deleteProject:function(e){const n=o.value.find(n=>n.id===e);n&&confirm(`确定删除项目 "${n.name}" 吗？`)&&(o.value=o.value.filter(n=>n.id!==e),console.log('删除项目后，剩余项目数:',o.value.length),r.value===e&&(r.value='',i.value='',s.value='',l.value=''),W(),toastr.success(`项目 "${n.name}" 已删除`))},createNewFolder:function(){const e=L.value;if(!e)return;const n=prompt('请输入文件夹路径：\n例如：css 或 js/utils','');if(!n||!n.trim())return;const t=n.trim().replace(/\/$/,''),a=`${t}/.gitkeep`;if(e.files.some(e=>e.path.startsWith(`${t}/`)))return void window.toastr.warning(`文件夹 "${t}" 已存在（包含文件）`);const o={path:a,name:'.gitkeep',content:'# 此文件用于保持文件夹结构\n'};e.files.push(o),W(),window.toastr.success(`文件夹 "${t}" 已创建`)},showNewFileDialog:function(){const e=L.value;if(!e)return;const n=new Set;n.add(''),e.files.forEach(e=>{const t=e.path.split('/');if(t.length>1)for(let a=1;a<t.length;a++){const e=t.slice(0,a).join('/');e&&n.add(e)}});const t=Array.from(n).sort(),a=[{name:'HTML 文件',ext:'.html',icon:'🌐'},{name:'CSS 文件',ext:'.css',icon:'🎨'},{name:'JavaScript 文件',ext:'.js',icon:'⚡'},{name:'TypeScript 文件',ext:'.ts',icon:'📘'},{name:'JSON 文件',ext:'.json',icon:'📄'},{name:'Markdown 文件',ext:'.md',icon:'📝'},{name:'其他文件',ext:'',icon:'📋'}],o=a.map((e,n)=>`${n+1}. ${e.icon} ${e.name} (${e.ext||'自定义'})`).join('\n'),r=prompt(`请选择文件类型（输入序号 1-${a.length}）：\n\n${o}`,'1');if(!r)return;const l=parseInt(r)-1;if(l<0||l>=a.length)return void window.toastr.error('无效的选项');const d=a[l];let c='';if(t.length>1){const e=t.length>5?'输入文件夹路径（留空为根目录）：':`请选择目标文件夹（输入序号）：\n\n${t.map((e,n)=>`${n+1}. ${e||'根目录'}`).join('\n')}\n\n或直接输入文件夹路径：`,n=prompt(e,'1');if(!n)return;const a=parseInt(n)-1;c=a>=0&&a<t.length?t[a]:n.trim().replace(/\/$/,'')}const p=prompt(`请输入文件名${d.ext?`（将自动添加 ${d.ext}）`:'（需包含扩展名）'}：`,d.ext?'new-file':'newfile.txt');if(!p||!p.trim())return;let u=p.trim();d.ext&&!u.endsWith(d.ext)&&(u+=d.ext);const g=c?`${c}/${u}`:u;if(e.files.some(e=>e.path===g))return void window.toastr.error(`文件 "${g}" 已存在！`);const f=u.split('.').pop()?.toLowerCase();let m='';switch(f){case'html':m='<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>'+u.replace('.html','')+'</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div class="container">\n    <h1>欢迎</h1>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>';break;case'css':case'scss':case'sass':m=`/* ${u} */\n\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n`;break;case'js':case'ts':m=`// ${u}\n\nconsole.log('${u} 已加载');\n\n$(function() {\n  // 在这里编写代码\n});\n`;break;case'json':m=`{\n  "name": "${u.replace('.json','')}",\n  "version": "1.0.0"\n}`;break;case'md':m=`# ${u.replace(/\.md$/,'')}\n\n`;break;default:m=''}const x={path:g,name:u,content:m};e.files.push(x),i.value=g,s.value=m,W(),B(),window.toastr.success(`文件 "${g}" 已创建`)},deleteFile:function(e){const n=L.value;if(!n)return;const t=n.files.find(n=>n.path===e);t&&confirm(`确定删除文件 "${t.path}" 吗？`)&&(n.files=n.files.filter(n=>n.path!==e),i.value===e&&(n.files.length>0?(i.value=n.files[0].path,s.value=n.files[0].content):(i.value='',s.value='')),W(),B(),window.toastr.success(`文件 "${t.path}" 已删除`))},getFileIcon:function(e){const n=e.split('.').pop()?.toLowerCase();return'html'===n?'fa-brands fa-html5':'css'===n?'fa-brands fa-css3-alt':'js'===n?'fa-brands fa-js':'fa-solid fa-file-code'},buildPreviewFromFiles:J,updatePreview:B,saveToChatVar:W,loadFromChatVar:G,get autoSaveTimer(){return Y},set autoSaveTimer(e){Y=e},get previewTimer(){return Z},set previewTimer(e){Z=e},showAIDialog:function(){d.value=!0,c.value=''},closeAIDialog:q,showBugFixDialog:function(){E.value=!0,P.value='',O.value='',N.value=''},closeBugFixDialog:function(){E.value=!1,P.value='',O.value='',N.value=''},fixBugWithAI:async function(){const e=L.value;if(!e)return void window.toastr.error('请先选择项目');if(!P.value.trim())return void window.toastr.error('请描述问题');p.value=!0,k.value=!0;let n='';const t=A.createTask('ui_modify',`🐛 修复 Bug: ${P.value.slice(0,30)}...`);try{I.value?.setProgress(5),I.value?.setMessage('正在准备 Bug 修复请求...'),A.updateTaskProgress(t,5,'正在准备 Bug 修复请求...'),await new Promise(e=>setTimeout(e,100));if(!T())throw new Error('无法获取脚本 ID');const a=b().settings,o=a.api_endpoint,r=a.api_key,i=a.model||'gpt-4o-mini';if(!o||!r)throw new Error('请先在"设置"标签中配置 API');n=M(o),I.value?.setProgress(15),I.value?.setMessage('正在构建 Bug 修复提示词...'),A.updateTaskProgress(t,15,'正在构建 Bug 修复提示词...'),await new Promise(e=>setTimeout(e,100));const s='你是专业的前端 Bug 修复专家。\n\n# 修复要求\n\n1. **专注性**：只修复用户描述的具体问题，不要改动其他功能\n2. **最小化改动**：只修改必要的代码，保持其他部分不变\n3. **精准定位**：优先根据 Console 错误信息定位问题\n4. **保持风格**：修复后的代码要保持原有的命名、格式、缩进风格\n\n# 常见 Bug 类型和修复策略\n\n**点击无响应：**\n- 检查事件绑定是否正确（ID 是否匹配）\n- 检查函数是否在 `$(function() {})` 内正确定义\n- 检查是否有 JavaScript 错误阻止了执行\n\n**显示异常：**\n- 检查 CSS 样式（display、visibility、z-index）\n- 检查 DOM 结构是否正确\n- 检查数据绑定是否正常\n\n**数据保存失败：**\n- 检查 insertOrAssignVariables 调用\n- 检查数据格式是否正确\n- 检查变量作用域\n\n**逻辑错误：**\n- 检查条件判断\n- 检查异步处理\n- 检查变量作用域\n\n# 输出格式\n\n只输出需要修改的文件，使用以下格式：\n\n```\nFILE_START: 文件名\n[修改后的完整文件内容，并在关键修复位置添加注释]\nFILE_END\n```\n\n不要输出任何其他文字或解释！',l=`# 当前项目文件：\n${e.files.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n')}\n\n# Bug 描述：\n${P.value}\n\n${O.value.trim()?`# Console 错误信息：\n\`\`\`\n${O.value}\n\`\`\`\n`:''}\n\n${N.value?`# 问题可能在文件：\n${N.value}\n`:''}\n\n# 修复要求：\n1. 专注修复上述 bug，不要改其他地方\n2. 只输出需要修改的文件\n3. 在修复的关键位置添加注释说明修复内容\n4. 保持代码风格一致\n\n请严格按 system 中的格式输出，不要添加解释！`;I.value?.setProgress(25),I.value?.setMessage('正在发送请求到 AI 服务器...'),A.updateTaskProgress(t,25,'正在发送请求到 AI 服务器...'),await new Promise(e=>setTimeout(e,100)),I.value?.setProgress(30),I.value?.setMessage('等待 AI 分析 bug...'),A.updateTaskProgress(t,30,'等待 AI 分析 bug...'),await new Promise(e=>setTimeout(e,100));const d=await fetch(n,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r}`},body:JSON.stringify({model:i,messages:[{role:'system',content:s},{role:'user',content:l}],temperature:.3})});if(!d.ok){const e=await d.text();throw new Error(`API 请求失败 (${d.status}): ${e}`)}I.value?.setProgress(60),I.value?.setMessage('正在接收 AI 修复方案...'),A.updateTaskProgress(t,60,'正在接收 AI 修复方案...'),await new Promise(e=>setTimeout(e,100));const c=await d.json(),p=c.choices?.[0]?.message?.content||'';if(!p)throw new Error('AI 未返回修复方案');I.value?.setProgress(75),I.value?.setMessage('正在解析修复方案...'),A.updateTaskProgress(t,75,'正在解析修复方案...'),await new Promise(e=>setTimeout(e,100));const u=/FILE_START:\s*(.+?)\s*\n([\s\S]*?)\nFILE_END/g,g=[];let h;for(;null!==(h=u.exec(p));){const n=h[1].trim(),t=h[2].trim(),a=e.files.find(e=>e.path===n);a&&g.push({path:n,oldContent:a.content,newContent:t})}if(0===g.length)throw new Error('AI 未返回有效的修复方案');I.value?.setProgress(85),I.value?.setMessage('正在准备对比预览...'),A.updateTaskProgress(t,85,'正在准备对比预览...'),await new Promise(e=>setTimeout(e,100)),y.value[e.id]||(y.value[e.id]=[]),y.value[e.id].unshift({timestamp:(new Date).toISOString(),prompt:`Bug 修复: ${P.value}`,changes:S(g)}),m.value=g,f.value=!0,x.value='after',I.value?.setProgress(95),I.value?.setMessage(`Bug 修复方案已生成 (${g.length} 个文件)`),A.updateTaskProgress(t,95,`Bug 修复方案已生成 (${g.length} 个文件)`),await new Promise(e=>setTimeout(e,100)),I.value?.setProgress(100),I.value?.setMessage('Bug 修复方案已生成！'),A.updateTaskProgress(t,100,'Bug 修复方案已生成！'),A.completeTask(t,{changedFiles:g.length}),setTimeout(()=>{k.value=!1,E.value=!1,window.toastr.success('AI 已生成修复方案，请在对比窗口中查看')},800)}catch(a){console.error('Bug 修复失败:',a);const e=a?.message||String(a);window.toastr.error(`Bug 修复失败: ${e}`),A.failTask(t,e),k.value=!1}finally{p.value=!1}},generateWithAI:async function(){if(!c.value.trim()||p.value)return;const e=L.value;if(!e)return void toastr.error('请先选择一个项目');const n=c.value.trim();if(['完善','优化','改进','美化','修改','调整','更新'].some(e=>new RegExp(`^${e}[一下了吧呗啊吗。！？\\s]*$`,'i').test(n)))return void toastr.warning('请详细描述你的需求！\n\n例如：\n❌ "优化一下"\n✅ "优化按钮样式，添加悬停动画和圆角效果"\n\n❌ "完善"\n✅ "添加响应式布局，支持移动端显示"','需求太模糊了',{timeOut:6e3});p.value=!0,k.value=!0;let t='';const a=A.createTask('ui_generate',`🤖 AI 生成: ${c.value.slice(0,30)}...`);try{I.value?.setProgress(5),I.value?.setMessage('正在准备 AI 请求...'),A.updateTaskProgress(a,5,'正在准备 AI 请求...'),await new Promise(e=>setTimeout(e,100));if(!T())return toastr.error('无法获取脚本 ID'),p.value=!1,void(k.value=!1);const n=b().settings,r=n.api_endpoint,i=n.api_key,s=n.model||'gpt-4o-mini',l=n.temperature||.7,d=n.max_tokens||4e3;if(!r||!i)return toastr.error('请先在"设置"标签页配置 API'),p.value=!1,void(k.value=!1);try{t=M(r),console.log('📍 原始端点:',r),console.log('🔗 规范化后的端点:',t)}catch(o){return toastr.error('API 端点格式不正确：'+o.message),p.value=!1,void(k.value=!1)}d<2e3&&toastr.warning(`当前 max_tokens 设置为 ${d}，可能导致 AI 返回内容被截断。建议设置为 4000 以上。`),I.value?.setProgress(15),I.value?.setMessage('正在构建提示词...'),A.updateTaskProgress(a,15,'正在构建提示词...'),await new Promise(e=>setTimeout(e,100));const h=`你是专业的前端开发助手。这是一个在 SillyTavern（酒馆）中运行的前端界面项目。\n\n# 当前项目文件：\n${e.files.map(e=>`- ${e.path}`).join('\n')}\n\n# 可用的 API 和库（可直接使用，无需导入）：\n## 第三方库：\n- jQuery ($): DOM 操作、事件处理\n- toastr: 消息提示\n- gsap: 动画效果\n- lodash (_): 工具函数\n- zod (z): 数据校验\n\n## 酒馆助手 API（全局可用）：\n**数据持久化（重要！）：**\n- \`getVariables({ type: 'chat' })\`: 获取聊天变量（对象形式）\n- \`insertOrAssignVariables(data, { type: 'chat' })\`: 保存数据到聊天变量（推荐用这个）\n- \`replaceVariables(data, { type: 'chat' })\`: 完全替换聊天变量\n\n**数据持久化示例代码：**\n\`\`\`javascript\n// ⚠️ 重要：需要检测是否在酒馆环境中（预览模式下酒馆 API 不可用）\nconst isInTavern = typeof SillyTavern !== 'undefined' && typeof getVariables !== 'undefined';\n\n// 加载数据\nfunction loadData() {\n  if (isInTavern) {\n    const data = getVariables({ type: 'chat' });\n    return data.my_key || { count: 0 };\n  } else {\n    // 预览模式：使用 localStorage\n    const stored = localStorage.getItem('my_key');\n    return stored ? JSON.parse(stored) : { count: 0 };\n  }\n}\n\n// 保存数据\nfunction saveData(data) {\n  if (isInTavern) {\n    insertOrAssignVariables({ my_key: data }, { type: 'chat' });\n  } else {\n    localStorage.setItem('my_key', JSON.stringify(data));\n  }\n}\n\n// 使用\nlet myData = loadData();\nmyData.count++;\nsaveData(myData);\n\`\`\`\n\n**其他 API：**\n- getChatMessages(): 获取当前聊天的所有消息\n- getCurrentCharacter(): 获取当前角色卡信息\n- getWorldbook(): 获取世界书\n- replaceWorldbook(data): 替换世界书\n- eventOn(event, callback): 监听酒馆事件\n- getIframeName(): 获取当前 iframe 名称\n- triggerSlash(command): 执行 STScript 命令\n- SillyTavern.getCurrentChatId(): 获取当前聊天 ID\n\n## 从消息中读取数据并更新界面\n\n**场景：** 创建状态栏界面，需要从最新的 AI 消息中提取角色状态并实时显示。\n\n**核心代码示例：**\n\n\`\`\`javascript\n// 1. 读取最新消息内容\nasync function updateStatusFromMessages() {\n  // 使用 TavernHelper 获取消息\n  if (typeof (window as any).TavernHelper === 'undefined' || \n      typeof (window as any).TavernHelper.getChatMessages !== 'function') {\n    return; // TavernHelper 不可用，跳过\n  }\n\n  const messages = (window as any).TavernHelper.getChatMessages('0-{{lastMessageId}}');\n  if (!messages || messages.length === 0) return;\n\n  // 获取最新的 AI 消息（从后往前找第一条 is_user: false）\n  const latestAIMessage = messages.slice().reverse().find(m => !m.is_user);\n  if (!latestAIMessage) return;\n\n  const content = latestAIMessage.mes; // 消息文本内容\n\n  // 2. 使用正则提取状态数据（示例：提取代码块中的状态）\n  const statusMatch = content.match(/\`\`\`json([\\s\\S]*?)\`\`\`/);\n  if (statusMatch) {\n    try {\n      const status = JSON.parse(statusMatch[1]);\n      // 3. 更新界面显示\n      $('#health').text(status.health || 100);\n      $('#level').text(status.level || 1);\n    } catch (e) {\n      console.error('解析状态失败:', e);\n    }\n  }\n\n  // 或者用正则直接提取特定格式（例如：【生命值：80】）\n  const healthMatch = content.match(/【生命值[：:](\\d+)】/);\n  if (healthMatch) {\n    $('#health').text(healthMatch[1]);\n  }\n}\n\n// 4. 页面加载时更新\n$(function() {\n  updateStatusFromMessages();\n});\n\n// 5. 监听新消息事件，自动更新（可选）\nif (typeof eventOn === 'function') {\n  eventOn('MESSAGE_RECEIVED', () => {\n    updateStatusFromMessages();\n  });\n}\n\`\`\`\n\n---\n\n## 🎯 状态栏 XML 美化（重要！）\n\n**场景：** AI 回复中包含 XML 格式的状态栏（如 \`<state_bar><i>【内容】</i></state_bar>\`），需要将其美化显示。\n\n**核心功能：**\n1. 提取 \`<state_bar>\` 标签内容\n2. 将 XML 标签转换为美化的 HTML\n3. 实时显示在界面上\n\n**完整实现示例：**\n\n\`\`\`typescript\n// ===== 1. 提取状态栏内容 =====\nfunction extractStateBar(text: string): string | null {\n  const match = text.match(/<state_bar>([\\s\\S]*?)<\\/state_bar>/i);\n  return match ? match[1].trim() : null;\n}\n\n// ===== 2. XML 转 HTML（支持多种标签格式）=====\nfunction convertXmlToHtml(xml: string): string {\n  let html = xml;\n\n  // 处理缩进标签：<i>、<2i>、<3i> 等\n  html = html.replace(/<i>([\\s\\S]*?)<\\/i>/g, '<div class="state-item indent-1">$1</div>');\n  html = html.replace(/<2i>([\\s\\S]*?)<\\/2i>/g, '<div class="state-item indent-2">$1</div>');\n  html = html.replace(/<3i>([\\s\\S]*?)<\\/3i>/g, '<div class="state-item indent-3">$1</div>');\n\n  // 处理语义化标签（常见的状态栏标签）\n  html = html.replace(/<日期>([\\s\\S]*?)<\\/日期>/g, '<div class="state-date">📅 $1</div>');\n  html = html.replace(/<时间>([\\s\\S]*?)<\\/时间>/g, '<div class="state-time">🕐 $1</div>');\n  html = html.replace(/<地点>([\\s\\S]*?)<\\/地点>/g, '<div class="state-location">📍 $1</div>');\n  html = html.replace(/<角色生理状态>([\\s\\S]*?)<\\/角色生理状态>/g, '<div class="state-physical">💓 $1</div>');\n  html = html.replace(/<角色心理状态>([\\s\\S]*?)<\\/角色心理状态>/g, '<div class="state-mental">🧠 $1</div>');\n  html = html.replace(/<当前状态>([\\s\\S]*?)<\\/当前状态>/g, '<div class="state-current">✨ $1</div>');\n\n  // 处理颜色标签（如 <角色生理状态>【描述角色当前生理状态】</角色生理状态>）\n  html = html.replace(/<角色生理状态>([\\s\\S]*?)<\\/角色生理状态>/g,\n    '<div class="state-colored" style="border-left: 3px solid #ff6b6b; background: rgba(255,107,107,0.1);">$1</div>');\n\n  // 通用标签处理（兜底方案）\n  html = html.replace(/<([^>\\/\\s]+)>([\\s\\S]*?)<\\/\\1>/g, '<div class="state-generic">$2</div>');\n\n  return html;\n}\n\n// ===== 3. 监听消息并更新 =====\nasync function updateStateBar() {\n  // 使用 TavernHelper 获取消息\n  if (typeof (window as any).TavernHelper === 'undefined' || \n      typeof (window as any).TavernHelper.getChatMessages !== 'function') {\n    return; // TavernHelper 不可用，跳过\n  }\n\n  const messages = (window as any).TavernHelper.getChatMessages('0-{{lastMessageId}}');\n  if (!messages || messages.length === 0) return;\n\n  // 获取最新的 AI 消息\n  const latestAI = messages.slice().reverse().find(m => !m.is_user);\n  if (!latestAI) return;\n\n  // 提取状态栏\n  const stateBarXml = extractStateBar(latestAI.mes);\n  if (stateBarXml) {\n    const stateBarHtml = convertXmlToHtml(stateBarXml);\n\n    // 更新界面（带动画）\n    const container = $('#state-bar-container');\n    container.fadeOut(200, () => {\n      container.html(stateBarHtml);\n      container.fadeIn(200);\n    });\n  }\n}\n\n// ===== 4. 初始化和监听 =====\n$(function() {\n  updateStateBar(); // 页面加载时更新\n\n  // 监听消息接收事件\n  if (typeof eventOn === 'function') {\n    eventOn('MESSAGE_RECEIVED', updateStateBar);\n  }\n});\n\`\`\`\n\n**配套 CSS 样式：**\n\n\`\`\`scss\n#state-bar-container {\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 12px;\n  padding: 16px;\n  color: white;\n  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);\n  margin-bottom: 16px;\n}\n\n.state-item {\n  padding: 8px 12px;\n  margin: 6px 0;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  backdrop-filter: blur(10px);\n  transition: all 0.3s ease;\n\n  &:hover {\n    background: rgba(255, 255, 255, 0.15);\n    transform: translateX(4px);\n  }\n}\n\n// 缩进样式\n.indent-1 { margin-left: 20px; }\n.indent-2 { margin-left: 40px; }\n.indent-3 { margin-left: 60px; }\n\n// 语义化标签样式\n.state-date, .state-time, .state-location {\n  font-weight: 600;\n  font-size: 14px;\n  padding: 8px 12px;\n  margin: 8px 0;\n  border-radius: 6px;\n}\n\n.state-date { background: rgba(100, 181, 246, 0.2); }\n.state-time { background: rgba(129, 199, 132, 0.2); }\n.state-location { background: rgba(255, 167, 38, 0.2); }\n\n.state-physical {\n  padding: 10px 14px;\n  margin: 8px 0;\n  background: rgba(255, 107, 107, 0.15);\n  border-left: 4px solid #ff6b6b;\n  border-radius: 4px;\n}\n\n.state-mental {\n  padding: 10px 14px;\n  margin: 8px 0;\n  background: rgba(149, 117, 205, 0.15);\n  border-left: 4px solid #9575cd;\n  border-radius: 4px;\n}\n\n.state-colored {\n  padding: 10px 14px;\n  margin: 8px 0;\n  border-radius: 4px;\n  backdrop-filter: blur(5px);\n}\n\n.state-generic {\n  padding: 6px 10px;\n  margin: 4px 0;\n  opacity: 0.9;\n}\n\`\`\`\n\n**使用 GSAP 制作高级动画（可选）：**\n\n\`\`\`typescript\n// 使用 GSAP 制作更流畅的动画\nfunction updateStateBarWithAnimation(stateBarHtml: string) {\n  const container = $('#state-bar-container');\n\n  // 淡出\n  gsap.to(container, {\n    opacity: 0,\n    y: -10,\n    duration: 0.2,\n    onComplete: () => {\n      container.html(stateBarHtml);\n\n      // 淡入\n      gsap.to(container, {\n        opacity: 1,\n        y: 0,\n        duration: 0.3,\n        ease: 'power2.out'\n      });\n\n      // 子元素依次出现\n      gsap.from('.state-item', {\n        opacity: 0,\n        x: -20,\n        duration: 0.4,\n        stagger: 0.05,\n        ease: 'back.out(1.2)'\n      });\n    }\n  });\n}\n\`\`\`\n\`\`\`\n\n**关键点：**\n- 使用 \`getChatMessages()\` 获取所有消息\n- 通过正则表达式从消息文本中提取数据\n- 用 jQuery 更新 DOM 元素显示\n- 监听 MESSAGE_RECEIVED 事件实现自动更新\n\n## 实现同层对话（流式传输前端界面）\n\n**核心概念：**\n同层对话是一个**独立的前端界面**（有自己的 index.html），玩家只在界面内游玩，不看酒馆主聊天。\n\n**🚨🚨🚨 绝对禁止（否则功能完全不工作！）🚨🚨🚨**\n\n\`\`\`javascript\n// ❌❌❌ 绝对禁止！绝对禁止！绝对禁止！\n$(function() {\n  let chatHistory = [];           // ❌ 外部访问不到！\n  function renderMessages() {}    // ❌ 外部访问不到！\n  function handleSend() {}        // ❌ 外部访问不到！\n\n  // 所有代码都在这里 ❌❌❌\n});\n\n// ✅✅✅ 必须这样写！必须这样写！必须这样写！\nlet chatHistory = [];              // ✅ 全局变量\nfunction renderMessages() {}       // ✅ 全局函数\nfunction handleSend() {}           // ✅ 全局函数\n\n$(function() {\n  // 只在这里调用函数，不定义！\n  loadChatHistory();\n  setupStreamListeners();\n});\n\`\`\`\n\n**代码结构必须严格按以下顺序（不能改！）：**\n1. 全局变量定义（let/const）\n2. 全局函数定义（function）\n3. \`$(function() {})\` - 只用于调用上面定义的函数\n4. \`$(window).on('pagehide', ...)\` - 卸载事件\n\n**⚠️⚠️⚠️ 第二重要的注意事项：generation_id 过滤**\n同层对话的流式监听器会监听到**所有**酒馆的生成事件（包括主界面的生成）。因此**必须使用 generation_id 过滤**，否则会出现：\n- 同层对话接收到主界面的 AI 回复\n- 状态管理混乱，生成状态对不上\n- 按钮状态异常\n\n**实现要点：**\n1. 创建**前端界面项目**（index.html + index.ts）\n2. 界面内设计输入框和发送按钮\n3. 点击发送时，调用 \`generate(text)\`，并**保存返回的 generation_id**\n4. **监听流式传输事件**时，必须检查 \`id === currentGenerationId\`：\n   - \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\`: 每个 token 的增量更新\n   - \`iframe_events.STREAM_TOKEN_RECEIVED_FULLY\`: 流式传输完成，获取完整文本\n   - \`iframe_events.GENERATION_ENDED\`: 生成结束（备用方案）\n5. 后台操作消息楼层（可选）：使用 \`setChatMessages\`、\`createChatMessages\` 配合 \`{ refresh: 'none' }\` 参数\n\n**⚠️⚠️⚠️ 关键 API（必须使用此方法！禁止使用 generate()！）：**\n- **\`triggerSlashWithResult(command)\`**: 执行 STScript 命令并获取返回值\n  - 返回值：\`Promise<string>\`（AI 生成的完整文本）\n  - 示例：\`const result = await triggerSlashWithResult('/gen lock=on "对话内容"');\`\n  - **重要**：使用 \`/gen\` 命令会自动使用角色卡、预设、世界书\n  - **关键优势**：不需要流式监听，不需要 generation_id，直接返回完整结果\n- **\`getRegexScripts()\`**: 获取当前启用的正则脚本列表\n  - 用于过滤思维链、调试信息等\n  - **必须在显示 AI 回复前应用正则过滤**\n- **构建对话历史为提示词**：将对话历史拼接成文本，而不是用 API 参数\n- **\`triggerSlash(command)\`**: 执行 STScript 命令但不等待返回值\n\n**⚠️⚠️⚠️ AI 回复的标签清理（非常重要！）：**\nAI 可能会在回复中生成思维链标签，如：\`<guide>\`、\`<dream>\`、\`<plot>\`、\`<status>\`、\`<think>\` 等。\n这些标签**必须在显示前移除**，否则会破坏界面效果！\n\n**清理策略（参考梦星大佬的方案）：**\n1. **优先提取正文标签**：如果 AI 用特定标签包裹正文（如 \`<gametxt>\`），优先提取\n2. **备用方案**：移除所有思维链标签\n3. **可选增强**：应用酒馆的全局正则和预设正则\n\n**完整的清理函数模板（梦星方案）：**\n\`\`\`typescript\n// 辅助函数：提取标签内容（从后往前查找最后一个）\nfunction extractLastTagContent(tagName: string, text: string, ignoreCase = false): string | null {\n  if (!text || typeof text !== 'string') return null;\n\n  const endTag = \`</\${tagName}>\`;\n  let searchPool = text;\n  let endTagPattern = endTag;\n\n  if (ignoreCase) {\n    searchPool = text.toLowerCase();\n    endTagPattern = endTag.toLowerCase();\n  }\n\n  const lastEndIndex = searchPool.lastIndexOf(endTagPattern);\n  if (lastEndIndex !== -1) {\n    const startTag = \`<\${tagName}>\`;\n    let startTagPattern = startTag;\n    if (ignoreCase) startTagPattern = startTag.toLowerCase();\n\n    const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);\n    if (lastStartIndex !== -1) {\n      const startIndex = lastStartIndex + startTag.length;\n      return text.substring(startIndex, lastEndIndex).trim();\n    }\n  }\n  return null;\n}\n\n// 主清理函数\nfunction applyRegexFilters(text: string): string {\n  console.log('🔍 开始清理，原始长度:', text.length);\n\n  if (!text || typeof text !== 'string') return '';\n\n  // ===== 步骤 0: 修复未闭合的标签（容错处理）=====\n  // 哈基米流口水时经常不闭合标签，导致"前端失踪"、"代码暴露"等问题\n  // 检测常见的未闭合标签并自动闭合\n  // ⚠️ dream 和 gametxt 是正文标签，需要补齐以便提取内容\n  const criticalTags = ['thinking', 'UpdateVariable', 'guide', 'plot', 'status', 'dream', 'gametxt'];\n  criticalTags.forEach(tag => {\n    const openTagRegex = new RegExp(\`<\${tag}([^>]*)>\`, 'gi');\n    const closeTagRegex = new RegExp(\`</\${tag}>\`, 'gi');\n\n    const openMatches = text.match(openTagRegex);\n    const closeMatches = text.match(closeTagRegex);\n\n    const openCount = openMatches ? openMatches.length : 0;\n    const closeCount = closeMatches ? closeMatches.length : 0;\n\n    if (openCount > closeCount) {\n      // 有未闭合的标签，自动补齐闭合标签\n      const missing = openCount - closeCount;\n      console.log(\`⚠️ 发现 \${missing} 个未闭合的 <\${tag}> 标签，自动补齐\`);\n      text = text + \`</\${tag}>\`.repeat(missing);\n    }\n  });\n\n  // ===== 步骤 1: 优先提取正文标签（梦星方案）=====\n  // 如果 AI 用特定标签包裹正文，优先提取该标签的内容\n  // ⚠️⚠️⚠️ dream 是常见的正文标签！必须优先提取！\n  const gameTextTags = ['dream', 'gametxt', 'output', 'display', 'text', 'content'];\n  for (const tag of gameTextTags) {\n    const extracted = extractLastTagContent(tag, text);\n    if (extracted !== null) {\n      console.log(\`✅ 提取了 <\${tag}> 标签的内容，长度:\`, extracted.length);\n      return extracted; // 直接返回正文，不需要进一步清理\n    }\n  }\n\n  // ===== 步骤 2: 备用方案 - 移除所有思维链标签 =====\n  let cleanedText = text;\n\n  // 常见的固定标签（注意：dream/gametxt 是正文标签，不应移除！）\n  const tagsToRemove = [\n    'guide', 'plot', 'status',\n    'UpdateVariable', '角色提取', '本世历程', '往世涟漪'\n  ];\n\n  tagsToRemove.forEach(tag => {\n    // 移除 <tag>...</tag> 结构\n    const regexWithContent = new RegExp(\`<\${tag}[^>]*>[\\\\s\\\\S]*?</\${tag}>\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regexWithContent, '');\n\n    // 移除自闭合的 <tag/> 结构\n    const regexSelfClosing = new RegExp(\`<\${tag}\\\\s*\\\\/>\`, 'gi');\n    cleanedText = cleanedText.replace(regexSelfClosing, '');\n\n    if (before !== cleanedText) {\n      console.log(\`  🧹 移除了 <\${tag}> 标签\`);\n    }\n  });\n\n  // ⚠️⚠️⚠️ 特殊处理：移除所有包含 think/thinking 的标签（思维链）\n  // 匹配 <xxx_think>、<thinking_xxx>、<think>、<thinking> 等所有变体\n  const thinkingRegex = /<[^>]*think[^>]*>[\\\\s\\\\S]*?<\\/[^>]*think[^>]*>/gi;\n  const beforeThinking = cleanedText;\n  cleanedText = cleanedText.replace(thinkingRegex, '');\n  if (beforeThinking !== cleanedText) {\n    console.log('  🧹 移除了包含 think/thinking 的思维链标签');\n  }\n\n  // 移除自闭合的 think 标签\n  const thinkingSelfClosing = /<[^>]*think[^>]*\\\\/>/gi;\n  cleanedText = cleanedText.replace(thinkingSelfClosing, '');\n\n  // 清理 HTML 注释\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  if (cleanedText !== text) {\n    console.log('✅ 标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 2-3: 尝试应用酒馆正则（可选）=====\n  let allRegexScripts: any[] = [];\n\n  // 方式 1: 全局正则\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegexes = getRegexScripts();\n      if (globalRegexes && globalRegexes.length > 0) {\n        console.log('📋 从全局正则获取到', globalRegexes.length, '个脚本');\n        allRegexScripts = allRegexScripts.concat(globalRegexes);\n      }\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  // 方式 2: 预设内置正则（支持 SoliUmbra 等脚本）\n  try {\n    const parentST = (window as any).parent?.SillyTavern || (window as any).SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find((p: any) => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes: any = null;\n\n              if (Array.isArray(data)) {\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break;\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length > 0) {\n    console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n    // 过滤出适用于 AI 输出后处理的正则（placement 包含 2）\n    // ⚠️ 只检查 disabled 和 placement，不检查 promptOnly\n    // 因为有些预设正则可能没有 promptOnly 字段，或者设置不规范\n    const activeScripts = allRegexScripts.filter((script: any) => {\n      if (script.disabled) return false;\n      if (!script.placement || !Array.isArray(script.placement)) return false;\n      if (!script.placement.includes(2)) return false;\n      return true;\n    });\n\n    console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n    let result = text;\n    activeScripts.forEach((script: any, index: number) => {\n      try {\n        const regex = new RegExp(script.findRegex, 'gim');\n        const beforeLength = result.length;\n        result = result.replace(regex, script.replaceString || '');\n\n        if (beforeLength !== result.length) {\n          console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效');\n        }\n      } catch (e) {\n        console.error('❌ 正则', index + 1, '应用失败:', e);\n      }\n    });\n\n    text = result;\n  }\n\n  console.log('📊 最终长度:', text.length);\n  return text;\n}\n\`\`\`\n\n**使用方式（完整示例）：**\n\`\`\`typescript\n// 全局变量\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\n\n// 发送消息\nasync function handleSend() {\n  const input = $('#user-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 1. 添加用户消息到历史\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  renderMessages();\n\n  // 2. 设置生成状态\n  isGenerating = true;\n  $('#send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    // 3. 构建对话历史提示词\n    let prompt = '';\n    chatHistory.slice(-10).forEach(msg => {\n      prompt += (msg.role === 'user' ? '玩家' : 'AI') + ': ' + msg.content + '\\n';\n    });\n\n    // 4. 调用 AI（不需要流式！）\n    const rawResult = await triggerSlashWithResult('/gen lock=on "' + prompt.replace(/"/g, '\\\\"') + '"');\n\n    // 5. ⭐ 关键：必须先清理标签再显示\n    const cleanedResult = applyRegexFilters(rawResult);\n\n    // 6. 添加到聊天历史并渲染\n    chatHistory.push({ role: 'assistant', content: cleanedResult });\n    renderMessages();\n    saveChatHistory(); // 保存到酒馆变量\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    isGenerating = false;\n    $('#send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// 渲染消息\nfunction renderMessages() {\n  const container = $('#messages');\n  container.empty();\n\n  chatHistory.forEach(msg => {\n    const div = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .text(msg.content); // 使用 text() 防止 XSS\n    container.append(div);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// 保存聊天历史\nfunction saveChatHistory() {\n  if (typeof insertOrAssignVariables === 'function') {\n    insertOrAssignVariables({ chat_history: chatHistory }, { type: 'chat' });\n  } else {\n    localStorage.setItem('chat_history', JSON.stringify(chatHistory));\n  }\n}\n\`\`\`\n\n**⚠️ 重要说明：流式传输的正确实现方式！**\n\n**🚨 同层对话必须使用真流式传输！🚨**\n\n### ⭐ 真流式模式（唯一正确的实现方式）\n- 使用 \`generate({ should_stream: true, generation_id })\` 启用流式\n- 监听 \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\` 实时接收文本\n- 边接收边清理标签边显示\n- ✅ 实时显示 AI 生成，无需等待，体验最佳\n- ✅ 用户可以立即看到 AI 的回复，体验流畅\n\n### ❌ 禁止使用以下方案：\n- ❌ \`triggerSlashWithResult\`（需要等待全部生成，体验差）\n- ❌ 打字机效果（假流式，仍需等待，不是真正的流式）\n- ❌ \`generateRaw\`（不使用角色卡和预设）\n\n**🎯 真流式模式的正确实现（强烈推荐）：**\n\n\`\`\`typescript\n// ===== 全局变量 =====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\nlet currentGenerationId: string | null = null;\n\n// ===== 真流式监听（核心！）=====\nfunction setupStreamListeners() {\n  // ⚠️ 监听增量文本（每次接收一小段）\n  eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text: string, id: string) => {\n    if (!isGenerating || id !== currentGenerationId) return;\n\n    // ⚠️⚠️⚠️ 核心！必须实时清理标签！\n    const cleanedText = applyRegexFilters(text);\n\n    // 更新 DOM（找到最后一条消息并更新）\n    const container = $('#inner-messages');  // 根据实际容器 ID 修改\n    const charName = SillyTavern?.name2 || 'AI';\n    const lastMsg = container.find('.message:last-child');\n\n    if (lastMsg.length && !lastMsg.hasClass('user-message')) {\n      // 更新已有的 AI 消息\n      lastMsg.html('<strong>' + charName + ':</strong> ' + cleanedText);\n    } else {\n      // 创建新的 AI 消息\n      const msgDiv = $('<div>')\n        .addClass('message ai-message')\n        .html('<strong>' + charName + ':</strong> ' + cleanedText);\n      container.append(msgDiv);\n    }\n\n    // 自动滚动到底部\n    container.scrollTop(container[0].scrollHeight);\n  });\n\n  // ⚠️ 监听生成完成\n  eventOn(iframe_events.GENERATION_ENDED, (text: string, id: string) => {\n    if (id === currentGenerationId) {\n      console.log('✅ 流式生成完成');\n\n      // ⚠️⚠️⚠️ 核心！最后清理一次再保存到历史！\n      const cleanedText = applyRegexFilters(text);\n\n      // 保存到聊天历史\n      chatHistory.push({ role: 'assistant', content: cleanedText });\n      saveChatHistory();\n\n      // 重新渲染（确保显示的是清理后的内容）\n      renderMessages();\n\n      // 重置状态\n      isGenerating = false;\n      currentGenerationId = null;\n      $('#inner-send-btn').prop('disabled', false).text('发送');  // 根据实际按钮 ID 修改\n    }\n  });\n}\n\n// ===== 发送消息（真流式版本）=====\nasync function handleSend() {\n  const input = $('#inner-input');  // 根据实际输入框 ID 修改\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 1. 添加用户消息\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  // 2. 生成唯一 ID\n  currentGenerationId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n\n  // 3. 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');  // 根据实际按钮 ID 修改\n\n  try {\n    // 4. ⚠️⚠️⚠️ 核心：调用 generate 并启用流式\n    await generate({\n      user_input: userInput,\n      should_stream: true,           // ⚠️ 必须启用流式\n      generation_id: currentGenerationId,  // ⚠️ 必须传入 ID 用于事件过滤\n      overrides: {\n        chat_history: {\n          prompts: chatHistory.map(msg => ({\n            role: msg.role === 'user' ? 'user' : 'assistant',\n            content: msg.content\n          }))\n        }\n      }\n    });\n\n    // 注意：由于是流式，实际的文本更新是通过事件监听器实时更新的\n    // GENERATION_ENDED 事件会自动保存 AI 回复到历史\n\n  } catch (error) {\n    console.error('❌ 生成失败:', error);\n    toastr.error('生成失败: ' + error.message);\n\n    // 重置状态\n    isGenerating = false;\n    currentGenerationId = null;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 渲染消息 =====\nfunction renderMessages() {\n  const container = $('#messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const div = $('<div>')\n      .attr('id', \\\`message-\\\${index}\\\`)  // ⚠️ 必须有 id\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .text(msg.content);\n    container.append(div);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 初始化 =====\n$(() => {\n  loadChatHistory();\n  setupStreamListeners();  // ⚠️ 必须在加载时就设置监听\n\n  $('#send-btn').on('click', handleSend);\n  $('#user-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n});\n\\\`\\\`\\\`\n\n**🎨 CSS 样式（可选，添加光标效果）：**\n\\\`\\\`\\\`css\n.streaming {\n  border-right: 2px solid #165DFF;\n  animation: blink 1s infinite;\n}\n\n@keyframes blink {\n  0%, 50% { border-right-color: transparent; }\n  51%, 100% { border-right-color: #165DFF; }\n}\n\\\`\\\`\\\`\n\n**💡 模式选择建议（重要！）：**\n- **同层对话（前端界面）**：必须使用真流式模式（模式 3）⭐⭐⭐\n- **脚本后台任务**：可以使用 triggerSlashWithResult（不需要流式）\n- **原因**：同层对话需要实时显示 AI 生成，给用户最佳体验\n- **不要用假流式！** 假流式需要等待完整生成，体验差\n\n**🔑 真流式的关键要点：**\n1. ✅ 必须调用 \`generate({ should_stream: true, generation_id: uniqueId })\`\n2. ✅ 必须在加载时就设置监听：\`setupStreamListeners()\`\n3. ✅ 监听事件：\`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => ...)\`\n4. ✅ 过滤 ID：确保只处理自己的 \`generation_id\`\n5. ✅ 使用 \`overrides.chat_history.prompts\` 传递聊天历史\n\n**🚨🚨🚨 最关键！必须在这些地方调用 \`applyRegexFilters\`：**\n1. ⚠️ **STREAM_TOKEN_RECEIVED_INCREMENTALLY 事件中**：\n   \`\`\`typescript\n   const cleanedText = applyRegexFilters(text);  // 清理后再显示！\n   lastMsg.html('<strong>' + charName + ':</strong> ' + cleanedText);\n   \`\`\`\n\n2. ⚠️ **GENERATION_ENDED 事件中**：\n   \`\`\`typescript\n   const cleanedText = applyRegexFilters(text);  // 清理后再保存！\n   chatHistory.push({ role: 'assistant', content: cleanedText });\n   \`\`\`\n\n**💡 \`applyRegexFilters\` 的容错机制（四层保护）：**\n1. ✅ **自动补齐未闭合的标签**（防止"前端失踪"、"代码暴露"）\n2. ✅ **优先提取正文标签**（如 \`<dream>\`、\`<gametxt>\`）⭐⭐⭐ 最重要！\n3. ✅ **移除思维链标签**（通配符匹配所有包含 \`think\` 的标签）\n4. ✅ **应用预设正则**（支持全局正则和预设内置正则）\n\n**🚨🚨🚨 正文标签提取（核心原理）：**\n- **不同预设使用不同的正文标签**：\`<dream>\`、\`<gametxt>\`、\`<output>\` 等\n- **优先提取顺序**：\`['dream', 'gametxt', 'output', 'display', 'text', 'content']\`\n- **提取逻辑**：找到第一个匹配的标签，提取其内容并直接返回\n- **示例**：\n  \`\`\`\n  原始：<guide>思维</guide><dream>正文内容</dream><plot>元数据</plot>\n  提取：正文内容  ← 只保留 <dream> 里的内容！\n  \`\`\`\n\n**🎯 思维链标签处理（重点！）：**\n- 思维链标签名通常包含 \`think\` 或 \`thinking\`\n- 使用通配符正则：\`/<[^>]*think[^>]*>[\\s\\S]*?<\\/[^>]*think[^>]*>/gi\`\n- 自动匹配所有变体：\`<think>\`、\`<thinking>\`、\`<xxx_think>\`、\`<thinking_xxx>\` 等\n- 即使标签名变化，也能正确清理\n\n**常见问题及解决方案：**\n- ❌ 思考内容暴露 → \`<thinking>\` 未闭合 → 自动补齐 + 清理\n- ❌ 前端失踪 → \`<UpdateVariable>\` 未闭合 → 自动补齐 + 清理\n- ❌ 代码暴露 → 多余的 \`<UpdateVariable>\` → 清理所有 \`<UpdateVariable>\` 标签\n\n**❌ 致命错误（绝对不能犯）：**\n- ❌ 直接显示/保存原始 text，没有调用 \`applyRegexFilters\`\n- ❌ 只在显示时清理，但保存时用原始 text\n- ❌ 只在保存时清理，但显示时用原始 text\n- ❌ 不设置 \`should_stream: true\`\n- ❌ 不设置 \`generation_id\`（会收到所有事件）\n- ❌ 不过滤 ID（会处理其他同层对话的事件）\n- ❌ 不在加载时设置监听（会丢失事件）\n\n**⚠️⚠️⚠️ 作用域问题（最常见错误！）：**\n变量和函数**必须在全局作用域**定义，不能在 \`$(function() {})\` 内部！\n\n\`\`\`javascript\n// ❌ 错误示例：变量在局部作用域\n$(function() {\n  let chatHistory = [];  // ❌ 外部访问不到！\n  function renderMessages() {}  // ❌ 外部访问不到！\n});\n\n// ✅ 正确示例：变量在全局作用域\nlet chatHistory = [];  // ✅ 全局可访问\nfunction renderMessages() {}  // ✅ 全局可访问\n\n$(function() {\n  // 在这里调用上面定义的函数\n  loadChatHistory();\n});\n\`\`\`\n\n**📋 代码结构大纲（必须严格按此顺序！）：**\n\n\`\`\`javascript\n// index.ts 文件结构：\n//\n// 1️⃣ 全局变量定义区（第 1-10 行左右）\n//    let chatHistory = [];\n//    let isGenerating = false;\n//    ...\n//\n// 2️⃣ 全局函数定义区（第 10-250 行左右）\n//    function loadChatHistory() { ... }\n//    function saveChatHistory() { ... }\n//    function renderMessages() { ... }\n//    function applyRegexFilters(text) { ... }  // ⚠️ 必须！用于过滤思维链\n//    function handleSend() { ... }\n//\n// 3️⃣ jQuery 初始化区（第 250-270 行左右）\n//    $(function() {\n//      // 只调用函数，不定义！\n//      loadChatHistory();\n//      $('#btn').on('click', handleSend);\n//    });\n//\n// 4️⃣ 卸载事件（第 270-275 行左右）\n//    $(window).on('pagehide', () => { ... });\n\`\`\`\n\n**完整实现示例（必须 100% 按此结构！）：**\n\n\`\`\`javascript\n// =====================================================\n// ⚠️⚠️⚠️ 以下所有代码都在全局作用域，不要放在 $(function() {}) 内！\n// =====================================================\n\n// ===== 1. 状态管理（必须在全局作用域！）=====\nlet chatHistory = []; // { role: 'user'|'assistant', content: string }\nlet isGenerating = false;\n\n// ===== 2. 数据持久化（使用聊天变量） =====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    // 预览模式\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    // 酒馆模式：从聊天变量读取\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 界面渲染 =====\nfunction renderMessages() {\n  console.log('🎨 renderMessages 开始，聊天历史:', chatHistory.length, '条');\n\n  const container = $('#inner-messages');\n  console.log('📦 消息容器:', container.length > 0 ? '✅ 存在' : '❌ 不存在');\n\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    // 获取显示名称\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    console.log('💬 渲染消息', index + 1, ':', msg.role, '-', name, '- 长度:', msg.content.length);\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  console.log('✅ renderMessages 完成，容器内消息数:', container.find('.message').length);\n\n  // 滚动到底部\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 4. 正则过滤（隐藏思维链等） =====\n/**\n * 应用正则脚本来清理 AI 回复\n * 支持三种清理方式：\n * 1. 酒馆原生全局正则（通过 getRegexScripts）\n * 2. 预设内置正则（通过 SoliUmbra 的预设绑定脚本）\n * 3. 内置的简单标签清理（作为备用方案）\n */\nfunction applyRegexFilters(text) {\n  console.log('🔍 开始应用正则过滤，原始文本长度:', text.length);\n\n  // ===== 步骤 0: 内置的简单标签清理（备用方案）=====\n  // 清理常见的思维链标签：<guide>、<dream>、<plot>、<status>、<think> 等\n  let cleanedText = text;\n  const commonTags = [\n    'guide', 'dream', 'plot', 'status', 'think', 'thinking',\n    'thought', 'reasoning', 'analysis', 'plan', 'reflection',\n    'meta', 'ooc', 'system', 'debug'\n  ];\n\n  commonTags.forEach(tag => {\n    // 匹配 <tag>...</tag> 格式（包括换行）\n    const regex = new RegExp(\`<\${tag}[^>]*>[\\\\s\\\\S]*?</\${tag}>\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regex, '');\n    if (before !== cleanedText) {\n      console.log(\`  🧹 内置清理: 移除了 <\${tag}> 标签\`);\n    }\n  });\n\n  // 清理 HTML 注释中的调试信息\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  // 如果内置清理生效了，先显示结果\n  if (cleanedText !== text) {\n    console.log('✅ 内置标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 1-2: 尝试使用酒馆的正则脚本 =====\n  let allRegexScripts = [];\n\n  // 方式 1: 尝试从酒馆原生全局正则获取\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegex = getRegexScripts();\n      console.log('📋 从全局正则获取到', globalRegex.length, '个脚本');\n      allRegexScripts = allRegexScripts.concat(globalRegex);\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  // 方式 2: 尝试从预设内置正则获取（SoliUmbra 的方案）\n  // ⚠️ 同层对话在 iframe 中，需要通过 window.parent.SillyTavern.getContext() 访问\n  try {\n    const parentST = window.parent?.SillyTavern || window.SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        // 尝试多个可能的 identifier（不同预设使用不同的命名）\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find(p => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes = null;\n\n              // 处理不同的数据格式\n              if (Array.isArray(data)) {\n                // 直接是数组（如 regexes-bindings）\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                // 嵌套对象（如 SPresetSettings.RegexBinding.regexes）\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break; // 找到就退出循环\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length === 0) {\n    console.log('⚠️ 未找到任何正则脚本，跳过过滤');\n    return text;\n  }\n\n  console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n  // 过滤出启用的、适用于 AI 输出后处理的正则\n  // placement 数组:\n  //   0 = 提示词之前\n  //   1 = 提示词之后（发送给 AI 之前）\n  //   2 = AI 输出之后（显示给用户之前）⭐ 这是我们需要的！\n  // promptOnly: true = 仅用于提示词处理\n  // promptOnly: false = 用于输出后处理 ⭐ 这是我们需要的！\n  const activeScripts = allRegexScripts.filter(script => {\n    return !script.disabled &&\n           !script.promptOnly &&  // 只要 promptOnly 为 false 的\n           script.placement &&\n           script.placement.includes(2);  // 只要 placement 包含 2 的（AI 输出后）\n  });\n\n  console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n  let result = text;\n\n  // 依次应用每个正则\n  activeScripts.forEach((script, index) => {\n    try {\n      const regex = new RegExp(script.findRegex, 'gim');\n      const beforeLength = result.length;\n      result = result.replace(regex, script.replaceString || '');\n\n      if (beforeLength !== result.length) {\n        console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效，移除了', beforeLength - result.length, '个字符');\n      }\n    } catch (e) {\n      console.error('❌ 正则', index + 1, '(', script.scriptName, ') 应用失败:', e);\n    }\n  });\n\n  console.log('🎯 正则过滤完成，原始长度:', text.length, '过滤后长度:', result.length);\n\n  return result;\n}\n\n// ===== 5. 发送消息 =====\n// ⚠️ 函数名必须避免与酒馆冲突（不要用 sendChatMessage）\n// ⚠️ 这个函数必须在全局作用域定义！\nasync function handleSend() {\n  const input = $('#inner-user-input');\n  const text = input.val().trim();\n\n  if (!text || isGenerating) return;\n\n  // 添加用户消息\n  chatHistory.push({ role: 'user', content: text });\n  input.val('');\n  renderMessages();\n  saveChatHistory();\n\n  // 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    // ⚠️ 检查 STScript API 可用性\n    if (typeof triggerSlashWithResult !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    // 获取用户名和角色名\n    const userName = SillyTavern?.name1 || 'You';\n    const charName = SillyTavern?.name2 || 'AI';\n\n    // 构建完整的对话上下文（包含历史记录）\n    let fullPrompt = '';\n    if (chatHistory.length > 0) {\n      fullPrompt += '【对话历史】\\n';\n      chatHistory.forEach((msg) => {\n        const name = msg.role === 'user' ? userName : charName;\n        fullPrompt += name + ': ' + msg.content + '\\n';\n      });\n      fullPrompt += '\\n';\n    }\n    fullPrompt += userName + ': ' + text;\n\n    console.log('🚀 开始生成，提示词长度:', fullPrompt.length);\n\n    // ⚠️⚠️⚠️ 使用 /gen 命令（会自动使用角色卡、预设、世界书）\n    const command = '/gen lock=on "' + fullPrompt.replace(/"/g, '\\\\"') + '"';\n    const result = await triggerSlashWithResult(command);\n\n    console.log('📥 AI 返回值长度:', result ? result.length : 0);\n\n    if (result && result.length > 0) {\n      // ⚠️⚠️⚠️ 应用正则过滤（隐藏思维链等调试信息）\n      const cleanedResult = applyRegexFilters(result);\n      console.log('🧹 正则过滤后长度:', cleanedResult.length);\n\n      // 添加 AI 回复到历史\n      chatHistory.push({ role: 'assistant', content: cleanedResult });\n      saveChatHistory();\n      renderMessages();\n      toastr.success('回复成功');\n    } else {\n      toastr.warning('AI 未返回内容');\n    }\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    // 重置状态\n    isGenerating = false;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// =====================================================\n// ⚠️⚠️⚠️ 从这里开始才能用 $(function() {})，上面的代码都是全局的！\n// =====================================================\n\n// ===== 6. 初始化 =====\n// ⚠️⚠️⚠️ 关键：只在这里调用函数，不要在这里定义变量和函数！\n$(function() {\n  // 调试输出，确保代码加载成功\n  console.log('✅ 同层对话初始化开始');\n  console.log('📋 chatHistory 可访问:', typeof chatHistory !== 'undefined');\n  console.log('🔧 renderMessages 可访问:', typeof renderMessages === 'function');\n  console.log('🔧 handleSend 可访问:', typeof handleSend === 'function');\n\n  // ⚠️ 如果上面任何一个是 false，说明函数定义在 $(function() {}) 内部了！\n  if (typeof chatHistory === 'undefined' || typeof renderMessages !== 'function') {\n    console.error('❌❌❌ 严重错误：变量/函数定义在了局部作用域！');\n    console.error('请检查代码，确保所有变量和函数都在 $(function() {}) 外部定义！');\n    toastr.error('代码结构错误：变量作用域问题');\n    return;\n  }\n\n  loadChatHistory();\n\n  // 绑定事件\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-user-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  // 清空按钮\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成');\n  console.log('📊 消息容器:', $('#inner-messages').length > 0 ? '✅ 存在' : '❌ 不存在');\n});\n\n// ===== 7. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  saveChatHistory();\n});\n\`\`\`\n\n**HTML 结构示例（必须包含以下所有元素）：**\n\`\`\`html\n<div class="inner-chat-container">\n  <div class="inner-chat-header">\n    <h3>同层对话</h3>\n    <button id="inner-clear-btn">清空</button>\n  </div>\n\n  \x3c!-- ⚠️ 必需：消息容器，ID 必须是 inner-messages --\x3e\n  <div id="inner-messages" class="inner-messages"></div>\n\n  <div class="inner-input-area">\n    \x3c!-- ⚠️ 必需：输入框，ID 必须是 inner-user-input --\x3e\n    <textarea id="inner-user-input" placeholder="输入消息..."></textarea>\n    \x3c!-- ⚠️ 必需：发送按钮，ID 必须是 inner-send-btn --\x3e\n    <button id="inner-send-btn">发送</button>\n  </div>\n</div>\n\`\`\`\n\n**⚠️ HTML 检查清单：**\n- [ ] 是否有 \`id="inner-messages"\` 的消息容器？\n- [ ] 是否有 \`id="inner-user-input"\` 的输入框？\n- [ ] 是否有 \`id="inner-send-btn"\` 的发送按钮？\n- [ ] 是否有 \`id="inner-clear-btn"\` 的清空按钮？\n- [ ] ID 是否与 JS 代码中使用的完全一致？\n\n**CSS 样式示例（必须严格遵守，确保消息正确左右对齐）：**\n\`\`\`css\n/* 消息容器 */\n.inner-messages {\n  height: 400px;\n  overflow-y: auto;\n  padding: 15px;\n  display: flex;  /* ⚠️ 必须用 flex */\n  flex-direction: column;\n  gap: 10px;\n}\n\n/* 消息基础样式 */\n.message {\n  max-width: 70%;\n  padding: 10px 15px;\n  border-radius: 12px;\n  word-wrap: break-word;\n}\n\n/* ⚠️ 用户消息：右对齐，蓝色 */\n.user-message {\n  align-self: flex-end;  /* ✅ 右对齐关键！*/\n  background: #4a9eff;\n  color: white;\n}\n\n/* ⚠️ AI 消息：左对齐，灰色 */\n.ai-message {\n  align-self: flex-start;  /* ✅ 左对齐关键！*/\n  background: #2a2a2a;\n  color: #e0e0e0;\n}\n\`\`\`\n\n**⚠️ 关键点：**\n- ID 必须用唯一前缀（\`inner-\`）\n- 容器必须 \`display: flex; flex-direction: column\`\n- 用户消息用 \`align-self: flex-end\` 右对齐\n- AI 消息用 \`align-self: flex-start\` 左对齐\n\n**关键 API：**\n- **\`generate(prompt)\`**: **调用 AI 生成（使用当前预设、角色卡、世界书）**\n- \`generateRaw(prompt)\`: 调用 AI 生成（不使用预设，纯文本生成）\n- \`getVariables({ type: 'message', message_id })\`: 读取消息楼层变量\n- \`insertOrAssignVariables(data, { type: 'message', message_id })\`: 保存到消息楼层变量\n- \`getChatMessages()\`: 获取所有消息\n\n**重要区别：**\n- **\`generate\`**: 使用完整的角色预设，适合同层对话（推荐！）\n- **\`generateRaw\`**: 不使用预设，适合纯文本生成任务\n\n**⚠️ 关键注意事项（必读）：**\n1. **作用域问题（最常见错误！80% 的问题都是这个！）**：\n   - ❌ **禁止**：在 \`$(function() {})\` 内部用 \`let\`/\`const\`/\`function\` 定义变量和函数\n   - ✅ **正确**：所有变量和函数都在**全局作用域**定义，\`$(function() {})\` 只用于调用\n   - **验证方法**：在初始化时打印 \`console.log(typeof chatHistory)\`，应该是 \`'object'\` 而非 \`'undefined'\`\n\n1.5. **禁止写模拟/假回复（常见多余代码！）**：\n   - ❌ **禁止**：\`chatHistory.push({ role: 'assistant', content: '这是模拟回复' });\`\n   - ❌ **禁止**：\`chatHistory.push({ role: 'assistant', content: '这是 AI 的回复' });\`\n   - ❌ **禁止**：任何硬编码的假 AI 回复\n   - ✅ **正确**：只调用 \`generate()\`，AI 回复通过 \`STREAM_TOKEN_RECEIVED_FULLY\` 事件自动接收\n   - **原因**：\`generate()\` 会真正调用 AI API，不需要写假回复来测试\n\n2. **generation_id 的正确用法（非常重要！）**：\n   - ❌ 错误：\`const result = await generate(...); const id = result.generation_id;\`\n   - ✅ 正确：\n     \`\`\`javascript\n     const myId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n     await generate({ user_input: text, generation_id: myId });\n     // 监听器中的 id 参数就是 myId\n     \`\`\`\n   - \`generate()\` 返回 \`Promise<string>\`，不返回对象！\n   - 必须自己生成唯一 ID 并传入，不是从返回值获取！\n\n3. **这是前端界面项目，不是消息楼层嵌入！**\n   - 需要创建 \`index.html\` + \`index.ts\`（前端界面项目）\n   - 玩家在界面内游玩，不看酒馆主聊天\n   - 后台可用 \`setChatMessages(..., { refresh: 'none' })\` 操作消息但不刷新\n\n4. **函数命名必须避免冲突**：\n   - ❌ 禁止使用 \`sendChatMessage\`（与酒馆原生函数重名！）\n   - ❌ 禁止使用 \`generate\`、\`getChatMessages\` 等酒馆 API 名作为函数名\n   - ✅ 使用带前缀的名称：\`handleSend\`、\`innerSendMessage\`、\`sendInnerMessage\`\n   - **原因**：重名会导致调用酒馆内部函数 \`sk()\` 等，引发错误\n\n5. **元素 ID 必须唯一**：\n   - 使用 \`inner-\` 等前缀避免与酒馆冲突\n   - 不要用 \`send-button\`、\`user-input\` 等常见名称\n   - **验证方法**：检查 \`$('#inner-messages').length\` 应该是 1，不是 0\n\n6. **流式传输监听（核心！最容易出错！）**：\n   - ⚠️ **事件名：使用常量 \`iframe_events.XXX\`，不要用字符串 \`'iframe_events.XXX'\`**\n   - ⚠️ **回调参数：是 \`(text, id)\`，不是 \`(data)\`！直接用 \`text\` 不要用 \`data.text\`**\n   - ⚠️ **必须启用流式：\`generate({ user_input: text, should_stream: true, generation_id: myId })\`**\n   - 使用 \`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, (text, id) => ...)\` 获取完整回复\n   - 使用 \`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => ...)\` 获取增量更新\n\n7. **API 使用规范**：\n   - ✅ \`generate(prompt)\`：包含角色卡、预设、世界书（推荐！）\n   - ✅ \`generateRaw(prompt)\`：纯文本生成，不使用预设\n   - 两者都会触发流式传输事件\n\n8. **数据持久化**：\n   - 推荐使用 \`getVariables({ type: 'chat' })\` 和 \`insertOrAssignVariables(data, { type: 'chat' })\`\n   - 或使用消息楼层变量：\`{ type: 'message', message_id }\`\n   - 页面卸载时必须保存数据\n\n**核心示例（必须严格遵守！）：**\n\`\`\`javascript\n// ========== ⚠️ 关键：流式事件监听（最容易出错！）==========\n\n// ❌❌❌ 错误写法（禁止！）：\n// eventOn('iframe_events.STREAM_TOKEN_RECEIVED_FULLY', (data) => { ... })\n// ❌ 不要用字符串 'iframe_events.XXX'\n// ❌ 不要用参数 (data)\n\n// ✅✅✅ 正确写法（必须这样写！）：\neventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => {\n  // text 是累积的完整文本\n  $('#ai-reply').text(text); // ✅ 直接用 text，不是 text.text 或 data.text\n  console.log('增量更新:', text);\n});\n\neventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, (text, id) => {\n  // text 是最终完整文本\n  console.log('✅ 生成完成:', text); // ✅ 直接用 text\n  chatHistory.push({ role: 'assistant', content: text });\n  saveChatHistory();\n  isGenerating = false;\n  $('#send-btn').prop('disabled', false).text('发送');\n});\n\n// 备选方案：如果流式不工作，用 GENERATION_ENDED\neventOn(iframe_events.GENERATION_ENDED, (text, id) => {\n  console.log('✅ 生成结束:', text);\n  chatHistory.push({ role: 'assistant', content: text });\n  saveChatHistory();\n  isGenerating = false;\n  $('#send-btn').prop('disabled', false).text('发送');\n});\n\n// ========== 发送消息 ==========\nasync function handleSend() {\n  const userInput = $('#user-input').val();\n  chatHistory.push({ role: 'user', content: userInput });\n\n  isGenerating = true;\n  $('#send-btn').prop('disabled', true).text('生成中...');\n\n  // ✅✅✅ 必须这样调用（使用 STScript 命令）：\n  const command = '/gen lock=on "' + userInput.replace(/"/g, '\\\\"') + '"';\n  const result = await triggerSlashWithResult(command);\n\n  if (result) {\n    chatHistory.push({ role: 'assistant', content: result });\n    renderMessages();\n  }\n\n  // ❌❌❌ 禁止使用 generate API：\n  // await generate({ user_input: userInput });  // ❌ 不推荐\n}\n\`\`\`\n\n**为什么用 triggerSlashWithResult？**\n- 使用 \`/gen\` 命令会自动应用角色卡、预设、世界书\n- 返回值直接是生成的文本，简单直接\n- 不需要复杂的流式监听和 generation_id 管理\n\n**\`/gen\` 命令说明：**\n- \`/gen lock=on "提示词"\`：生成时锁定输入框（推荐！）\n- 会自动使用当前角色卡、预设、世界书\n- 返回值是 AI 生成的完整文本\n\n---\n\n# 🌊 同层对话的两种实现方式（AI 自动选择）\n\n当用户需求中提到**"实时显示"、"打字效果"、"流式"、"边生成边显示"**时，使用**真流式方案**（方案B）。\n否则，使用**简单方案**（方案A）。\n\n## ⚠️⚠️⚠️ 必须包含的核心功能（两种方案都要有！）\n\n### 1. 数据持久化（最重要！）\n- ✅ **保存到聊天变量**：使用 \`insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' })\`\n- ✅ **页面加载时恢复**：在 \`$(function() {})\` 中调用 \`loadChatHistory()\`\n- ✅ **切换聊天时重新加载**：监听 \`SillyTavern.getCurrentChatId()\` 变化\n- ✅ **页面卸载时保存**：在 \`$(window).on('pagehide', ...)\` 中保存\n- ✅ **实时保存**：每次发送/接收消息后立即调用 \`saveChatHistory()\`\n\n### 2. 不打断生成（关键！）\n- ✅ **最小化面板不打断**：面板只是隐藏（\`display: none\`），iframe 不卸载\n- ✅ **切换标签页不打断**：数据已保存到变量，切换回来自动恢复\n- ✅ **刷新页面后恢复**：从聊天变量读取 \`chatHistory\`，完整恢复对话\n\n### 3. 跨聊天隔离\n- ✅ **每个聊天独立**：数据存储在 \`{ type: 'chat' }\`，不同聊天文件数据互不影响\n- ✅ **切换聊天自动切换数据**：监听 \`getCurrentChatId()\` 变化，自动加载对应聊天的历史\n\n## 📚 简单方案（triggerSlashWithResult）\n\n**特点：** 代码简单，等待完整生成后一次性显示。\n\n**完整实现（包含数据持久化！）：**\n\n\`\`\`typescript\n// ===== 1. 全局变量（必须在全局作用域！）=====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\n\n// ===== 2. 数据持久化 =====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 正则过滤（核心！）=====\nfunction applyRegexFilters(text: string): string {\n  console.log('🔍 开始清理，原始长度:', text.length);\n\n  if (!text || typeof text !== 'string') return '';\n\n  // ===== 步骤 0: 修复未闭合的标签 =====\n  const criticalTags = ['thinking', 'UpdateVariable', 'guide', 'plot', 'status', 'dream', 'gametxt'];\n  criticalTags.forEach(tag => {\n    const openTagRegex = new RegExp(\\\`<\\\${tag}([^>]*)>\\\`, 'gi');\n    const closeTagRegex = new RegExp(\\\`</\\\${tag}>\\\`, 'gi');\n\n    const openMatches = text.match(openTagRegex);\n    const closeMatches = text.match(closeTagRegex);\n\n    const openCount = openMatches ? openMatches.length : 0;\n    const closeCount = closeMatches ? closeMatches.length : 0;\n\n    if (openCount > closeCount) {\n      const missing = openCount - closeCount;\n      console.log(\\\`⚠️ 发现 \\\${missing} 个未闭合的 <\\\${tag}> 标签，自动补齐\\\`);\n      text = text + \\\`</\\\${tag}>\\\`.repeat(missing);\n    }\n  });\n\n  // ===== 步骤 1: 优先提取正文标签（梦星方案）=====\n  function extractLastTagContent(tagName: string, text: string): string | null {\n    if (!text || typeof text !== 'string') return null;\n\n    const endTag = \\\`</\\\${tagName}>\\\`;\n    const searchPool = text.toLowerCase();\n    const endTagPattern = endTag.toLowerCase();\n\n    const lastEndIndex = searchPool.lastIndexOf(endTagPattern);\n    if (lastEndIndex !== -1) {\n      const startTag = \\\`<\\\${tagName}>\\\`;\n      const startTagPattern = startTag.toLowerCase();\n\n      const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);\n      if (lastStartIndex !== -1) {\n        const startIndex = lastStartIndex + startTag.length;\n        return text.substring(startIndex, lastEndIndex).trim();\n      }\n    }\n    return null;\n  }\n\n  const gameTextTags = ['dream', 'gametxt', 'output', 'display', 'text', 'content'];\n  for (const tag of gameTextTags) {\n    const extracted = extractLastTagContent(tag, text);\n    if (extracted !== null) {\n      console.log(\\\`✅ 提取了 <\\\${tag}> 标签的内容，长度:\\\`, extracted.length);\n      return extracted;\n    }\n  }\n\n  // ===== 步骤 2: 移除所有思维链标签 =====\n  let cleanedText = text;\n\n  const tagsToRemove = [\n    'guide', 'plot', 'status',\n    'UpdateVariable', '角色提取', '本世历程', '往世涟漪'\n  ];\n\n  tagsToRemove.forEach(tag => {\n    const regexWithContent = new RegExp(\\\`<\\\${tag}[^>]*>[\\\\\\\\s\\\\\\\\S]*?</\\\${tag}>\\\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regexWithContent, '');\n\n    const regexSelfClosing = new RegExp(\\\`<\\\${tag}\\\\\\\\s*\\\\\\\\/>\\\`, 'gi');\n    cleanedText = cleanedText.replace(regexSelfClosing, '');\n\n    if (before !== cleanedText) {\n      console.log(\\\`  🧹 移除了 <\\\${tag}> 标签\\\`);\n    }\n  });\n\n  // 特殊处理：移除所有包含 think/thinking 的标签\n  const thinkingRegex = /<[^>]*think[^>]*>[\\\\s\\\\S]*?<\\\\/[^>]*think[^>]*>/gi;\n  const beforeThinking = cleanedText;\n  cleanedText = cleanedText.replace(thinkingRegex, '');\n  if (beforeThinking !== cleanedText) {\n    console.log('  🧹 移除了包含 think/thinking 的思维链标签');\n  }\n\n  const thinkingSelfClosing = /<[^>]*think[^>]*\\\\/>/gi;\n  cleanedText = cleanedText.replace(thinkingSelfClosing, '');\n\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  if (cleanedText !== text) {\n    console.log('✅ 标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 3: 尝试应用酒馆正则（可选）=====\n  let allRegexScripts: any[] = [];\n\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegexes = getRegexScripts();\n      if (globalRegexes && globalRegexes.length > 0) {\n        console.log('📋 从全局正则获取到', globalRegexes.length, '个脚本');\n        allRegexScripts = allRegexScripts.concat(globalRegexes);\n      }\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  try {\n    const parentST = (window as any).parent?.SillyTavern || (window as any).SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find((p: any) => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes: any = null;\n\n              if (Array.isArray(data)) {\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break;\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length > 0) {\n    console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n    const activeScripts = allRegexScripts.filter((script: any) => {\n      if (script.disabled) return false;\n      if (!script.placement || !Array.isArray(script.placement)) return false;\n      if (!script.placement.includes(2)) return false;\n      return true;\n    });\n\n    console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n    let result = text;\n    activeScripts.forEach((script: any, index: number) => {\n      try {\n        const regex = new RegExp(script.findRegex, 'gim');\n        const beforeLength = result.length;\n        result = result.replace(regex, script.replaceString || '');\n\n        if (beforeLength !== result.length) {\n          console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效');\n        }\n      } catch (e) {\n        console.error('❌ 正则', index + 1, '应用失败:', e);\n      }\n    });\n\n    text = result;\n  }\n\n  console.log('📊 最终长度:', text.length);\n  return text;\n}\n\n// ===== 4. 发送消息 =====\nasync function handleSend() {\n  const input = $('#inner-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    if (typeof triggerSlashWithResult !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    const userName = SillyTavern?.name1 || 'You';\n    const charName = SillyTavern?.name2 || 'AI';\n\n    let fullPrompt = '';\n    if (chatHistory.length > 1) {\n      fullPrompt += '【对话历史】\\n';\n      chatHistory.slice(0, -1).forEach((msg) => {\n        const name = msg.role === 'user' ? userName : charName;\n        fullPrompt += name + ': ' + msg.content + '\\n';\n      });\n      fullPrompt += '\\n';\n    }\n    fullPrompt += userName + ': ' + userInput;\n\n    console.log('🚀 开始生成，提示词长度:', fullPrompt.length);\n\n    const command = '/gen lock=on "' + fullPrompt.replace(/"/g, '\\\\"') + '"';\n    const result = await triggerSlashWithResult(command);\n\n    console.log('📥 AI 返回值长度:', result ? result.length : 0);\n\n    if (result && result.length > 0) {\n      const cleanedResult = applyRegexFilters(result);\n      console.log('🧹 正则过滤后长度:', cleanedResult.length);\n\n      chatHistory.push({ role: 'assistant', content: cleanedResult });\n      saveChatHistory();\n      renderMessages();\n      toastr.success('回复成功');\n    } else {\n      toastr.warning('AI 未返回内容');\n    }\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    isGenerating = false;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 5. 渲染消息 =====\nfunction renderMessages() {\n  const container = $('#inner-messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 6. 监听聊天切换（重要！）=====\nlet currentChatId = SillyTavern.getCurrentChatId();\nif (typeof eventOn === 'function') {\n  eventOn('CHAT_CHANGED', (newChatId: string) => {\n    if (currentChatId !== newChatId) {\n      console.log('🔄 检测到聊天切换:', currentChatId, '->', newChatId);\n      currentChatId = newChatId;\n\n      // 重新加载新聊天的历史\n      loadChatHistory();\n\n      // 重置生成状态（如果正在生成，会被打断）\n      if (isGenerating) {\n        isGenerating = false;\n        $('#inner-send-btn').prop('disabled', false).text('发送');\n        console.log('⚠️ 切换聊天，已中断生成');\n      }\n    }\n  });\n}\n\n// ===== 7. 初始化 =====\n$(function() {\n  console.log('✅ 同层对话初始化开始（方案A）');\n  console.log('📊 当前聊天 ID:', currentChatId);\n\n  // 加载聊天历史（从聊天变量恢复）\n  loadChatHistory();\n\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成（方案A）');\n  console.log('💾 已加载', chatHistory.length, '条历史消息');\n});\n\n// ===== 8. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  console.log('💾 页面卸载，保存数据');\n  saveChatHistory();\n});\n\`\`\`\n\n---\n\n## 🌊 真流式方案（generate + 事件监听）\n\n**特点：** 实时显示 AI 打字效果，体验最佳。\n\n**完整实现：**\n\n\`\`\`typescript\n// ===== 1. 全局变量（必须在全局作用域！）=====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\nlet currentGenerationId: string | null = null;\n\n// ===== 2. 数据持久化（与方案A相同）=====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 正则过滤（与方案A相同）=====\nfunction applyRegexFilters(text: string): string {\n  // ... 与方案A完全相同，此处省略 ...\n  // （请复制方案A中的 applyRegexFilters 完整实现）\n  return text;\n}\n\n// ===== 4. 真流式监听（核心！）=====\nfunction setupStreamListeners() {\n  // ⚠️ 监听增量文本（实时更新）\n  eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text: string, id: string) => {\n    if (!isGenerating || id !== currentGenerationId) return;\n\n    console.log('📥 收到增量文本，长度:', text.length);\n\n    // ⚠️ 实时清理标签\n    const cleanedText = applyRegexFilters(text);\n\n    // 更新 DOM\n    const container = $('#inner-messages');\n    const charName = (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n    const lastMsg = container.find('.message:last-child');\n\n    if (lastMsg.length && lastMsg.hasClass('ai-message')) {\n      // 更新已有的 AI 消息\n      lastMsg.html('<strong>' + charName + ':</strong> <span class="streaming">' + cleanedText + '</span>');\n    } else {\n      // 创建新的 AI 消息\n      const msgDiv = $('<div>')\n        .addClass('message ai-message')\n        .html('<strong>' + charName + ':</strong> <span class="streaming">' + cleanedText + '</span>');\n      container.append(msgDiv);\n    }\n\n    // 自动滚动到底部\n    container.scrollTop(container[0].scrollHeight);\n  });\n\n  // ⚠️ 监听生成完成\n  eventOn(iframe_events.GENERATION_ENDED, (text: string, id: string) => {\n    if (id === currentGenerationId) {\n      console.log('✅ 流式生成完成，长度:', text.length);\n\n      // ⚠️ 最后清理一次再保存\n      const cleanedText = applyRegexFilters(text);\n\n      // 保存到聊天历史\n      chatHistory.push({ role: 'assistant', content: cleanedText });\n      saveChatHistory();\n\n      // 重新渲染（移除光标效果）\n      renderMessages();\n\n      // 重置状态\n      isGenerating = false;\n      currentGenerationId = null;\n      $('#inner-send-btn').prop('disabled', false).text('发送');\n\n      toastr.success('回复完成');\n    }\n  });\n}\n\n// ===== 5. 发送消息（真流式版本）=====\nasync function handleSend() {\n  const input = $('#inner-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 添加用户消息\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  // 生成唯一 ID\n  currentGenerationId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n\n  // 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    if (typeof generate !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    console.log('🚀 开始生成（真流式），generation_id:', currentGenerationId);\n\n    // ⚠️ 核心：调用 generate 并启用流式\n    await generate({\n      user_input: userInput,\n      should_stream: true,           // ⚠️ 必须启用流式\n      generation_id: currentGenerationId,  // ⚠️ 必须传入 ID\n      overrides: {\n        chat_history: {\n          prompts: chatHistory.map(msg => ({\n            role: msg.role === 'user' ? 'user' : 'assistant',\n            content: msg.content\n          }))\n        }\n      }\n    });\n\n    // 注意：实际的文本更新是通过事件监听器实时更新的\n    // GENERATION_ENDED 事件会自动保存 AI 回复到历史\n\n  } catch (error) {\n    console.error('❌ 生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n\n    // 重置状态\n    isGenerating = false;\n    currentGenerationId = null;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 6. 渲染消息（与方案A相同）=====\nfunction renderMessages() {\n  const container = $('#inner-messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 7. 监听聊天切换（重要！）=====\nlet currentChatId = SillyTavern.getCurrentChatId();\nif (typeof eventOn === 'function') {\n  eventOn('CHAT_CHANGED', (newChatId: string) => {\n    if (currentChatId !== newChatId) {\n      console.log('🔄 检测到聊天切换:', currentChatId, '->', newChatId);\n      currentChatId = newChatId;\n\n      // 重新加载新聊天的历史\n      loadChatHistory();\n\n      // 重置生成状态（如果正在生成，会被打断）\n      if (isGenerating) {\n        isGenerating = false;\n        currentGenerationId = null;\n        $('#inner-send-btn').prop('disabled', false).text('发送');\n        console.log('⚠️ 切换聊天，已中断生成');\n      }\n    }\n  });\n}\n\n// ===== 8. 初始化 =====\n$(function() {\n  console.log('✅ 同层对话初始化开始（方案B - 真流式）');\n  console.log('📊 当前聊天 ID:', currentChatId);\n\n  // 加载聊天历史（从聊天变量恢复）\n  loadChatHistory();\n\n  // 设置流式监听（⚠️ 必须在加载时就设置）\n  setupStreamListeners();\n\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成（方案B）');\n  console.log('💾 已加载', chatHistory.length, '条历史消息');\n});\n\n// ===== 9. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  console.log('💾 页面卸载，保存数据');\n  saveChatHistory();\n});\n\`\`\`\n\n**CSS 样式（为方案B添加光标效果）：**\n\n\`\`\`css\n.streaming {\n  border-right: 2px solid #165DFF;\n  padding-right: 4px;\n  animation: blink 1s infinite;\n}\n\n@keyframes blink {\n  0%, 50% { border-right-color: #165DFF; }\n  51%, 100% { border-right-color: transparent; }\n}\n\`\`\`\n\n---\n\n## 🤖 AI 选择策略\n\n**分析用户需求描述，自动选择合适方案：**\n\n1. **使用真流式方案（第二种）**，如果用户提到：\n   - "实时显示"、"边生成边显示"\n   - "打字效果"、"流式"\n   - "不想等待"、"即时反馈"\n   - 或明确要求同层对话\n\n2. **使用简单方案（第一种）**，如果：\n   - 用户没有明确要求流式显示\n   - 或用户说"简单的对话界面"\n\n**⚠️ 默认推荐：** 当用户提到"同层对话"时，默认使用**真流式方案**（体验更好）。\n\n## 需求收集与界面设计引导（重要！）\n\n**当用户需求不够详细时，必须先引导用户补充信息，不要立即生成代码！**\n\n### AI 交互流程（必须遵守）\n\n**步骤1：检查用户需求是否完整**\n\n检查用户是否明确了以下内容：\n- 界面布局（对话框、输入区域、功能区的排布）\n- 配色方案（深色/浅色模式、主色调）\n- 特殊效果（动画、过渡效果）\n- 额外功能（文件上传、语音输入、消息编辑等）\n\n**步骤2：根据需求完整度决定输出**\n\n### 情况A：需求不完整（用户只说了"同层对话"、"流式对话"等核心功能）\n\n**不要立即生成代码！应该先引导用户补充需求！**\n\n输出格式：\n\`\`\`\nFILE_START: NEED_MORE_INFO\n\n你好！我看到你想要创建一个对话前端界面，核心功能包括：\n- 真流式传输（实时显示 AI 生成）\n- 消息历史自动管理（保存到聊天变量）\n- 正文标签实时清理（过滤思维链等）\n\n但是，为了给你生成最符合需求的界面，我需要了解更多细节：\n\n**1. 界面布局**\n- 对话框的位置和大小？\n- 输入区域放在底部还是其他位置？\n- 是否需要侧边栏、顶部栏或底部功能区？\n- 消息列表如何滚动（自动滚动到底部？）\n\n**2. 配色方案**\n- 偏好深色模式还是浅色模式？\n- 主色调偏好（蓝色、绿色、紫色等）？\n- 用户消息和 AI 消息如何区分颜色？\n\n**3. 特殊效果**\n- 是否需要动画效果（淡入淡出、滑动等）？\n- 消息出现时的过渡效果？\n- 按钮点击、输入框聚焦的交互反馈？\n\n**4. 额外功能**\n- 是否需要文件上传功能？\n- 是否需要语音输入？\n- 是否需要消息编辑/删除功能？\n- 是否需要清空历史按钮？\n- 是否需要正则预设切换（下拉菜单或按钮组）？\n\n---\n\n**在你提供这些详细信息之前，我先说明一下核心功能的实现原理：**\n\n### 核心组件结构\n\n一个基本的对话界面包含：\n\n1. **消息显示区**：用于渲染所有历史消息和正在进行的流式消息，支持滚动显示\n2. **消息输入区**：用户输入文本的区域，通常包含发送按钮\n3. **功能控制区**（可选）：切换正则预设、清除历史等功能按钮\n\n### 真流式对话的实现机制\n\n**流程：**\n1. 用户发送消息 → 调用 \`generate({ should_stream: true, generation_id })\`\n2. 监听 \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\` 事件实时接收文本片段\n3. 每接收一个片段 → 清理标签 → 附加到显示区（形成打字机效果）\n4. 流式结束 → 保存完整的清理后消息到 \`chatHistory\` → 持久化到聊天变量\n\n**关键点：**\n- 使用 \`generation_id\` 过滤事件（避免接收其他对话的消息）\n- 实时清理标签（\`applyRegexFilters\`）防止思维链暴露\n- 禁用发送按钮防止用户重复发送\n\n### 消息历史自动保存\n\n**数据结构：**\n\`\`\`javascript\nlet chatHistory = [\n  { role: 'user', content: '用户消息', timestamp: '...' },\n  { role: 'assistant', content: 'AI回复（已清理标签）', timestamp: '...' }\n];\n\`\`\`\n\n**保存时机：**\n- 用户消息：点击发送后立即保存\n- AI 消息：流式传输完成后，清理标签再保存\n\n**持久化：**\n使用 \`insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' })\` 保存到聊天变量\n\n### 正文标签实时清理\n\n**\`applyRegexFilters\` 函数的核心逻辑：**\n1. 自动补齐未闭合的标签（防止"前端失踪"）\n2. 优先提取正文标签（\`<dream>\`、\`<gametxt>\` 等）\n3. 移除思维链标签（\`<think>\`、\`<guide>\`、\`<plot>\` 等）\n4. 应用酒馆全局正则和预设正则\n\n**调用时机：**\n- 流式接收时：每个片段都清理后再显示\n- 保存时：完整消息清理后再保存到历史\n\n---\n\n**请补充上述细节，我会为你生成完整的代码！**\n\n如果你现在不想纠结这些细节，也可以直接说"用默认设计"，我会使用以下默认配置：\n- 深色模式（背景 #1a1a1a）\n- 用户消息：右对齐蓝色（#4a9eff）\n- AI 消息：左对齐灰色（#3a3a3a）\n- 圆角设计 + 基础动画\n- 自动滚动到底部\n\nFILE_END\n\`\`\`\n\n### 情况B：需求完整（用户提供了详细的界面设计需求）\n\n**直接生成代码！**\n\n输出格式：\n\`\`\`\nFILE_START: index.html\n[完整的 HTML 代码]\nFILE_END\n\nFILE_START: style.css\n[完整的 CSS 代码]\nFILE_END\n\nFILE_START: script.js\n[完整的 JavaScript 代码]\nFILE_END\n\`\`\`\n\n### 情况C：用户明确说"用默认设计"或"简单的对话界面就行"\n\n**使用默认设计规范生成代码**\n\n**默认界面设计规范：**\n- 深色模式（背景 #1a1a1a，消息区 #2a2a2a）\n- 用户消息：右对齐，蓝色背景（#4a9eff）\n- AI 消息：左对齐，灰色背景（#3a3a3a）\n- 圆角设计（border-radius: 12px）\n- 基础过渡动画（fadeIn/fadeOut）\n- 自动滚动到底部\n- 清空历史按钮\n- 基础的消息列表和输入框\n\n---\n\n### 正则预设切换功能（可选）\n\n如果用户明确需要支持不同的正则清理预设：\n\n\`\`\`typescript\n// 定义正则预设\nconst regexPresets = {\n  "默认清理": [\n    { pattern: /<tag1>/g, replacement: "" },\n    { pattern: /\\[tag2\\]/g, replacement: "" },\n  ],\n  "特殊格式清理": [\n    { pattern: /\\{\\{some_meta_data\\}\\}/g, replacement: "" },\n  ]\n};\n\nlet currentPreset = "默认清理";\n\nfunction applyRegexFilters(text: string, presetName?: string): string {\n  const preset = presetName || currentPreset;\n  const rules = regexPresets[preset] || regexPresets["默认清理"];\n\n  let cleanedText = text;\n  rules.forEach(rule => {\n    cleanedText = cleanedText.replace(rule.pattern, rule.replacement);\n  });\n\n  // 仍然应用酒馆的全局正则\n  // ... 原有逻辑 ...\n\n  return cleanedText;\n}\n\nfunction switchPreset(presetName: string) {\n  currentPreset = presetName;\n  renderMessages(); // 重新渲染应用新预设\n}\n\`\`\`\n\n**界面实现：**在顶部添加下拉菜单或按钮组切换预设\n\n---\n\n# 输出格式（必须严格遵守）：\n只在 FILE_START 和 FILE_END 之间输出代码，不要添加任何其他文字。\n\n**示例（创建界面时必须输出三个文件）：**\n\nFILE_START: index.html\n[完整的 HTML 代码，包含 head、body、引用 CSS 和 JS]\nFILE_END\n\nFILE_START: style.css\n[完整的 CSS 样式代码]\nFILE_END\n\nFILE_START: script.js\n[完整的 JavaScript 代码，使用 jQuery]\nFILE_END\n\n**⚠️ 代码规范（必须遵守）：**\n1. **函数命名**：必须使用唯一前缀（如 \`inner\`、\`my\`），避免与酒馆函数重名\n   - ❌ 禁止：\`sendChatMessage\`、\`generate\`、\`getChatMessages\`\n   - ✅ 正确：\`innerSendMessage\`、\`handleSendMessage\`、\`sendInnerMessage\`\n2. **元素 ID**：必须使用唯一前缀（如 \`inner-\`、\`my-\`）\n   - ❌ 禁止：\`#send-button\`、\`#user-input\`\n   - ✅ 正确：\`#inner-send-btn\`、\`#inner-user-input\`\n3. **每个文件都要输出完整内容，不能省略！**\n\n# 🔑 核心原则：优先增量修改，避免重写！\n**除非用户明确要求"重写"、"从头开始"、"重新创建"，否则必须基于现有代码进行最小化修改！**\n\n- ✅ 用户说"把按钮改成绿色" → **只输出 style.css**（只改颜色）\n- ✅ 用户说"添加一个重置功能" → **只输出 script.js**（只加函数）\n- ✅ 用户说"修复点击无响应" → **只输出 script.js**（只改事件）\n- ❌ 禁止：因为小改动就重写整个文件！\n\n# 输出文件策略：\n## 小改动（只输出必要的文件）：\n- 只修改颜色/字体/边距/动画 → **只输出 style.css**\n- 只修改一个函数逻辑/修复 bug → **只输出 script.js**\n- 只添加一个按钮/输入框 → **只输出 index.html**\n- 只修改文案/标签内容 → **只输出 index.html**\n\n## 大改动（输出所有相关文件）：\n- 创建新界面/新功能 → **输出 index.html、style.css、script.js**\n- 重构整体布局/完全重设计 → **输出所有文件**\n- 添加需要新样式和新逻辑的复杂功能 → **输出相关的所有文件**\n\n# 其他规则：\n1. **⚠️ 数据持久化：涉及用户数据必须使用 getVariables/insertOrAssignVariables！**\n2. **⚠️ 预览兼容：必须检测 \`typeof SillyTavern !== 'undefined'\`，预览模式下用 localStorage 替代酒馆 API**\n3. 必须输出完整内容，即使文件很长也不能省略（但优先只输出需要修改的文件）\n4. 不要在代码外添加任何解释文字\n5. CSS 要美观且符合现代设计\n6. JavaScript 使用 \`$(function() { ... })\` 确保 DOM 加载\n7. 数据存储：\`{ type: 'chat' }\` 绑定聊天，\`{ type: 'global' }\` 为全局\n8. 保持现有代码的命名风格、缩进、格式，不要随意重构`,y=`# 当前项目文件：\n${e.files.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n')}\n\n# 用户需求：\n${c.value}\n\n# ⚠️ 核心提醒：\n1. **优先增量修改**：除非用户明确要求重写，否则基于现有代码最小化修改\n2. **只输出需要改的文件**：小改动只输出 1 个文件，大改动才输出多个\n3. **保持代码风格一致**：不要随意重构现有代码\n4. **数据持久化**：使用 getVariables/insertOrAssignVariables\n\n请严格按 system 中的格式输出，不要添加解释！`;g.value='';let v='';if(I.value?.setProgress(25),I.value?.setMessage('正在发送请求到 AI 服务器...'),A.updateTaskProgress(a,25,'正在发送请求到 AI 服务器...'),await new Promise(e=>setTimeout(e,100)),u.value){I.value?.setProgress(30),I.value?.setMessage('等待 AI 流式响应...'),A.updateTaskProgress(a,30,'等待 AI 流式响应...'),await new Promise(e=>setTimeout(e,100));const e=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${i}`},body:JSON.stringify({model:s,messages:[{role:'system',content:h},{role:'user',content:y}],temperature:l,max_tokens:d,stream:!0})});if(!e.ok){let n=`API 请求失败: ${e.status} ${e.statusText}`;try{const t=await e.json();console.error('API 错误详情:',t),n+=`\n${JSON.stringify(t,null,2)}`}catch(o){console.error('无法解析错误响应')}throw new Error(n)}const n=e.body?.getReader(),r=new TextDecoder;if(!n)throw new Error('无法读取响应流');let c=0;for(;;){const{done:e,value:t}=await n.read();if(e)break;const a=r.decode(t,{stream:!0}).split('\n');for(const n of a)if(n.startsWith('data: ')){const e=n.slice(6);if('[DONE]'===e)continue;try{const n=JSON.parse(e),t=n.choices?.[0]?.delta?.content||'';if(t){v+=t,g.value+=t,c++;const e=Math.min(60,30+c/10);I.value?.setProgress(e),c%10==0&&I.value?.setMessage(`正在接收 AI 响应... (${v.length} 字符)`)}}catch(o){}}}}else{I.value?.setProgress(30),I.value?.setMessage('等待 AI 响应...'),A.updateTaskProgress(a,30,'等待 AI 响应...'),await new Promise(e=>setTimeout(e,100));const e=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${i}`},body:JSON.stringify({model:s,messages:[{role:'system',content:h},{role:'user',content:y}],temperature:l,max_tokens:d})});if(!e.ok){let n=`API 请求失败: ${e.status} ${e.statusText}`;try{const t=await e.json();console.error('API 错误详情:',t),n+=`\n${JSON.stringify(t,null,2)}`}catch(o){console.error('无法解析错误响应')}throw new Error(n)}I.value?.setProgress(60),I.value?.setMessage('正在接收 AI 响应...'),A.updateTaskProgress(a,60,'正在接收 AI 响应...');const n=await e.json();v=n.choices?.[0]?.message?.content||''}if(I.value?.setProgress(75),I.value?.setMessage('正在解析 AI 生成的代码...'),A.updateTaskProgress(a,75,'正在解析 AI 生成的代码...'),console.log('AI 原始回复:',v),console.log('AI 回复长度:',v.length),!v||0===v.trim().length)throw new Error('AI 返回内容为空，请检查 API 配置或重试');const w=[],S=/FILE_START:\s*(.+?)[\r\n]+([\s\S]*?)FILE_END/gi;let C;console.log('开始解析 AI 返回内容...');const E=v.match(/FILE_START:\s*NEED_MORE_INFO\s*[\r\n]+([\s\S]*?)FILE_END/i);if(E){const e=E[1].trim();return console.log('🤖 AI 需要更多信息，显示引导内容'),q(),toastr.info('AI 需要更多信息','',{timeOut:3e3}),alert(e),void(p.value=!1)}for(;null!==(C=S.exec(v));){const n=C[1].trim(),t=C[2].trim();console.log(`找到文件: ${n}, 内容长度: ${t.length}`);const a=e.files.find(e=>e.path===n);a?w.push({path:n,oldContent:a.content,newContent:t}):console.warn(`文件 ${n} 不存在于项目中，已忽略`)}if(0===w.length){if(console.error('未能从 AI 回复中解析出文件修改'),console.error('AI 返回内容预览:',v.substring(0,500)),v.length<500||!v.includes('FILE_END'))throw new Error(`AI 返回内容被截断（仅 ${v.length} 字符）。请在"设置"中增加 max_tokens（建议 4000 以上），然后重试。`);throw new Error('AI 未返回有效的文件修改格式。请确保 AI 返回的内容包含 FILE_START 和 FILE_END 标记。')}console.log('解析到的修改:',w.length,'个文件'),I.value?.setProgress(85),I.value?.setMessage('正在准备对比预览...'),A.updateTaskProgress(a,85,'正在准备对比预览...'),1===w.length&&'index.html'===w[0].path&&toastr.warning('AI 可能只生成了 HTML，建议重新生成或手动补充 CSS/JS');(v.trim().split('FILE_START').pop()||'').includes('FILE_END')||toastr.error('AI 回复可能被截断，建议简化需求或重试');const P={changes:w};if(!P.changes||!Array.isArray(P.changes))throw new Error('AI 返回格式错误');m.value=P.changes,I.value?.setProgress(95),I.value?.setMessage(`正在生成预览... (${w.length} 个文件)`),A.updateTaskProgress(a,95,`正在生成预览... (${w.length} 个文件)`),q(),f.value=!0,x.value='after',I.value?.setProgress(100),I.value?.setMessage('✅ AI 生成完成！'),A.updateTaskProgress(a,100,'✅ AI 生成完成！'),A.completeTask(a,{changedFiles:w.length}),setTimeout(()=>{k.value=!1,toastr.success(`✅ AI 生成完成！已更新 ${w.length} 个文件`)},800)}catch(r){console.error('AI 生成失败:',r);const e=r.message||String(r);A.failTask(a,e),k.value=!1,e.includes('CORS')||e.includes('Failed to fetch')||e.includes('Access-Control-Allow-Origin')?toastr.error(`⚠️ CORS 错误：无法访问 API\n\n原因：API 服务器（${new URL(t).origin}）未配置 CORS 头\n\n解决方案：\n1. 在 API 服务器配置 CORS\n2. 或使用支持 CORS 的 API 端点\n3. 或通过酒馆的 API 代理功能调用`):e.includes('307')||e.includes('Temporary Redirect')?toastr.error(`⚠️ URL 重定向错误\n\n端点：${t}\n\n可能原因：URL 格式不正确\n请检查端点设置，确保格式为：https://服务器/v1`):toastr.error(`AI 生成失败: ${e}`)}finally{p.value=!1}},acceptChanges:function(){const e=L.value;if(!e)return;const n={timestamp:(new Date).toISOString(),prompt:c.value,changes:m.value};if(y.value[r.value]||(y.value[r.value]=[]),y.value[r.value].unshift(n),console.log('添加 AI 历史记录，当前项目历史数:',y.value[r.value].length),m.value.forEach(n=>{const t=e.files.find(e=>e.path===n.path);t&&(t.content=n.newContent)}),W(),B(),i.value){const n=e.files.find(e=>e.path===i.value);n&&(s.value=n.content)}f.value=!1,m.value=[],toastr.success('更改已应用')},rejectChanges:function(){f.value=!1,m.value=[],toastr.info('已拒绝更改')},showHistoryDialog:function(){h.value=!0},closeHistoryDialog:X,restoreHistory:function(e){if(!confirm(`确定要恢复到这个历史版本吗？\n\n"${e.prompt}"\n\n当前的修改将被覆盖。`))return;const n=L.value;if(n){if(e.changes.forEach(e=>{const t=n.files.find(n=>n.path===e.path);t&&(t.content=e.newContent)}),console.log('恢复历史版本:',e.prompt),W(),B(),i.value){const e=n.files.find(e=>e.path===i.value);e&&(s.value=e.content)}X(),toastr.success('已恢复到历史版本')}},exportToRegex:function(){const e=L.value;if(!e)return void toastr.error('请先选择一个项目');const n=e.files.find(e=>e.name===i.value);if(n&&s.value!==n.content){if(!confirm('检测到有未保存的修改，建议先手动保存。\n\n是否继续导出（将使用上次保存的版本）？'))return}const t=prompt(`正在导出项目：${e.name}\n\n请输入触发词（正则表达式）：\n例如：【开场白】 或 /开场白/g`,`【${e.name}】`);if(t)try{const n=J(e.files),a='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const n=16*Math.random()|0;return('x'===e?n:3&n|8).toString(16)});let o=n.replace(/\r/g,'');o=o.replace(/^<!DOCTYPE html>\n/,'');const r={id:a,scriptName:e.name,findRegex:t.startsWith('/')?t:`/${t}/g`,replaceString:'```html\n\n'+o+'\n```',trimStrings:[],placement:[1,2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null},i=JSON.stringify(r,null,4),s=new Blob([i],{type:'application/json'}),l=URL.createObjectURL(s),d=document.createElement('a');d.href=l,d.download=`${e.name}_regex.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l),console.log('导出的正则 JSON:',r),toastr.success(`项目 "${e.name}" 已导出为正则 JSON`)}catch(a){console.error('导出失败:',a),toastr.error(`导出失败: ${a.message}`)}else toastr.info('已取消导出')},openInNewWindow:function(){if(!l.value)return void toastr.error('没有可预览的内容');const e=L.value,n=e?e.name:'预览',t=window.open('','_blank','width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');t?(t.document.write(l.value),t.document.close(),t.document.title=n,toastr.success('已在新窗口打开预览')):toastr.error('无法打开新窗口，请检查浏览器弹窗设置')},ProgressDialog:ei};return Object.defineProperty(K,'__isScriptSetup',{enumerable:!1,value:!0}),K}}),ti={class:'project-tab'},ai={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 28px',background:'#2a2a2a','backdrop-filter':'blur(12px)','border-radius':'14px','margin-bottom':'20px',border:'1px solid #333','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'}},oi={class:'project-action-buttons',style:{display:'flex',gap:'10px'}},ri={style:{display:'grid','grid-template-columns':'220px 1fr 650px',gap:'20px','min-height':'500px'}},ii={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},si={key:0,style:{'text-align':'center',color:'#666','font-size':'12px',padding:'20px 10px'}},li=['onClick','onMouseenter','onMouseleave'],di={style:{'font-size':'13px',flex:'1'}},ci=['onClick'],pi={key:1,style:{'margin-top':'20px','border-top':'1px solid #3a3a3a','padding-top':'15px'}},ui={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'10px'}},gi={style:{display:'flex',gap:'5px'}},fi=['onClick','onMouseenter','onMouseleave'],mi=['onClick'],xi={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},hi={key:0,style:{flex:'1',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px'}},bi={key:1,style:{flex:'1',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px'}},yi={key:2,style:{display:'flex','flex-direction':'column',height:'100%'}},vi={style:{'margin-bottom':'10px',display:'flex','justify-content':'space-between','align-items':'center'}},wi={style:{display:'flex','align-items':'center',gap:'8px'}},ki={style:{color:'#fff','font-size':'14px','font-weight':'500'}},_i={style:{display:'flex','align-items':'center',gap:'10px'}},Ti=['placeholder'],Si={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},Ii={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'15px'}},Ai={style:{display:'flex',gap:'8px'}},zi={style:{flex:'1',background:'#1e1e1e','border-radius':'8px',overflow:'auto',position:'relative','min-height':'400px'}},Ci=['srcdoc'],$i={key:1,style:{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%, -50%)',color:'#666','font-size':'12px','text-align':'center'}},Ei={style:{background:'#2a2a2a','border-radius':'16px',padding:'25px',width:'90%','max-width':'600px',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},Pi={style:{'margin-bottom':'15px'}},Mi={style:{'margin-top':'12px'}},Oi={style:{display:'flex','flex-wrap':'wrap',gap:'8px'}},ji=['onClick'],Di={style:{display:'flex','align-items':'center',gap:'10px','margin-bottom':'15px',padding:'10px',background:'#252525','border-radius':'6px'}},Ri={style:{display:'flex','align-items':'center',gap:'8px',cursor:'pointer',color:'#ccc','font-size':'13px','user-select':'none'}},Ni={key:0,style:{'margin-bottom':'15px',padding:'15px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px','max-height':'200px','overflow-y':'auto','font-family':'\'Consolas\', monospace','font-size':'12px',color:'#e0e0e0','line-height':'1.5','white-space':'pre-wrap'}},Hi={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Li=['disabled'],Fi={key:0,class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},Vi={key:1,class:'fa-solid fa-spinner fa-spin',style:{'margin-right':'6px'}},Ui={style:{background:'#2a2a2a','border-radius':'16px',padding:'25px',width:'90%','max-width':'650px',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},Ji={style:{'margin-bottom':'15px'}},Bi={style:{'margin-bottom':'15px'}},Wi={style:{'margin-bottom':'15px'}},Gi={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Yi=['disabled'],Zi={key:0,class:'fa-solid fa-wrench',style:{'margin-right':'6px'}},qi={key:1,class:'fa-solid fa-spinner fa-spin',style:{'margin-right':'6px'}},Xi={key:2,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.9)',display:'flex','align-items':'center','justify-content':'center','z-index':'10001',padding:'20px'}},Ki={style:{background:'#2a2a2a','border-radius':'16px',width:'95%',height:'90%',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',display:'flex','flex-direction':'column'}},Qi={style:{padding:'20px 25px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},es={style:{display:'flex',gap:'10px'}},ns={style:{flex:'1',display:'grid','grid-template-columns':'1fr 1fr 1.5fr',gap:'15px',padding:'20px',overflow:'hidden'}},ts={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},as={style:{flex:'1','overflow-y':'auto',padding:'15px'}},os={style:{color:'#4a9eff','font-size':'12px','font-weight':'600','margin-bottom':'8px',display:'flex','align-items':'center',gap:'6px'}},rs={style:{margin:'0',padding:'12px',background:'#1a1a1a','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.5','overflow-x':'auto',border:'1px solid #3a3a3a'}},is={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},ss={style:{flex:'1','overflow-y':'auto',padding:'15px'}},ls={style:{color:'#4a9eff','font-size':'12px','font-weight':'600','margin-bottom':'8px',display:'flex','align-items':'center',gap:'6px'}},ds={style:{margin:'0',padding:'12px',background:'#1a1a1a','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.5','overflow-x':'auto',border:'1px solid #3a3a3a'}},cs={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},ps={style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},us={style:{display:'flex',gap:'8px'}},gs={style:{flex:'1',background:'white',overflow:'hidden'}},fs=['srcdoc'],ms={style:{background:'#2a2a2a','border-radius':'16px',width:'90%','max-width':'900px','max-height':'80%',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',display:'flex','flex-direction':'column'}},xs={style:{padding:'20px 25px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},hs={style:{flex:'1','overflow-y':'auto',padding:'20px'}},bs={key:0,style:{'text-align':'center',color:'#666',padding:'40px 20px'}},ys={style:{display:'flex','justify-content':'space-between','align-items':'start','margin-bottom':'10px'}},vs={style:{color:'#fff','font-size':'14px','font-weight':'600','margin-bottom':'5px'}},ws={style:{color:'#888','font-size':'12px'}},ks=['onClick'],_s={style:{color:'#ccc','font-size':'13px','margin-top':'10px'}},Ts={style:{'margin-top':'5px',display:'flex','flex-wrap':'wrap',gap:'8px'}},Ss={style:{background:'#1e1e1e','border-radius':'16px','max-width':'850px',width:'100%','max-height':'90vh','overflow-y':'auto','box-shadow':'0 20px 60px rgba(0, 0, 0, 0.8)',border:'1px solid #333'}},Is={style:{padding:'24px 28px','border-bottom':'1px solid #2a2a2a',display:'flex','justify-content':'space-between','align-items':'center'}},As={style:{padding:'28px'}},zs={style:{display:'grid','grid-template-columns':'repeat(auto-fit, minmax(240px, 1fr))',gap:'20px'}};const Cs=a(ni,[['render',function(e,n,t,a,u,b){return i(),o('div',ti,[s('div',ai,[n[68]||(n[68]=s('h3',{style:{margin:'0',color:'#fff','font-size':'16px !important','font-weight':'600',display:'flex','align-items':'center',gap:'12px','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-laptop-code',style:{color:'#4a9eff','font-size':'18px'}}),d(' 前端项目管理器 ')],-1)),s('div',oi,[a.currentId?(i(),o('button',{key:0,style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.exportToRegex,onMouseenter:n[0]||(n[0]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[1]||(n[1]=e=>e.currentTarget.style.background='#444')},[...n[61]||(n[61]=[s('i',{class:'fa-solid fa-download',style:{'margin-right':'6px'}},null,-1),d(' 导出为正则 ',-1)])],32)):r('',!0),a.currentId?(i(),o('button',{key:1,style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.showHistoryDialog,onMouseenter:n[2]||(n[2]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[3]||(n[3]=e=>e.currentTarget.style.background='#444')},[...n[62]||(n[62]=[s('i',{class:'fa-solid fa-history',style:{'margin-right':'6px'}},null,-1),d(' 历史记录 ',-1)])],32)):r('',!0),a.currentId?(i(),o('button',{key:2,style:{padding:'8px 16px',background:'#8b5cf6',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.showAIDialog,onMouseenter:n[4]||(n[4]=e=>e.currentTarget.style.background='#7c3aed'),onMouseleave:n[5]||(n[5]=e=>e.currentTarget.style.background='#8b5cf6')},[...n[63]||(n[63]=[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能编写 ',-1)])],32)):r('',!0),a.currentId?(i(),o('button',{key:3,style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.showBugFixDialog,onMouseenter:n[6]||(n[6]=e=>e.currentTarget.style.background='#dc2626'),onMouseleave:n[7]||(n[7]=e=>e.currentTarget.style.background='#ef4444')},[...n[64]||(n[64]=[s('i',{class:'fa-solid fa-bug',style:{'margin-right':'6px'}},null,-1),d(' Bug 修复 ',-1)])],32)):r('',!0),s('button',{style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.showProjectTemplateDialog,onMouseenter:n[8]||(n[8]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[9]||(n[9]=e=>e.currentTarget.style.background='#444')},[...n[65]||(n[65]=[s('i',{class:'fa-solid fa-file-lines',style:{'margin-right':'6px'}},null,-1),d(' 使用模板 ',-1)])],32),s('button',{style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.triggerFolderImport,onMouseenter:n[10]||(n[10]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[11]||(n[11]=e=>e.currentTarget.style.background='#444')},[...n[66]||(n[66]=[s('i',{class:'fa-solid fa-folder-open',style:{'margin-right':'6px'}},null,-1),d(' 导入文件夹 ',-1)])],32),s('button',{style:{padding:'8px 16px',background:'#10b981',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.createProject,onMouseenter:n[12]||(n[12]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[13]||(n[13]=e=>e.currentTarget.style.background='#10b981')},[...n[67]||(n[67]=[s('i',{class:'fa-solid fa-plus',style:{'margin-right':'6px'}},null,-1),d(' 新建项目 ',-1)])],32)])]),s('input',{ref:'folderInputRef',type:'file',webkitdirectory:'',directory:'',multiple:'',style:{display:'none'},onChange:a.handleFolderImport},null,544),s('div',ri,[s('div',ii,[n[73]||(n[73]=s('h4',{style:{margin:'0 0 15px 0',color:'#fff','font-size':'14px','font-weight':'600'}},'项目列表',-1)),0===a.projects.length?(i(),o('div',si,[...n[69]||(n[69]=[d(' 暂无项目',-1),s('br',null,null,-1),d(' 点击"新建项目"开始 ',-1)])])):r('',!0),(i(!0),o(m,null,x(a.projects,e=>(i(),o('div',{key:e.id,style:g({padding:'10px 12px',marginBottom:'8px',background:a.currentId===e.id?'#4a9eff':'#1e1e1e',borderRadius:'8px',cursor:'pointer',transition:'all 0.2s ease',display:'flex',justifyContent:'space-between',alignItems:'center',color:a.currentId===e.id?'#fff':'#e0e0e0'}),onClick:n=>a.selectProject(e.id),onMouseenter:n=>a.currentId!==e.id&&(n.currentTarget.style.background='#3a3a3a'),onMouseleave:n=>a.currentId!==e.id&&(n.currentTarget.style.background='#1e1e1e')},[s('span',di,c(e.name),1),s('button',{style:{width:'20px',height:'20px',background:'rgba(239, 68, 68, 0.2)',border:'none','border-radius':'4px',color:'#ff4444','font-size':'14px','line-height':'1',cursor:'pointer',opacity:'0.6',transition:'all 0.2s ease'},onClick:f(n=>a.deleteProject(e.id),['stop']),onMouseenter:n[14]||(n[14]=e=>(e.currentTarget.style.opacity='1',e.currentTarget.style.background='#ef4444',e.currentTarget.style.color='#fff')),onMouseleave:n[15]||(n[15]=e=>(e.currentTarget.style.opacity='0.6',e.currentTarget.style.background='rgba(239, 68, 68, 0.2)',e.currentTarget.style.color='#ff4444'))},' × ',40,ci)],44,li))),128)),a.currentId&&a.currentProject?(i(),o('div',pi,[s('div',ui,[n[72]||(n[72]=s('h4',{style:{margin:'0',color:'#fff','font-size':'13px','font-weight':'600'}},'文件',-1)),s('div',gi,[s('button',{style:{padding:'4px 8px',background:'#444',border:'none','border-radius':'5px',color:'#e0e0e0','font-size':'11px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center',gap:'4px'},title:'新建文件夹',onClick:a.createNewFolder,onMouseenter:n[16]||(n[16]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[17]||(n[17]=e=>e.currentTarget.style.background='#444')},[...n[70]||(n[70]=[s('i',{class:'fa-solid fa-folder-plus',style:{'font-size':'10px'}},null,-1)])],32),s('button',{style:{padding:'4px 8px',background:'#10b981',border:'none','border-radius':'5px',color:'white','font-size':'11px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center',gap:'4px'},title:'新建文件',onClick:a.showNewFileDialog,onMouseenter:n[18]||(n[18]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[19]||(n[19]=e=>e.currentTarget.style.background='#10b981')},[...n[71]||(n[71]=[s('i',{class:'fa-solid fa-plus',style:{'font-size':'10px'}},null,-1)])],32)])]),(i(!0),o(m,null,x(a.currentProject.files,e=>(i(),o('div',{key:e.path,style:g({padding:'8px 10px',marginBottom:'5px',background:a.currentFile===e.path?'#10b981':'#1e1e1e',borderRadius:'6px',cursor:'pointer',transition:'all 0.2s ease',color:a.currentFile===e.path?'#fff':'#e0e0e0',fontSize:'12px',display:'flex',justifyContent:'space-between',alignItems:'center'}),onClick:n=>a.selectFile(e.path),onMouseenter:n=>a.currentFile!==e.path&&(n.currentTarget.style.background='#3a3a3a'),onMouseleave:n=>a.currentFile!==e.path&&(n.currentTarget.style.background='#1e1e1e')},[s('span',null,[s('i',{class:h(a.getFileIcon(e.path)),style:{'margin-right':'6px'}},null,2),d(' '+c(e.name),1)]),s('button',{style:{width:'18px',height:'18px',background:'rgba(239, 68, 68, 0.2)',border:'none','border-radius':'3px',color:'#ff4444','font-size':'12px','line-height':'1',cursor:'pointer',opacity:'0',transition:'all 0.2s ease'},title:'删除文件',onClick:f(n=>a.deleteFile(e.path),['stop']),onMouseenter:n[20]||(n[20]=e=>(e.currentTarget.style.opacity='1',e.currentTarget.style.background='#ef4444',e.currentTarget.style.color='#fff')),onMouseleave:n[21]||(n[21]=e=>(e.currentTarget.style.opacity='0.6',e.currentTarget.style.background='rgba(239, 68, 68, 0.2)',e.currentTarget.style.color='#ff4444'))},' × ',40,mi)],44,fi))),128))])):r('',!0)]),s('div',xi,[a.currentId?a.currentFile?(i(),o('div',yi,[s('div',vi,[s('div',wi,[s('i',{class:h(a.getFileIcon(a.currentFile)),style:{color:'#4a9eff'}},null,2),s('span',ki,c(a.currentFile),1)]),s('div',_i,[n[75]||(n[75]=s('span',{style:{color:'#888','font-size':'11px'}},[s('i',{class:'fa-solid fa-circle-check',style:{color:'#10b981','margin-right':'4px'}}),d(' 自动保存 ')],-1)),s('button',{style:{padding:'6px 12px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},onClick:a.saveCode,onMouseenter:n[22]||(n[22]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[23]||(n[23]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[74]||(n[74]=[s('i',{class:'fa-solid fa-floppy-disk',style:{'margin-right':'4px'}},null,-1),d(' 手动保存 ',-1)])],32)])]),l(s('textarea',{'onUpdate:modelValue':n[24]||(n[24]=e=>a.code=e),placeholder:`在这里编写 ${a.currentFile.split('.').pop()?.toUpperCase()} 代码...`,style:{flex:'1',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'13px','line-height':'1.6',padding:'15px',resize:'none',outline:'none','min-height':'400px'}},null,8,Ti),[[p,a.code]])])):(i(),o('div',bi,' ← 请选择一个文件 ')):(i(),o('div',hi,' ← 请选择一个项目 '))]),s('div',Si,[s('div',Ii,[n[77]||(n[77]=s('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-eye',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 实时预览 ')],-1)),s('div',Ai,[a.previewHtml?(i(),o('button',{key:0,title:'新窗口打开',style:{width:'28px',height:'28px',padding:'0',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0',cursor:'pointer',display:'flex','align-items':'center','justify-content':'center',transition:'all 0.2s ease'},onClick:a.openInNewWindow,onMouseenter:n[25]||(n[25]=e=>e.currentTarget.style.background='#4a9eff'),onMouseleave:n[26]||(n[26]=e=>e.currentTarget.style.background='#3a3a3a')},[...n[76]||(n[76]=[s('i',{class:'fa-solid fa-external-link-alt',style:{'font-size':'12px'}},null,-1)])],32)):r('',!0)])]),s('div',zi,[a.previewHtml?(i(),o('iframe',{key:0,srcdoc:a.previewHtml,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,Ci)):(i(),o('div',$i,' 保存代码后将显示预览 '))])])]),a.showAI?(i(),o('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:f(a.closeAIDialog,['self'])},[s('div',Ei,[n[85]||(n[85]=s('h3',{style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{color:'#8b5cf6'}}),d(' AI 智能编写 ')],-1)),s('div',Pi,[n[79]||(n[79]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px'}},[s('i',{class:'fa-solid fa-pencil',style:{color:'#8b5cf6','margin-right':'6px'}}),d(' 详细描述你的需求（越详细效果越好）： ')],-1)),n[80]||(n[80]=s('div',{style:{'margin-bottom':'10px',padding:'10px 12px',background:'rgba(139, 92, 246, 0.1)','border-left':'3px solid #8b5cf6','border-radius':'4px','font-size':'12px',color:'#ccc','line-height':'1.6'}},[s('strong',{style:{color:'#8b5cf6'}},'💡 提示：'),d(' 不要只说"优化"、"完善"，要具体说明你想要什么效果、什么样式、什么功能！ ')],-1)),l(s('textarea',{'onUpdate:modelValue':n[27]||(n[27]=e=>a.aiPrompt=e),placeholder:'请详细描述你的需求，例如：添加一个响应式导航栏，带汉堡菜单和平滑滚动效果...',style:{width:'100%',height:'120px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','line-height':'1.6',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,a.aiPrompt]]),s('div',Mi,[n[78]||(n[78]=s('div',{style:{color:'#888','font-size':'12px','margin-bottom':'8px'}},[s('i',{class:'fa-solid fa-lightbulb',style:{color:'#fbbf24','margin-right':'4px'}}),d(' 快捷建议（点击填入）： ')],-1)),s('div',Oi,[(i(),o(m,null,x(a.quickSuggestions,e=>s('button',{key:e,style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#ccc','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>a.aiPrompt=e,onMouseenter:n[28]||(n[28]=e=>e.currentTarget.style.background='#3a3a3a'),onMouseleave:n[29]||(n[29]=e=>e.currentTarget.style.background='#2a2a2a')},c(e),41,ji)),64))])])]),s('div',Di,[s('label',Ri,[l(s('input',{'onUpdate:modelValue':n[30]||(n[30]=e=>a.enableStream=e),type:'checkbox',style:{width:'16px',height:'16px',cursor:'pointer'}},null,512),[[N,a.enableStream]]),n[81]||(n[81]=s('i',{class:'fa-solid fa-water',style:{color:'#4a9eff'}},null,-1)),n[82]||(n[82]=d(' 启用流式传输 ',-1))]),n[83]||(n[83]=s('span',{style:{color:'#888','font-size':'12px'}},' （实时查看生成过程，体验更流畅） ',-1))]),a.aiGenerating&&a.enableStream&&a.streamingText?(i(),o('div',Ni,[d(c(a.streamingText)+' ',1),n[84]||(n[84]=s('span',{style:{animation:'blink 1s infinite'}},'▊',-1))])):r('',!0),s('div',Hi,[s('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:a.closeAIDialog,onMouseenter:n[31]||(n[31]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[32]||(n[32]=e=>e.currentTarget.style.background='#3a3a3a')},' 取消 ',32),s('button',{disabled:a.aiGenerating||!a.aiPrompt.trim(),style:g([{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},{opacity:a.aiGenerating||!a.aiPrompt.trim()?.5:1,cursor:a.aiGenerating||!a.aiPrompt.trim()?'not-allowed':'pointer'}]),onClick:a.generateWithAI},[a.aiGenerating?(i(),o('i',Vi)):(i(),o('i',Fi)),d(' '+c(a.aiGenerating?'生成中...':'开始生成'),1)],12,Li)])])])):r('',!0),a.showBugFix?(i(),o('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:f(a.closeBugFixDialog,['self'])},[s('div',Ui,[n[90]||(n[90]=s('h3',{style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-bug',style:{color:'#ef4444'}}),d(' Bug 修复助手 ')],-1)),s('div',Ji,[n[86]||(n[86]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[s('i',{class:'fa-solid fa-circle-exclamation',style:{color:'#f59e0b','margin-right':'6px'}}),d(' 哪里有问题？（必填） ')],-1)),l(s('textarea',{'onUpdate:modelValue':n[33]||(n[33]=e=>a.bugDescription=e),placeholder:'例如：点击发送按钮没有反应\n或者：消息列表不显示内容\n或者：输入框输入后数据没有保存',style:{width:'100%',height:'90px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','line-height':'1.6',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,a.bugDescription]])]),s('div',Bi,[n[87]||(n[87]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[s('i',{class:'fa-solid fa-terminal',style:{color:'#ef4444','margin-right':'6px'}}),d(' 浏览器 Console 错误信息（按 F12 查看） ')],-1)),l(s('textarea',{'onUpdate:modelValue':n[34]||(n[34]=e=>a.consoleError=e),placeholder:'如果浏览器 Console 中有红色错误，请复制粘贴到这里\n例如：Uncaught TypeError: xxx is not a function\n\n如果没有错误，留空即可',style:{width:'100%',height:'80px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#ff6b6b','font-size':'12px','font-family':'\'Consolas\', monospace','line-height':'1.5',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,a.consoleError]])]),s('div',Wi,[n[89]||(n[89]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[s('i',{class:'fa-solid fa-file-code',style:{color:'#4a9eff','margin-right':'6px'}}),d(' 问题可能在哪个文件？ ')],-1)),l(s('select',{'onUpdate:modelValue':n[35]||(n[35]=e=>a.bugFile=e),style:{width:'100%',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px',padding:'10px 12px',outline:'none',cursor:'pointer'}},[...n[88]||(n[88]=[s('option',{value:''},'让 AI 自动判断',-1),s('option',{value:'index.html'},'HTML 文件（index.html）',-1),s('option',{value:'style.css'},'CSS 文件（style.css）',-1),s('option',{value:'script.js'},'JavaScript 文件（script.js）',-1)])],512),[[H,a.bugFile]])]),n[91]||(n[91]=s('div',{style:{padding:'12px',background:'rgba(74, 158, 255, 0.1)',border:'1px solid rgba(74, 158, 255, 0.3)','border-radius':'6px','margin-bottom':'15px'}},[s('p',{style:{margin:'0',color:'#4a9eff','font-size':'12px','line-height':'1.6'}},[s('i',{class:'fa-solid fa-lightbulb',style:{'margin-right':'6px'}}),s('strong',null,'提示：'),d('AI 会专注于修复这个具体的 bug，不会改动其他功能。如果有 Console 错误信息，修复成功率会更高！ ')])],-1)),s('div',Gi,[s('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:a.closeBugFixDialog,onMouseenter:n[36]||(n[36]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[37]||(n[37]=e=>e.currentTarget.style.background='#3a3a3a')},' 取消 ',32),s('button',{disabled:a.aiGenerating||!a.bugDescription.trim(),style:g([{padding:'8px 16px',background:'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},{opacity:a.aiGenerating||!a.bugDescription.trim()?.5:1,cursor:a.aiGenerating||!a.bugDescription.trim()?'not-allowed':'pointer'}]),onClick:a.fixBugWithAI},[a.aiGenerating?(i(),o('i',qi)):(i(),o('i',Zi)),d(' '+c(a.aiGenerating?'修复中...':'开始修复'),1)],12,Yi)])])])):r('',!0),a.showComparison?(i(),o('div',Xi,[s('div',Ki,[s('div',Qi,[n[94]||(n[94]=s('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-code-compare',style:{color:'#8b5cf6'}}),d(' AI 生成结果对比 ')],-1)),s('div',es,[s('button',{style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:a.rejectChanges,onMouseenter:n[38]||(n[38]=e=>e.currentTarget.style.background='#dc2626'),onMouseleave:n[39]||(n[39]=e=>e.currentTarget.style.background='#ef4444')},[...n[92]||(n[92]=[s('i',{class:'fa-solid fa-xmark',style:{'margin-right':'6px'}},null,-1),d(' 拒绝 ',-1)])],32),s('button',{style:{padding:'8px 16px',background:'#10b981',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:a.acceptChanges,onMouseenter:n[40]||(n[40]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[41]||(n[41]=e=>e.currentTarget.style.background='#10b981')},[...n[93]||(n[93]=[s('i',{class:'fa-solid fa-check',style:{'margin-right':'6px'}},null,-1),d(' 应用更改 ',-1)])],32)])]),s('div',ns,[s('div',ts,[n[95]||(n[95]=s('div',{style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a'}},[s('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-file-code',style:{'margin-right':'8px',color:'#ef4444'}}),d(' 修改前 ')])],-1)),s('div',as,[(i(!0),o(m,null,x(a.aiChanges,e=>(i(),o('div',{key:e.path,style:{'margin-bottom':'20px'}},[s('div',os,[s('i',{class:h(a.getFileIcon(e.path))},null,2),d(' '+c(e.path),1)]),s('pre',rs,c(e.oldContent),1)]))),128))])]),s('div',is,[n[96]||(n[96]=s('div',{style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a'}},[s('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-file-code',style:{'margin-right':'8px',color:'#10b981'}}),d(' 修改后 ')])],-1)),s('div',ss,[(i(!0),o(m,null,x(a.aiChanges,e=>(i(),o('div',{key:e.path,style:{'margin-bottom':'20px'}},[s('div',ls,[s('i',{class:h(a.getFileIcon(e.path))},null,2),d(' '+c(e.path),1)]),s('pre',ds,c(e.newContent),1)]))),128))])]),s('div',cs,[s('div',ps,[n[97]||(n[97]=s('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-eye',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 预览效果 ')],-1)),s('div',us,[s('button',{style:g({padding:'4px 10px',background:'before'===a.previewMode?'#ef4444':'#3a3a3a',border:'none',borderRadius:'4px',color:'white',fontSize:'11px',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n[42]||(n[42]=e=>a.previewMode='before')},' 修改前 ',4),s('button',{style:g({padding:'4px 10px',background:'after'===a.previewMode?'#10b981':'#3a3a3a',border:'none',borderRadius:'4px',color:'white',fontSize:'11px',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n[43]||(n[43]=e=>a.previewMode='after')},' 修改后 ',4)])]),s('div',gs,[s('iframe',{srcdoc:a.comparisonPreviewHtml,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none'}},null,8,fs)])])])])])):r('',!0),a.showHistory?(i(),o('div',{key:3,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:f(a.closeHistoryDialog,['self'])},[s('div',ms,[s('div',xs,[n[98]||(n[98]=s('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-history',style:{color:'#f59e0b'}}),d(' AI 编写历史 ')],-1)),s('button',{style:{width:'28px',height:'28px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0',cursor:'pointer',transition:'all 0.2s ease'},onClick:a.closeHistoryDialog,onMouseenter:n[44]||(n[44]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[45]||(n[45]=e=>e.currentTarget.style.background='#3a3a3a')},' × ',32)]),s('div',hs,[0===a.currentProjectHistory.length?(i(),o('div',bs,[...n[99]||(n[99]=[s('i',{class:'fa-solid fa-inbox',style:{'font-size':'48px','margin-bottom':'15px',opacity:'0.3'}},null,-1),s('p',null,'暂无历史记录',-1)])])):r('',!0),(i(!0),o(m,null,x(a.currentProjectHistory,(e,t)=>(i(),o('div',{key:t,style:{background:'#1e1e1e','border-radius':'8px',padding:'15px','margin-bottom':'15px',border:'1px solid #3a3a3a'}},[s('div',ys,[s('div',null,[s('div',vs,c(e.prompt),1),s('div',ws,c(new Date(e.timestamp).toLocaleString('zh-CN')),1)]),s('button',{style:{padding:'6px 12px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:n=>a.restoreHistory(e),onMouseenter:n[46]||(n[46]=e=>e.currentTarget.style.background='#3b82f6'),onMouseleave:n[47]||(n[47]=e=>e.currentTarget.style.background='#4a9eff')},[...n[100]||(n[100]=[s('i',{class:'fa-solid fa-undo',style:{'margin-right':'4px'}},null,-1),d(' 恢复 ',-1)])],40,ks)]),s('div',_s,[n[101]||(n[101]=s('strong',null,'修改的文件：',-1)),s('div',Ts,[(i(!0),o(m,null,x(e.changes,e=>(i(),o('span',{key:e.path,style:{background:'#2a2a2a',padding:'4px 10px','border-radius':'4px','font-size':'12px',display:'inline-flex','align-items':'center',gap:'6px'}},[s('i',{class:h(a.getFileIcon(e.path))},null,2),d(' '+c(e.path),1)]))),128))])])]))),128))])])])):r('',!0),a.showProjectTemplate?(i(),o('div',{key:4,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:n[60]||(n[60]=f(e=>a.showProjectTemplate=!1,['self']))},[s('div',Ss,[s('div',Is,[n[103]||(n[103]=s('h3',{style:{margin:'0',color:'#fff','font-size':'20px','font-weight':'600',display:'flex','align-items':'center',gap:'12px'}},[s('span',{style:{width:'40px',height:'40px',background:'#2a2a2a','border-radius':'10px',display:'flex','align-items':'center','justify-content':'center','font-size':'20px'}},' 📁 '),d(' 选择项目模板 ')],-1)),s('button',{style:{width:'36px',height:'36px',background:'#2a2a2a',border:'none','border-radius':'8px',color:'#888','font-size':'18px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center'},onClick:n[48]||(n[48]=e=>a.showProjectTemplate=!1),onMouseenter:n[49]||(n[49]=e=>{e.currentTarget.style.background='#333',e.currentTarget.style.color='#fff'}),onMouseleave:n[50]||(n[50]=e=>{e.currentTarget.style.background='#2a2a2a',e.currentTarget.style.color='#888'})},[...n[102]||(n[102]=[s('i',{class:'fa-solid fa-times'},null,-1)])],32)]),s('div',As,[s('div',zs,[s('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[51]||(n[51]=e=>a.createProjectFromTemplate('同层对话界面')),onMouseenter:n[52]||(n[52]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[53]||(n[53]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[104]||(n[104]=[s('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 💬 ',-1),s('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'同层对话界面',-1),s('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'流式对话、消息历史、正则清理',-1)])],32),s('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[54]||(n[54]=e=>a.createProjectFromTemplate('状态栏面板')),onMouseenter:n[55]||(n[55]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[56]||(n[56]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[105]||(n[105]=[s('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 📊 ',-1),s('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'状态栏面板',-1),s('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'HP/MP/经验值，进度条动画',-1)])],32),s('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[57]||(n[57]=e=>a.createProjectFromTemplate('好感度面板')),onMouseenter:n[58]||(n[58]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[59]||(n[59]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[106]||(n[106]=[s('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 💝 ',-1),s('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'好感度面板',-1),s('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'多角色卡片，爱心图标',-1)])],32)]),n[107]||(n[107]=s('div',{style:{'margin-top':'24px',padding:'16px 18px',background:'#252525',border:'1px solid #333','border-radius':'10px'}},[s('div',{style:{color:'#ccc','font-weight':'500','margin-bottom':'6px','font-size':'13px',display:'flex','align-items':'center',gap:'8px'}},[s('span',{style:{color:'#fbbf24','font-size':'16px'}},'💡'),d(' 使用提示 ')]),s('p',{style:{margin:'0',color:'#888','font-size':'13px','line-height':'1.7'}},' 选择模板后，会自动创建包含完整代码的项目，你可以直接预览和编辑 ')],-1))])])])):r('',!0),C(a.ProgressDialog,{ref:'progressDialogRef',show:a.showProgress,title:'AI 正在处理'},null,8,['show'])])}],['__scopeId','data-v-60228402'],['__file','ProjectManager.vue']]);'undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope);const $s=()=>{};const Es=e=>e();function Ps(e,n={}){let t,a,o=$s;const r=e=>{clearTimeout(e),o(),o=$s};let i;return s=>{const l=L(e),d=L(n.maxWait);return t&&r(t),l<=0||void 0!==d&&d<=0?(a&&(r(a),a=void 0),Promise.resolve(s())):new Promise((e,c)=>{o=n.rejectOnCancel?c:e,i=s,d&&!a&&(a=setTimeout(()=>{t&&r(t),a=void 0,e(i())},d)),t=setTimeout(()=>{a&&r(a),a=void 0,e(s())},l)})}}function Ms(e,n,a={}){const{eventFilter:o=Es,...r}=a;return t(e,(i=o,s=n,function(...e){return new Promise((n,t)=>{Promise.resolve(i(()=>s.apply(this,e),{fn:s,thisArg:this,args:e})).then(n).catch(t)})}),r);var i,s}const Os={class:'regex-ui-generator',style:{padding:'25px !important',background:'#1a1a1a !important'}},js={style:{display:'grid','grid-template-columns':'1fr 1fr',gap:'20px','margin-bottom':'20px'}},Ds={style:{display:'flex','flex-direction':'column',gap:'20px'}},Rs={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px'}},Ns={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px',flex:'1',display:'flex','flex-direction':'column'}},Hs={style:{display:'flex',gap:'12px','margin-top':'15px'}},Ls=['disabled'],Fs=['disabled'],Vs={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px',display:'flex','flex-direction':'column'}},Us={style:{color:'#51cf66',margin:'0 0 15px 0','font-size':'16px',display:'flex','align-items':'center',gap:'8px'}},Js={key:0,style:{'margin-left':'auto',background:'#51cf66',color:'white',padding:'4px 12px','border-radius':'16px','font-size':'12px'}},Bs={style:{flex:'1',background:'#1a1a1a',border:'2px solid #444','border-radius':'6px',overflow:'hidden',display:'flex','align-items':'center','justify-content':'center','min-height':'400px'}},Ws={key:0,style:{'text-align':'center',color:'#666',padding:'40px'}},Gs=['srcdoc'],Ys={key:0,style:{background:'#2a2a2a',padding:'20px','border-radius':'8px'}},Zs={key:0,style:{background:'#1a1a1a',padding:'15px','border-radius':'4px',border:'1px solid #444','max-height':'300px','overflow-y':'auto'}},qs={style:{margin:'0',color:'#e0e0e0','font-family':'\'Consolas\', monospace','font-size':'13px','white-space':'pre-wrap','word-wrap':'break-word'}},Xs={style:{display:'flex',gap:'12px'}},Ks=['disabled'];const Qs=a(e({__name:'RegexUIGenerator',setup(e,{expose:t}){t();const a=b(),{settings:o}=y(a),r=v(),i=n('【开场白】'),s=n(''),l=n(''),d=n(''),c=n(!1),p=n(!1),u=n(!1),g=n(!1),f=n(''),m=n(null),x=()=>{try{const n=T();if(!n)return;const t=`${n}_regex_ui_generator`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);i.value=e.triggerKeyword||'【开场白】',s.value=e.interfaceDescription||'',l.value=e.generatedCode||'',d.value=e.generatedRegex||'',console.log('✅ [界面生成器] 数据已从 localStorage 加载')}catch(e){console.error('❌ [界面生成器] 解析数据失败:',e)}}catch(n){console.error('❌ [界面生成器] 加载数据失败:',n)}},h=()=>{try{const e=T();if(!e)return;const n={triggerKeyword:i.value,interfaceDescription:s.value,generatedCode:l.value,generatedRegex:d.value},t=`${e}_regex_ui_generator`;localStorage.setItem(t,JSON.stringify(n)),console.log('💾 [界面生成器] 数据已保存到 localStorage')}catch(e){console.error('❌ [界面生成器] 保存数据失败:',e)}};k(()=>{x()}),function(e,n,t={}){const{debounce:a=0,maxWait:o,...r}=t;Ms(e,n,{...r,eventFilter:Ps(a,{maxWait:o})})}([i,s,l,d],()=>{h()},{debounce:500});const w={settingsStore:a,settings:o,taskStore:r,triggerKeyword:i,interfaceDescription:s,generatedCode:l,generatedRegex:d,isGenerating:c,isModifying:p,showCode:u,showModify:g,modifyInstruction:f,previewFrame:m,loadData:x,saveData:h,generateWithAI:async()=>{if(!i.value||!s.value)return void window.toastr.warning('请填写触发关键词和界面描述');const e=r.createTask('ui_generate',`生成界面：${i.value}`);c.value=!0;try{r.updateTaskProgress(e,10,'正在构建提示词...');const n='你是专业的前端开发专家，擅长生成完整的单文件 HTML 应用。\n\n# 核心任务\n根据用户的自然语言描述，生成**完整**的 HTML 代码（包含 CSS 和 JS）。\n\n# 代码结构要求\n1. **必须是完整的HTML文档**：从 `<!DOCTYPE html>` 开始到 `</html>` 结束\n2. **所有样式内嵌**：使用 `<style>` 标签，不要外部CSS\n3. **所有脚本内嵌**：使用 `<script>` 标签，不要外部JS\n4. **无外部依赖**：不要引入 CDN 或外部库（除非用户明确要求）\n\n# 关键原则\n1. **完整性第一**：确保生成的代码是完整的，不要截断\n2. **美观现代**：使用现代 CSS 特性（flexbox, grid, 动画等）\n3. **符合描述**：严格按照用户的风格需求和功能需求\n4. **可直接运行**：代码可以直接在浏览器中运行，无需修改\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用 markdown 代码块（```html）\n❌ 不要生成不完整的代码\n❌ 不要省略任何部分（如"...省略..."）\n❌ 不要引入外部依赖（除非用户明确要求）\n\n# 输出格式\n直接输出完整的 HTML 代码，从 `<!DOCTYPE html>` 开始。',t=`**触发关键词**：${i.value}\n\n**界面需求**：\n${s.value}\n\n---\n\n**生成要求**：\n1. 生成完整的单文件 HTML（包含 <style> 和 <script>）\n2. 风格：${s.value.includes('风格')?'按描述风格':'现代简洁风格'}\n3. 确保代码完整，不要截断\n4. 可以直接在浏览器中运行\n\n立即生成完整的HTML代码：`;r.updateTaskProgress(e,20,'正在发送请求到 AI 服务器...'),r.addTaskDetail(e,`触发词: ${i.value}`);const a=M(o.value.api_endpoint),c={model:o.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:o.value.temperature||.7,max_tokens:o.value.max_tokens||16e3,top_p:o.value.top_p,presence_penalty:o.value.presence_penalty,frequency_penalty:o.value.frequency_penalty},{filterApiParams:p}=await I(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),u=p(c,o.value.api_endpoint),g=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${o.value.api_key}`},body:JSON.stringify(u)});if(r.updateTaskProgress(e,40,'等待AI响应...'),!g.ok)throw new Error(`API 请求失败: ${g.status}`);r.updateTaskProgress(e,50,'正在等待 AI 生成代码...'),r.addTaskDetail(e,'AI 正在思考并生成完整的HTML代码...');const f=await g.json();let m=f.choices?.[0]?.message?.content||'';r.updateTaskProgress(e,70,'正在处理 AI 返回的代码...'),console.log('📝 [界面生成] AI 原始返回长度:',m.length),console.log('📝 [界面生成] AI 原始返回前500字符:',m.substring(0,500)),m=m.replace(/```html\n?/g,'').replace(/```\n?/g,'').trim();const x=m.match(/<!DOCTYPE html>[\s\S]*/i);if(x)m=x[0].trim(),console.log('✅ [界面生成] 提取到完整的HTML文档（含DOCTYPE）');else{const e=m.match(/<html[\s\S]*/i);if(e)m=e[0].trim(),console.log('✅ [界面生成] 提取到HTML文档（不含DOCTYPE）');else{if(!m.includes('<')||!m.includes('>'))throw console.error('❌ [界面生成] AI未返回有效的HTML代码'),console.error('AI返回内容:',m),new Error('AI未返回有效的HTML代码，请尝试更详细的界面描述或更换模型');console.log('⚠️ [界面生成] 包含HTML标签但格式不标准，尝试包装'),m.includes('<html')||(m=`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n${m}\n</body>\n</html>`,console.log('✅ [界面生成] 已自动包装为完整HTML文档'))}}console.log('📝 [界面生成] 最终HTML长度:',m.length),r.updateTaskProgress(e,85,'正在生成正则配置...'),l.value=m;const h=i.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),b={id:`regex_ui_${Date.now()}`,scriptName:`界面_${i.value}`,findRegex:h,replaceString:m,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null};d.value=JSON.stringify(b,null,2),r.addTaskDetail(e,`✅ HTML代码长度: ${m.length} 字符`),r.completeTask(e,{code:m,regex:d.value}),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI 生成失败:',n),r.failTask(e,n.message),window.toastr.error('AI 生成失败: '+n.message)}finally{c.value=!1}},showModifyDialog:()=>{f.value='',g.value=!0},modifyWithAI:async()=>{if(!f.value)return void window.toastr.warning('请输入修改建议');const e=r.createTask('ui_modify',`修改界面：${i.value}`);p.value=!0;try{r.updateTaskProgress(e,10,'正在构建修改提示词...');const n='你是专业的前端开发专家，擅长根据用户反馈修改和优化界面代码。\n\n# 核心任务\n根据用户的原始需求和修改建议，生成**完整**的优化后的 HTML 代码。\n\n# 修改原则\n1. **保持原有风格**：不要改变原始描述中的核心风格\n2. **精准修改**：只修改用户明确要求修改的部分\n3. **完整输出**：确保修改后的代码是完整的，不要截断\n4. **向下兼容**：确保修改不会破坏原有功能\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用 markdown 代码块（```html）\n❌ 不要生成不完整的代码\n❌ 不要省略任何部分\n\n# 输出格式\n直接输出完整的 HTML 代码，从 `<!DOCTYPE html>` 开始。',t=`**触发关键词**：${i.value}\n\n**原始界面需求**：\n${s.value}\n\n**用户修改建议**：\n${f.value}\n\n---\n\n**修改要求**：\n1. 在原始需求的基础上，精准应用修改建议\n2. 保持代码完整性，不要截断\n3. 确保可以直接在浏览器中运行\n\n立即生成修改后的完整HTML代码：`;r.updateTaskProgress(e,20,'正在发送修改请求...'),r.addTaskDetail(e,`修改建议: ${f.value}`);const a=M(o.value.api_endpoint),c=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${o.value.api_key}`},body:JSON.stringify({model:o.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:o.value.temperature||.7,max_tokens:o.value.max_tokens||16e3,top_p:o.value.top_p,presence_penalty:o.value.presence_penalty,frequency_penalty:o.value.frequency_penalty})});if(r.updateTaskProgress(e,40,'等待AI响应...'),!c.ok)throw new Error(`API 请求失败: ${c.status}`);r.updateTaskProgress(e,50,'正在等待 AI 修改代码...'),r.addTaskDetail(e,'AI 正在根据修改建议重新生成代码...');const p=await c.json();let u=p.choices?.[0]?.message?.content||'';r.updateTaskProgress(e,70,'正在处理修改后的代码...'),console.log('📝 [界面修改] AI 原始返回长度:',u.length),console.log('📝 [界面修改] AI 原始返回前500字符:',u.substring(0,500)),u=u.replace(/```html\n?/g,'').replace(/```\n?/g,'').trim();const m=u.match(/<!DOCTYPE html>[\s\S]*/i);if(m)u=m[0].trim(),console.log('✅ [界面修改] 提取到完整的HTML文档（含DOCTYPE）');else{const e=u.match(/<html[\s\S]*/i);if(e)u=e[0].trim(),console.log('✅ [界面修改] 提取到HTML文档（不含DOCTYPE）');else{if(!u.includes('<')||!u.includes('>'))throw console.error('❌ [界面修改] AI未返回有效的HTML代码'),console.error('AI返回内容:',u),new Error('AI未返回有效的HTML代码，请尝试更详细的修改建议或更换模型');console.log('⚠️ [界面修改] 包含HTML标签但格式不标准，尝试包装'),u.includes('<html')||(u=`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n${u}\n</body>\n</html>`,console.log('✅ [界面修改] 已自动包装为完整HTML文档'))}}console.log('📝 [界面修改] 最终HTML长度:',u.length),r.updateTaskProgress(e,85,'正在更新正则配置...'),l.value=u;const x=i.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),h={id:`regex_ui_${Date.now()}`,scriptName:`界面_${i.value}`,findRegex:x,replaceString:u,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null};d.value=JSON.stringify(h,null,2),s.value=`${s.value}\n\n【已应用的修改】：\n${f.value}`,r.addTaskDetail(e,`✅ 修改后代码长度: ${u.length} 字符`),r.completeTask(e,{code:u,regex:d.value}),window.toastr.success('AI 修改成功！'),g.value=!1}catch(n){console.error('AI 修改失败:',n),r.failTask(e,n.message),window.toastr.error('AI 修改失败: '+n.message)}finally{p.value=!1}},copyRegex:()=>{A(d.value,'正则代码已复制到剪贴板')}};return Object.defineProperty(w,'__isScriptSetup',{enumerable:!1,value:!0}),w}}),[['render',function(e,n,t,a,m,x){return i(),o('div',Os,[n[21]||(n[21]=u('<div style="background:linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);padding:20px;border-radius:16px;margin-bottom:20px;border:1px solid rgba(102, 126, 234, 0.2);" data-v-632b3b07><h3 style="color:#4a9eff;margin:0 0 10px 0;font-size:20px;font-weight:600;" data-v-632b3b07>🔧 酒馆正则界面生成器</h3><p style="color:#888;margin:0;font-size:14px;line-height:1.6;" data-v-632b3b07> AI 辅助生成酒馆正则替换界面，用自然语言描述即可生成完整的 HTML/CSS/JS 代码 </p></div><div style="background:#2a2a2a;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107;" data-v-632b3b07><h4 style="color:#ffc107;margin:0 0 15px 0;font-size:16px;display:flex;align-items:center;gap:8px;" data-v-632b3b07><i class="fa-solid fa-lightbulb" data-v-632b3b07></i> 新手使用流程（超简单！）： </h4><ol style="margin:0;padding-left:20px;color:#ccc;line-height:2;" data-v-632b3b07><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第1步：</strong> 输入触发词（比如 <code style="background:#1a1a1a;padding:2px 6px;border-radius:3px;color:#4a9eff;" data-v-632b3b07>【状态栏】</code> ） </li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第2步：</strong> 用自然语言描述你想要的界面（省略技术细节）</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第3步：</strong> 点击&quot;AI 生成&quot;，等几秒钟，AI 自动生成代码</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第4步：</strong> 看右侧<strong style="color:#51cf66;" data-v-632b3b07>实时预览</strong>，不满意就点&quot;AI 修改&quot;继续调整 </li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第5步：</strong> 点击&quot;复制正则&quot;，直接粘贴到酒馆正则里就完了！</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>完成！</strong> 现在在聊天中输入 <code style="background:#1a1a1a;padding:2px 6px;border-radius:3px;color:#51cf66;" data-v-632b3b07>【状态栏】</code> 就会显示你的界面了！ </li></ol></div>',2)),s('div',js,[s('div',Ds,[s('div',Rs,[n[7]||(n[7]=s('h4',{style:{color:'#4a9eff',margin:'0 0 15px 0','font-size':'16px'}},[s('i',{class:'fa-solid fa-key'}),d(' 触发关键词: ')],-1)),l(s('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>a.triggerKeyword=e),type:'text',placeholder:'输入触发词，例如：【开场白】',style:{width:'100%',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px'}},null,512),[[p,a.triggerKeyword]])]),s('div',Ns,[n[10]||(n[10]=s('h4',{style:{color:'#4a9eff',margin:'0 0 15px 0','font-size':'16px'}},[s('i',{class:'fa-solid fa-magic'}),d(' 界面描述（AI 生成）: ')],-1)),n[11]||(n[11]=s('p',{style:{color:'#888',margin:'0 0 10px 0','font-size':'13px'}},' 用自然语言描述你想要的界面，比如：一个RPG游戏风格的状态栏，显示生命值、魔力值、经验值... ',-1)),l(s('textarea',{'onUpdate:modelValue':n[1]||(n[1]=e=>a.interfaceDescription=e),placeholder:'详细描述你想要的界面（越详细越好）：\n- 说清楚你想要什么功能（如：生命值、魔力值、经验值）\n- 说清楚你想要什么样式（如：RPG游戏风格、赛博朋克、可爱风等）\n- 如果想要特殊效果（如：进度条、动画、按钮），也写清楚\n\n例如：\n我想要一个现代简洁风格的状态栏，显示当前日期、时间、地点、天气温度。',style:{width:'100%',flex:'1','min-height':'200px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','font-family':'\'Consolas\', monospace',resize:'none','line-height':'1.6'}},null,512),[[p,a.interfaceDescription]]),s('div',Hs,[s('button',{disabled:!a.triggerKeyword||!a.interfaceDescription||a.isGenerating,style:g([{flex:'1',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.3s'},{opacity:a.triggerKeyword&&a.interfaceDescription&&!a.isGenerating?1:.5}]),onClick:a.generateWithAI},[n[8]||(n[8]=s('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(a.isGenerating?'AI 生成中...':a.generatedCode?'AI 重新生成':'AI 生成界面'),1)],12,Ls),a.generatedCode?(i(),o('button',{key:0,disabled:a.isModifying,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.3s'},{opacity:a.isModifying?.5:1}]),onClick:a.showModifyDialog},[n[9]||(n[9]=s('i',{class:'fa-solid fa-edit'},null,-1)),d(' '+c(a.isModifying?'修改中...':'AI 修改界面'),1)],12,Fs)):r('',!0)])])]),s('div',Vs,[s('h4',Us,[n[12]||(n[12]=s('i',{class:'fa-solid fa-eye'},null,-1)),n[13]||(n[13]=d(' 实时预览 ',-1)),a.generatedCode?(i(),o('span',Js,'已生成')):r('',!0)]),s('div',Bs,[a.generatedCode?(i(),o('iframe',{key:1,ref:'previewFrame',srcdoc:a.generatedCode,sandbox:'allow-scripts allow-same-origin',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,Gs)):(i(),o('div',Ws,[...n[14]||(n[14]=[s('i',{class:'fa-solid fa-image',style:{'font-size':'64px','margin-bottom':'20px',opacity:'0.3'}},null,-1),s('p',{style:{'font-size':'16px',margin:'0'}},'等待生成...',-1),s('p',{style:{'font-size':'14px',margin:'10px 0 0 0'}},'点击"AI 生成界面"后，预览将显示在这里',-1)])]))]),a.generatedCode?(i(),o('button',{key:0,style:{'margin-top':'15px',background:'#51cf66',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},onClick:a.copyRegex},[...n[15]||(n[15]=[s('i',{class:'fa-solid fa-copy'},null,-1),d(' 复制正则代码 ',-1)])])):r('',!0)])]),a.generatedRegex?(i(),o('div',Ys,[s('div',{style:{display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','margin-bottom':'15px'},onClick:n[2]||(n[2]=e=>a.showCode=!a.showCode)},[n[16]||(n[16]=s('h4',{style:{color:'#4a9eff',margin:'0'}},[s('i',{class:'fa-solid fa-code'}),d(' 生成的正则代码 ')],-1)),s('i',{class:h(a.showCode?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888',transition:'transform 0.3s'}},null,2)]),a.showCode?(i(),o('div',Zs,[s('pre',qs,c(a.generatedRegex),1)])):r('',!0)])):r('',!0),a.showModify?(i(),o('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'},onClick:n[6]||(n[6]=f(e=>a.showModify=!1,['self']))},[s('div',{style:{background:'#2a2a2a',border:'2px solid #ffc107','border-radius':'16px',padding:'30px','max-width':'600px',width:'100%'},onClick:n[5]||(n[5]=f(()=>{},['stop']))},[n[18]||(n[18]=s('h3',{style:{color:'#ffc107',margin:'0 0 20px 0'}},[s('i',{class:'fa-solid fa-edit'}),d(' AI 修改界面 ')],-1)),n[19]||(n[19]=s('p',{style:{color:'#888',margin:'0 0 15px 0','line-height':'1.6'}},' 描述你想要修改的地方，AI 会在当前界面的基础上进行调整。例如： ',-1)),n[20]||(n[20]=s('ul',{style:{color:'#888',margin:'0 0 20px 0','padding-left':'20px','line-height':'1.8'}},[s('li',null,'把生命值进度条改成红色'),s('li',null,'增加一个金币显示'),s('li',null,'调整整体布局，改成竖向排列'),s('li',null,'添加一个按钮，点击后显示详细信息')],-1)),l(s('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>a.modifyInstruction=e),placeholder:'输入修改建议...',style:{width:'100%','min-height':'150px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical'}},null,512),[[p,a.modifyInstruction]]),s('div',Xs,[s('button',{disabled:!a.modifyInstruction||a.isModifying,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600'},{opacity:!a.modifyInstruction||a.isModifying?.5:1}]),onClick:a.modifyWithAI},[n[17]||(n[17]=s('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(a.isModifying?'修改中...':'确认修改'),1)],12,Ks),s('button',{style:{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600'},onClick:n[4]||(n[4]=e=>a.showModify=!1)},' 取消 ')])])])):r('',!0)])}],['__scopeId','data-v-632b3b07'],['__file','RegexUIGenerator.vue']]),el=e({__name:'SettingsTab',setup(e,{expose:t}){t();const a=b(),{settings:o}=y(a),r=F(),i=v(),s=n({api:!0,autoSummary:!0,manualSummary:!0,tableGeneration:!0,messageManagement:!0}),l=e=>{if(!e.trim())return[];const n=[],t=e.split(',');for(const a of t){const e=a.trim();if(e)if(e.includes('-')){const[t,a]=e.split('-').map(e=>parseInt(e.trim()));if(!isNaN(t)&&!isNaN(a)&&t>=0&&a>=0)for(let e=t;e<=a;e++)n.push(e)}else{const t=parseInt(e);!isNaN(t)&&t>=0&&n.push(t)}}return n},d=n([]),c=n(!1),p=n(''),u=n([]),g=n(!1),f=n(!1),m=n(!1),x=n(!1),h=n(null),w=n([]),A=n(''),C=n({name:'',headers:''}),E=()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载生成状态');const t=`${n}_generation_status`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);f.value=e.is_summarizing||!1,m.value=e.is_generating_table||!1,console.log('✅ 从 localStorage 加载生成状态:',{summarizing:f.value,generating_table:m.value})}catch(e){console.error('解析生成状态失败:',e),f.value=!1,m.value=!1}else f.value=!1,m.value=!1}catch(n){console.error('加载生成状态失败:',n),f.value=!1,m.value=!1}},P=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存生成状态');const n=`${e}_generation_status`,t={is_summarizing:f.value,is_generating_table:m.value};localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 已保存生成状态到 localStorage')}catch(e){console.error('保存生成状态失败:',e)}},M=()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载列头模板');const t=`${n}_header_templates`,a=localStorage.getItem(t);if(a)try{let e=JSON.parse(a);Array.isArray(e)||(e=[]),w.value=e,console.log('✅ 从 localStorage 加载列头模板:',w.value.length,'个')}catch(e){console.error('解析列头模板失败:',e),w.value=[]}else w.value=[]}catch(n){console.error('加载列头模板失败:',n),w.value=[]}},O=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存列头模板');const n=`${e}_header_templates`;localStorage.setItem(n,JSON.stringify(w.value)),console.log('✅ 已保存列头模板到 localStorage')}catch(e){console.error('保存列头模板失败:',e)}},j=()=>{if(''!==A.value){const e=parseInt(A.value);e>=0&&e<w.value.length&&(C.value={...w.value[e]})}},D=()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载隐藏楼层数据');console.log('脚本ID:',n);const t=`${n}_hidden_messages`,a=localStorage.getItem(t);if(a)try{u.value=JSON.parse(a),console.log('✅ 从 localStorage 加载隐藏楼层数据:',u.value.length,'个')}catch(e){console.error('解析隐藏楼层数据失败:',e),u.value=[]}else console.log('📝 localStorage 中没有隐藏楼层数据'),u.value=[]}catch(n){console.error('加载隐藏楼层数据失败:',n)}},N=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存隐藏楼层数据');console.log('保存到脚本ID:',e),console.log('要保存的数据:',S(u.value));const n=`${e}_hidden_messages`;localStorage.setItem(n,JSON.stringify(u.value)),console.log('✅ 成功保存隐藏楼层数据到 localStorage:',u.value.length,'个')}catch(e){console.error('保存隐藏楼层数据失败:',e)}},H=()=>{if(!o.value.api_provider||''===o.value.api_provider){const e=o.value.api_endpoint||'';e.includes('generativelanguage.googleapis.com')?o.value.api_provider='gemini':e.includes('open.bigmodel.cn')?o.value.api_provider='zhipu':o.value.api_provider='openai'}};k(()=>{console.log('SettingsTab 组件已挂载，开始加载数据'),H(),D(),M(),E()});const L={settingsStore:a,settings:o,summaryHistoryStore:r,taskStore:i,expandedSections:s,toggleSection:e=>{s.value[e]=!s.value[e]},parseMessageRange:l,available_models:d,loading_models:c,hide_range:p,hidden_messages:u,hidden_display_expanded:g,is_summarizing:f,is_generating_table:m,showProgress:x,progressDialogRef:h,headerTemplates:w,selectedTemplate:A,currentTemplate:C,loadGenerationStatus:E,saveGenerationStatus:P,stopGeneration:()=>{(f.value||m.value)&&(f.value=!1,m.value=!1,P(),window.toastr.info('已停止所有生成任务'))},loadHeaderTemplates:M,saveHeaderTemplates:O,loadTemplate:j,showAddTemplateDialog:()=>{const e=window.prompt('请输入模板名称：');if(e&&e.trim()){const n=window.prompt('请输入列头（用逗号分隔）：');n&&n.trim()&&(w.value.push({name:e.trim(),headers:n.trim()}),O(),A.value=(w.value.length-1).toString(),j(),window.toastr.success('模板添加成功'))}},saveTemplate:()=>{if(''!==A.value&&C.value.name.trim()&&C.value.headers.trim()){const e=parseInt(A.value);e>=0&&e<w.value.length&&(w.value[e]={...C.value},O(),window.toastr.success('模板保存成功'))}else window.toastr.warning('请填写模板名称和列头')},deleteTemplate:()=>{if(''!==A.value&&confirm('确定要删除这个模板吗？')){const e=parseInt(A.value);e>=0&&e<w.value.length&&(w.value.splice(e,1),O(),A.value='',C.value={name:'',headers:''},window.toastr.success('模板删除成功'))}},loadHiddenMessages:D,saveHiddenMessages:N,initApiProvider:H,handleTestButton:()=>{console.log('原生点击 - Vue事件绑定工作正常'),window.toastr.success('Vue事件绑定工作正常！')},handleSaveSettings:()=>{console.log('💾 手动保存设置...');a.saveSettings()?console.log('✅ 设置保存成功'):console.error('❌ 设置保存失败')},handleReloadSettings:()=>{console.log('🔄 重新加载设置...');a.reloadSettings()?console.log('✅ 设置重新加载成功'):console.error('❌ 设置重新加载失败')},handleResetAutoSummaryStart:()=>{console.log('🔄 重置自动总结起始楼层...');try{'function'==typeof window.smartResetChat?window.smartResetChat():window.toastr.error('重置函数不可用，请刷新页面后重试')}catch(e){console.error('❌ 重置起始楼层失败:',e),window.toastr.error('重置失败: '+e.message)}},handleProviderChange:()=>{const e=o.value.api_provider,n={openai:'https://api.openai.com/v1',gemini:'https://generativelanguage.googleapis.com/v1beta/openai'};n[e]&&(o.value.api_endpoint=n[e],window.toastr.success('已切换到 '+('openai'===e?'OpenAI':'Gemini AI Studio')))},handleSaveApiConfig:()=>{try{if(!o.value.api_endpoint||!o.value.api_key)return void window.toastr.warning('请先填写 API 端点和 API Key');a.saveSettings()&&console.log('API 配置已保存:',{endpoint:o.value.api_endpoint,model:o.value.model,provider:o.value.api_provider,api_key:o.value.api_key?'***'+o.value.api_key.slice(-4):''})}catch(e){console.error('保存 API 配置失败:',e),window.toastr.error('保存失败：'+e.message)}},handleImportFromTavern:async()=>{try{if(console.log('📥 开始从酒馆导入配置...'),'undefined'==typeof triggerSlash)return void window.toastr.error('无法访问酒馆命令，请确保在酒馆环境中运行');console.log('🔍 使用斜杠命令读取连接配置文件...'),console.log('1️⃣ 执行 /profile 获取当前配置文件...');const n=await triggerSlash('/profile');if(console.log('当前配置文件返回:',n),!n||'No connection profile selected.'===n||n.includes('未选择')){console.log('⚠️ 未选择连接配置文件，尝试读取全局配置...');const e=window.parent||window.top||window,n=e.power_user,t=e.secret_state;let r='',i='',s='';return n&&(r=n.custom_chat_url||n.reverse_proxy||'',s=n.custom_model||n.openai_model||''),t&&(i=t.api_key_custom||t.custom||t.openai||''),r||i||s?(r&&(o.value.api_endpoint=r),i&&(o.value.api_key=i),s&&(o.value.model=s),await a.saveSettings(),void window.toastr.success('✅ 从全局配置导入成功！\n\n'+(r?`• 端点: ${r}\n`:'')+(i?`• Key: ***${i.slice(-4)}\n`:'')+(s?`• 模型: ${s}`:''))):void window.toastr.warning('未能读取到 API 配置。\n\n💡 建议：在酒馆主界面创建一个连接配置文件\n（API 连接菜单 → 连接配置文件 → 创建）')}const t=n.trim();console.log(`2️⃣ 获取配置文件详情: ${t}`);const r=await triggerSlash(`/profile-get ${t}`);let i;console.log('配置文件详情返回:',r);try{i=JSON.parse(r),console.log('✅ 解析配置文件数据:',i)}catch(e){return console.error('❌ 解析配置文件 JSON 失败:',e),void window.toastr.error('无法解析配置文件数据')}let s='',l='',d='';if(i['api-url']?(s=i['api-url'],console.log('✅ 找到 API 端点 (api-url):',s)):i.server_url&&(s=i.server_url,console.log('✅ 找到 API 端点 (server_url):',s)),i['secret-id']){const e=i['secret-id'];console.log('ℹ️ 配置文件包含 secret-id:',e),console.log('ℹ️ API Key 存储在服务器端，无法从前端读取（这是正常的安全措施）')}else i.key&&(l=i.key,console.log('✅ 找到 API Key (key)'));if(i.model&&(d=i.model,console.log('✅ 找到模型:',d)),!s&&!d)return window.toastr.warning('配置文件中未找到 API 配置信息。\n\n可能的原因：\n• 配置文件格式不符合预期\n• 配置文件未保存完整信息\n\n💡 查看控制台了解详细数据'),void console.warn('📋 配置文件完整数据:',i);l||console.log('ℹ️ API Key 存储在服务器端，需要手动输入');let c=0;const p=[];s&&(o.value.api_endpoint=s,c++,p.push(`• API 端点: ${s}`)),l&&(o.value.api_key=l,c++,p.push(`• API Key: ***${l.slice(-4)}`)),d&&(o.value.model=d,c++,p.push(`• 模型: ${d}`)),await a.saveSettings();let u=`🎉 成功从酒馆导入 ${c} 项配置！\n\n📋 配置文件: ${t}\n\n${p.join('\n')}`;l||(u+='\n\n⚠️ API Key 需要手动输入\n（出于安全考虑，酒馆不在前端存储 API Key）'),window.toastr.success(u),console.log('✅ 导入配置成功:',{profileName:t,endpoint:s,apiKey:l?'***'+l.slice(-4):'',model:d})}catch(n){console.error('❌ 从酒馆导入配置失败:',n),window.toastr.error('导入失败：'+n.message)}},handle_fetch_models:async()=>{if(!c.value)try{if(c.value=!0,console.log('🚀 开始拉取模型列表...'),console.log('📍 API 端点:',o.value.api_endpoint),console.log('🔑 API Key:',o.value.api_key?'***'+o.value.api_key.slice(-4):'未设置'),!o.value.api_endpoint||!o.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');window.toastr.info('正在拉取模型列表，请查看控制台了解详细过程...');const{fetchAvailableModels:e}=await I(async()=>{const{fetchAvailableModels:e}=await import('./index.js').then(e=>e.S);return{fetchAvailableModels:e}},__vite__mapDeps([0,1])),n=await e();console.log('✅ 最终获取到的模型列表:',n),n.length>0?(d.value=n,window.toastr.success(`🎉 成功获取 ${n.length} 个模型！\n模型列表: ${n.slice(0,3).join(', ')}${n.length>3?'...':''}`),!o.value.model&&n[0]&&(o.value.model=n[0],console.log('✅ 自动选择模型:',n[0]))):window.toastr.warning('未找到可用模型，请手动输入')}catch(e){console.error('❌ 拉取模型失败:',e);const n=e.message;n.length>200?window.toastr.error('❌ 拉取模型失败\n\n请打开浏览器控制台（F12）查看详细的调试信息\n\n可能的原因：\n• API 不支持 /v1/models 接口\n• API Key 权限不足\n• 网络连接问题或 CORS 限制'):window.toastr.error(`❌ 拉取模型失败\n\n${n}`),console.error('📋 完整错误信息:',n)}finally{c.value=!1}},handle_test_connection:async()=>{try{if(console.log('测试连接...'),!o.value.api_endpoint||!o.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');window.toastr.info('正在测试连接，请稍候...');const{normalizeApiEndpoint:e,filterApiParams:n}=await I(async()=>{const{normalizeApiEndpoint:e,filterApiParams:n}=await import('./index.js').then(e=>e.R);return{normalizeApiEndpoint:e,filterApiParams:n}},__vite__mapDeps([0,1])),t=e(o.value.api_endpoint);console.log('📍 规范化的端点:',t);const a=n({model:o.value.model||'gpt-3.5-turbo',messages:[{role:'user',content:'Hello'}],max_tokens:5,temperature:o.value.temperature,top_p:o.value.top_p,presence_penalty:o.value.presence_penalty,frequency_penalty:o.value.frequency_penalty},o.value.api_endpoint);console.log('🔍 过滤后的参数:',a);const r=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${o.value.api_key}`},body:JSON.stringify(a)});if(r.ok){const e=await r.json();console.log('API 测试响应:',e);const n=e.choices?.[0]?.message?.content||'(无内容)',t=e.model||o.value.model;window.toastr.success(`✅ 连接成功！\n📦 模型: ${t}\n💬 回复: ${n.substring(0,50)}...`)}else{const e=await r.text();console.error('API 错误响应:',e),window.toastr.error(`❌ 连接失败 (${r.status})\n详情: ${e.substring(0,100)}`)}}catch(e){console.error('连接测试失败:',e),window.toastr.error('连接测试失败: '+e.message)}},handle_summarize:async()=>{let e=null;try{if(f.value)return;if(console.log('开始手动总结...'),f.value=!0,P(),e=i.addTask({title:'生成总结',description:`正在总结楼层 ${o.value.start_message_id} - ${o.value.end_message_id}`,category:'总结'}),!o.value.api_endpoint||!o.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');if(void 0===o.value.start_message_id||void 0===o.value.end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');if(o.value.start_message_id<0||o.value.end_message_id<o.value.start_message_id)return void window.toastr.warning('楼层范围无效，请确保结束楼层大于等于开始楼层');console.log(`总结范围: ${o.value.start_message_id} - ${o.value.end_message_id}`),x.value=!0,h.value?.setProgress(10),h.value?.setMessage('正在准备生成总结...'),h.value?.addDetail(`楼层范围: ${o.value.start_message_id} - ${o.value.end_message_id}`),h.value?.setProgress(30),h.value?.setMessage('正在调用 AI 生成总结...'),h.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const{summarizeMessages:n}=await I(async()=>{const{summarizeMessages:e}=await import('./index.js').then(e=>e.S);return{summarizeMessages:e}},__vite__mapDeps([0,1])),t=await n(o.value.start_message_id,o.value.end_message_id);h.value?.setProgress(90),h.value?.setMessage('正在保存总结结果...'),console.log('总结完成:',t);const a=T();if(a){const e=`${a}_last_summary`;localStorage.setItem(e,JSON.stringify({last_summary:t})),console.log('✅ 总结已保存到 localStorage')}r.addSummary(o.value.start_message_id??0,o.value.end_message_id??o.value.start_message_id??0,t),window.dispatchEvent(new CustomEvent('summary-history-updated')),h.value?.setProgress(100),h.value?.setMessage('✅ 总结完成！'),h.value?.addDetail('总结已保存到历史记录'),setTimeout(()=>{x.value=!1,window.toastr.success('总结完成并已保存到历史！'),e&&i.completeTask(e)},800)}catch(n){console.error('总结失败:',n),x.value=!1,window.toastr.error('总结失败: '+n.message),e&&i.failTask(e,n.message)}finally{f.value=!1,P()}},handle_generate_table:async()=>{let e=null;try{if(m.value)return;if(console.log('开始生成表格...'),m.value=!0,P(),e=i.addTask({title:'生成表格',description:`正在生成楼层 ${o.value.table_start_message_id} - ${o.value.table_end_message_id} 的表格`,category:'表格'}),!o.value.api_endpoint||!o.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');if(x.value=!0,h.value?.setProgress(5),h.value?.setMessage('正在准备生成表格...'),!o.value.table_start_message_id||!o.value.table_end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');let r=null;if(C.value.headers.trim()){confirm(`是否使用模板"${C.value.name}"的列头？\n列头：${C.value.headers}`)&&(r=C.value.headers)}if(r||(r=window.prompt('请输入表格列头（用逗号分隔，如：时间,事件,地点,人物）：')),!r||!r.trim())return void window.toastr.warning('请设置表格列头');const s=r.split(',').map(e=>e.trim()).filter(e=>e);if(0===s.length)return void window.toastr.warning('请设置有效的表格列头');let l;h.value?.setProgress(15),h.value?.setMessage('正在获取聊天消息...'),h.value?.addDetail(`楼层范围: ${o.value.table_start_message_id} - ${o.value.table_end_message_id}`);try{const e=`${o.value.table_start_message_id}-${o.value.table_end_message_id}`;if(console.log('获取消息范围:',e),void 0===window.TavernHelper||'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');l=window.TavernHelper.getChatMessages(e),console.log('✅ 通过 TavernHelper.getChatMessages() 获取到的消息数量:',l.length),h.value?.addDetail(`获取到 ${l.length} 条消息`)}catch(n){return console.error('获取聊天消息失败:',n),x.value=!1,void window.toastr.error('获取聊天消息失败: '+n.message)}if(!l||0===l.length)return void window.toastr.warning('指定范围内没有消息');const d=l.map((e,n)=>`[消息${n+1}] ${'user'===e.role?'用户':'AI'}: ${e.message}`).join('\n\n'),c='你是专业的数据提取助手，负责从聊天记录中提取结构化数据并生成表格。\n\n# 核心任务\n从用户提供的聊天记录中，提取与列头相关的信息，生成JSON格式的表格数据。\n\n# 关键原则\n1. **只提取有效信息**：忽略错误消息、系统提示、无关对话\n2. **精准匹配列头**：每一列都要对应列头的含义\n3. **保持结构化**：每行数据必须是数组，长度等于列头数量\n4. **避免空表**：如果聊天内容中确实没有相关信息，生成示例说明"无相关数据"\n\n# 输出格式（严格遵守）\n只输出纯JSON，格式如下：\n{\n  "data": [\n    ["值1", "值2", "值3"],\n    ["值4", "值5", "值6"]\n  ]\n}\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用markdown代码块（```json）\n❌ 不要复制错误消息作为数据\n❌ 不要改变列头顺序或数量\n\n现在开始提取数据。',p=`请从以下聊天记录中提取信息，生成表格数据。\n\n**表格列头**：${s.join(', ')}\n（共${s.length}列，每行数据必须包含${s.length}个值）\n\n**聊天记录**：\n${d}\n\n---\n\n**重要提醒**：\n- 每行数据格式：[${s.map(e=>`"${e}对应的值"`).join(', ')}]\n- 如果某列没有信息，填写"无"或"-"\n- 忽略错误消息、系统提示等无关内容\n- 只返回JSON，不要任何其他文字\n\n立即生成表格JSON：`;console.log('发送AI请求...'),console.log('📋 System Prompt:',c),console.log('📝 User Prompt:',p.slice(0,500)+'...'),h.value?.setProgress(30),h.value?.setMessage('正在发送请求到 AI 服务器...'),h.value?.addDetail(`表格列头: ${s.join(', ')}`);const{normalizeApiEndpoint:u,filterApiParams:g}=await I(async()=>{const{normalizeApiEndpoint:e,filterApiParams:n}=await import('./index.js').then(e=>e.R);return{normalizeApiEndpoint:e,filterApiParams:n}},__vite__mapDeps([0,1])),f=u(o.value.api_endpoint);h.value?.setProgress(40),h.value?.setMessage('等待 AI 分析并生成表格...'),h.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const b=g({model:o.value.model,messages:[{role:'system',content:c},{role:'user',content:p}],max_tokens:o.value.max_tokens,temperature:.3,top_p:o.value.top_p,presence_penalty:o.value.presence_penalty,frequency_penalty:o.value.frequency_penalty},o.value.api_endpoint),y=await fetch(f,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${o.value.api_key}`},body:JSON.stringify(b)});if(!y.ok){const e=await y.text();return x.value=!1,console.error('❌ API请求失败:',y.status,y.statusText),console.error('错误详情:',e),void window.toastr.error(`API请求失败！\n\n状态码: ${y.status}\n错误: ${y.statusText}\n\n请检查：\n1. API端点是否正确\n2. API Key是否有效\n3. 网络连接是否正常`,'',{timeOut:1e4})}h.value?.setProgress(70),h.value?.setMessage('正在接收 AI 响应...');const v=await y.json();if(console.log('AI响应:',v),!v.choices||!v.choices[0]||!v.choices[0].message)return x.value=!1,console.error('❌ AI响应格式错误:',v),void window.toastr.error('AI响应格式错误，请检查API是否为OpenAI兼容格式','',{timeOut:8e3});const w=v.choices[0].message.content;let k;console.log('AI返回内容:',w),h.value?.setProgress(85),h.value?.setMessage('正在解析表格数据...');try{if(w.includes('API密钥')||w.includes('请求失败')||w.includes('轮询日志')||w.includes('error')||!w.includes('{')&&!w.includes('['))return x.value=!1,window.toastr.error(`API调用失败，请检查API配置！\n\n错误信息：\n${w.slice(0,200)}`,'',{timeOut:1e4}),void console.error('❌ API返回错误信息:',w);let e=w.trim();e=e.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'');const n=e.match(/\{[\s\S]*\}/);if(!n)throw new Error('无法找到JSON格式的表格数据');k=JSON.parse(n[0])}catch(t){return console.error('解析AI响应失败:',t),console.log('AI原始响应:',w),x.value=!1,void window.toastr.error(`AI返回的数据格式不正确！\n\n原始响应：\n${w.slice(0,200)}`,'',{timeOut:8e3})}if(!k.data||!Array.isArray(k.data))return void window.toastr.error('AI返回的表格数据格式不正确：缺少data数组');for(let e=0;e<k.data.length;e++){if(!Array.isArray(k.data[e]))return void window.toastr.error(`第${e+1}行数据格式错误：不是数组`);if(k.data[e].length!==s.length)return window.toastr.error(`第${e+1}行数据列数不匹配：期望${s.length}列，实际${k.data[e].length}列`),console.log('期望列头:',s),void console.log('实际数据:',k.data[e])}const S={headers:s,data:k.data},A=R();if(A){const n=`${T()}_table_history_${A}`;let t=[];const r=localStorage.getItem(n);if(r)try{t=JSON.parse(r)}catch(a){console.error('解析表格历史失败:',a),t=[]}t.push({start_id:o.value.table_start_message_id,end_id:o.value.table_end_message_id,headers:S.headers,data:S.data}),localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 表格已保存到 localStorage，chat_id:',A),h.value?.setProgress(100),h.value?.setMessage('✅ 表格生成完成！'),h.value?.addDetail(`共生成 ${S.data.length} 行数据`),setTimeout(()=>{x.value=!1,window.toastr.success(`表格生成成功！共${S.data.length}行数据`),e&&i.completeTask(e)},800),console.log('表格已保存到聊天变量:',t)}else x.value=!1,window.toastr.warning('无法获取聊天ID，表格生成失败')}catch(n){console.error('生成表格失败:',n),x.value=!1,window.toastr.error('生成表格失败: '+n.message),e&&i.failTask(e,n.message)}finally{m.value=!1,P()}},handle_create_table:()=>{try{if(!o.value.table_start_message_id||!o.value.table_end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');const n=window.prompt('请输入表格列头（用逗号分隔，如：时间,事件,地点,人物）：');if(!n||!n.trim())return void window.toastr.warning('请设置表格列头');const t=n.split(',').map(e=>e.trim()).filter(e=>e);if(0===t.length)return void window.toastr.warning('请设置有效的表格列头');const a={start_id:o.value.table_start_message_id,end_id:o.value.table_end_message_id,headers:t,data:[]},r=R();if(r){const n=`${T()}_table_history_${r}`;let o=[];const i=localStorage.getItem(n);if(i)try{o=JSON.parse(i)}catch(e){console.error('解析表格历史失败:',e),o=[]}o.push(a),localStorage.setItem(n,JSON.stringify(o)),console.log('✅ 空表格已保存到 localStorage，chat_id:',r),window.toastr.success(`空表格创建成功！列头：${t.join(', ')}`),console.log('空表格已保存到聊天变量:',a)}else window.toastr.warning('无法获取聊天ID，表格创建失败')}catch(n){console.error('创建表格失败:',n),window.toastr.error('创建表格失败: '+n.message)}},handle_hide_messages:async()=>{try{if(console.log('隐藏楼层...'),!p.value.trim())return void window.toastr.warning('请输入要隐藏的楼层范围');const n=p.value.split(',').map(e=>e.trim()),t=[];for(const e of n)if(e.includes('-')){const[n,a]=e.split('-').map(Number);if(n&&a&&n<=a)for(let e=n;e<=a;e++)t.push(e)}else{const n=Number(e);n&&t.push(n)}if(0===t.length)return void window.toastr.warning('请输入有效的楼层范围');let a;try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');a=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',a.length)}}catch(e){return console.error('获取聊天消息失败:',e),void window.toastr.error('获取聊天消息失败: '+e.message)}if(!a||0===a.length)return void window.toastr.warning('当前聊天没有消息');let o=0;const r=[];for(const e of t){if(u.value.some(n=>n.message_id===e)){console.log(`楼层 ${e} 已经被隐藏，跳过`);continue}const n=a.find(n=>n.message_id===e);n&&(r.push({message_id:e,is_hidden:!0}),u.value.push({message_id:e,name:n.name||'Unknown',role:n.role||'user',message:n.message||''}),o++)}if(r.length>0)try{console.log('准备调用 slash 命令隐藏楼层:',t);for(const n of t)try{await triggerSlash(`/hide ${n}`),console.log(`成功隐藏楼层 ${n}`)}catch(e){console.error(`隐藏楼层 ${n} 失败:`,e)}window.toastr.success('楼层已真正隐藏')}catch(e){console.error('调用隐藏API失败:',e),window.toastr.error('隐藏楼层API调用失败: '+e.message)}o>0?(N(),window.toastr.success(`成功隐藏 ${o} 个楼层`),p.value=''):window.toastr.warning('未找到要隐藏的楼层')}catch(e){console.error('隐藏楼层失败:',e),window.toastr.error('隐藏楼层失败: '+e.message)}},handle_show_messages:async()=>{try{if(console.log('显示指定楼层...'),!p.value.trim())return void window.toastr.warning('请输入要显示的楼层范围');const n=l(p.value.trim());if(0===n.length)return void window.toastr.warning('请输入有效的楼层范围');let t;try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');t=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',t.length)}}catch(e){return console.error('获取聊天消息失败:',e),void window.toastr.error('获取聊天消息失败: '+e.message)}if(!t||0===t.length)return void window.toastr.warning('当前聊天没有消息');const a=[];let o=0;for(const e of n){t.find(n=>n.message_id===e)&&(a.push({message_id:e,is_hidden:!1}),o++)}if(0===a.length)return void window.toastr.warning('未找到要显示的楼层');try{for(const t of n)try{await triggerSlash(`/unhide ${t}`),console.log(`成功显示楼层 ${t}`)}catch(e){console.error(`显示楼层 ${t} 失败:`,e)}}catch(e){return console.error('调用显示API失败:',e),void window.toastr.error('显示楼层API调用失败: '+e.message)}u.value=u.value.filter(e=>!n.includes(e.message_id)),N(),window.toastr.success(`成功显示 ${o} 个楼层`),p.value=''}catch(e){console.error('显示楼层失败:',e),window.toastr.error('显示楼层失败: '+e.message)}},handle_refresh_hidden:async(e=!1)=>{try{let t;console.log('刷新隐藏楼层',e),0===u.value.length&&(console.log('隐藏楼层列表为空，先加载数据...'),D());try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');t=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',t.length)}}catch(n){return console.error('获取聊天消息失败:',n),void(e&&window.toastr.error('获取聊天消息失败: '+n.message))}if(!t||0===t.length)return void(e&&window.toastr.warning('当前聊天没有消息'));const a=[];let o=0;for(const e of u.value){const n=t.find(n=>n.message_id===e.message_id);n?a.push({message_id:e.message_id,name:n.name||e.name,role:n.role||e.role,message:n.message||e.message}):o++}u.value=a,N(),e&&(o>0?window.toastr.success(`刷新完成，移除了 ${o} 个不存在的楼层`):window.toastr.success('刷新完成，所有隐藏楼层仍然有效')),console.log(`刷新完成：${a.length} 个有效隐藏楼层，${o} 个已移除`)}catch(n){console.error('刷新隐藏楼层失败:',n),e&&window.toastr.error('刷新隐藏楼层失败: '+n.message)}},handle_unhide_single:async e=>{try{console.log('显示单个楼层',e);const t=u.value.findIndex(n=>n.message_id===e);if(-1===t)return void window.toastr.warning(`楼层 #${e} 不在隐藏列表中`);try{await triggerSlash(`/unhide ${e}`),console.log('成功显示楼层:',e)}catch(n){return console.error('调用显示API失败:',n),void window.toastr.warning('显示楼层API调用失败')}u.value.splice(t,1),N(),window.toastr.success(`已显示楼层 #${e}`)}catch(n){console.error('显示单个楼层失败:',n),window.toastr.error('显示单个楼层失败: '+n.message)}},ProgressDialog:ei};return Object.defineProperty(L,'__isScriptSetup',{enumerable:!1,value:!0}),L}}),nl={class:'settings-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},tl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},al={class:'form-group',style:{'margin-bottom':'18px !important'}},ol={class:'form-group',style:{'margin-bottom':'18px !important'}},rl={class:'form-group',style:{'margin-bottom':'18px !important'}},il={class:'form-group'},sl={class:'model-controls',style:{display:'flex','flex-direction':'column',gap:'10px'}},ll={style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},dl={key:0,style:{color:'#888','font-size':'11px','margin-left':'8px'}},cl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},pl=['disabled'],ul=['value'],gl={class:'form-group',style:{'margin-bottom':'18px !important'}},fl={class:'form-group',style:{'margin-bottom':'18px !important'}},ml={class:'form-group',style:{'margin-bottom':'18px !important'}},xl={class:'form-group',style:{'margin-bottom':'18px !important'}},hl={class:'form-group',style:{'margin-bottom':'18px !important'}},bl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},yl={class:'form-group',style:{'margin-bottom':'18px !important'}},vl={class:'checkbox-label',style:{display:'flex','align-items':'center',gap:'10px',color:'#ccc','font-size':'13px',cursor:'pointer'}},wl={key:0,class:'form-group',style:{'margin-bottom':'18px !important'}},kl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},_l={class:'form-group',style:{'margin-bottom':'18px !important'}},Tl={class:'form-group',style:{'margin-bottom':'18px !important'}},Sl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},Il=['disabled'],Al=['disabled'],zl={key:0,class:'fa-solid fa-magic'},Cl={key:1,class:'fa-solid fa-spinner fa-spin'},$l={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},El={class:'form-group',style:{'margin-bottom':'18px !important'}},Pl={class:'form-group',style:{'margin-bottom':'18px !important'}},Ml={class:'form-group',style:{'margin-bottom':'18px !important'}},Ol={style:{display:'flex',gap:'8px','margin-bottom':'8px'}},jl=['value'],Dl={key:0,style:{display:'flex',gap:'8px'}},Rl={class:'form-group',style:{'margin-bottom':'18px !important'}},Nl={style:{display:'flex',gap:'12px','align-items':'center'}},Hl={style:{display:'flex','align-items':'center',gap:'6px'}},Ll={style:{display:'flex','align-items':'center',gap:'6px'}},Fl={key:0,style:{'margin-left':'auto'}},Vl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},Ul=['disabled'],Jl={key:0,class:'fa-solid fa-robot'},Bl={key:1,class:'fa-solid fa-spinner fa-spin'},Wl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},Gl={class:'form-group',style:{'margin-bottom':'18px !important'}},Yl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},Zl=['disabled'],ql={key:0,class:'hidden-messages-section'},Xl={class:'form-group'},Kl={class:'flex-label'},Ql={key:0,class:'hidden-messages-list'},ed={class:'message-info'},nd={class:'message-id'},td={class:'message-preview'},ad=['onClick'],od={key:1,class:'empty-state'};const rd=a(el,[['render',function(e,n,t,a,f,b){return i(),o('div',nl,[s('div',tl,[s('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[0]||(n[0]=e=>a.toggleSection('api')),onMouseenter:n[1]||(n[1]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[2]||(n[2]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[37]||(n[37]=s('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-cog',style:{color:'#17a2b8','font-size':'18px'}}),d(' API 配置 ')],-1)),s('i',{class:h([a.expandedSections.api?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(s('div',null,[s('div',al,[n[39]||(n[39]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'API 提供商',-1)),l(s('select',{'onUpdate:modelValue':n[3]||(n[3]=e=>a.settings.api_provider=e),style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s',cursor:'pointer'},onChange:a.handleProviderChange},[...n[38]||(n[38]=[s('option',{value:'openai'},'OpenAI',-1),s('option',{value:'gemini'},'Gemini AI Studio',-1)])],544),[[H,a.settings.api_provider]])]),s('div',ol,[n[40]||(n[40]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' API 端点 '),s('span',{style:{color:'#888','font-size':'11px','margin-left':'8px'}},' (兼容酒馆格式，填写 base URL 即可) ')],-1)),l(s('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>a.settings.api_endpoint=e),type:'text',placeholder:'https://你的服务器/v1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.api_endpoint]]),n[41]||(n[41]=u('<div style="margin-top:8px;padding:8px 12px;background:rgba(74, 158, 255, 0.1);border-radius:4px;border-left:3px solid #4a9eff;"><div style="color:#4a9eff;font-size:12px;font-weight:bold;margin-bottom:4px;"> 📌 常见端点示例（与酒馆格式一致）： </div><div style="color:#999;font-size:11px;line-height:1.6;"> • <strong>OpenAI 官方:</strong> https://api.openai.com/v1<br> • <strong>Gemini AI Studio:</strong> https://generativelanguage.googleapis.com/v1beta/openai/<br> • <strong>NewAPI / One API:</strong> https://你的服务器/v1<br> • <strong>本地模型 (Ollama):</strong> http://localhost:11434/v1<br> 💡 <strong>提示：</strong>会自动补全 /chat/completions，也可以直接填完整路径 </div></div>',1))]),s('div',rl,[n[42]||(n[42]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'API Key',-1)),l(s('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>a.settings.api_key=e),type:'password',placeholder:'sk-...',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.api_key]])]),s('div',il,[s('div',sl,[s('label',ll,[n[43]||(n[43]=d(' 模型名称 ',-1)),0===a.available_models.length?(i(),o('span',dl,' (手动输入模型名称，如 gpt-4o-mini) ')):r('',!0)]),s('div',cl,[s('button',{disabled:a.loading_models,class:'fetch-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#4a9eff','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.3)',color:'white'},onmouseover:'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(74, 158, 255, 0.4)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(74, 158, 255, 0.3)\'',onClick:a.handle_fetch_models},c(a.loading_models?'拉取中...':'🔍 拉取模型列表'),9,pl),s('button',{class:'save-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},onmouseover:'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(81, 207, 102, 0.4)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(81, 207, 102, 0.3)\'',onClick:a.handleSaveApiConfig},' 💾 保存配置 ')])]),0===a.available_models.length?l((i(),o('input',{key:0,'onUpdate:modelValue':n[6]||(n[6]=e=>a.settings.model=e),type:'text',placeholder:'gpt-4o-mini 或 deepseek-chat 等',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512)),[[p,a.settings.model]]):l((i(),o('select',{key:1,'onUpdate:modelValue':n[7]||(n[7]=e=>a.settings.model=e),class:'model-select',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},[(i(!0),o(m,null,x(a.available_models,e=>(i(),o('option',{key:e,value:e},c(e),9,ul))),128))],512)),[[H,a.settings.model]])]),s('div',gl,[n[44]||(n[44]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'最大 Token 数（建议4000以上获得更详细的总结）',-1)),l(s('input',{'onUpdate:modelValue':n[8]||(n[8]=e=>a.settings.max_tokens=e),type:'number',min:'100',max:'16000',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.max_tokens,void 0,{number:!0}]])]),s('div',fl,[n[45]||(n[45]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Temperature (温度) '),s('span',{style:{color:'#888','font-size':'11px'}},'(0-2，推荐 0.7)')],-1)),l(s('input',{'onUpdate:modelValue':n[9]||(n[9]=e=>a.settings.temperature=e),type:'number',min:'0',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.temperature,void 0,{number:!0}]]),n[46]||(n[46]=s('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 较高值（如 0.8）使输出更随机，较低值（如 0.2）使其更确定 ',-1))]),s('div',ml,[n[47]||(n[47]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Top P (核采样) '),s('span',{style:{color:'#888','font-size':'11px'}},'(0-1，推荐 1.0)')],-1)),l(s('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>a.settings.top_p=e),type:'number',min:'0',max:'1',step:'0.01',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.top_p,void 0,{number:!0}]]),n[48]||(n[48]=s('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' ⚠️ 一般建议只改 Temperature 或 Top P，不要同时修改 ',-1))]),s('div',xl,[n[49]||(n[49]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Presence Penalty (存在惩罚) '),s('span',{style:{color:'#888','font-size':'11px'}},'(-2.0 to 2.0，推荐 0)')],-1)),l(s('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>a.settings.presence_penalty=e),type:'number',min:'-2',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.presence_penalty,void 0,{number:!0}]]),n[50]||(n[50]=s('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 正值根据标记是否出现过来惩罚，增加讨论新主题的可能性 ',-1))]),s('div',hl,[n[51]||(n[51]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Frequency Penalty (频率惩罚) '),s('span',{style:{color:'#888','font-size':'11px'}},'(-2.0 to 2.0，推荐 0)')],-1)),l(s('input',{'onUpdate:modelValue':n[12]||(n[12]=e=>a.settings.frequency_penalty=e),type:'number',min:'-2',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.frequency_penalty,void 0,{number:!0}]]),n[52]||(n[52]=s('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 正值根据标记频率来惩罚，降低逐字重复同一行的可能性 ',-1))])],512),[[P,a.expandedSections.api]])]),s('div',bl,[s('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[13]||(n[13]=e=>a.toggleSection('autoSummary')),onMouseenter:n[14]||(n[14]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[15]||(n[15]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[53]||(n[53]=s('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-bolt',style:{color:'#ffc107','font-size':'18px'}}),d(' 自动总结 ')],-1)),s('i',{class:h([a.expandedSections.autoSummary?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(s('div',null,[s('div',yl,[s('label',vl,[l(s('input',{'onUpdate:modelValue':n[16]||(n[16]=e=>a.settings.auto_summarize_enabled=e),type:'checkbox',style:{width:'18px',height:'18px',cursor:'pointer','accent-color':'#4a9eff','border-radius':'4px'}},null,512),[[N,a.settings.auto_summarize_enabled]]),n[54]||(n[54]=d(' 启用自动总结 ',-1))])]),a.settings.auto_summarize_enabled?(i(),o('div',wl,[n[55]||(n[55]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'每多少楼层总结一次',-1)),l(s('input',{'onUpdate:modelValue':n[17]||(n[17]=e=>a.settings.summarize_interval=e),type:'number',min:'1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.summarize_interval,void 0,{number:!0}]]),s('div',{style:{'margin-top':'10px',display:'flex',gap:'10px'}},[s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:a.handleSaveSettings},' 💾 保存设置 '),s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:a.handleReloadSettings},' 🔄 重新加载 '),s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:a.handleResetAutoSummaryStart},' 🔄 重置起始楼层 ')])])):r('',!0)],512),[[P,a.expandedSections.autoSummary]])]),s('div',kl,[s('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[18]||(n[18]=e=>a.toggleSection('manualSummary')),onMouseenter:n[19]||(n[19]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[20]||(n[20]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[56]||(n[56]=s('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-pen-to-square',style:{color:'#28a745','font-size':'18px'}}),d(' 手动总结 ')],-1)),s('i',{class:h([a.expandedSections.manualSummary?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(s('div',null,[s('div',_l,[n[57]||(n[57]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'开始楼层',-1)),l(s('input',{'onUpdate:modelValue':n[21]||(n[21]=e=>a.settings.start_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.start_message_id,void 0,{number:!0}]])]),s('div',Tl,[n[58]||(n[58]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'结束楼层',-1)),l(s('input',{'onUpdate:modelValue':n[22]||(n[22]=e=>a.settings.end_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.end_message_id,void 0,{number:!0}]])]),s('div',Sl,[s('button',{class:'action-button test-button',disabled:a.is_summarizing,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'1px solid #4a4a4a','border-radius':'6px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#3a3a3a',color:'#e0e0e0'},onClick:a.handle_test_connection},[...n[59]||(n[59]=[s('i',{class:'fa-solid fa-plug'},null,-1),d(' 测试连接 ',-1)])],8,Il),s('button',{class:'action-button summarize-button',disabled:a.is_summarizing||!a.settings.api_key,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'1px solid #5aaeff','border-radius':'6px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'linear-gradient(135deg, #4a9eff 0%, #3a8edf 100%)','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.25),\n                inset 0 1px 0 rgba(255, 255, 255, 0.15)',color:'white'},onClick:a.handle_summarize},[a.is_summarizing?(i(),o('i',Cl)):(i(),o('i',zl)),d(' '+c(a.is_summarizing?'正在总结...':'手动总结'),1)],8,Al)])],512),[[P,a.expandedSections.manualSummary]])]),s('div',$l,[s('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[23]||(n[23]=e=>a.toggleSection('tableGeneration')),onMouseenter:n[24]||(n[24]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[25]||(n[25]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[60]||(n[60]=s('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-table',style:{color:'#6f42c1','font-size':'18px'}}),d(' 表格生成 ')],-1)),s('i',{class:h([a.expandedSections.tableGeneration?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(s('div',null,[s('div',El,[n[61]||(n[61]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'开始楼层',-1)),l(s('input',{'onUpdate:modelValue':n[26]||(n[26]=e=>a.settings.table_start_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.table_start_message_id,void 0,{number:!0}]])]),s('div',Pl,[n[62]||(n[62]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'结束楼层',-1)),l(s('input',{'onUpdate:modelValue':n[27]||(n[27]=e=>a.settings.table_end_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.settings.table_end_message_id,void 0,{number:!0}]])]),s('div',Ml,[n[67]||(n[67]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'表格列头模板',-1)),s('div',Ol,[l(s('select',{'onUpdate:modelValue':n[28]||(n[28]=e=>a.selectedTemplate=e),style:{flex:'1',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'},onChange:a.loadTemplate},[n[63]||(n[63]=s('option',{value:''},'选择模板...',-1)),(i(!0),o(m,null,x(a.headerTemplates,(e,n)=>(i(),o('option',{key:n,value:n},c(e.name),9,jl))),128))],544),[[H,a.selectedTemplate]]),s('button',{style:{padding:'8px 12px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:a.showAddTemplateDialog},[...n[64]||(n[64]=[s('i',{class:'fa-solid fa-plus'},null,-1),d(' 添加 ',-1)])])]),''!==a.selectedTemplate?(i(),o('div',Dl,[l(s('input',{'onUpdate:modelValue':n[29]||(n[29]=e=>a.currentTemplate.name=e),type:'text',placeholder:'模板名称',style:{flex:'1',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},null,512),[[p,a.currentTemplate.name]]),l(s('input',{'onUpdate:modelValue':n[30]||(n[30]=e=>a.currentTemplate.headers=e),type:'text',placeholder:'列头（用逗号分隔）',style:{flex:'2',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},null,512),[[p,a.currentTemplate.headers]]),s('button',{style:{padding:'8px 12px',background:'#28a745',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:a.saveTemplate},[...n[65]||(n[65]=[s('i',{class:'fa-solid fa-save'},null,-1),d(' 保存 ',-1)])]),s('button',{style:{padding:'8px 12px',background:'#dc3545',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:a.deleteTemplate},[...n[66]||(n[66]=[s('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])])])):r('',!0)]),s('div',Rl,[n[71]||(n[71]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'生成状态',-1)),s('div',Nl,[s('div',Hl,[s('div',{style:g({width:'8px',height:'8px',borderRadius:'50%',backgroundColor:a.is_summarizing?'#ff6b6b':'#4caf50',transition:'background-color 0.3s'})},null,4),n[68]||(n[68]=s('span',{style:{color:'#ccc','font-size':'12px'}},'总结生成',-1))]),s('div',Ll,[s('div',{style:g({width:'8px',height:'8px',borderRadius:'50%',backgroundColor:a.is_generating_table?'#ff6b6b':'#4caf50',transition:'background-color 0.3s'})},null,4),n[69]||(n[69]=s('span',{style:{color:'#ccc','font-size':'12px'}},'表格生成',-1))]),a.is_summarizing||a.is_generating_table?(i(),o('div',Fl,[s('button',{style:{padding:'4px 8px',background:'#dc3545',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'11px'},onClick:a.stopGeneration},[...n[70]||(n[70]=[s('i',{class:'fa-solid fa-stop'},null,-1),d(' 停止生成 ',-1)])])])):r('',!0)])]),s('div',Vl,[s('button',{class:'action-button summarize-button',disabled:a.is_generating_table||!a.settings.api_key,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#4a9eff','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.3)',color:'white'},onClick:a.handle_generate_table},[a.is_generating_table?(i(),o('i',Bl)):(i(),o('i',Jl)),d(' '+c(a.is_generating_table?'AI填充中...':'AI填充表格'),1)],8,Ul),s('button',{class:'action-button create-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},onClick:a.handle_create_table},[...n[72]||(n[72]=[s('i',{class:'fa-solid fa-plus'},null,-1),d(' 创建空表格 ',-1)])])])],512),[[P,a.expandedSections.tableGeneration]])]),s('div',Wl,[s('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[31]||(n[31]=e=>a.toggleSection('messageManagement')),onMouseenter:n[32]||(n[32]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[33]||(n[33]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[73]||(n[73]=s('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-layer-group',style:{color:'#dc3545','font-size':'18px'}}),d(' 楼层管理 ')],-1)),s('i',{class:h([a.expandedSections.messageManagement?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(s('div',null,[s('div',Gl,[n[74]||(n[74]=s('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'隐藏楼层范围（如：1-10 或单个楼层如：5）',-1)),l(s('input',{'onUpdate:modelValue':n[34]||(n[34]=e=>a.hide_range=e),type:'text',placeholder:'1-10',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,a.hide_range]])]),s('div',Yl,[s('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#ff6b6b','box-shadow':'0 2px 8px rgba(255, 107, 107, 0.3)',color:'white'},onClick:a.handle_hide_messages},[...n[75]||(n[75]=[s('i',{class:'fa-solid fa-eye-slash'},null,-1),d(' 隐藏楼层 ',-1)])]),s('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},disabled:!a.hide_range.trim(),onClick:a.handle_show_messages},[...n[76]||(n[76]=[s('i',{class:'fa-solid fa-eye'},null,-1),d(' 显示楼层 ',-1)])],8,Zl),s('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#ffd43b','box-shadow':'0 2px 8px rgba(255, 212, 59, 0.3)',color:'#333'},onClick:n[35]||(n[35]=()=>a.handle_refresh_hidden(!0))},[...n[77]||(n[77]=[s('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新 ',-1)])])]),a.hidden_messages.length>0?(i(),o('div',ql,[s('div',Xl,[s('label',Kl,[s('span',null,'已隐藏的楼层 ('+c(a.hidden_messages.length)+' 个)',1),s('button',{class:'mini-button',style:{padding:'6px 14px',background:'#4a9eff',color:'white',border:'none','border-radius':'8px',cursor:'pointer','font-size':'12px','font-weight':'500',transition:'all 0.2s','box-shadow':'0 2px 6px rgba(74, 158, 255, 0.3)'},onClick:n[36]||(n[36]=e=>a.hidden_display_expanded=!a.hidden_display_expanded)},c(a.hidden_display_expanded?'收起':'展开'),1)])]),a.hidden_display_expanded?(i(),o('div',Ql,[(i(!0),o(m,null,x(a.hidden_messages,e=>(i(),o('div',{key:e.message_id,class:'hidden-message-item'},[s('div',ed,[s('span',nd,'#'+c(e.message_id),1),s('span',{class:h(['message-role','role-'+e.role])},c('user'===e.role?'👤':'assistant'===e.role?'🤖':'⚙️')+' '+c(e.name),3),s('span',td,c(e.message.substring(0,50))+c(e.message.length>50?'...':''),1)]),s('button',{class:'show-button',style:{padding:'6px 14px',background:'#51cf66',color:'white',border:'none','border-radius':'8px',cursor:'pointer','font-size':'12px','font-weight':'500',transition:'all 0.2s','box-shadow':'0 2px 6px rgba(81, 207, 102, 0.3)'},onClick:()=>a.handle_unhide_single(e.message_id)},' 显示 ',8,ad)]))),128))])):r('',!0)])):(i(),o('div',od,'暂无隐藏的楼层'))],512),[[P,a.expandedSections.messageManagement]])]),C(a.ProgressDialog,{ref:'progressDialogRef',show:a.showProgress,title:'AI 正在处理'},null,8,['show'])])}],['__file','SettingsTab.vue']]),id=e({__name:'StatusBarGenerator',setup(e,{expose:a}){a();const o=b(),{settings:r}=y(o),i=v(),s={simple:{name:'简单状态栏',findRegex:'<-CHARACTER_STATUS->',fields:[{name:'姓名',label:'姓名',icon:'fa-solid fa-user'},{name:'性别',label:'性别',icon:'fa-solid fa-venus-mars'},{name:'年龄',label:'年龄',icon:'fa-solid fa-cake-candles'},{name:'好感度',label:'好感度',icon:'fa-solid fa-heart'}]},abo:{name:'ABO设定状态栏',findRegex:'<-ENVIRONMENT_DATA->[\\r\\n]*\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|[\\r\\n]*<-CHARACTER_STATUS->[\\r\\n]*\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|[\\r\\n]*',fields:[{name:'日期',label:'日期',icon:'fa-solid fa-calendar'},{name:'时间',label:'时间',icon:'fa-solid fa-clock'},{name:'地点',label:'地点',icon:'fa-solid fa-location-dot'},{name:'天气温度',label:'天气温度',icon:'fa-solid fa-cloud-sun'},{name:'着装',label:'着装',icon:'fa-solid fa-shirt'},{name:'黏人程度',label:'黏人程度',icon:'fa-solid fa-heart'},{name:'发情状态',label:'发情状态',icon:'fa-solid fa-fire'},{name:'标记情况',label:'标记情况',icon:'fa-solid fa-bookmark'}]}},l=n({name:'角色状态栏',findRegex:'<-CHARACTER_STATUS->',fields:[{name:'姓名',label:'姓名',icon:'fa-solid fa-user'},{name:'性别',label:'性别',icon:'fa-solid fa-venus-mars'},{name:'年龄',label:'年龄',icon:'fa-solid fa-cake-candles'},{name:'好感度',label:'好感度',icon:'fa-solid fa-heart'}]}),d=n([{path:'index.html',content:''},{path:'style.css',content:''},{path:'script.js',content:''}]),c=n(d.value[0]),p=n(!1),u=n(''),g=n(''),f=n(!1),m=n(!1),x=n(null),h=n(!1),S=n(null),I=n(''),C=n(!1),E=n(!1),P=n(''),O=n(!1),j=n(!1),D=n(!1),R=n(''),N=n(!1),H=n(!1),L=n(''),F=n(!1),V=w(()=>{l.value.fields.map(e=>`{{${e.label||e.name}}}`).join('|');const e=l.value.fields.map(e=>{const n=e.icon?`<i class="${e.icon}"></i> `:'',t=e.label||e.name;return`  - ${n}${t}：描述{{char}}的${t}状态`}).join('\n');l.value.fields.map(e=>e.label||e.name||'示例值').join('|');const{formatExample:n,exampleOutput:t}=((e,n)=>{if(0===(e.match(/<-[^>]+->/g)||[]).length){return{formatExample:`|${n.map(e=>`{{${e.label||e.name}}}`).join('|')}|`,exampleOutput:`|${n.map(e=>e.label||e.name).join('|')}|`}}let t=e.replace(/\\\\/g,'\\').replace(/\\\|/g,'|').replace(/\\\(/g,'(').replace(/\\\)/g,')').replace(/\\\[/g,'[').replace(/\\\]/g,']').replace(/\\\+/g,'+');console.log('🔍 原始正则:',e),console.log('🔍 规范化正则:',t);const a=[],o=[];let r=0;const i=t.split(/(<-[^>]+->)/);console.log('🔍 分割后的部分:',i);for(let s=0;s<i.length;s++){const e=i[s];if(e.match(/<-[^>]+->/))a.push(e),o.push(e),console.log(`📍 标记: ${e}`);else if(e.trim().length>0&&!e.match(/<-[^>]+->/)){const t=e.match(/\([^\)]+\)/g)||[],i=t.length;if(console.log(`🔢 部分内容 (前100字符): "${e.substring(0,100)}"`),console.log('🔢 匹配到的捕获组:',t),console.log(`🔢 捕获组数量: ${i}, 当前字段索引: ${r}, 总字段数: ${n.length}`),0===i){console.warn('⚠️ 未找到捕获组，跳过此部分');continue}const s=4;for(let e=0;e<i;e+=s){const t=Math.min(s,i-e);if(t>0){const e=n.slice(r,r+t);for(;e.length<t;)e.push({name:`字段${r+e.length+1}`,label:`字段${r+e.length+1}`,icon:''});const i=e.map(e=>`{{${e.label||e.name}}}`).join('|'),s=e.map(e=>e.label||e.name).join('|');a.push(`|${i}|`),o.push(`|${s}|`),console.log(`✅ 添加字段行: |${s}|`),r+=t}}}}return console.log('📊 最终格式示例:',a.join('\n')),console.log('📊 最终输出示例:',o.join('\n')),{formatExample:a.join('\n'),exampleOutput:o.join('\n')}})(l.value.findRegex,l.value.fields);return`<status_rule>\n#每一次回复都必须在末尾加上完整的状态栏，实时更新{{char}}的状态。\n\n##状态栏格式：\n<status>\n${n}\n</status>\n\n##字段说明\n${e||'  - 暂无字段，请先在生成器中添加字段'}\n\n##输出示例\n此处仅为格式示例，具体内容需根据剧情填写\n<status>\n${t}\n</status>\n\n##格式要求（必读）：\n1. **必须包含 <status> 标签**：\n   - ✅ 开头：<status>\n   - ✅ 结尾：</status>\n   - ❌ 缺少标签将无法正确渲染\n\n2. **严格按照上述示例格式输出**：\n   - 每个标记（如 <-ENVIRONMENT_DATA->）必须独占一行\n   - 每行字段用竖线 | 分隔，字段数量必须完全一致\n   - 不要改变行数、不要合并行、不要调换顺序\n   - 完全按照示例格式，只替换字段内容\n\n3. **字段值格式**：\n   - ❌ 错误：|伴侣: 无|信息素: 雪后冷杉|\n   - ✅ 正确：|无|雪后冷杉|\n   - 只输出实际值，不要加字段名前缀\n\n4. **换行要求**：\n   - 严格遵守示例中的换行\n   - 标记后必须换行\n   - 每行字段后必须换行\n   - 绝不把多行合并成一行\n\n5. **其他要求**：\n   - 状态栏紧贴正文最后一句\n   - {{字段名}} 仅为占位符，输出时替换为实际内容\n   - 这是 {{char}} 的状态，不是 {{user}} 的状态\n</status_rule>`}),U=w(()=>{const e=d.value.find(e=>'index.html'===e.path),n=d.value.find(e=>'style.css'===e.path),t=d.value.find(e=>'script.js'===e.path);if(!e)return'';const a='script',o='style';let r=e.content||'';return l.value.fields.forEach((e,n)=>{const t=e.name||`示例${n+1}`;r=r.replace(new RegExp(`\\$${n+1}(?!\\d)`,'g'),t)}),`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">\n  <${o}>\n    html, body {\n      margin: 0;\n      padding: 0;\n      width: 100%;\n      height: auto;\n      min-height: 800px;\n      overflow: visible;\n    }\n    ${n?.content||''}\n  </${o}>\n  <${a} src="https://code.jquery.com/jquery-3.7.1.min.js"></${a}>\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></${a}>\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></${a}>\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></${a}>\n</head>\n<body>\n  ${r}\n  <${a}>${t?.content||''}</${a}>\n</body>\n</html>`});function J(){}function B(e,n){let t=n.trim();const a=t.match(/^```[a-zA-Z0-9]*\s*([\s\S]*?)\s*```$/);a&&(t=a[1].trim());const o=t.match(/^("""|''')[a-zA-Z0-9]*\s*([\s\S]*?)\s*\1$/);return o&&(t=o[2].trim()),t=t.replace(/^(```|"""|''')[a-zA-Z0-9]*\s*\n?/,''),t=t.replace(/\n?\s*(```|"""|''')$/,''),e.endsWith('.html')&&(t=t.replace(/<!DOCTYPE html>/i,e=>e.toUpperCase())),t}function W(){try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载状态栏配置');const t=`${n}_statusbar_generator_config`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);l.value={...l.value,...e},console.log('✅ 已从 localStorage 加载保存的状态栏配置')}catch(e){console.error('解析状态栏配置失败:',e)}}catch(n){console.error('加载状态栏配置失败:',n)}}function G(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存状态栏配置');const n=`${e}_statusbar_generator_config`;localStorage.setItem(n,JSON.stringify(l.value)),console.log('💾 状态栏配置已保存到 localStorage')}catch(e){console.error('保存状态栏配置失败:',e)}}k(()=>{W()}),t(()=>l.value,()=>{G()},{deep:!0});const Y={settingsStore:o,settings:r,taskStore:i,templates:s,config:l,files:d,currentFile:c,showAI:p,aiPrompt:u,originalAiPrompt:g,showAiModifyDialog:f,isModifyingAi:m,showIconPickerFor:x,showProgress:h,progressDialogRef:S,originalXmlInput:I,showXmlModifyDialog:C,isModifyingXml:E,originalFieldDescription:P,showFieldModifyDialog:O,isModifyingField:j,showXmlDialog:D,xmlInput:R,isParsingXml:N,showAiFieldDialog:H,aiFieldDescription:L,isGeneratingFields:F,iconList:['fa-solid fa-cat','fa-solid fa-dog','fa-solid fa-dove','fa-solid fa-fish','fa-solid fa-paw','fa-solid fa-spider','fa-solid fa-horse','fa-solid fa-heart','fa-solid fa-heart-pulse','fa-solid fa-face-smile','fa-solid fa-face-grin-stars','fa-solid fa-face-grin-beam','fa-solid fa-face-laugh','fa-solid fa-star','fa-solid fa-wand-magic-sparkles','fa-solid fa-hat-wizard','fa-solid fa-bolt','fa-solid fa-fire','fa-solid fa-meteor','fa-solid fa-rocket','fa-solid fa-sun','fa-solid fa-moon','fa-solid fa-cloud','fa-solid fa-seedling','fa-solid fa-leaf','fa-solid fa-tree','fa-solid fa-snowflake','fa-solid fa-cake-candles','fa-solid fa-candy-cane','fa-solid fa-apple','fa-solid fa-ice-cream','fa-solid fa-gem','fa-solid fa-crown','fa-solid fa-gift','fa-solid fa-ribbon','fa-solid fa-medal','fa-solid fa-trophy','fa-solid fa-shield','fa-solid fa-scroll','fa-solid fa-book','fa-solid fa-book-open','fa-solid fa-feather','fa-solid fa-pen','fa-solid fa-paintbrush','fa-solid fa-palette','fa-solid fa-music','fa-solid fa-headphones','fa-solid fa-gamepad','fa-solid fa-chess','fa-solid fa-puzzle-piece','fa-solid fa-dice','fa-solid fa-mobile-screen','fa-solid fa-tablet','fa-solid fa-laptop','fa-solid fa-camera','fa-solid fa-video','fa-solid fa-tv','fa-solid fa-bell','fa-solid fa-envelope'],worldbookContent:V,previewHtml:U,updatePreview:J,addField:function(){l.value.fields.push({name:'',label:'',icon:''})},removeField:function(e){l.value.fields.splice(e,1)},showXmlParseDialog:function(){D.value=!0,R.value=''},showAiFieldGeneratorDialog:function(){H.value=!0,L.value=''},parseXmlWithAI:async function(){if(!R.value.trim())return void toastr.warning('请先输入 XML 代码');if(!r.value.api_endpoint||!r.value.api_key)return void toastr.error('⚠️ API 未配置！请点击右上角"⚙️ 设置"检查 API 配置','',{timeOut:0,extendedTimeOut:0,closeButton:!0});const e=i.createTask('ui_generate','AI解析XML生成字段');I.value=R.value,N.value=!0,h.value=!0;try{S.value?.setProgress(10),S.value?.setMessage('正在准备解析 XML...'),S.value?.addDetail(`XML 长度: ${R.value.length} 字符`),i.updateTaskProgress(e,10,'准备解析XML');const t='你是一个专业的 XML 解析助手。用户会给你一个 XML 格式的状态栏代码，你需要：\n\n1. **识别所有标签**：提取所有的 XML 标签名（如 <i>、<2i>、<日期>、<角色生理状态> 等）\n2. **分析标签含义**：\n   - 如果标签名是 <i>、<2i>、<3i> 等，这表示缩进层级，标签内容才是实际字段名\n   - 如果标签名是中文或英文名称（如 <日期>、<角色生理状态>），这本身就是字段名\n3. **生成字段配置**：为每个字段生成 name、label、icon（可选）\n\n请**严格按照以下 JSON 格式**输出，不要添加任何其他文字：\n\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]\n\n**重要规则**：\n- name 应该是简洁的英文或拼音（如 date, location, status）\n- label 应该是中文描述（如 日期、地点、角色生理状态）\n- icon 可以留空，或者根据字段含义选择合适的 Font Awesome 图标\n- 输出**必须**是有效的 JSON 数组格式\n- **禁止**输出任何解释性文字，只输出 JSON\n\n示例输入：\n<state_bar>\n<i>【内容】</i>\n<日期>【当前日期】</日期>\n<角色生理状态>【描述角色当前生理状态】</角色生理状态>\n</state_bar>\n\n示例输出：\n[\n  { "name": "content", "label": "内容", "icon": "" },\n  { "name": "date", "label": "日期", "icon": "fa-solid fa-calendar" },\n  { "name": "physical_status", "label": "角色生理状态", "icon": "fa-solid fa-heart-pulse" }\n]',a=`请解析以下 XML 状态栏代码，生成字段配置：\n\n\`\`\`xml\n${R.value.trim()}\n\`\`\`\n\n请严格按照 JSON 格式输出，不要添加任何解释。`;console.log('🤖 开始 AI 解析 XML...'),console.log('📍 使用 API:',r.value.api_endpoint),console.log('🤖 使用模型:',r.value.model),S.value?.setProgress(20),S.value?.setMessage('正在发送 XML 到 AI 服务器...'),i.updateTaskProgress(e,20,'发送XML到AI');const o=M(r.value.api_endpoint);console.log('🔗 规范化后的端点:',o),S.value?.setProgress(30),S.value?.setMessage('等待 AI 解析 XML 结构...'),i.updateTaskProgress(e,40,`调用AI (${r.value.model})`);const s=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],max_tokens:2e3,temperature:.7})});if(!s.ok){const e=await s.text();throw new Error(`API请求失败: ${s.status} ${s.statusText}\n${e}`)}const d=await s.json();if(console.log('✅ AI 完整响应:',d),!d.choices||!d.choices[0]||!d.choices[0].message)throw new Error('AI响应格式错误');const c=d.choices[0].message.content;if(console.log('✅ AI 原始返回:',c),!c||'string'!=typeof c)throw new Error('AI 未返回有效内容');let p=c.trim();p=p.replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const u=p.match(/\[\s*{[\s\S]*}\s*\]/);let g;u&&(p=u[0]);try{g=JSON.parse(p)}catch(n){throw new Error(`AI 返回的不是有效的 JSON 格式\n\n请检查 AI 配置，或者手动添加字段。\n\n原始返回（前200字符）:\n${d.slice(0,200)}`)}if(!Array.isArray(g))throw new Error('AI 返回的不是有效的数组格式');const f=g.filter(e=>e.name&&e.label);if(0===f.length)throw new Error('未能从 AI 返回中解析出有效的字段');l.value.fields=f.map(e=>({name:e.name||'',label:e.label||'',icon:e.icon||''})),S.value?.setProgress(100),S.value?.setMessage('✅ 解析完成！'),S.value?.addDetail(`成功解析 ${f.length} 个字段`),i.completeTask(e,{fieldCount:f.length}),setTimeout(()=>{h.value=!1,D.value=!1,R.value='',toastr.success(`成功解析 ${f.length} 个字段！`)},800)}catch(t){console.error('❌ XML 解析失败:',t),h.value=!1;const n=t.message||'未知错误';i.failTask(e,n),n.includes('API请求失败')||n.includes('403')||n.includes('401')||n.includes('Unauthorized')?toastr.error('⚠️ API 请求失败！请检查：\n1. API 密钥是否有效\n2. 模型名称是否正确\n3. 账户余额是否充足','',{timeOut:0,extendedTimeOut:0,closeButton:!0}):toastr.error(`解析失败: ${n}`,'',{timeOut:8e3,closeButton:!0})}finally{N.value=!1}},modifyXmlWithAI:async function(e){if(I.value){E.value=!0,h.value=!0;try{S.value?.setProgress(20),S.value?.setMessage('正在准备修改字段配置...'),S.value?.addDetail(`修改指令: ${e}`);const n='你是一个专业的 XML 解析助手。根据用户的原始 XML 和修改建议，重新解析并生成字段配置。',t=`# 原始 XML：\n${I.value}\n\n# 修改建议：\n${e}\n\n请根据原始 XML 和修改建议，重新生成字段配置。\n输出格式要求（JSON 数组）：\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]`;S.value?.setProgress(40),S.value?.setMessage('正在调用 AI 修改...');const a=M(r.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],max_tokens:2e3,temperature:.7})});if(!o.ok)throw new Error(`API 错误: ${o.statusText}`);S.value?.setProgress(70),S.value?.setMessage('正在接收 AI 响应...');const i=await o.json(),s=i.choices[0]?.message?.content||'';S.value?.setProgress(85),S.value?.setMessage('正在解析字段配置...');let d=s.trim().replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const c=d.match(/\[\s*{[\s\S]*}\s*\]/);c&&(d=c[0]);const p=JSON.parse(d);if(!Array.isArray(p))throw new Error('AI 返回的不是有效的数组格式');l.value.fields=p.map(e=>({name:e.name||'',label:e.label||e.name||'',icon:e.icon||''})),I.value+=`\n\n【已应用的修改】：${e}`,S.value?.setProgress(100),S.value?.setMessage('✅ 修改完成！'),S.value?.addDetail(`已更新 ${p.length} 个字段`),setTimeout(()=>{h.value=!1,C.value=!1,window.toastr.success('✅ AI 修改完成！')},800)}catch(n){console.error('AI 修改失败:',n),h.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{E.value=!1}}else window.toastr.warning('请先解析 XML')},generateFieldsWithAI:async function(){if(!L.value.trim())return void toastr.warning('请先描述你想要的状态栏');if(!r.value.api_endpoint||!r.value.api_key)return void toastr.error('⚠️ API 未配置！请点击右上角"⚙️ 设置"检查 API 配置','',{timeOut:0,extendedTimeOut:0,closeButton:!0});const e=i.createTask('ui_generate','AI智能生成字段');P.value=L.value,F.value=!0,h.value=!0;try{S.value?.setProgress(10),S.value?.setMessage('正在准备智能生成...'),S.value?.addDetail('AI 正在分析你的需求'),i.updateTaskProgress(e,10,'准备智能生成');const t='你是一个专业的状态栏字段设计助手。用户会用自然语言描述他们想要的状态栏，你需要：\n\n1. **理解用户需求**：分析用户描述的场景、类型（如修仙、现代、ABO等）\n2. **设计合理的字段**：根据场景设计完整、实用的字段\n3. **生成字段配置**：为每个字段生成 name、label、icon\n\n请**严格按照以下 JSON 格式**输出，不要添加任何其他文字：\n\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "fa-solid fa-xxx" }\n]\n\n**重要规则**：\n- name 应该是简洁的英文或拼音（如 realm, spiritual_power, location）\n- label 应该是中文描述（如 境界、灵力、位置）\n- icon 必须选择合适的 Font Awesome 图标（如 fa-solid fa-star, fa-solid fa-bolt）\n- 输出**必须**是有效的 JSON 数组格式\n- **禁止**输出任何解释性文字，只输出 JSON\n\n常用图标参考：\n- 人物：fa-solid fa-user, fa-solid fa-user-ninja, fa-solid fa-user-secret\n- 状态：fa-solid fa-heart, fa-solid fa-heart-pulse, fa-solid fa-star\n- 位置：fa-solid fa-location-dot, fa-solid fa-map-marker\n- 时间：fa-solid fa-clock, fa-solid fa-calendar\n- 能量：fa-solid fa-bolt, fa-solid fa-fire, fa-solid fa-droplet\n- 物品：fa-solid fa-book, fa-solid fa-wand-magic-sparkles, fa-solid fa-scroll\n- 情感：fa-solid fa-heart, fa-solid fa-face-smile, fa-solid fa-face-sad-tear\n\n示例：\n用户："帮我生成一个修仙游戏的状态栏"\n输出：\n[\n  { "name": "name", "label": "姓名", "icon": "fa-solid fa-user-ninja" },\n  { "name": "realm", "label": "境界", "icon": "fa-solid fa-star" },\n  { "name": "spiritual_power", "label": "灵力", "icon": "fa-solid fa-bolt" },\n  { "name": "cultivation_method", "label": "功法", "icon": "fa-solid fa-scroll" },\n  { "name": "location", "label": "位置", "icon": "fa-solid fa-location-dot" },\n  { "name": "status", "label": "状态", "icon": "fa-solid fa-heart-pulse" }\n]',a=`请根据以下描述，生成状态栏字段配置：\n\n${L.value.trim()}\n\n请严格按照 JSON 格式输出，不要添加任何解释。`;console.log('🤖 开始 AI 智能生成字段...'),console.log('📍 使用 API:',r.value.api_endpoint),console.log('🤖 使用模型:',r.value.model),S.value?.setProgress(20),S.value?.setMessage('正在发送需求到 AI...'),i.updateTaskProgress(e,20,'发送需求到AI');const o=M(r.value.api_endpoint);console.log('🔗 规范化后的端点:',o),S.value?.setProgress(30),S.value?.setMessage('等待 AI 设计字段...'),i.updateTaskProgress(e,40,`调用AI (${r.value.model})`);const s=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],max_tokens:3e3,temperature:.8})});if(!s.ok){const e=await s.text();throw new Error(`API请求失败: ${s.status} ${s.statusText}\n${e}`)}const d=await s.json();if(console.log('✅ AI 完整响应:',d),!d.choices||!d.choices[0]||!d.choices[0].message)throw new Error('AI响应格式错误');const c=d.choices[0].message.content;if(console.log('✅ AI 原始返回:',c),!c||'string'!=typeof c)throw new Error('AI 未返回有效内容');let p=c.trim();p=p.replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const u=p.match(/\[\s*{[\s\S]*}\s*\]/);let g;u&&(p=u[0]);try{g=JSON.parse(p)}catch(n){throw new Error(`AI 返回的不是有效的 JSON 格式\n\n请检查 AI 配置，或者手动添加字段。\n\n原始返回（前200字符）:\n${c.slice(0,200)}`)}if(!Array.isArray(g))throw new Error('AI 返回的不是有效的数组格式');const f=g.filter(e=>e.name&&e.label);if(0===f.length)throw new Error('未能从 AI 返回中解析出有效的字段');l.value.fields=f.map(e=>({name:e.name||'',label:e.label||'',icon:e.icon||''})),S.value?.setProgress(100),S.value?.setMessage('✅ 生成完成！'),S.value?.addDetail(`成功生成 ${f.length} 个字段`),i.completeTask(e,{fieldCount:f.length}),setTimeout(()=>{h.value=!1,H.value=!1,L.value='',toastr.success(`成功生成 ${f.length} 个字段！`)},800)}catch(t){console.error('❌ AI 生成字段失败:',t),h.value=!1;const n=t.message||'未知错误';i.failTask(e,n),n.includes('API请求失败')||n.includes('403')||n.includes('401')||n.includes('Unauthorized')?toastr.error('⚠️ API 请求失败！请检查：\n1. API 密钥是否有效\n2. 模型名称是否正确\n3. 账户余额是否充足','',{timeOut:0,extendedTimeOut:0,closeButton:!0}):toastr.error(`生成失败: ${n}`,'',{timeOut:8e3,closeButton:!0})}finally{F.value=!1}},showIconPicker:function(e){x.value=e},selectIcon:function(e){null!==x.value&&(l.value.fields[x.value].icon=e,x.value=null)},modifyFieldWithAI:async function(e){if(P.value){j.value=!0,h.value=!0;try{S.value?.setProgress(20),S.value?.setMessage('正在准备修改字段配置...'),S.value?.addDetail(`修改指令: ${e}`);const n='你是一个专业的状态栏字段设计助手。根据用户的原始描述和修改建议，重新生成字段配置。',t=`# 原始描述：\n${P.value}\n\n# 修改建议：\n${e}\n\n请根据原始描述和修改建议，重新生成字段配置。\n输出格式要求（JSON 数组）：\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]`;S.value?.setProgress(40),S.value?.setMessage('正在调用 AI 修改...');const a=M(r.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],max_tokens:2e3,temperature:.7})});if(!o.ok)throw new Error(`API 错误: ${o.statusText}`);S.value?.setProgress(70),S.value?.setMessage('正在接收 AI 响应...');const i=await o.json(),s=i.choices[0]?.message?.content||'';S.value?.setProgress(85),S.value?.setMessage('正在解析字段配置...');let d=s.trim().replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const c=d.match(/\[\s*{[\s\S]*}\s*\]/);c&&(d=c[0]);const p=JSON.parse(d);if(!Array.isArray(p))throw new Error('AI 返回的不是有效的数组格式');l.value.fields=p.map(e=>({name:e.name||'',label:e.label||e.name||'',icon:e.icon||''})),P.value+=`\n\n【已应用的修改】：${e}`,S.value?.setProgress(100),S.value?.setMessage('✅ 修改完成！'),S.value?.addDetail(`已更新 ${p.length} 个字段`),setTimeout(()=>{h.value=!1,O.value=!1,window.toastr.success('✅ AI 修改完成！')},800)}catch(n){console.error('AI 修改失败:',n),h.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{j.value=!1}}else window.toastr.warning('请先生成字段')},generateFromFields:function(){const e=l.value.fields,n=e.length;if(0===n)return l.value.findRegex='<-CHARACTER_STATUS->',void console.log('⚠️ 没有字段，使用默认标记');if(n<=4)l.value.findRegex=`<-CHARACTER_STATUS->[\\r\\n]*\\|${e.map(()=>'([^|]+)').join('\\|')}\\|[\\r\\n]*`,console.log('✅ 自动生成的 findRegex (单标记):',l.value.findRegex),console.log('📊 字段数量:',n);else{const t=n<=8?Math.ceil(n/2):4,a=Math.min(Math.ceil(n/2),n<=12?4:Math.ceil(n/3)),o=[];o.push('<-ENVIRONMENT_DATA->[\\r\\n]*');for(let n=0;n<a;n+=t){const r=Math.min(t,a-n);o.push('\\|'+e.slice(n,n+r).map(()=>'([^|]+)').join('\\|')+'\\|[\\r\\n]*')}o.push('<-CHARACTER_STATUS->[\\r\\n]*');for(let r=a;r<n;r+=t){const a=Math.min(t,n-r);o.push('\\|'+e.slice(r,r+a).map(()=>'([^|]+)').join('\\|')+'\\|[\\r\\n]*')}l.value.findRegex=o.join(''),console.log('✅ 自动生成的 findRegex (双标记):',l.value.findRegex),console.log('📊 字段数量:',n),console.log('📊 分配方案:',`第一个标记: ${a}个字段, 第二个标记: ${n-a}个字段, 每行: ${t}个`)}const t=e.map((e,n)=>`        <div class="status-field">\n          <div class="field-label">${e.icon?`<i class="${e.icon}"></i> `:''}${e.label||'字段'+(n+1)}</div>\n          <div class="field-value">$${n+1}</div>\n        </div>`).join('\n'),a=`<details>\n<summary> ${l.value.name} </summary>\n<div class="status-card">\n    <div class="status-header">\n        <span>📋</span>\n        <span>${l.value.name}</span>\n    </div>\n    <div class="status-content">\n        <div class="status-grid">\n${t}\n        </div>\n    </div>\n</div>\n</details>`,o=`// 状态栏交互脚本\n(function() {\n  // 等待内容渲染\n  setTimeout(function() {\n    console.log('${l.value.name} 已加载');\n\n    // 可以添加动画效果\n    if (typeof gsap !== 'undefined') {\n      gsap.from('.status-field', {\n        opacity: 0,\n        y: 20,\n        duration: 0.5,\n        stagger: 0.1,\n        ease: 'power2.out'\n      });\n\n      // 鼠标悬停效果\n      $('.status-field').hover(\n        function() {\n          gsap.to($(this), { scale: 1.05, duration: 0.2 });\n        },\n        function() {\n          gsap.to($(this), { scale: 1, duration: 0.2 });\n        }\n      );\n    }\n  }, 100);\n})();`;d.value[0].content=a,d.value[1].content='.status-card {\n    font-family: \'Microsoft YaHei\', sans-serif;\n    background: linear-gradient(145deg, #1e293b, #334155);\n    border-radius: 14px;\n    margin: 16px 0;\n    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.4);\n    overflow: hidden;\n    border: 1px solid rgba(148, 163, 184, 0.2);\n    max-width: 600px;\n}\n\n.status-header {\n    background: linear-gradient(135deg, #0f172a, #1e293b);\n    color: #e2e8f0;\n    padding: 12px 20px;\n    font-size: 15px;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    border-bottom: 1px solid rgba(148, 163, 184, 0.15);\n}\n\n.status-content {\n    padding: 20px;\n    background: rgba(30, 41, 59, 0.5);\n}\n\n.status-grid {\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 16px;\n}\n\n.status-field {\n    background: rgba(30, 41, 59, 0.8);\n    padding: 16px;\n    border-radius: 10px;\n    border-left: 3px solid #6366f1;\n}\n\n.field-label {\n    font-size: 11px;\n    color: #94a3b8;\n    margin-bottom: 8px;\n    font-weight: 600;\n    text-transform: uppercase;\n}\n\n.field-value {\n    font-size: 14px;\n    color: #e2e8f0;\n    line-height: 1.5;\n    font-weight: 600;\n}',d.value[2].content=o,c.value=d.value[0],window.toastr.success('✅ 模板已生成！')},showAIDialog:function(){p.value=!0,u.value=''},addFieldInDialog:function(){l.value.fields.push({name:`字段${l.value.fields.length+1}`,label:`字段${l.value.fields.length+1}`,icon:''})},removeFieldInDialog:function(e){l.value.fields.length<=1?window.toastr.warning('至少需要保留一个字段'):l.value.fields.splice(e,1)},loadTemplate:function(e){const n=s[e];n&&(l.value=JSON.parse(JSON.stringify(n)),window.toastr.success(`✅ 已加载"${n.name}"模板`))},generateWithAI:async function(){if(!u.value.trim())return void window.toastr.error('请输入修改需求');const e=i.createTask('ui_generate','AI生成状态栏界面');g.value=u.value,h.value=!0;try{if(!r.value.api_endpoint||!r.value.api_key)return window.toastr.error('请先在设置页面配置 API 端点和 API Key'),h.value=!1,void i.failTask(e,'API未配置');S.value?.setProgress(10),S.value?.setMessage('正在准备 AI 请求...'),S.value?.addDetail(`字段数量: ${l.value.fields.length} 个`),S.value?.addDetail(`模型: ${r.value.model}`),i.updateTaskProgress(e,10,'准备AI请求');const n=d.value.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n'),t='你是一个专业的前端开发助手，专门为 SillyTavern 状态栏生成 HTML/CSS/JS 代码片段。\n\n【重要】最终代码会被嵌入到 Regex 脚本的 replaceString 字段中，用于替换 AI 输出的纯文本状态栏。\n【重要】这是**{{char}}（角色）的状态栏**，用于显示角色的状态信息，不是{{user}}（用户）的状态。\n\n可用环境：\n- Font Awesome 图标库（已加载）\n- jQuery ($) - 已全局可用\n- toastr（消息提示）- 已全局可用\n- gsap（动画库）- 已全局可用\n- lodash (_) - 已全局可用\n\n字段占位符规则：\n- 用 $1、$2、$3 等表示正则捕获的字段值\n- $1 代表第一个字段，$2 代表第二个字段，以此类推\n- 用户会明确告诉你每个占位符对应的字段名，你必须严格按照用户的字段配置来生成代码\n- **禁止**根据当前代码文件中的字段来推断，必须使用用户明确提供的字段列表\n\n输出格式（三个独立文件）：\nFILE_START: index.html\n<details>\n<summary> 状态栏标题 </summary>\n<div class="status-card">\n  \x3c!-- 使用 $1, $2, $3 等占位符，必须与用户提供的字段一一对应 --\x3e\n  <div class="field-value">$1</div>\n</div>\n</details>\nFILE_END\n\nFILE_START: style.css\n.status-card {\n  /* 完整样式 */\n}\nFILE_END\n\nFILE_START: script.js\n(function() {\n  // 立即执行函数，避免全局污染\n  // 可以直接使用 $ 和 document\n})();\nFILE_END\n\n【关键要求】：\n1. index.html 必须以 <details> 开头，以 </details> 结尾，不要 <!DOCTYPE> 和 <html> 标签\n2. FILE_START 和 FILE_END 之间直接写纯代码，**绝对禁止**添加代码块标记（\\`\\`\\`html、"""html 等）\n3. HTML 中使用的占位符（$1, $2, $3...）必须与用户提供的字段配置完全一致\n4. CSS 样式要完整、美观，使用现代设计\n5. JS 使用立即执行函数 (function() { ... })()，不需要 $(function() { ... })\n6. 代码会直接嵌入到聊天消息中，不需要考虑 DOM 加载时机\n7. **最重要**：如果用户提供的字段配置与当前代码文件中的字段不同，必须使用用户配置的字段，删除代码中不在用户配置列表里的字段',a=`# 【强制要求】字段配置（这是唯一的字段来源，禁止自行添加或删除字段）：\n${l.value.fields.map((e,n)=>`字段${n+1}：${e.label} (变量名: ${e.name}) - 占位符: $${n+1}${e.icon?` - 图标: ${e.icon}`:''}`).join('\n')}\n\n【⚠️ 重要】你的任务：\n1. HTML 中必须且只能包含上述 ${l.value.fields.length} 个字段\n2. 字段顺序必须严格按照：$1 = ${l.value.fields[0]?.label||'字段1'}, $2 = ${l.value.fields[1]?.label||'字段2'}${l.value.fields[2]?`, $3 = ${l.value.fields[2].label}`:''}${l.value.fields[3]?`, $4 = ${l.value.fields[3].label}`:''}${l.value.fields[4]?`, $5 = ${l.value.fields[4].label}`:''}\n3. 禁止添加任何额外的字段（如"姓名"、"性别"、"年龄"等，除非它们在上面的字段列表中）\n4. 禁止使用 $${l.value.fields.length+1} 及以上的占位符\n\n# 【重要说明】状态栏用途：\n这是**{{char}}（角色）的状态栏**，用于显示角色的状态信息（如时间、地点、着装、状态等），**不是{{user}}（用户）的状态**。\n状态栏会通过MVU Beta变量系统读取{{char}}的stat_data变量，显示在聊天消息中。\n\n# 触发正则：\n${l.value.findRegex}\n\n# 用户需求：\n${u.value}\n\n# 当前代码文件（仅供参考样式，字段必须按上面的配置）：\n${n}\n\n【输出要求】：\n1. 根据用户需求设计状态栏样式和布局\n2. 使用上述 ${l.value.fields.length} 个字段，每个占位符（$1, $2, $3...）必须出现在 HTML 中\n3. 可以美化样式、调整布局、添加动画效果\n4. 必须同时输出 index.html、style.css、script.js 三个文件\n5. 如果当前代码中有字段不在上述列表中，请删除它们`;S.value?.setProgress(20),S.value?.setMessage('正在发送请求到 AI 服务器...'),S.value?.addDetail(`API 端点: ${r.value.api_endpoint}`),i.updateTaskProgress(e,20,'发送请求到AI');const o=M(r.value.api_endpoint),s=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],temperature:r.value.temperature||.7,max_tokens:r.value.max_tokens||65500})});if(S.value?.setProgress(40),S.value?.setMessage('等待 AI 响应...'),S.value?.addDetail('这可能需要 10-30 秒，请耐心等待'),i.updateTaskProgress(e,50,`等待AI响应 (${r.value.model})`),!s.ok)throw new Error(`API 错误: ${s.statusText}`);const g=await s.json(),f=g.choices[0]?.message?.content||'';S.value?.setProgress(70),S.value?.setMessage('正在解析 AI 生成的代码...'),S.value?.addDetail(`收到响应，长度: ${f.length} 字符`),i.updateTaskProgress(e,70,'解析AI生成的代码');const m=/FILE_START:\s*([^\n]+)\n([\s\S]*?)(?=FILE_START:|FILE_END:|$)/g,x=[...f.matchAll(m)];if(0===x.length)throw new Error('AI 未返回任何文件修改');for(const e of x){const n=e[1].trim().replace(/^\.\//,'');let t=B(n,e[2]);t.endsWith('FILE_END')&&(t=t.slice(0,-8).trim());const a=d.value.find(e=>e.path===n);a?a.content=t:'index.html'!==n&&'style.css'!==n&&'script.js'!==n||d.value.push({path:n,content:t})}d.value.forEach(e=>{e.path=e.path.replace(/^\.\//,'')});const b=new Map;d.value.forEach(e=>{b.set(e.path,e)}),d.value=Array.from(b.values()),S.value?.setProgress(90),S.value?.setMessage('正在更新预览界面...'),S.value?.addDetail(`已生成 ${x.length} 个文件`),i.updateTaskProgress(e,90,'更新预览界面');const y=d.value.find(e=>'index.html'===e.path)||d.value[0];c.value=y,S.value?.setProgress(100),S.value?.setMessage('✅ AI 生成完成！'),i.completeTask(e,{fileCount:x.length}),setTimeout(()=>{h.value=!1,p.value=!1,window.toastr.success('✅ AI 生成完成！')},800)}catch(n){console.error('AI 生成失败:',n),h.value=!1,i.failTask(e,n.message),window.toastr.error('AI 生成失败: '+n.message)}},modifyWithAI:async function(e){if(g.value){m.value=!0,h.value=!0;try{S.value?.setProgress(10),S.value?.setMessage('正在准备 AI 修改请求...'),S.value?.addDetail(`修改指令: ${e}`);const n=d.value.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n'),t='你是一个专业的前端开发助手，专门为 SillyTavern 状态栏生成 HTML/CSS/JS 代码片段。\n\n【关键要求】：\n1. **必须同时输出 index.html、style.css、script.js 三个文件**\n2. 即使用户只提到修改样式，你也必须完整输出所有三个文件\n3. 不要只修改一个文件就停止，一定要输出完整的三个文件\n4. 使用 FILE_START 和 FILE_END 格式严格标记每个文件\n\n请根据用户的原始需求和修改建议，**完整地**重新生成所有代码文件。',a=`# 原始需求：\n${g.value}\n\n# 修改建议：\n${e}\n\n# 字段配置（必须严格遵守）：\n${l.value.fields.map((e,n)=>`字段${n+1}：${e.label} (变量名: ${e.name}) - 占位符: $${n+1}${e.icon?` - 图标: ${e.icon}`:''}`).join('\n')}\n\n# 当前代码（作为修改基础）：\n${n}\n\n【⚠️ 重要】请根据修改建议，**完整地输出以下三个文件**：\n\nFILE_START: index.html\n<details>\n  \x3c!-- 完整的 HTML，必须使用 $1, $2, $3 等占位符 --\x3e\n</details>\nFILE_END\n\nFILE_START: style.css\n/* 完整的 CSS 样式 */\nFILE_END\n\nFILE_START: script.js\n(function() {\n  // 完整的 JS 代码\n})();\nFILE_END\n\n**不要遗漏任何文件**，即使某个文件没有修改也要完整输出！`;S.value?.setProgress(20),S.value?.setMessage('正在发送修改请求到 AI 服务器...'),S.value?.addDetail(`当前文件数: ${d.value.length} 个`);const o=M(r.value.api_endpoint);S.value?.setProgress(30),S.value?.setMessage('等待 AI 修改代码...'),S.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const i=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify({model:r.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],temperature:.7,max_tokens:65500})});if(!i.ok)throw new Error(`API 错误: ${i.statusText}`);S.value?.setProgress(60),S.value?.setMessage('正在接收 AI 响应...');const s=await i.json(),c=s.choices[0]?.message?.content||'';S.value?.setProgress(80),S.value?.setMessage('正在解析修改后的代码...'),S.value?.addDetail(`响应长度: ${c.length} 字符`);const p=/FILE_START:\s*([^\n]+)\n([\s\S]*?)(?=FILE_START:|FILE_END:|$)/g,u=[...c.matchAll(p)];if(0===u.length)throw new Error('AI 未返回任何文件修改。请尝试更明确的修改指令。');S.value?.addDetail(`解析到 ${u.length} 个文件`);const m=u.map(e=>e[1].trim().replace(/^\.\//,'')),x=['index.html','style.css','script.js'].filter(e=>!m.includes(e));if(x.length>0&&(S.value?.addDetail(`⚠️ 警告: AI 未生成以下文件: ${x.join(', ')}`),window.toastr.warning(`AI 可能只生成了部分文件，缺少: ${x.join(', ')}`,'',{timeOut:5e3})),u.length>0)for(const e of u){const n=e[1].trim().replace(/^\.\//,'');let t=B(n,e[2]);t.endsWith('FILE_END')&&(t=t.slice(0,-8).trim());const a=d.value.find(e=>e.path===n);a&&(a.content=t,S.value?.addDetail(`✓ 已更新: ${n}`))}S.value?.setProgress(95),S.value?.setMessage('正在更新预览...'),g.value+=`\n\n【已应用的修改】：${e}`,S.value?.setProgress(100),S.value?.setMessage('✅ AI 修改完成！'),setTimeout(()=>{h.value=!1,f.value=!1,window.toastr.success(`✅ AI 修改完成！已更新 ${u.length} 个文件`)},800)}catch(n){console.error('AI 修改失败:',n),h.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{m.value=!1}}else window.toastr.warning('请先生成内容')},copyWorldbook:async function(){await A(V.value,'✅ 世界书内容已复制到剪贴板！')},sanitizeFileContent:B,exportRegex:function(){const e=d.value.find(e=>'index.html'===e.path),n=d.value.find(e=>'style.css'===e.path),t=d.value.find(e=>'script.js'===e.path);if(!e||''===e.content.trim())return void window.toastr.error('请先生成或编辑状态栏代码');const a='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const n=16*Math.random()|0;return('x'===e?n:3&n|8).toString(16)}),o='script',r='style',i=`${e.content.trim()}\n<${r}>\n${n?.content||''}\n</${r}>\n\n<${o}>\n${t?.content||''}\n</${o}>`;let s=l.value.findRegex;const c=(s.match(/\([^)]+\)/g)||[]).length,p=l.value.fields.length;0===c&&(s=`${s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}[\\r\\n]*${Array(p).fill('\\|([^|]+)').join('')}\\|[\\r\\n]*`);const u=i.replace(/\r\n/g,'\n').replace(/\r/g,'\n'),g={id:a,scriptName:l.value.name,findRegex:s,replaceString:u,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null},f=new Blob([JSON.stringify(g,null,2)],{type:'application/json'}),m=URL.createObjectURL(f),x=document.createElement('a');x.href=m,x.download=`regex-${l.value.name}.json`,x.click(),URL.revokeObjectURL(m),window.toastr.success('✅ 正则 JSON 已导出成功！')},loadSavedConfig:W,saveConfig:G,AIModifyDialog:Oo,ProgressDialog:ei};return Object.defineProperty(Y,'__isScriptSetup',{enumerable:!1,value:!0}),Y}}),sd={class:'statusbar-generator'},ld={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 28px',background:'linear-gradient(\n          135deg,\n          rgba(30, 30, 30, 0.95) 0%,\n          rgba(38, 38, 38, 0.9) 50%,\n          rgba(30, 30, 30, 0.95) 100%\n        )','backdrop-filter':'blur(12px)','border-radius':'14px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n          inset 0 1px 0 rgba(255, 255, 255, 0.04),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.2)'}},dd={style:{display:'flex',gap:'10px','flex-wrap':'wrap'}},cd={style:{display:'grid','grid-template-columns':'280px 1fr 500px',gap:'20px','min-height':'600px'}},pd={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column','overflow-y':'auto'}},ud={style:{'margin-bottom':'15px'}},gd={style:{flex:'1',display:'flex','flex-direction':'column',gap:'10px','margin-bottom':'15px'}},fd={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'8px'}},md={style:{color:'#4a9eff','font-size':'11px','font-weight':'600'}},xd=['disabled','onClick'],hd=['onUpdate:modelValue'],bd=['onUpdate:modelValue'],yd={style:{display:'flex',gap:'6px','align-items':'center'}},vd=['onUpdate:modelValue'],wd=['onClick'],kd={key:1,class:'fa-solid fa-icons'},_d={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},Td={style:{display:'flex',gap:'8px','margin-bottom':'12px','border-bottom':'1px solid #3a3a3a','padding-bottom':'8px'}},Sd=['onClick'],Id={style:{display:'flex','flex-direction':'column',gap:'15px','overflow-y':'auto'}},Ad={style:{background:'#2a2a2a','border-radius':'12px',padding:'15px',border:'1px solid #3a3a3a'}},zd={style:{background:'#1e1e1e','border-radius':'8px',padding:'12px',border:'1px solid #3a3a3a',overflow:'auto','max-height':'200px'}},Cd={style:{margin:'0',color:'#e0e0e0','font-size':'11px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','font-family':'\'Consolas\', \'Monaco\', monospace'}},$d={style:{background:'#2a2a2a','border-radius':'12px',padding:'15px',border:'1px solid #3a3a3a',flex:'1'}},Ed=['innerHTML'],Pd={style:{background:'#2a2a2a','border-radius':'16px',padding:'20px',width:'600px','max-width':'90vw',border:'1px solid #3a3a3a'}},Md={style:{display:'grid','grid-template-columns':'repeat(8, 1fr)',gap:'8px','margin-bottom':'16px','max-height':'400px','overflow-y':'auto'}},Od=['title','onClick'],jd={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Dd={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'600px','max-width':'90vw','max-height':'90vh','overflow-y':'auto',border:'1px solid #3a3a3a'}},Rd={style:{background:'linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%)',border:'1px solid rgba(59, 130, 246, 0.3)','border-radius':'8px',padding:'12px 16px','margin-bottom':'16px'}},Nd={style:{display:'flex','align-items':'center','justify-content':'space-between','margin-bottom':'10px'}},Hd={style:{display:'flex','align-items':'center',gap:'10px'}},Ld={style:{color:'#93c5fd','font-size':'13px','font-weight':'600'}},Fd={key:0,style:{display:'flex','flex-direction':'column',gap:'8px'}},Vd={style:{color:'#60a5fa','font-weight':'600','font-size':'11px','min-width':'50px'}},Ud=['onUpdate:modelValue'],Jd=['onUpdate:modelValue'],Bd=['onClick'],Wd=['disabled','onClick'],Gd={key:1,style:{color:'#fbbf24','font-size':'12px',padding:'8px 0'}},Yd={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Zd={key:0,style:{'margin-top':'16px',display:'flex',gap:'10px','justify-content':'flex-end'}},qd=['disabled'],Xd={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'90%','max-width':'700px','max-height':'80vh','overflow-y':'auto','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'}},Kd={style:{'margin-bottom':'16px'}},Qd={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},ec=['disabled'],nc=['disabled'],tc={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'90%','max-width':'700px','max-height':'80vh','overflow-y':'auto','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'}},ac={style:{'margin-bottom':'16px'}},oc={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},rc=['disabled'],ic=['disabled'];const sc=a(id,[['render',function(e,n,t,a,b,y){return i(),o('div',sd,[s('div',ld,[n[32]||(n[32]=s('h3',{style:{margin:'0',color:'#fff','font-size':'16px !important','font-weight':'600',display:'flex','align-items':'center',gap:'12px','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[s('i',{class:'fa-solid fa-chart-bar',style:{color:'#4a9eff','font-size':'18px'}}),d(' 状态栏生成器 ')],-1)),s('div',dd,[s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>a.loadTemplate('abo')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[29]||(n[29]=[s('i',{class:'fa-solid fa-magic',style:{'margin-right':'6px'}},null,-1),d(' 快速加载 ABO 模板 ',-1)])],32),s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:a.showAIDialog,onMouseenter:n[3]||(n[3]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[4]||(n[4]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[30]||(n[30]=[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能编辑 ',-1)])],32),s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:a.exportRegex,onMouseenter:n[5]||(n[5]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[6]||(n[6]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[31]||(n[31]=[s('i',{class:'fa-solid fa-download',style:{'margin-right':'6px'}},null,-1),d(' 导出正则 JSON ',-1)])],32)])]),s('div',cd,[s('div',pd,[n[38]||(n[38]=s('h4',{style:{margin:'0 0 15px 0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-cog',style:{color:'#4a9eff'}}),d(' 字段配置 ')],-1)),s('div',ud,[n[33]||(n[33]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#c0c0c0','font-size':'12px','font-weight':'600'}},'触发正则',-1)),l(s('input',{'onUpdate:modelValue':n[7]||(n[7]=e=>a.config.findRegex=e),type:'text',placeholder:'<-CHARACTER_STATUS->',style:{width:'100%',padding:'8px 12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'12px'}},null,512),[[p,a.config.findRegex]])]),s('div',gd,[(i(!0),o(m,null,x(a.config.fields,(e,n)=>(i(),o('div',{key:n,style:{padding:'10px',background:'#1e1e1e','border-radius':'6px',border:'1px solid #3a3a3a'}},[s('div',fd,[s('span',md,'字段 '+c(n+1),1),s('button',{disabled:a.config.fields.length<=1,style:g({padding:'4px 8px',background:'#ef4444',border:'none',borderRadius:'4px',color:'white',fontSize:'10px',cursor:'pointer',opacity:a.config.fields.length<=1?.4:1}),onClick:e=>a.removeField(n)},' 删除 ',12,xd)]),l(s('input',{'onUpdate:modelValue':n=>e.name=n,type:'text',placeholder:'字段名称',style:{width:'100%',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','margin-bottom':'6px'}},null,8,hd),[[p,e.name]]),l(s('input',{'onUpdate:modelValue':n=>e.label=n,type:'text',placeholder:'显示名称',style:{width:'100%',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','margin-bottom':'6px'}},null,8,bd),[[p,e.label]]),s('div',yd,[l(s('input',{'onUpdate:modelValue':n=>e.icon=n,type:'text',placeholder:'图标类名（可选，如：fa-solid fa-user）',style:{flex:'1',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','font-family':'monospace'}},null,8,vd),[[p,e.icon]]),s('button',{style:{padding:'6px 10px',background:'#3a3a3a',border:'1px solid #4a4a4a','border-radius':'4px',color:'#fff','font-size':'12px',cursor:'pointer','min-width':'36px'},title:'选择图标',onClick:e=>a.showIconPicker(n)},[e.icon?(i(),o('i',{key:0,class:h(e.icon)},null,2)):(i(),o('i',kd))],8,wd)])]))),128))]),s('button',{style:{width:'100%',padding:'8px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:a.addField},[...n[34]||(n[34]=[s('i',{class:'fa-solid fa-plus',style:{'margin-right':'6px'}},null,-1),d(' 添加字段 ',-1)])]),s('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:a.showXmlParseDialog},[...n[35]||(n[35]=[s('i',{class:'fa-solid fa-code',style:{'margin-right':'6px'}},null,-1),d(' AI 解析 XML 生成字段 ',-1)])]),s('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:a.showAiFieldGeneratorDialog},[...n[36]||(n[36]=[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能生成字段 ',-1)])]),s('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:a.generateFromFields},[...n[37]||(n[37]=[s('i',{class:'fa-solid fa-sparkles',style:{'margin-right':'6px'}},null,-1),d(' 根据字段生成模板 ',-1)])])]),s('div',_d,[s('div',Td,[(i(!0),o(m,null,x(a.files,e=>(i(),o('div',{key:e.path,style:g({padding:'6px 14px',background:a.currentFile?.path===e.path?'#4a9eff':'#1e1e1e',color:a.currentFile?.path===e.path?'#fff':'#c0c0c0',borderRadius:'6px',fontSize:'12px',fontWeight:'600',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n=>a.currentFile=e},c(e.path),13,Sd))),128))]),a.currentFile?l((i(),o('textarea',{key:0,'onUpdate:modelValue':n[8]||(n[8]=e=>a.currentFile.content=e),style:{flex:'1',width:'100%',padding:'12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-family':'\'Consolas\', \'Monaco\', monospace','line-height':'1.6',resize:'none','min-height':'400px'},onInput:a.updatePreview},null,544)),[[p,a.currentFile.content]]):r('',!0)]),s('div',Id,[s('div',Ad,[s('div',{style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'12px'}},[n[40]||(n[40]=s('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-book',style:{color:'#4a9eff'}}),d(' 世界书条目 ')],-1)),s('button',{style:{padding:'6px 12px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:a.copyWorldbook},[...n[39]||(n[39]=[s('i',{class:'fa-solid fa-copy',style:{'margin-right':'4px'}},null,-1),d(' 复制 ',-1)])])]),s('div',zd,[s('pre',Cd,c(a.worldbookContent),1)])]),s('div',$d,[n[41]||(n[41]=s('h4',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-eye',style:{color:'#4a9eff'}}),d(' 实时预览 ')],-1)),s('div',{style:{background:'#1e1e1e','border-radius':'8px',padding:'20px','min-height':'400px',border:'1px solid #3a3a3a',overflow:'auto'},innerHTML:a.previewHtml},null,8,Ed)])])]),null!==a.showIconPickerFor?(i(),o('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[13]||(n[13]=f(e=>a.showIconPickerFor=null,['self']))},[s('div',Pd,[n[42]||(n[42]=s('h3',{style:{margin:'0 0 16px 0',color:'#fff','font-size':'15px','font-weight':'600'}},'选择图标',-1)),s('div',Md,[(i(),o(m,null,x(a.iconList,(e,t)=>s('div',{key:t,style:{padding:'14px',background:'#1e1e1e',borderRadius:'8px',cursor:'pointer',textAlign:'center',border:'1px solid #3a3a3a',transition:'all 0.2s ease',display:'flex',alignItems:'center',justifyContent:'center'},title:e,onClick:n=>a.selectIcon(e),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.background='#3a3a3a',e.currentTarget.style.borderColor='#4a9eff',e.currentTarget.style.transform='scale(1.1)',e.currentTarget.style.boxShadow='0 4px 12px rgba(74, 158, 255, 0.3)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.background='#1e1e1e',e.currentTarget.style.borderColor='#3a3a3a',e.currentTarget.style.transform='scale(1)',e.currentTarget.style.boxShadow='none'})},[s('i',{class:h(e),style:{'font-size':'20px',color:'#4a9eff'}},null,2)],40,Od)),64))]),s('div',jd,[s('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#fff','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[11]||(n[11]=e=>a.showIconPickerFor=null)},' 取消 '),s('button',{style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[12]||(n[12]=e=>{a.config.fields[a.showIconPickerFor].icon='',a.showIconPickerFor=null})},' 清除图标 ')])])])):r('',!0),a.showAI?(i(),o('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[17]||(n[17]=f(e=>a.showAI=!1,['self']))},[s('div',Dd,[n[48]||(n[48]=s('h3',{style:{margin:'0 0 16px 0',color:'#fff','font-size':'16px','font-weight':'600'}},'AI 智能编辑',-1)),s('div',Rd,[s('div',Nd,[s('div',Hd,[n[43]||(n[43]=s('i',{class:'fa-solid fa-cog',style:{color:'#60a5fa','font-size':'16px'}},null,-1)),s('div',Ld,' 字段配置（共 '+c(a.config.fields.length)+' 个） ',1)]),s('button',{style:{padding:'4px 10px',background:'rgba(16, 185, 129, 0.2)',border:'1px solid rgba(16, 185, 129, 0.4)','border-radius':'4px',color:'#10b981','font-size':'11px',cursor:'pointer'},onClick:a.addFieldInDialog},[...n[44]||(n[44]=[s('i',{class:'fa-solid fa-plus'},null,-1),d(' 添加字段 ',-1)])])]),a.config.fields.length>0?(i(),o('div',Fd,[(i(!0),o(m,null,x(a.config.fields,(e,t)=>(i(),o('div',{key:t,style:{background:'rgba(15, 23, 42, 0.6)',border:'1px solid rgba(148, 163, 184, 0.15)','border-radius':'6px',padding:'8px 10px',display:'flex','align-items':'center',gap:'8px'}},[s('span',Vd,'字段'+c(t+1)+':',1),l(s('input',{'onUpdate:modelValue':n=>e.label=n,type:'text',placeholder:'显示名称',style:{flex:'1',padding:'4px 8px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px'}},null,8,Ud),[[p,e.label]]),l(s('input',{'onUpdate:modelValue':n=>e.name=n,type:'text',placeholder:'变量名',style:{flex:'1',padding:'4px 8px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px'}},null,8,Jd),[[p,e.name]]),e.icon?(i(),o('button',{key:0,style:{padding:'4px 8px',background:'rgba(139, 92, 246, 0.2)',border:'1px solid rgba(139, 92, 246, 0.3)','border-radius':'4px',color:'#a78bfa','font-size':'11px',cursor:'pointer','min-width':'30px'},title:'移除图标',onClick:n=>e.icon=''},[s('i',{class:h(e.icon)},null,2)],8,Bd)):r('',!0),s('button',{disabled:a.config.fields.length<=1,style:g([{padding:'4px 8px',background:'rgba(239, 68, 68, 0.2)',border:'1px solid rgba(239, 68, 68, 0.3)','border-radius':'4px',color:'#ef4444','font-size':'11px',cursor:'pointer'},{opacity:a.config.fields.length<=1?.4:1,cursor:a.config.fields.length<=1?'not-allowed':'pointer'}]),title:'删除字段',onClick:e=>a.removeFieldInDialog(t)},[...n[45]||(n[45]=[s('i',{class:'fa-solid fa-trash'},null,-1)])],12,Wd)]))),128))])):(i(),o('div',Gd,'⚠️ 暂无字段，请点击"添加字段"按钮'))]),l(s('textarea',{'onUpdate:modelValue':n[14]||(n[14]=e=>a.aiPrompt=e),placeholder:'描述您想要的样式和效果，例如：\n• 保持现有样式，美化状态栏界面\n• 把背景色改成深蓝色渐变\n• 添加动画效果，让字段淡入显示\n• 使用卡片布局，每个字段独立显示\n\n⚠️ 注意：\n• AI 会基于上方配置的字段生成代码，不会改变字段数量和顺序\n• 代码会使用通用格式，可迁移到任何角色',style:{width:'100%',padding:'12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px','min-height':'120px','margin-bottom':'16px',resize:'vertical'}},null,512),[[p,a.aiPrompt]]),s('div',Yd,[s('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#fff','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[15]||(n[15]=e=>a.showAI=!1)},' 取消 '),s('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:a.generateWithAI},[...n[46]||(n[46]=[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' 生成 ',-1)])])]),a.originalAiPrompt?(i(),o('div',Zd,[s('button',{style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px','font-weight':'600',cursor:'pointer'},disabled:a.isModifyingAi,onClick:n[16]||(n[16]=e=>a.showAiModifyDialog=!0)},[n[47]||(n[47]=s('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingAi?'修改中...':'AI 修改'),1)],8,qd)])):r('',!0)])])):r('',!0),C(a.AIModifyDialog,{show:a.showAiModifyDialog,'is-modifying':a.isModifyingAi,title:'AI 修改界面代码',description:'描述你想要修改的地方，AI 会在当前代码的基础上进行调整。',examples:['把背景色改成深蓝色渐变','添加动画效果，让字段淡入显示','使用卡片布局，每个字段独立显示','增加悬停效果'],onClose:n[18]||(n[18]=e=>a.showAiModifyDialog=!1),onConfirm:a.modifyWithAI},null,8,['show','is-modifying']),a.showXmlDialog?(i(),o('div',{key:2,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[22]||(n[22]=f(e=>a.showXmlDialog=!1,['self']))},[s('div',Xd,[n[52]||(n[52]=u('<h3 style="margin:0 0 16px 0;color:#f59e0b;font-size:18px;font-weight:600;" data-v-584dacc9><i class="fa-solid fa-robot" style="margin-right:8px;" data-v-584dacc9></i> AI 解析 XML 生成字段 </h3><div style="background:rgba(251, 191, 36, 0.1);border:1px solid rgba(251, 191, 36, 0.3);border-radius:6px;padding:12px;margin-bottom:16px;" data-v-584dacc9><p style="margin:0;color:#fbbf24;font-size:12px;line-height:1.6;" data-v-584dacc9><i class="fa-solid fa-circle-info" style="margin-right:6px;" data-v-584dacc9></i><strong data-v-584dacc9>温馨提示：</strong>此功能需要调用 AI，请确保已在右上角 <i class="fa-solid fa-cog" data-v-584dacc9></i> 设置中配置了有效的 API 密钥。 </p></div>',2)),s('div',Kd,[n[49]||(n[49]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'13px'}},' 粘贴 XML 状态栏代码： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[19]||(n[19]=e=>a.xmlInput=e),placeholder:'例如：\n<state_bar>\n<i>【内容】</i>\n<日期>【当前日期】</日期>\n<角色生理状态>【描述角色当前生理状态】</角色生理状态>\n</state_bar>',style:{width:'100%','min-height':'200px',padding:'12px',background:'#1a1a1a',border:'1px solid #404040','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'13px',resize:'vertical'}},null,512),[[p,a.xmlInput]])]),s('div',Qd,[s('button',{style:{padding:'10px 20px',background:'#404040',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer'},onClick:n[20]||(n[20]=e=>a.showXmlDialog=!1)},' 取消 '),s('button',{style:{padding:'10px 20px',background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer','margin-right':'10px'},disabled:!a.xmlInput.trim()||a.isParsingXml,onClick:a.parseXmlWithAI},[n[50]||(n[50]=s('i',{class:'fa-solid fa-robot',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isParsingXml?'AI 解析中...':'开始解析'),1)],8,ec),a.originalXmlInput?(i(),o('button',{key:0,style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px',cursor:'pointer'},disabled:a.isModifyingXml,onClick:n[21]||(n[21]=e=>a.showXmlModifyDialog=!0)},[n[51]||(n[51]=s('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingXml?'修改中...':'AI 修改'),1)],8,nc)):r('',!0)])])])):r('',!0),C(a.AIModifyDialog,{show:a.showXmlModifyDialog,'is-modifying':a.isModifyingXml,title:'AI 修改 XML 解析',description:'描述你想要修改的字段，AI 会在当前解析结果的基础上进行调整。',examples:['添加一个【身高】字段','删除【年龄】字段','把【位置】改成【所在地点】','增加3个用于描述外貌的字段'],onClose:n[23]||(n[23]=e=>a.showXmlModifyDialog=!1),onConfirm:a.modifyXmlWithAI},null,8,['show','is-modifying']),a.showAiFieldDialog?(i(),o('div',{key:3,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[27]||(n[27]=f(e=>a.showAiFieldDialog=!1,['self']))},[s('div',tc,[n[56]||(n[56]=u('<h3 style="margin:0 0 16px 0;color:#10b981;font-size:18px;font-weight:600;" data-v-584dacc9><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:8px;" data-v-584dacc9></i> AI 智能生成字段 </h3><div style="background:rgba(16, 185, 129, 0.1);border:1px solid rgba(16, 185, 129, 0.3);border-radius:6px;padding:12px;margin-bottom:16px;" data-v-584dacc9><p style="margin:0;color:#10b981;font-size:12px;line-height:1.6;" data-v-584dacc9><i class="fa-solid fa-lightbulb" style="margin-right:6px;" data-v-584dacc9></i><strong data-v-584dacc9>使用说明：</strong>用自然语言描述你想要的状态栏，AI 会自动帮你生成字段配置！ </p></div>',2)),s('div',ac,[n[53]||(n[53]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'13px'}},' 描述你想要的状态栏： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[24]||(n[24]=e=>a.aiFieldDescription=e),placeholder:'例如：\n帮我生成一个修仙游戏的状态栏，包含以下字段：\n- 角色姓名\n- 修炼境界\n- 灵力值\n- 当前功法\n- 所在位置\n- 角色状态（如受伤、中毒等）\n- 好感度',style:{width:'100%','min-height':'180px',padding:'12px',background:'#1a1a1a',border:'1px solid #404040','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.6'}},null,512),[[p,a.aiFieldDescription]])]),s('div',oc,[s('button',{style:{padding:'10px 20px',background:'#404040',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer'},onClick:n[25]||(n[25]=e=>a.showAiFieldDialog=!1)},' 取消 '),s('button',{style:{padding:'10px 20px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer','margin-right':'10px'},disabled:!a.aiFieldDescription.trim()||a.isGeneratingFields,onClick:a.generateFieldsWithAI},[n[54]||(n[54]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isGeneratingFields?'AI 生成中...':'开始生成'),1)],8,rc),a.originalFieldDescription?(i(),o('button',{key:0,style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px',cursor:'pointer'},disabled:a.isModifyingField,onClick:n[26]||(n[26]=e=>a.showFieldModifyDialog=!0)},[n[55]||(n[55]=s('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingField?'修改中...':'AI 修改'),1)],8,ic)):r('',!0)])])])):r('',!0),C(a.AIModifyDialog,{show:a.showFieldModifyDialog,'is-modifying':a.isModifyingField,title:'AI 修改字段配置',description:'描述你想要修改的字段，AI 会在当前字段配置的基础上进行调整。',examples:['添加一个【身高】字段','删除第3个字段','把【好感度】改成【亲密度】','增加2个用于描述状态的字段'],onClose:n[28]||(n[28]=e=>a.showFieldModifyDialog=!1),onConfirm:a.modifyFieldWithAI},null,8,['show','is-modifying']),C(a.ProgressDialog,{ref:'progressDialogRef',show:a.showProgress,title:'AI 正在处理'},null,8,['show'])])}],['__scopeId','data-v-584dacc9'],['__file','StatusBarGenerator.vue']]),lc=e({__name:'SummaryTab',setup(e,{expose:t}){t();const a=F(),o=n([]),r=n(new Map),i=()=>{try{o.value=a.getSummaryHistory(),console.log('已刷新总结历史，当前聊天记录数:',o.value.length)}catch(e){console.error('刷新总结历史失败:',e),o.value=[]}},s=async(e,n='内容已复制到剪贴板')=>{console.log('开始复制，文本长度:',e.length);try{if(window.parent&&window.parent!==window){console.log('检测到iframe环境，尝试在父窗口复制');if(await l(e))return console.log('父窗口复制成功'),void window.toastr.success(n)}if(navigator.clipboard&&window.isSecureContext){console.log('使用现代 Clipboard API');try{return await navigator.clipboard.writeText(e),console.log('Clipboard API 复制成功'),void window.toastr.success(n)}catch(t){console.warn('Clipboard API 失败:',t)}}console.log('使用 execCommand 方法');if(await d(e))return console.log('execCommand 复制成功'),void window.toastr.success(n);console.log('所有自动复制方法都失败，显示手动复制界面'),c(e)}catch(a){console.error('复制异常:',a),c(e)}},l=async e=>new Promise(n=>{try{const t=window.parent.document,a=window.parent.document.body,o=t.createElement('textarea');o.value=e,o.style.cssText='\n        position: fixed;\n        left: -9999px;\n        top: -9999px;\n        opacity: 0;\n        pointer-events: none;\n        z-index: -1000;\n      ',o.setAttribute('readonly',''),a.appendChild(o),o.focus(),o.select(),o.setSelectionRange(0,e.length);const r=t.execCommand('copy');a.removeChild(o),n(r)}catch(t){console.error('父窗口复制失败:',t),n(!1)}}),d=async e=>new Promise(n=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='-9999px',t.style.opacity='0',t.style.pointerEvents='none',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const a=document.execCommand('copy');document.body.removeChild(t),n(a)}catch(t){console.error('execCommand 复制失败:',t),n(!1)}}),c=e=>{console.log('显示手动复制对话框，文本长度:',e.length);try{const n=window.parent.document,t=window.parent.document.body,a=n.getElementById('manual-copy-overlay');a&&t.removeChild(a);const o=n.createElement('div');o.id='manual-copy-overlay',o.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const r=n.createElement('div');r.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 900px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const i=n.createElement('div');i.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #4a9eff; text-align: center; font-size: 18px; font-weight: 600;">\n        📋 手动复制总结内容\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>操作步骤：</strong>\n        </p>\n        <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>点击下方文本框</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+A</kbd> 全选文本</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+C</kbd> 复制到剪贴板</li>\n          <li>点击"关闭"按钮或按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Esc</kbd> 关闭对话框</li>\n        </ol>\n      </div>\n    ';const s=n.createElement('textarea');s.value=e,s.style.cssText='\n      width: 100%;\n      height: 400px;\n      background: #1a1a1a;\n      border: 2px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      color: #e0e0e0;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 13px;\n      line-height: 1.5;\n      resize: vertical;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      outline: none;\n      margin-bottom: 20px;\n      box-sizing: border-box;\n    ';const l=n.createElement('div');l.style.cssText='\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n      align-items: center;\n    ';const d=n.createElement('button');d.textContent='关闭',d.style.cssText='\n      background: #4a9eff;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',d.onmouseover=()=>{d.style.background='#5ba8ff'},d.onmouseout=()=>{d.style.background='#4a9eff'};const c=n.createElement('button');c.textContent='尝试自动复制',c.style.cssText='\n      background: #28a745;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',c.onmouseover=()=>{c.style.background='#218838'},c.onmouseout=()=>{c.style.background='#28a745'},l.appendChild(c),l.appendChild(d),r.appendChild(i),r.appendChild(s),r.appendChild(l),o.appendChild(r),t.appendChild(o),d.onclick=()=>{console.log('关闭按钮被点击'),t.removeChild(o)},c.onclick=async()=>{console.log('尝试自动复制按钮被点击');try{s.focus(),s.select();document.execCommand('copy')?(window.toastr.success('自动复制成功！'),t.removeChild(o)):window.toastr.warning('自动复制失败，请手动复制')}catch(e){console.error('自动复制失败:',e),window.toastr.warning('自动复制失败，请手动复制')}},o.onclick=e=>{e.target===o&&(console.log('点击背景关闭'),t.removeChild(o))};const p=e=>{'Escape'===e.key&&(console.log('按ESC键关闭'),t.removeChild(o),n.removeEventListener('keydown',p))};n.addEventListener('keydown',p),setTimeout(()=>{console.log('自动选中文本'),s.focus(),s.select()},200),window.toastr.info('手动复制对话框已打开，请按照提示操作')}catch(n){console.error('创建手动复制对话框失败:',n),window.toastr.error('无法显示复制对话框，请检查浏览器权限')}},p=async e=>new Promise(n=>{const t=$(`\n      <div style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        padding: 20px;\n        z-index: 1000000;\n        min-width: 300px;\n      ">\n        <h3 style="margin: 0 0 15px 0; color: #e0e0e0;">选择世界书</h3>\n        <div style="margin-bottom: 15px;">\n          ${e.map(e=>`\n            <label style="display: block; margin: 5px 0; color: #e0e0e0;">\n              <input type="radio" name="worldbook" value="${e}" style="margin-right: 8px;">\n              ${e}\n            </label>\n          `).join('')}\n        </div>\n        <div style="text-align: right;">\n          <button id="cancelWorldbook" style="\n            background: #666;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            margin-right: 10px;\n            cursor: pointer;\n          ">取消</button>\n          <button id="confirmWorldbook" style="\n            background: #4a9eff;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            cursor: pointer;\n          ">确定</button>\n        </div>\n      </div>\n    `),a=$('\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 999999;\n      "></div>\n    ');$('body').append(a).append(t),$('#cancelWorldbook').on('click',()=>{a.remove(),t.remove(),n(null)}),$('#confirmWorldbook').on('click',()=>{const e=$('input[name="worldbook"]:checked').val();a.remove(),t.remove(),n(e||null)}),$('input[name="worldbook"]:first').prop('checked',!0)});i();const u={historyStore:a,summary_history:o,expandedState:r,refreshSummaryHistory:i,toggleExpanded:e=>{const n=r.value.get(e)||!1;r.value.set(e,!n)},isExpanded:e=>r.value.get(e)||!1,handleRefreshData:async()=>{console.log('刷新数据按钮被点击');try{await i(),window.toastr.success('数据已刷新')}catch(e){console.error('刷新数据失败:',e),window.toastr.error('刷新数据失败: '+e.message)}},copyToClipboard:s,tryParentWindowCopy:l,execCommandCopy:d,showManualCopyDialog:c,copySummary:e=>{s(e,'总结已复制到剪贴板')},deleteSummary:e=>{if(confirm('确定要删除这条总结吗？'))try{const n=R();if(!n)return void window.toastr.error('无法获取当前聊天信息');o.value.splice(e,1);const t=`${getScriptIdSafe()}_summary_history_${n}`;localStorage.setItem(t,JSON.stringify(o.value)),console.log('✅ 总结已删除并保存到 localStorage'),window.toastr.success('总结已删除')}catch(n){console.error('删除总结失败:',n),window.toastr.error('删除总结失败')}},createSummaryWorldbook:async()=>{try{let t='未知角色';try{const e=getCharData('current');e&&e.name&&(t=e.name,t=t.replace(/[<>:"/\\|?*]/g,'_').trim())}catch(e){console.warn('获取角色信息失败:',e)}const a=`总结_${t}_${(new Date).toISOString().slice(0,10)}`;console.log('准备创建世界书:',a);if(getWorldbookNames().includes(a))return void window.toastr.warning(`世界书 "${a}" 已存在`);await createWorldbook(a,[]);try{await rebindChatWorldbook('current',a),window.toastr.success(`已创建总结世界书 "${a}" 并绑定到当前聊天`)}catch(n){console.warn('绑定到聊天失败:',n),window.toastr.success(`已创建总结世界书 "${a}"，请手动在聊天知识书中绑定`)}}catch(t){console.error('创建总结世界书失败:',t),window.toastr.error('创建总结世界书失败: '+t.message)}},bindToWorldbook:async(e,n)=>{try{const t=getWorldbookNames();if(0===t.length)return void window.toastr.warning('没有可用的世界书，请先创建总结世界书');const a=1===t.length?t[0]:await p(t);if(!a)return;const r={name:`总结_${n+1}_${(new Date).toLocaleDateString()}`,enabled:!0,strategy:{type:'constant',keys:[],keys_secondary:{logic:'and_any',keys:[]},scan_depth:'same_as_global'},position:{type:'before_character_definition',role:'system',depth:1},content:e,comment:`自动生成的总结条目 - 楼层范围: ${o.value[n]?.start_id||'?'} - ${o.value[n]?.end_id||'?'}`,insertion_order:0,case_sensitive:!1,name_is_regex:!1,keys_are_regex:!1,selective_logic:'and',secondary_keys_logic:'and',activation_threshold:0,disabled:!1,order:0,group:'',local_id:0,depth_entries:[],depth_entries_all:!1,search_range:0,force_activation:!1,disable:!1,exclude_recursion:!1,hidden:!1,priority:0,comment_is_regex:!1,content_is_regex:!1,secondary_keys_are_regex:!1,keys_secondary_are_regex:!1,uid:Date.now()};await createWorldbookEntries(a,[r]),window.toastr.success(`总结已绑定到世界书: ${a}`)}catch(t){console.error('绑定到世界书失败:',t),window.toastr.error('绑定到世界书失败: '+t.message)}},promptForWorldbook:p,showDebugPanel:()=>{try{const e=window.parent.document,n=window.parent.document.body,t=e.getElementById('debug-panel-overlay');t&&n.removeChild(t);const a=e.createElement('div');a.id='debug-panel-overlay',a.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const o=e.createElement('div');o.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #ffc107;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 800px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const r=e.createElement('div');r.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #ffc107; text-align: center; font-size: 18px; font-weight: 600;">\n        🐛 自动总结调试工具\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>调试功能：</strong>\n        </p>\n        <ul style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>测试自动总结流程</li>\n          <li>同步localStorage数据到酒馆助手变量</li>\n          <li>检查当前楼层状态</li>\n          <li>验证触发条件计算</li>\n        </ul>\n      </div>\n    ';const i=e.createElement('div');i.style.cssText='\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 12px;\n      margin-bottom: 20px;\n    ';[{id:'testComplete',text:'🧪 测试完整流程',color:'#4a9eff'},{id:'syncData',text:'🔄 同步数据',color:'#28a745'},{id:'checkFloor',text:'🔍 检查楼层',color:'#17a2b8'},{id:'testCalculation',text:'🧮 验证计算',color:'#6f42c1'},{id:'showStatus',text:'📊 显示状态',color:'#fd7e14'},{id:'resetStartId',text:'🔄 重置起始楼层',color:'#dc3545'}].forEach(n=>{const t=e.createElement('button');t.id=n.id,t.textContent=n.text,t.style.cssText=`\n        background: ${n.color};\n        color: white;\n        border: none;\n        padding: 12px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 13px;\n        font-weight: 500;\n        transition: background 0.2s;\n      `,t.onmouseover=()=>{t.style.opacity='0.8'},t.onmouseout=()=>{t.style.opacity='1'},i.appendChild(t)});const s=e.createElement('div');s.id='debug-output',s.style.cssText='\n      background: #1a1a1a;\n      border: 1px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      height: 200px;\n      overflow-y: auto;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 12px;\n      color: #e0e0e0;\n      white-space: pre-wrap;\n      margin-bottom: 20px;\n    ',s.textContent='点击上方按钮开始调试...\n';const l=e.createElement('button');l.textContent='关闭',l.style.cssText='\n      background: #6c757d;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n      align-self: center;\n    ',o.appendChild(r),o.appendChild(i),o.appendChild(s),o.appendChild(l),a.appendChild(o),n.appendChild(a);const d=n=>{const t=e.getElementById('debug-output');t&&(t.textContent+=n+'\n',t.scrollTop=t.scrollHeight)};l.onclick=()=>{n.removeChild(a)},e.getElementById('testComplete')?.addEventListener('click',()=>{d('🧪 开始测试完整自动总结流程...');try{window.testCompleteAutoSummary?(window.testCompleteAutoSummary(),d('✅ 测试函数已执行，请查看控制台输出')):d('❌ 测试函数不可用')}catch(e){d('❌ 测试失败: '+e.message)}}),e.getElementById('syncData')?.addEventListener('click',()=>{d('🔄 开始同步数据...');try{window.syncAutoSummaryData?(window.syncAutoSummaryData(),d('✅ 同步函数已执行，请查看控制台输出')):d('❌ 同步函数不可用')}catch(e){d('❌ 同步失败: '+e.message)}}),e.getElementById('checkFloor')?.addEventListener('click',()=>{d('🔍 开始检查楼层...');try{window.checkCurrentFloor?(window.checkCurrentFloor(),d('✅ 楼层检查函数已执行，请查看控制台输出')):d('❌ 楼层检查函数不可用')}catch(e){d('❌ 楼层检查失败: '+e.message)}}),e.getElementById('testCalculation')?.addEventListener('click',()=>{d('🧮 开始验证计算...');try{window.testFloorCalculation?(window.testFloorCalculation(),d('✅ 计算验证函数已执行，请查看控制台输出')):d('❌ 计算验证函数不可用')}catch(e){d('❌ 计算验证失败: '+e.message)}}),e.getElementById('showStatus')?.addEventListener('click',()=>{d('📊 开始显示状态...');try{window.checkAutoSummaryStatus?(window.checkAutoSummaryStatus(),d('✅ 状态检查函数已执行，请查看控制台输出')):d('❌ 状态检查函数不可用')}catch(e){d('❌ 状态检查失败: '+e.message)}}),e.getElementById('resetStartId')?.addEventListener('click',()=>{d('🔄 开始重置起始楼层...');try{window.smartResetChat?(window.smartResetChat(),d('✅ 重置函数已执行，请查看控制台输出')):d('❌ 重置函数不可用')}catch(e){d('❌ 重置失败: '+e.message)}}),a.onclick=e=>{e.target===a&&n.removeChild(a)};const c=t=>{'Escape'===t.key&&(n.removeChild(a),e.removeEventListener('keydown',c))};e.addEventListener('keydown',c),window.toastr?.info('调试面板已打开')}catch(e){console.error('创建调试面板失败:',e),window.toastr?.error('无法显示调试面板，请检查浏览器权限')}}};return Object.defineProperty(u,'__isScriptSetup',{enumerable:!1,value:!0}),u}}),dc={class:'summary-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},cc={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},pc={class:'header-actions',style:{display:'flex','align-items':'center',gap:'10px'}},uc={key:0,class:'count-badge',style:{background:'#4a9eff',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},gc={key:0,class:'history-list',style:{display:'flex','flex-direction':'column',gap:'15px','margin-top':'20px'}},fc=['onClick'],mc={class:'history-info',style:{display:'flex','align-items':'center',gap:'10px',flex:'1'}},xc={class:'history-number',style:{color:'#4a9eff','font-weight':'bold'}},hc={class:'history-range',style:{color:'#888','font-size':'12px'}},bc={class:'expand-icon',style:{color:'#888','font-size':'12px'}},yc={key:0,class:'history-content',style:{padding:'15px',background:'#2a2a2a','border-radius':'0 0 6px 6px'}},vc={class:'history-actions',style:{display:'flex',gap:'8px','margin-bottom':'12px','padding-bottom':'8px','border-bottom':'1px solid #3a3a3a'}},wc=['onClick'],kc=['onClick'],_c=['onClick'],Tc={class:'history-text',style:{'font-family':'\'Courier New\', monospace','font-size':'13px','line-height':'1.6',color:'#e0e0e0','white-space':'pre-wrap','word-wrap':'break-word','user-select':'text',cursor:'text'}},Sc={key:1,class:'empty-state',style:{'text-align':'center',padding:'40px 20px',color:'#888'}};const Ic=a(lc,[['render',function(e,n,t,a,l,p){return i(),o('div',dc,[s('div',cc,[n[3]||(n[3]=s('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},' 📝 历史总结记录 ',-1)),s('div',pc,[a.summary_history.length>0?(i(),o('span',uc,c(a.summary_history.length)+' 条记录',1)):r('',!0),s('button',{class:'mini-button refresh-button',style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:a.handleRefreshData},[...n[0]||(n[0]=[s('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新数据 ',-1)])]),s('button',{class:'mini-button create-worldbook-button',style:{padding:'6px 12px',background:'#51cf66',border:'1px solid #40c057','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:a.createSummaryWorldbook},[...n[1]||(n[1]=[s('i',{class:'fa-solid fa-plus'},null,-1),d(' 创建总结世界书 ',-1)])]),s('button',{class:'mini-button debug-button',style:{padding:'6px 12px',background:'#ffc107',border:'1px solid #ffb300','border-radius':'4px',color:'#000',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:a.showDebugPanel},[...n[2]||(n[2]=[s('i',{class:'fa-solid fa-bug'},null,-1),d(' 调试工具 ',-1)])])])]),a.summary_history&&a.summary_history.length>0?(i(),o('div',gc,[(i(!0),o(m,null,x(a.summary_history,(e,t)=>(i(),o('div',{key:t,class:'history-item',style:{background:'#2a2a2a',border:'1px solid #444','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[s('div',{class:'history-header',style:{padding:'12px 15px',background:'#1a1a1a',display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','user-select':'none',transition:'background 0.2s','border-radius':'6px'},onClick:e=>a.toggleExpanded(t)},[s('div',mc,[s('span',xc,'#'+c(t+1),1),s('span',hc,'楼层 '+c(e.start_id)+' - '+c(e.end_id),1)]),s('span',bc,c(a.isExpanded(t)?'▼':'▶'),1)],8,fc),a.isExpanded(t)?(i(),o('div',yc,[s('div',vc,[s('button',{class:'mini-button',style:{flex:'1',padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'background 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:n=>a.copySummary(e.content)},[...n[4]||(n[4]=[s('i',{class:'fa-solid fa-copy'},null,-1),d(' 复制 ',-1)])],8,wc),s('button',{class:'mini-button worldbook-button',style:{flex:'1',padding:'6px 12px',background:'#4a9eff',border:'1px solid #5aaeff','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:n=>a.bindToWorldbook(e.content,t)},[...n[5]||(n[5]=[s('i',{class:'fa-solid fa-book'},null,-1),d(' 绑定到世界书 ',-1)])],8,kc),s('button',{class:'mini-button delete-button',style:{flex:'1',padding:'6px 12px',background:'#ff6b6b',border:'1px solid #ff5252','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:e=>a.deleteSummary(t)},[...n[6]||(n[6]=[s('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])],8,_c)]),s('div',Tc,c(e.content),1)])):r('',!0)]))),128))])):(i(),o('div',Sc,[...n[7]||(n[7]=[s('i',{class:'fa-solid fa-inbox',style:{'font-size':'48px','margin-bottom':'10px',opacity:'0.3'}},null,-1),s('p',{style:{margin:'10px 0','font-size':'16px'}},'还没有总结记录',-1),s('small',{style:{'font-size':'12px',color:'#666'}},'使用"设置"标签页手动创建总结',-1)])]))])}],['__scopeId','data-v-a83452cc'],['__file','SummaryTab.vue']]),Ac=e({__name:'TableTab',setup(e,{expose:t}){t();const a=n([]),o=n(new Map),r=()=>{try{const e=R();if(!e)return console.warn('无法获取聊天ID，清空表格历史'),void(a.value=[]);const n=`${getScriptIdSafe()}_table_history_${e}`,t=localStorage.getItem(n);console.log('从 localStorage 读取表格历史，key:',n),a.value=t?JSON.parse(t):[],console.log('已刷新表格历史，当前聊天表格数:',a.value.length)}catch(e){console.error('刷新表格历史失败:',e),a.value=[]}},i=async(e,n='内容已复制到剪贴板')=>{console.log('开始复制，文本长度:',e.length);try{if(window.parent&&window.parent!==window){console.log('检测到iframe环境，尝试在父窗口复制');if(await s(e))return console.log('父窗口复制成功'),void window.toastr.success(n)}if(navigator.clipboard&&window.isSecureContext){console.log('使用现代 Clipboard API');try{return await navigator.clipboard.writeText(e),console.log('Clipboard API 复制成功'),void window.toastr.success(n)}catch(t){console.warn('Clipboard API 失败:',t)}}console.log('使用 execCommand 方法');if(await l(e))return console.log('execCommand 复制成功'),void window.toastr.success(n);console.log('所有自动复制方法都失败，显示手动复制界面'),d(e)}catch(a){console.error('复制异常:',a),d(e)}},s=async e=>new Promise(n=>{try{const t=window.parent.document,a=window.parent.document.body,o=t.createElement('textarea');o.value=e,o.style.cssText='\n        position: fixed;\n        left: -9999px;\n        top: -9999px;\n        opacity: 0;\n        pointer-events: none;\n        z-index: -1000;\n      ',o.setAttribute('readonly',''),a.appendChild(o),o.focus(),o.select(),o.setSelectionRange(0,e.length);const r=t.execCommand('copy');a.removeChild(o),n(r)}catch(t){console.error('父窗口复制失败:',t),n(!1)}}),l=async e=>new Promise(n=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='-9999px',t.style.opacity='0',t.style.pointerEvents='none',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const a=document.execCommand('copy');document.body.removeChild(t),n(a)}catch(t){console.error('execCommand 复制失败:',t),n(!1)}}),d=e=>{console.log('显示手动复制对话框，文本长度:',e.length);try{const n=window.parent.document,t=window.parent.document.body,a=n.getElementById('manual-copy-overlay');a&&t.removeChild(a);const o=n.createElement('div');o.id='manual-copy-overlay',o.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const r=n.createElement('div');r.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 900px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const i=n.createElement('div');i.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #4a9eff; text-align: center; font-size: 18px; font-weight: 600;">\n        📋 手动复制表格内容\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>操作步骤：</strong>\n        </p>\n        <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>点击下方文本框</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+A</kbd> 全选文本</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+C</kbd> 复制到剪贴板</li>\n          <li>点击"关闭"按钮或按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Esc</kbd> 关闭对话框</li>\n        </ol>\n      </div>\n    ';const s=n.createElement('textarea');s.value=e,s.style.cssText='\n      width: 100%;\n      height: 400px;\n      background: #1a1a1a;\n      border: 2px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      color: #e0e0e0;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 13px;\n      line-height: 1.5;\n      resize: vertical;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      outline: none;\n      margin-bottom: 20px;\n      box-sizing: border-box;\n    ';const l=n.createElement('div');l.style.cssText='\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n      align-items: center;\n    ';const d=n.createElement('button');d.textContent='关闭',d.style.cssText='\n      background: #4a9eff;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',d.onmouseover=()=>{d.style.background='#5ba8ff'},d.onmouseout=()=>{d.style.background='#4a9eff'};const c=n.createElement('button');c.textContent='尝试自动复制',c.style.cssText='\n      background: #28a745;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',c.onmouseover=()=>{c.style.background='#218838'},c.onmouseout=()=>{c.style.background='#28a745'},l.appendChild(c),l.appendChild(d),r.appendChild(i),r.appendChild(s),r.appendChild(l),o.appendChild(r),t.appendChild(o),d.onclick=()=>{console.log('关闭按钮被点击'),t.removeChild(o)},c.onclick=async()=>{console.log('尝试自动复制按钮被点击');try{s.focus(),s.select();document.execCommand('copy')?(window.toastr.success('自动复制成功！'),t.removeChild(o)):window.toastr.warning('自动复制失败，请手动复制')}catch(e){console.error('自动复制失败:',e),window.toastr.warning('自动复制失败，请手动复制')}},o.onclick=e=>{e.target===o&&(console.log('点击背景关闭'),t.removeChild(o))};const p=e=>{'Escape'===e.key&&(console.log('按ESC键关闭'),t.removeChild(o),n.removeEventListener('keydown',p))};n.addEventListener('keydown',p),setTimeout(()=>{console.log('自动选中文本'),s.focus(),s.select()},200),window.toastr.info('手动复制对话框已打开，请按照提示操作')}catch(n){console.error('创建手动复制对话框失败:',n),window.toastr.error('无法显示复制对话框，请检查浏览器权限')}};r();const c={table_history:a,tableExpandedState:o,refreshTableHistory:r,toggleTableExpanded:e=>{const n=o.value.get(e)||!1;o.value.set(e,!n)},isTableExpanded:e=>o.value.get(e)||!1,copyToClipboard:i,tryParentWindowCopy:s,execCommandCopy:l,showManualCopyDialog:d,copyTable:e=>{try{const n=[e.headers.join('\t'),...e.data.map(e=>e.join('\t'))].join('\n');i(n,'表格已复制到剪贴板')}catch(n){console.error('复制表格失败:',n),window.toastr.error('复制失败，请手动复制')}},deleteTable:e=>{if(confirm('确定要删除这个表格吗？')){a.value.splice(e,1);const n=R();if(n){const e=`${getScriptIdSafe()}_table_history_${n}`;localStorage.setItem(e,JSON.stringify(a.value)),window.toastr.success('表格已删除')}}}};return Object.defineProperty(c,'__isScriptSetup',{enumerable:!1,value:!0}),c}}),zc={class:'table-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},Cc={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},$c={key:0,class:'count-badge',style:{background:'#4a9eff',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},Ec={key:0,class:'history-list',style:{display:'flex','flex-direction':'column',gap:'15px','margin-top':'20px'}},Pc=['onClick'],Mc={class:'history-info',style:{display:'flex','align-items':'center',gap:'10px',flex:'1'}},Oc={class:'history-number',style:{color:'#4a9eff','font-weight':'bold'}},jc={class:'history-range',style:{color:'#888','font-size':'12px'}},Dc={class:'expand-icon',style:{color:'#888','font-size':'12px'}},Rc={key:0,class:'history-content',style:{padding:'15px',background:'#2a2a2a','border-radius':'0 0 6px 6px'}},Nc={class:'history-actions',style:{display:'flex',gap:'10px','margin-bottom':'12px','padding-bottom':'8px','border-bottom':'1px solid #3a3a3a','flex-wrap':'wrap'}},Hc=['onClick'],Lc=['onClick'],Fc={class:'table-display',style:{'overflow-x':'auto','border-radius':'6px',border:'1px solid #3a3a3a'}},Vc={style:{width:'100%','border-collapse':'collapse',background:'#1a1a1a'}},Uc={style:{background:'#2a2a2a'}},Jc={key:1,class:'empty-state',style:{'text-align':'center',padding:'40px 20px',color:'#888'}};const Bc=a(Ac,[['render',function(e,n,t,a,l,p){return i(),o('div',zc,[s('div',Cc,[n[0]||(n[0]=s('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},' 📊 表格分析 ',-1)),a.table_history.length>0?(i(),o('span',$c,c(a.table_history.length)+' 条记录',1)):r('',!0)]),a.table_history&&a.table_history.length>0?(i(),o('div',Ec,[(i(!0),o(m,null,x(a.table_history,(e,t)=>(i(),o('div',{key:t,class:'history-item',style:{background:'#2a2a2a',border:'1px solid #444','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[s('div',{class:'history-header',style:{padding:'12px 15px',background:'#1a1a1a',display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','user-select':'none',transition:'background 0.2s','border-radius':'6px'},onClick:e=>a.toggleTableExpanded(t)},[s('div',Mc,[s('span',Oc,'#'+c(t+1),1),s('span',jc,'楼层 '+c(e.start_id)+' - '+c(e.end_id),1)]),s('span',Dc,c(a.isTableExpanded(t)?'▼':'▶'),1)],8,Pc),a.isTableExpanded(t)?(i(),o('div',Rc,[s('div',Nc,[s('button',{class:'copy-button',style:{padding:'8px 16px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'6px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:n=>a.copyTable(e)},[...n[1]||(n[1]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-copy',style:{'font-size':'12px'}},null,-1),d(' 复制 ',-1)])],8,Hc),s('button',{class:'delete-button',style:{padding:'8px 16px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'6px','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:e=>a.deleteTable(t)},[...n[2]||(n[2]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-trash',style:{'font-size':'12px'}},null,-1),d(' 删除 ',-1)])],8,Lc)]),s('div',Fc,[s('table',Vc,[s('thead',Uc,[s('tr',null,[(i(!0),o(m,null,x(e.headers,(e,n)=>(i(),o('th',{key:n,style:{padding:'12px 16px','text-align':'left','font-weight':'bold',color:'#fff','border-bottom':'2px solid #3a3a3a','border-right':'1px solid #3a3a3a'}},c(e),1))),128))])]),s('tbody',null,[(i(!0),o(m,null,x(e.data,(e,n)=>(i(),o('tr',{key:n,style:{'border-bottom':'1px solid #3a3a3a'}},[(i(!0),o(m,null,x(e,(e,n)=>(i(),o('td',{key:n,style:{padding:'10px 16px',color:'#e0e0e0','border-right':'1px solid #3a3a3a'}},c(e),1))),128))]))),128))])])])])):r('',!0)]))),128))])):(i(),o('div',Jc,[...n[3]||(n[3]=[s('i',{class:'fa-solid fa-table',style:{'font-size':'48px','margin-bottom':'10px',opacity:'0.3'}},null,-1),s('p',{style:{margin:'10px 0','font-size':'16px'}},'还没有表格记录',-1),s('small',{style:{'font-size':'12px',color:'#666'}},'使用"设置"标签页手动生成表格',-1)])]))])}],['__scopeId','data-v-642c0020'],['__file','TableTab.vue']]);var Wc,Gc;var Yc=Gc?Wc:(Gc=1,Wc=_);const Zc={class:'tools-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},qc={class:'tool-section'},Xc={key:0,class:'tool-content'},Kc={class:'form-group',style:{margin:'15px 0'}},Qc={class:'form-group',style:{margin:'15px 0'}},ep={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},np={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},tp={class:'progress-bar',style:{width:'100%',height:'8px',background:'#2a2a2a','border-radius':'4px',overflow:'hidden',position:'relative'}},ap={style:{'text-align':'center','margin-top':'8px',color:'#667eea','font-size':'12px','font-weight':'500'}},op={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},rp=['disabled'],ip={key:1,class:'output-section'},sp={class:'output-content',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px',color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','max-height':'300px','overflow-y':'auto'}},lp={style:{'margin-top':'20px','padding-top':'20px','border-top':'1px solid #3a3a3a'}},dp={class:'form-group',style:{'margin-bottom':'12px'}},cp={style:{display:'flex',gap:'10px'}},pp=['disabled'],up=['disabled'],gp={class:'tool-section'},fp={key:0,class:'tool-content'},mp={class:'form-group',style:{margin:'15px 0'}},xp={class:'form-group',style:{margin:'15px 0'}},hp={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},bp={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},yp={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(255, 193, 7, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},vp={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},wp={style:{color:'#ffc107','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #ffc107 0%, #ff9800 50%, #ffc107 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},kp={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},_p=['disabled'],Tp={key:1,class:'output-section'},Sp={class:'entry-preview',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px','margin-bottom':'15px'}},Ip={class:'entry-field',style:{'margin-bottom':'10px'}},Ap={style:{color:'#e0e0e0','font-size':'13px'}},zp={class:'entry-field',style:{'margin-bottom':'10px'}},Cp={style:{color:'#e0e0e0','font-size':'13px'}},$p={class:'entry-field',style:{'margin-bottom':'10px'}},Ep={style:{color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','max-height':'200px','overflow-y':'auto'}},Pp={class:'entry-field'},Mp={style:{color:'#e0e0e0','font-size':'13px'}},Op={class:'modify-section',style:{'margin-top':'25px','border-top':'2px dashed #3a3a3a','padding-top':'20px'}},jp={class:'form-group',style:{margin:'15px 0'}},Dp={key:0,class:'progress-bar-container',style:{margin:'12px 0'}},Rp={class:'progress-bar',style:{width:'100%',height:'8px',background:'#2a2a2a','border-radius':'4px',overflow:'hidden',position:'relative'}},Np={style:{'text-align':'center','margin-top':'8px',color:'#ffa500','font-size':'12px','font-weight':'500'}},Hp={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'15px'}},Lp=['disabled'],Fp={class:'insert-section',style:{background:'#1a1a1a',padding:'15px','border-radius':'6px','margin-top':'20px'}},Vp={class:'form-group',style:{'margin-bottom':'12px'}},Up=['value'],Jp={class:'output-actions',style:{display:'flex',gap:'12px'}},Bp=['disabled'],Wp={class:'tool-section'},Gp={key:0,class:'tool-content'},Yp={class:'form-group',style:{'margin-bottom':'20px'}},Zp=['value'],qp={key:0,class:'form-group',style:{'margin-bottom':'20px'}},Xp={key:1,style:{display:'flex',gap:'10px','margin-bottom':'15px'}},Kp={key:2,style:{'margin-bottom':'15px',color:'#888','font-size':'12px'}},Qp={key:0},eu={key:1,style:{color:'#ff6b6b'}},nu={key:3,style:{display:'flex','flex-direction':'column',gap:'12px'}},tu=['onClick'],au={style:{flex:'1','line-height':'1.6'}},ou={style:{display:'flex','align-items':'center',gap:'6px','margin-bottom':'8px'}},ru={key:0,style:{'font-size':'14px'}},iu={key:1,style:{'font-size':'14px'}},su={key:2,style:{'font-size':'14px'}},lu={style:{color:'#fff','font-weight':'600','font-size':'14px'}},du={style:{'padding-left':'20px','margin-bottom':'6px','font-size':'12px',color:'#ccc'}},cu={key:0},pu={key:1},uu={key:2},gu={key:3},fu={style:{'padding-left':'20px','font-size':'12px',color:'#999','font-style':'italic'}},mu={key:0,style:{'margin-top':'15px','padding-top':'15px','border-top':'1px solid #3a3a3a'}},xu={style:{'margin-bottom':'12px'}},hu={style:{display:'flex','align-items':'center',gap:'8px'}},bu={key:0,style:{padding:'4px 10px',background:'#4a9eff',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},yu={key:1,style:{padding:'4px 10px',background:'#28a745',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},vu={key:2,style:{padding:'4px 10px',background:'#888',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},wu={style:{'margin-bottom':'12px'}},ku={style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},_u={key:0,style:{color:'#ffa500','font-size':'10px','margin-left':'6px'}},Tu={style:{display:'flex','flex-wrap':'wrap',gap:'6px'}},Su={key:0,style:{color:'#888','font-size':'11px'}},Iu={style:{'margin-bottom':'12px'}},Au={style:{padding:'12px',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#ccc','font-size':'12px','line-height':'1.6','max-height':'200px','overflow-y':'auto','white-space':'pre-wrap'}},zu={style:{display:'flex',gap:'10px','margin-top':'12px'}},Cu=['onClick'],$u=['onClick'],Eu={style:{background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',padding:'25px','max-width':'700px',width:'90%','max-height':'85vh','overflow-y':'auto','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},Pu={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'20px'}},Mu={style:{display:'flex','flex-direction':'column',gap:'15px'}},Ou={style:{display:'flex','align-items':'center',gap:'10px'}},ju=['value'],Du=['value'],Ru=['value'],Nu={style:{display:'grid','grid-template-columns':'1fr 1fr',gap:'10px'}},Hu=['value'],Lu=['value'],Fu={style:{background:'#1a1a1a',padding:'15px','border-radius':'8px',border:'1px solid rgba(255, 255, 255, 0.1)'}},Vu={style:{display:'flex','flex-direction':'column',gap:'10px'}},Uu={style:{color:'#ccc','font-size':'13px',display:'flex','align-items':'center',gap:'10px',cursor:'pointer'}},Ju=['checked'],Bu={style:{color:'#ccc','font-size':'13px',display:'flex','align-items':'center',gap:'10px',cursor:'pointer'}},Wu=['checked'],Gu=['value'],Yu={style:{display:'flex',gap:'10px','margin-top':'20px','justify-content':'flex-end'}},Zu={class:'tool-section'},qu={key:0,class:'tool-content'},Xu={class:'form-group',style:{margin:'15px 0'}},Ku={class:'form-group',style:{margin:'15px 0'}},Qu={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},eg={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},ng={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(23, 162, 184, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},tg={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},ag={style:{color:'#17a2b8','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},og={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},rg=['disabled'],ig={key:1,class:'output-section'},sg={class:'output-content',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px',color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','max-height':'300px','overflow-y':'auto'}},lg={class:'modify-section',style:{'margin-top':'25px','border-top':'2px dashed #3a3a3a','padding-top':'20px'}},dg={class:'form-group',style:{margin:'15px 0'}},cg={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},pg={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(23, 162, 184, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},ug={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},gg={style:{color:'#17a2b8','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},fg={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'15px'}},mg=['disabled'];const xg=a(e({__name:'ToolsTab',setup(e,{expose:a}){a();const o=b(),{settings:r}=y(o),i=n(new Map),s=n(''),l=n(''),d=n(!1),c=n(!1),p=n(0),u=n(''),g=n(!1),f=n(''),m=n(''),x=n(!1),h=n(''),v=n(!1),S=n(!1),I=n(0),C=n(''),E=n(null),P=n(!1),O=n([]),j=n(''),R=n(!1),N=n(''),H=n(!1),L=n(!1),F=n(0),V=n(''),U=n([]),J=n(''),B=n('original'),W=n(new Map),G=n(!1),Y=n({}),Z=n(null),q=n(!1),X=()=>{try{void 0!==window.TavernHelper&&'function'==typeof window.TavernHelper.getWorldbookNames?(O.value=window.TavernHelper.getWorldbookNames(),console.log('✅ 已加载世界书列表 (TavernHelper):',O.value)):(O.value=[],console.warn('⚠️ TavernHelper 不可用，世界书功能受限'))}catch(e){console.error('❌ 加载世界书列表失败:',e),O.value=[]}},K=()=>{try{q.value=!1;const e=T();if(!e)return console.warn('⚠️ script_id 为空，无法加载数据'),void(q.value=!0);const n=`${e}_tools_data`,t=localStorage.getItem(n),a=t?JSON.parse(t):{};console.log('📥 加载工具数据:',a),a.tools_antiCliche&&(s.value=a.tools_antiCliche.input||'',l.value=a.tools_antiCliche.output||'',c.value=a.tools_antiCliche.enableStreaming||!1,u.value=a.tools_antiCliche.modifyRequest||'',console.log('✅ 已恢复反八股数据:',{input:s.value.substring(0,50),output:l.value.substring(0,50),enableStreaming:c.value,modifyRequest:u.value.substring(0,30)})),a.tools_characterCard&&(f.value=a.tools_characterCard.description||'',m.value=a.tools_characterCard.output||'',h.value=a.tools_characterCard.modifyRequest||'',S.value=a.tools_characterCard.enableStreaming||!1,console.log('✅ 已恢复角色卡数据:',{description:f.value.substring(0,50),output:m.value.substring(0,50),modifyRequest:h.value.substring(0,50),enableStreaming:S.value})),a.tools_worldbookEntry&&(C.value=a.tools_worldbookEntry.description||'',E.value=a.tools_worldbookEntry.output||null,j.value=a.tools_worldbookEntry.selectedWorldbook||'',N.value=a.tools_worldbookEntry.modifyRequest||'',L.value=a.tools_worldbookEntry.enableStreaming||!1,console.log('✅ 已恢复世界书条目数据:',{description:C.value.substring(0,50),output:E.value?'有输出':'无输出',selectedWorldbook:j.value,modifyRequest:N.value.substring(0,50),enableStreaming:L.value})),a.tools_expandedState&&(i.value=new Map(Object.entries(a.tools_expandedState)),console.log('✅ 已恢复展开状态:',Object.fromEntries(i.value))),a.tools_worldbookViewer&&(V.value=a.tools_worldbookViewer.selectedWorldbook||'',J.value=a.tools_worldbookViewer.searchQuery||'',B.value=a.tools_worldbookViewer.sortBy||'original',console.log('✅ 已恢复世界书查看器数据:',{selectedWorldbook:V.value,searchQuery:J.value,sortBy:B.value}),V.value&&(console.log('🔄 自动加载已选择的世界书条目...'),setTimeout(()=>{ae()},200))),setTimeout(()=>{q.value=!0,console.log('✅ 数据加载完成，启用自动保存')},100)}catch(e){console.error('❌ 加载工具数据失败:',e),q.value=!0}},Q=()=>{if(q.value)try{const e=T();if(!e)return void console.warn('⚠️ script_id 为空，无法保存数据');const n={tools_antiCliche:{input:s.value,output:l.value,enableStreaming:c.value,modifyRequest:u.value},tools_characterCard:{description:f.value,output:m.value,modifyRequest:h.value,enableStreaming:S.value},tools_worldbookEntry:{description:C.value,output:E.value,selectedWorldbook:j.value,modifyRequest:N.value,enableStreaming:L.value},tools_worldbookViewer:{selectedWorldbook:V.value,searchQuery:J.value,sortBy:B.value},tools_expandedState:Object.fromEntries(i.value)},t=`${e}_tools_data`;localStorage.setItem(t,JSON.stringify(n)),console.log('💾 工具数据已保存到 localStorage:',{antiCliche_input_length:s.value.length,antiCliche_output_length:l.value.length,character_desc_length:f.value.length,character_output_length:m.value.length})}catch(e){console.error('❌ 保存工具数据失败:',e)}else console.log('⏸️ 跳过保存：数据尚未加载完成')},ee=Yc.debounce(Q,300);t([s,l,c,u,f,m,h,S,C,E,j,N,L,V,J,B,i],()=>{q.value&&(console.log('📝 数据变化，触发保存...'),ee())},{deep:!0}),k(()=>{console.log('🔧 ToolsTab 组件已挂载，加载数据...'),K(),X()}),D(()=>{console.log('🔄 ToolsTab 组件即将卸载，保存数据...'),ee.cancel(),Q()});const ne=e=>e.choices?.[0]?.delta?.content?e.choices[0].delta.content:e.delta?.text?e.delta.text:'string'==typeof e.content?e.content:'string'==typeof e.text?e.text:'string'==typeof e.response?e.response:null,te=async(e,n)=>{const t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(e)});if(!a.ok){const e=await a.text();throw new Error(`流式请求失败：${a.status} ${a.statusText}\n${e.slice(0,400)}`)}if(!a.body)throw new Error('该 API 未返回可读流，请关闭流式模式或检查端点支持情况');const o=a.body.getReader(),i=new TextDecoder('utf-8');let s='',l=!1,d='';n.value=0;const c=e=>{const t=e.trim();if(!t)return!1;if('data: [DONE]'===t||'[DONE]'===t)return!0;const a=t.startsWith('data:')?t.slice(5).trim():t;if(!a||'[DONE]'===a)return!1;try{const e=JSON.parse(a),t=ne(e);t&&(d+=t,n.value=Math.min(n.value+2,98))}catch(o){console.warn('无法解析流式数据块:',a.slice(0,100),o)}return!1};for(;!l;){const{value:e,done:n}=await o.read();if(e){s+=i.decode(e,{stream:!0});const n=s.split('\n');s=n.pop()??'';for(const e of n)if(c(e)){l=!0;break}}n&&(l=!0)}return s&&!l&&c(s),n.value=100,d},ae=async()=>{if(V.value)try{let e=null;if(void 0===window.TavernHelper||'function'!=typeof window.TavernHelper.getWorldbook)return console.error('❌ TavernHelper.getWorldbook 不可用'),window.toastr.error('世界书功能需要酒馆助手支持'),void(U.value=[]);e=await window.TavernHelper.getWorldbook(V.value),e&&Array.isArray(e)&&e.length>0?(U.value=e,console.log(`✅ 已加载世界书 "${V.value}" 的 ${U.value.length} 个条目`),window.toastr.success(`已加载 ${U.value.length} 个条目`)):(U.value=[],window.toastr.info('该世界书没有条目'))}catch(e){console.error('❌ 加载世界书条目失败:',e),window.toastr.error('加载失败：'+e.message),U.value=[]}else U.value=[]},oe=w(()=>{let e=[...U.value];if(J.value.trim()){const n=J.value.toLowerCase();e=e.filter(e=>{const t=e.name?.toLowerCase().includes(n),a=e.content?.toLowerCase().includes(n),o=e.strategy?.keys?.some(e=>'string'==typeof e?e.toLowerCase().includes(n):e instanceof RegExp&&e.toString().toLowerCase().includes(n));return t||a||o})}return'enabled'===B.value?e=e.filter(e=>e.enabled):'disabled'===B.value&&(e=e.filter(e=>!e.enabled)),e}),re={settingsStore:o,settings:r,toolExpandedState:i,antiClicheInput:s,antiClicheOutput:l,isProcessingAntiCliche:d,enableAntiClicheStreaming:c,antiClicheProgressPercent:p,antiClicheModifyRequest:u,isModifyingAntiCliche:g,characterDescription:f,characterCardOutput:m,isGeneratingCharacter:x,modifyRequest:h,isModifyingCharacter:v,enableCharacterStreaming:S,characterProgressPercent:I,worldbookDescription:C,worldbookEntryOutput:E,isGeneratingWorldbook:P,availableWorldbooks:O,selectedWorldbook:j,isInsertingEntry:R,worldbookModifyRequest:N,isModifyingWorldbook:H,enableWorldbookStreaming:L,worldbookProgressPercent:F,selectedViewerWorldbook:V,worldbookEntries:U,viewerSearchQuery:J,viewerSortBy:B,entryExpandedState:W,showEditDialog:G,editingEntry:Y,editingEntryUid:Z,isDataLoaded:q,loadAvailableWorldbooks:X,loadToolsData:K,saveToolsDataImmediate:Q,saveToolsData:ee,toggleToolExpanded:e=>{console.log('toggleToolExpanded 被调用，工具名称:',e);const n=i.value.get(e)||!1;console.log('当前展开状态:',n),i.value.set(e,!n),console.log('新的展开状态:',!n)},isToolExpanded:e=>i.value.get(e)||!1,handleAntiClicheProcess:async()=>{if(s.value.trim())try{d.value=!0,p.value=0,window.toastr.info('AI正在分析文本...','反八股清理',{timeOut:15e3});const e={model:r.value.model,max_tokens:r.value.max_tokens||8e3,temperature:.7,stream:c.value,messages:[{role:'system',content:'你是专业的文本编辑助手，专注于清理角色卡/世界书/开场白中的AI文学腔和八股表述。\n\n# 🎯 第一原则（最重要！）\n\n## ⚠️ 信息量守恒定律\n**输入500字，输出也应该接近500字！信息量必须相同！**\n\n- ❌ 错误：把五段话压缩成两句话\n- ❌ 错误：删除整个句子或段落\n- ❌ 错误：把详细描述变成简略概括\n- ✅ 正确：只替换/删除八股词汇，保留所有实质内容\n- ✅ 正确：用更自然的表达替换文学腔，而不是简单删除\n\n## 💡 工作方式\n**不是"删除工"，而是"改写师"：**\n- 不要想着"删删删"\n- 要想着"怎么用人话说同样的事"\n- 把文学腔改成日常口语\n- 把套路比喻改成直接描述\n\n---\n\n# 📋 清理规则（三级分类）\n\n## 🔴 第一级：必须删除（最明显的八股）\n\n### 1️⃣ AI套话词汇（见到就删）\n**模糊词**：一丝、一抹、一缕、一股、似乎、几乎、近乎、仿佛\n**比喻词**：如同、宛如、恰似、像是、好像、就像\n**对比句**："不是...而是..."、"既...又..."、"与其...不如"\n**强调词**：猛地、重重地、狂野、激烈地、恨不得、不容置疑\n**修饰废话**："不易察觉"、"难以察觉"、"带着xx意味"、"充满了某种"\n\n### 2️⃣ AI文学腔描写（全部删除）\n- **眼神/视线**："眼里闪过xxx"、"嘴角上扬"、"视线交汇" → 直接删\n- **心理状态**："她感到害怕"、"他内心矛盾" → 改成对白或动作\n- **声音描述**："声音沙哑"、"声音里带着..." → 全删\n- **动物比喻**："像小兽"、"像猫咪"、"野兽般的" → 全删\n- **气氛渲染**："气氛凝重"、"空气凝固" → 全删\n- **对白标注**："（带着不屑的口吻）"、"（轻声说）" → 全删\n\n### 3️⃣ 所有格主语（改写）\n- ❌ "她的声音"、"他的眼神" → 直接删或改主语\n- ❌ "她的性格是..." → 改为 "她很..."\n\n### 4️⃣ 精确数据（模糊化）\n- ❌ "身高168cm"、"一米六八" → ✅ "个子高"\n- ❌ "体重50kg" → ✅ "很瘦" 或直接删\n- ❌ "罩杯C" → ✅ "胸部丰满" 或直接删\n\n---\n\n## 🟡 第二级：改写替换（文学腔 → 人话）\n\n### 文学腔比喻 → 直接描述\n| 文学腔 | 人话 |\n|--------|------|\n| 醇厚的香气扑面而来 | 闻到酒味了 / 有股酒香 |\n| 如同黑曜石般璀璨的眼眸 | 黑眼睛 / 眼睛很黑 |\n| 心中涌起复杂的情绪 | 心里矛盾 / 又怕又期待 |\n| 冷暖交织的气息 | 冷香和酒味混在一起 |\n| 致命的诱惑 | 忍不住想靠近 |\n| 矛盾而极具吸引力 | 说不上来，但就是想看 |\n\n### 对仗结构 → 口语化\n- "既冷冽又醇厚" → "冷香和酒味"\n- "既矛盾又复杂" → "很矛盾"\n- "不是温柔而是傲慢" → "傲慢，不温柔"\n\n---\n\n## 🟢 第三级：必须保留（核心内容）\n\n### ✅ 完全保留：\n1. **所有对白**：包括""内的所有台词\n2. **核心设定**：人物背景、职业、关系\n3. **基础动作**：走、坐、站、拿、放\n4. **简单情绪**：开心、难过、生气（这些可以保留）\n5. **具体信息**：年龄、地点、时间、事件\n\n### ✅ 可以保留：\n- 自然的形容词（不是套话比喻）\n- 日常化的描述\n- 有意义的细节\n\n---\n\n# 💡 对比示例（学习正确做法）\n\n## 示例1：角色卡八股清理\n\n**❌ 输入（AI八股）：**\n角色A似乎有些困惑，眼里闪过一丝不易察觉的疑惑，她用不容置疑的语气说："你是谁？"她的声音低沉而富有磁性，如同野兽般的低吼。\n\n角色A出生于贵族家庭，她有着一头如同黑曜石般的长发，双眸宛如深邃的湖泊，身高168cm，罩杯C。她的性格并不是温柔的，而是傲慢且狂热的。\n\n她对魔法有着近乎狂热的追求，仿佛那是她生命的全部意义。语料："哼，你这种凡人怎么会理解我的想法。"（带着不屑的口吻）\n\n**❌ 错误输出（过度删减，信息量丢失）：**\n角色A问："你是谁？"\n角色A出生于贵族家庭，有黑色长发。\n语料："你不会理解我的想法。"\n\n**✅ 正确输出（保持信息量，只去八股）：**\n角色A停了停。"你是谁？"\n\n角色A出生于贵族家庭，黑色长发，黑眼睛，个子高，胸部丰满。傲慢，对很多事都很热情。喜欢阅读，经常一个人待在图书馆。\n\n角色A对魔法很痴迷，投入了很多时间研究。她怕一些东西。\n\n语料："哼，你这种凡人怎么会理解我的想法。"\n\n**改写思路：**\n- "似乎有些困惑，眼里闪过..." → "停了停"（行为代替心理+眼神）\n- "她的声音...如同野兽..." → 全删（声音描写+比喻）\n- "如同黑曜石般的长发" → "黑色长发"（删套话比喻）\n- "身高168cm，罩杯C" → "个子高，胸部丰满"（模糊化数字）\n- "并不是...而是..." → "傲慢"（删对比句）\n- "（带着不屑的口吻）" → 删（对白标注）\n- **对白完全保留**，设定信息全保留\n\n---\n\n## 示例2：信息素描写清理\n\n**❌ 输入（文学腔）：**\n一阵既冷冽又醇厚的香气飘来，混合着冬日雪松与温热白兰地的味道，矛盾而极具吸引力。浓郁而滚烫的信息素正从他身上源源不断地散发出来，那冰冷的雪杉气息已经被醇厚的白兰地酒香彻底包裹，充满了毫无防备的、致命的诱惑。\n\n**✅ 正确输出（人话）：**\n闻到香味，雪松和白兰地混在一起。滚烫的信息素从他身上散出来，雪杉味被酒香盖过了。\n\n**改写思路：**\n- "一阵" → "闻到"（删"一"+量词）\n- "既...又..." → 删（删对仗结构）\n- "矛盾而极具吸引力" → 删（删文学腔评价）\n- "浓郁而滚烫" → "滚烫"（删冗余形容词）\n- "充满了...致命的诱惑" → 删（删夸张描述）\n- **保留核心信息**：雪松、白兰地、信息素、滚烫、混合、盖过\n\n---\n\n# 🎯 最终执行要求\n\n1. **信息量守恒**：输入多少字，输出接近多少字\n2. **段落数守恒**：输入几段，输出几段\n3. **对白完整**：所有""内的台词必须100%保留\n4. **设定保留**：背景、职业、关系等核心设定全保留\n5. **只改八股**：只处理上述明确列出的八股表述\n6. **直接输出**：不要任何解释、标注、说明，直接给清理后的文本\n\n---\n\n**现在开始清理，记住：你是"改写师"而不是"删除工"！**'},{role:'user',content:s.value}]};let n;if(c.value)n=await te(e,p);else{const t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),p.value=100}l.value=n,Q(),window.toastr.success('文本清理完成！')}catch(e){console.error('反八股清理失败:',e),window.toastr.error('清理失败：'+e.message)}finally{d.value=!1,p.value=0}else window.toastr.warning('请输入需要清理的文本')},copyAntiClicheResult:()=>{l.value?A(l.value,'清理结果已复制到剪贴板'):window.toastr.warning('没有可复制的内容')},handleModifyAntiCliche:async()=>{if(u.value.trim())if(l.value)try{g.value=!0,p.value=0,window.toastr.info('AI正在修改...','反八股修改',{timeOut:15e3});const e={model:r.value.model,max_tokens:r.value.max_tokens||8e3,temperature:.7,stream:c.value,messages:[{role:'system',content:'你是一个文本编辑助手。根据用户的修改需求，对提供的文本进行修改。直接输出修改后的结果，不要添加任何解释或说明。'},{role:'user',content:`当前文本：\n${l.value}\n\n修改需求：${u.value}`}]};let n;if(c.value)n=await te(e,p);else{const t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),p.value=100}l.value=n,Q(),window.toastr.success('修改完成！')}catch(e){console.error('反八股修改失败:',e),window.toastr.error('修改失败：'+e.message)}finally{g.value=!1,p.value=0}else window.toastr.warning('没有可修改的内容');else window.toastr.warning('请输入修改需求')},clearAntiClicheModifyRequest:()=>{u.value='',Q(),window.toastr.success('修改需求已清空')},handleGenerateCharacterCard:async()=>{if(f.value.trim())try{x.value=!0,I.value=0,window.toastr.info('AI正在生成角色卡，请稍候...');const e={model:r.value.model||'gpt-3.5-turbo',max_tokens:r.value.max_tokens||16e3,temperature:.8,stream:S.value,messages:[{role:'system',content:'你是一位专业的角色设计师，擅长创造真实、立体、有血有肉的角色。\n\n# 核心原则\n1. **真实性第一**：角色必须像真实存在的人，有优点也有缺点，有逻辑也有矛盾\n2. **避免刻板印象**：拒绝"温柔体贴"、"成熟稳重"、"活泼开朗"等空洞标签\n3. **展现而非告知**：用具体行为、习惯、反应来展现性格，而非直接描述\n4. **矛盾与冲突**：性格要有张力，内心要有挣扎，行为要有动机\n\n# 输出格式\n严格使用 YAML 格式，纯中文，结构如下：\n\n```yaml\n基础信息:\n  姓名: "全名（只写中文，不带英文）"\n  年龄: 具体数字\n  出生年月: "YYYY年MM月"\n  性别: "男/女"\n  第二性别: "Alpha/Beta/Omega/无"\n  身高体重: "用描述性词语，如\'身材高挑\'\'体型匀称\'\'略显瘦削\'，禁用数字和单位"\n  信息素: "如适用ABO设定，描述气味和特征，否则写\'无\'"\n  性取向: "明确但自然的描述"\n  恋爱经验: "具体描述过往经历和对感情的态度，不要写\'丰富\'这种模糊词"\n  身份职业: "具体职业+当前状态，如\'互联网公司产品经理，正处于职业瓶颈期\'"\n  标志性特征:\n    微信昵称: "符合角色性格的昵称"\n    头像: "简短描述，体现性格"\n    其他: "1-2个独特的外在特征"\n\n外貌与身材:\n  整体印象: "第一眼给人的感觉，用生动的比喻"\n  面容特征:\n    发型发色: "具体描述+日常打理习惯"\n    肤色肤质: "不只说白/黑，要有质感描述"\n    眼睛: "形状+神态+眼神特点（如\'总是微微眯起，带着审视\'）"\n    五官: "1-2个最突出的特点+细节"\n  穿搭风格: "日常3种场景的穿着+品味倾向+为什么这样穿"\n  声音气质: "音色+语速+说话习惯（如\'会在句尾拖长音\'\'习惯用鼻音哼声\'）"\n  习惯动作: "3-5个自然的小动作，注明在什么情况下会做"\n\n性格与心理:\n  核心性格:\n    主导特质: "1个最核心的性格特点，用行为模式解释"\n    次要特质: "2-3个补充特质，说明如何体现"\n    隐藏面: "不轻易展现但确实存在的一面"\n  性格矛盾: "至少1组内在矛盾（如：渴望亲密却害怕受伤，追求完美却容易自我怀疑）"\n  情绪模式:\n    基线情绪: "日常的情绪基调，不要用\'平和\'\'稳定\'这种词"\n    易触发点: "具体场景+为什么会触发"\n    情绪表现: "高兴/生气/难过时的具体表现，要有细节"\n    自我调节: "心情不好时会做什么，效果如何"\n  压力应对: "面对压力的第一反应+长期策略+极限状态"\n  自我认知: "TA如何看待自己+与他人眼中形象的差异"\n\n对话风格:\n  语言特征: "用词习惯+句式特点+说话节奏，给出具体例子"\n  对不同对象:\n    熟人: "如何说话+举例"\n    生人: "如何说话+举例"\n    上级/长辈: "如何说话+举例"\n    下属/晚辈: "如何说话+举例"\n  情绪化时: "生气时语气如何变化+难过时说话方式+兴奋时的特点"\n  口头禅: ["2-3个符合角色的口头禅，要自然"]\n  言外之意: "常用的委婉表达或暗示方式"\n\n背景经历:\n  家庭背景: "家庭结构+成长环境+家庭氛围+对性格的影响"\n  教育经历: "学习经历+成绩表现+对知识/权威的态度"\n  重要事件:\n    - "具体事件1+当时年龄+如何影响了TA"\n    - "具体事件2+当时年龄+如何影响了TA"\n    - "具体事件3+当时年龄+如何影响了TA"\n  转折点: "人生中最重要的改变+前后对比"\n  当前状况: "具体的生活状态+面临的问题+应对方式"\n  未来规划: "想要什么+为什么想要+有何行动"\n\n人际关系:\n  对{{user}}: "初次见面的态度+相处模式+内心真实想法+可能的发展"\n  社交模式: "喜欢什么样的社交+讨厌什么+社交能量来源"\n  群体定位: "在团体中的角色+如何获得这个位置+是否满意"\n  关系处理: "如何建立关系+如何维持关系+如何结束关系"\n  冲突模式: "冲突时第一反应+沟通方式+底线在哪"\n\n行为模式:\n  日常习惯: "3-5个具体的生活习惯+背后原因"\n  决策模式: "做决定的方式+考虑因素+犹豫点"\n  主动行为: "TA会主动去做的事+动机"\n  回避行为: "TA避免做的事+为什么回避"\n  应激反应: "突发情况的本能反应+事后如何处理"\n  行为底线: "绝对不会做的事+为什么"\n\n内在动机:\n  核心驱动: "推动TA行动的最深层原因（不是\'想成功\'这种泛泛之谈）"\n  深层需求: "TA真正缺失和渴望的（可能自己都未意识到）"\n  价值排序: "TA认为最重要的3-5个价值观，按优先级排序"\n  内在冲突: "价值观之间的矛盾+如何权衡"\n  隐秘想法: "不愿说出口的真实想法+为什么隐藏"\n  自我欺骗: "TA对自己撒的谎+真相是什么"\n\n情绪管理:\n  失控阈值: "什么情况会失控+失控时的表现"\n  恢复机制: "如何平复下来+需要多久+谁能帮助"\n  情绪模式: "是压抑型/爆发型/渐进型"\n  脆弱时刻: "什么时候最脆弱+会向谁示弱"\n```\n\n# 写作要求\n\n## ✅ 这样写（好例子）：\n- "会在紧张时咬指甲，咬到出血也不自觉"\n- "表面上说无所谓，但会在深夜反复刷对方的社交账号"\n- "习惯在句尾加\'吧\'\'呢\'这些不确定的语气词，显得不够坚定"\n- "对陌生人冷淡，但遇到流浪猫会蹲下来哄半天"\n\n## ❌ 不要这样写（坏例子）：\n- "性格温柔善良" → 太空洞，要写具体行为\n- "是个负责任的人" → 太抽象，要写如何体现\n- "很关心朋友" → 太笼统，要写具体怎么关心\n- "成熟稳重" → 太刻板，真人有复杂性\n\n## 关键原则：\n1. **每个描述都要有"为什么"**：不只说TA是什么样，要说为什么是这样\n2. **展现矛盾**：真实的人都有自相矛盾的地方\n3. **具体场景**：用"会在XX情况下做XX"而非"是个XX的人"\n4. **避免完美**：缺陷和局限让角色真实\n5. **语言生动**：用比喻、对比、细节，不要用形容词堆砌\n\n现在请根据用户描述，创造一个真实可信的角色。记住：你在创造一个人，不是填写表格。'},{role:'user',content:f.value}]};let n;if(S.value)n=await te(e,I);else{const t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),I.value=100}m.value=n,Q(),window.toastr.success('角色卡生成完成！')}catch(e){console.error('角色卡生成失败:',e),window.toastr.error('生成失败：'+e.message)}finally{x.value=!1,I.value=0}else window.toastr.warning('请输入角色描述')},clearCharacterForm:()=>{f.value='',m.value='',h.value='',Q(),window.toastr.success('内容已清空')},copyCharacterCard:()=>{m.value?A(m.value,'角色卡已复制到剪贴板'):window.toastr.warning('没有可复制的内容')},clearAntiClicheForm:()=>{s.value='',l.value='',Q(),window.toastr.success('内容已清空')},handleModifyCharacterCard:async()=>{if(h.value.trim())if(m.value)try{v.value=!0,I.value=0,window.toastr.info('AI正在根据你的需求修改角色卡，请稍候...');const e={model:r.value.model||'gpt-3.5-turbo',max_tokens:r.value.max_tokens||16e3,temperature:.8,stream:S.value,messages:[{role:'system',content:'你是一个角色卡编辑助手。用户会提供一个现有的 YAML 格式角色卡和修改需求，请根据修改需求调整角色卡内容。\n\n**修改原则**：\n1. 必须保持 YAML 格式，所有字段名和内容都使用中文\n2. 只修改用户明确要求修改的部分\n3. 确保修改后的内容与原有角色卡风格一致\n4. 如果用户的要求与原有设定冲突，以用户的要求为准\n5. 输出完整的修改后的角色卡，不要截断\n6. 保持原有的字段结构，除非用户要求添加或删除字段\n\n**重要注意事项**：\n- 身高体重必须用文字描述（高大/中等/娇小/匀称/纤瘦等），不要用数字和单位\n- 保持性格的多面性和复杂性，避免单一化\n- 行为模式要从角色视角出发，描述角色会如何思考和行动\n- 避免AI刻板化，保持角色的真实感和多样性\n\n请输出完整的 YAML 格式角色卡。'},{role:'user',content:`以下是现有的角色卡：\n\n${m.value}\n\n---\n\n请根据以下修改需求调整角色卡：\n${h.value}`}]};let n;if(S.value)n=await te(e,I);else{const t=M(r.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),I.value=100}m.value=n,h.value='',Q(),window.toastr.success('角色卡修改完成！')}catch(e){console.error('角色卡修改失败:',e),window.toastr.error('修改失败：'+e.message)}finally{v.value=!1,I.value=0}else window.toastr.warning('没有可修改的角色卡，请先生成角色卡');else window.toastr.warning('请输入修改需求')},clearModifyRequest:()=>{h.value='',Q(),window.toastr.success('修改需求已清空')},extractStreamContent:ne,generateWithStreaming:te,handleGenerateWorldbookEntry:async()=>{if(C.value.trim())try{P.value=!0,F.value=0,window.toastr.info('AI正在生成世界书条目，请稍候...','',{timeOut:15e3});const n={model:r.value.model||'gpt-3.5-turbo',max_tokens:r.value.max_tokens||4e3,temperature:.7,stream:L.value,messages:[{role:'system',content:'你是SillyTavern世界书条目生成专家，负责将用户需求转换为标准JSON格式的世界书条目。\n\n# JSON结构规范\n\n{\n  "name": "条目名称",\n  "enabled": true,\n  "strategy": {\n    "type": "selective或constant",\n    "keys": ["关键字数组"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "条目正文内容",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n---\n\n# 字段填写规则\n\n## 1️⃣ name（条目名称）\n- 简短明确（2-6字最佳）\n- 反映核心主题\n- 示例："林潜"、"魔法学院"、"火焰剑"\n\n## 2️⃣ strategy.type（激活类型）\n**selective（绿灯）** - 关键字触发：\n- 角色、地点、物品\n- 特定事件、特定概念\n- 需要按需激活的内容\n\n**constant（蓝灯）** - 始终生效：\n- 世界观基础设定\n- 通用规则\n- 全局背景信息\n\n## 3️⃣ strategy.keys（关键字）\n- 3-6个关键词\n- 包含：全名、简称、别名、相关概念\n- 示例：["林潜", "林", "潜"]、["魔法学院", "学院", "星辉"]\n\n## 4️⃣ content（正文内容）⚠️ 最重要！\n\n### ❌ 严禁使用的格式\n**禁止Markdown语法**：\n- ❌ 不用 # 标题、## 二级标题\n- ❌ 不用 **粗体**、*斜体*\n- ❌ 不用 - 列表、1. 数字列表\n- ❌ 不用 > 引用\n- ❌ 不用 `代码`\n\n**禁止AI八股文**：\n- ❌ 不用"一丝"、"一抹"、"如同"、"宛如"\n- ❌ 不用"眼里闪过"、"嘴角上扬"\n- ❌ 不用"既...又..."、"不是...而是..."\n- ❌ 不描写心理、眼神、声音、气氛\n\n### ✅ 正确的写法\n**纯文本 + 冒号分隔**：\n- 用"。"句号分隔信息\n- 用"："冒号引出具体内容\n- 用"、"顿号列举\n\n**陈述式 + 信息密集**：\n- 直接陈述事实\n- 简洁有力，不绕弯子\n- 每句话都有实质信息\n\n**结构化组织**：\n- 从基础信息到详细设定\n- 逻辑顺序：身份→特征→背景→能力→关系\n- 用换行段落分隔不同主题\n\n### 📋 内容模板\n\n**角色类**：\n[姓名]，[性别]，[年龄]，[职业/身份]。[外貌特征1-2句]。[性格核心特点]。[重要背景]。[能力/特长]。[与其他角色的关系]。\n\n**地点类**：\n[地点名]位于[位置]，[基本描述]。[功能用途]。[历史背景]。[重要特征]。[相关规则]。\n\n**物品类**：\n[物品名]，[类型]，[外观]。[功能/效果]。[获取方式]。[使用限制]。[特殊说明]。\n\n**概念/事件类**：\n[概念名]指[定义]。[具体表现]。[影响范围]。[相关规则]。[注意事项]。\n\n---\n\n# 完整示例\n\n## 示例1：角色条目\n\n用户需求："创建角色林潜的条目，16岁，男，高中生，普通家庭"\n\n输出：\n{\n  "name": "林潜",\n  "enabled": true,\n  "strategy": {\n    "type": "selective",\n    "keys": ["林潜", "林", "潜", "男生", "同学"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "林潜，男性，16岁，目前就读高中。出身于普通家庭，家庭经济状况中等。性格内向，不太擅长社交。学习成绩中等偏上，理科比文科好。平时喜欢独自看书，经常一个人待在图书馆。对陌生人保持警惕，熟悉后会放松一些。",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n## 示例2：地点条目\n\n用户需求："创建魔法学院的条目，包含历史和规则"\n\n输出：\n{\n  "name": "星辉魔法学院",\n  "enabled": true,\n  "strategy": {\n    "type": "selective",\n    "keys": ["星辉魔法学院", "魔法学院", "学院", "星辉", "校园"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "星辉魔法学院位于浮空岛上，建立于三百年前。学院有七座高塔，对应七大魔法流派：元素、心灵、转化、召唤、预言、防护、幻术。学院采用学分制，学生需完成基础课程和专精课程才能毕业。\n\n学院规则：禁止在教学区施展未经许可的魔法。禁止擅自进入禁书区。禁止私下决斗，违者将被停学。学生需佩戴学院徽章，按时参加每周的全体集会。",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n---\n\n# 最终要求\n\n1. **只输出JSON**：不要任何解释、注释、说明\n2. **格式正确**：确保可被JSON.parse()解析\n3. **信息完整**：用户提供的所有信息都必须在content中体现\n4. **禁用Markdown**：content必须是纯文本，不用任何Markdown语法\n5. **避免八股文**：不用套话、比喻、心理描写\n6. **结构清晰**：用句号、冒号、换行组织内容，不用列表符号\n\n现在根据用户需求生成世界书条目JSON。'},{role:'user',content:C.value}]};let t;if(L.value)t=await te(n,F);else{const e=M(r.value.api_endpoint),a=await fetch(e,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(n)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);t=(await a.json()).choices[0].message.content.trim(),F.value=100}try{const e=(t.match(/```(?:json)?\s*([\s\S]*?)```/)||[null,t])[1]||t,n=JSON.parse(e);E.value=n,Q(),window.toastr.success('世界书条目生成完成！')}catch(e){console.error('JSON 解析失败:',e),console.log('原始响应:',t),window.toastr.error('生成的内容格式错误，请重试')}}catch(n){console.error('世界书条目生成失败:',n),window.toastr.error('生成失败：'+n.message)}finally{P.value=!1,F.value=0}else window.toastr.warning('请输入条目描述')},clearWorldbookForm:()=>{C.value='',E.value=null,j.value='',N.value='',Q(),window.toastr.success('内容已清空')},handleInsertEntry:async()=>{if(j.value)if(E.value)try{R.value=!0,window.toastr.info(`正在插入条目到「${j.value}」...`),await createWorldbookEntries(j.value,[E.value],{render:'immediate'}),window.toastr.success(`✅ 条目已成功插入到「${j.value}」`)}catch(e){console.error('插入条目失败:',e),window.toastr.error('插入失败：'+e.message)}finally{R.value=!1}else window.toastr.warning('没有可插入的条目');else window.toastr.warning('请选择目标世界书')},copyWorldbookEntry:()=>{if(!E.value)return void window.toastr.warning('没有可复制的内容');const e=JSON.stringify(E.value,null,2);A(e,'世界书条目 JSON 已复制到剪贴板')},handleModifyWorldbookEntry:async()=>{if(N.value.trim())if(E.value)try{H.value=!0,F.value=0,window.toastr.info('AI正在根据你的需求修改世界书条目，请稍候...');const n={model:r.value.model||'gpt-3.5-turbo',max_tokens:r.value.max_tokens||4e3,temperature:.7,stream:L.value,messages:[{role:'system',content:'你是一个世界书条目编辑助手。用户会提供一个现有的世界书条目 JSON 和修改需求，请根据修改需求调整条目内容。\n\n**修改原则**：\n1. 必须保持 JSON 格式正确\n2. 只修改用户明确要求修改的部分\n3. 确保修改后的内容与原有条目风格一致\n4. 如果用户的要求与原有设定冲突，以用户的要求为准\n5. 输出完整的修改后的 JSON，不要截断\n6. 保持原有的字段结构，除非用户要求添加或删除字段\n\n**重要注意事项**：\n- 如果修改内容 (content)，务必包含用户要求的所有信息\n- 如果修改关键字 (keys)，要确保关键字与内容匹配\n- 保持激活策略 (strategy.type) 的合理性\n- 只输出 JSON 数据，不要添加任何解释\n\n请输出完整的 JSON 格式世界书条目。'},{role:'user',content:`以下是现有的世界书条目：\n\n${JSON.stringify(E.value,null,2)}\n\n---\n\n请根据以下修改需求调整条目：\n${N.value}`}]};let t;if(L.value)t=await te(n,F);else{const e=M(r.value.api_endpoint),a=await fetch(e,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r.value.api_key}`},body:JSON.stringify(n)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);t=(await a.json()).choices[0].message.content.trim(),F.value=100}try{const e=(t.match(/```(?:json)?\s*([\s\S]*?)```/)||[null,t])[1]||t,n=JSON.parse(e);E.value=n,N.value='',Q(),window.toastr.success('世界书条目修改完成！')}catch(e){console.error('JSON 解析失败:',e),console.log('原始响应:',t),window.toastr.error('修改的内容格式错误，请重试')}}catch(n){console.error('世界书条目修改失败:',n),window.toastr.error('修改失败：'+n.message)}finally{H.value=!1,F.value=0}else window.toastr.warning('没有可修改的条目，请先生成条目');else window.toastr.warning('请输入修改需求')},clearWorldbookModifyRequest:()=>{N.value='',Q(),window.toastr.success('修改需求已清空')},loadWorldbookEntries:ae,filteredWorldbookEntries:oe,toggleEntryExpanded:e=>{const n=W.value.get(e)||!1;W.value.set(e,!n)},isEntryExpanded:e=>W.value.get(e)||!1,editWorldbookEntry:e=>{try{Y.value={uid:e.uid,name:e.name||'',enabled:e.enabled??!0,content:e.content||'',strategy:{type:e.strategy?.type||'selective',keys:[...e.strategy?.keys||[]],keys_secondary:{logic:e.strategy?.keys_secondary?.logic||'and_any',keys:[...e.strategy?.keys_secondary?.keys||[]]},scan_depth:e.strategy?.scan_depth||'same_as_global'},position:e.position?{type:e.position.type||'before_character_definition',role:e.position.role||'system',depth:e.position.depth??0,order:e.position.order??0}:{type:'before_character_definition',role:'system',depth:0,order:0},probability:e.probability??100,recursion:e.recursion?{prevent_incoming:e.recursion.prevent_incoming??!1,prevent_outgoing:e.recursion.prevent_outgoing??!1,delay_until:e.recursion.delay_until??null}:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:e.effect?{sticky:e.effect.sticky??null,cooldown:e.effect.cooldown??null,delay:e.effect.delay??null}:{sticky:null,cooldown:null,delay:null}},Z.value=e.uid,G.value=!0}catch(n){console.error('打开编辑界面失败:',n),window.toastr.error('打开编辑界面失败：'+n.message)}},saveEditedEntry:async()=>{if(Y.value.name?.trim())if(Z.value)try{const e=await updateWorldbookWith(V.value,e=>{const n=e.findIndex(e=>e.uid===Z.value);return-1!==n&&(e[n]={...e[n],...Y.value,uid:Z.value}),e});U.value=e,G.value=!1,Y.value={},Z.value=null,window.toastr.success('条目已保存')}catch(e){console.error('保存条目失败:',e),window.toastr.error('保存失败：'+e.message)}else window.toastr.error('条目ID不存在');else window.toastr.warning('条目名称不能为空')},deleteWorldbookEntry:async e=>{if(confirm(`确定要删除条目 "${e.name}" 吗？`))try{const{worldbook:n}=await deleteWorldbookEntries(V.value,n=>n.uid===e.uid);U.value=n,window.toastr.success(`已删除条目 "${e.name}"`)}catch(n){console.error('删除条目失败:',n),window.toastr.error('删除失败：'+n.message)}}};return Object.defineProperty(re,'__isScriptSetup',{enumerable:!1,value:!0}),re}}),[['render',function(e,n,t,a,b,y){return i(),o('div',Zc,[s('div',qc,[s('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>a.toggleToolExpanded('antiCliche')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[n[51]||(n[51]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-broom',style:{color:'#ff6b6b','font-size':'18px'}}),d(' 反八股工具 ')],-1)),s('i',{class:h(a.isToolExpanded('antiCliche')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),a.isToolExpanded('antiCliche')?(i(),o('div',Xc,[n[62]||(n[62]=u('<div class="tool-instructions" data-v-ae874133><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-ae874133></i> 角色卡/世界书/开场白八股清理工具，<strong style="color:#10b981;" data-v-ae874133>适度清理</strong>明显八股，保持原文信息量。 </p><p style="margin:0 0 8px 0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-ae874133> 🎯 <strong data-v-ae874133>清理重点</strong>：模糊词（一丝、似乎）、动物化比喻（像小兽）、否定句式（不是而是）、极端情绪、夸张修辞 </p><p style="margin:0;color:#10b981;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #10b981;" data-v-ae874133> ✅ <strong data-v-ae874133>保持内容</strong>：核心设定、对话内容、具体动作、重要信息 - 输入几段输出几段！ </p></div>',1)),s('div',Kc,[n[52]||(n[52]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 输入文本： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>a.antiClicheInput=e),placeholder:'请输入需要清理的文本...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.antiClicheInput]])]),s('div',Qc,[s('label',ep,[l(s('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>a.enableAntiClicheStreaming=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,a.enableAntiClicheStreaming]]),n[53]||(n[53]=d(' 启用流式传输（可查看清理进度） ',-1))])]),a.isProcessingAntiCliche&&a.antiClicheProgressPercent>0?(i(),o('div',np,[s('div',tp,[s('div',{class:'progress-fill',style:g({width:a.antiClicheProgressPercent+'%',height:'100%',background:'linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%)',backgroundSize:'200% 100%',animation:a.enableAntiClicheStreaming?'progress-slide 2s linear infinite':'none',transition:'width 0.3s ease'})},null,4)]),s('div',ap,' 清理中... '+c(a.antiClicheProgressPercent.toFixed(0))+'% ',1)])):r('',!0),s('div',op,[s('button',{class:'process-button',disabled:a.isProcessingAntiCliche||!a.antiClicheInput.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleAntiClicheProcess},[n[54]||(n[54]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[55]||(n[55]=s('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(a.isProcessingAntiCliche?'处理中...':'开始清理'),1)],8,rp),s('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:a.clearAntiClicheForm},[...n[56]||(n[56]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),a.antiClicheOutput?(i(),o('div',ip,[n[61]||(n[61]=s('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 清理结果： ')],-1)),s('div',sp,c(a.antiClicheOutput),1),s('div',{class:'output-actions',style:{'margin-top':'12px',display:'flex',gap:'12px'}},[s('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:a.copyAntiClicheResult},[...n[57]||(n[57]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制结果 ',-1)])])]),s('div',lp,[n[60]||(n[60]=s('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px',color:'#ffc107'}}),d(' AI 修改清理结果 ')],-1)),s('div',dp,[l(s('textarea',{'onUpdate:modelValue':n[5]||(n[5]=e=>a.antiClicheModifyRequest=e),placeholder:'描述你想要的修改，例如：把这段话改得更简洁一些...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.antiClicheModifyRequest]])]),s('div',cp,[s('button',{disabled:a.isModifyingAntiCliche||!a.antiClicheModifyRequest.trim(),style:g([{flex:'1',padding:'10px 20px',background:'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',border:'none','border-radius':'6px',color:'#1a1a1a','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 193, 7, 0.3)',opacity:'1'},{opacity:a.isModifyingAntiCliche||!a.antiClicheModifyRequest.trim()?.5:1,cursor:a.isModifyingAntiCliche||!a.antiClicheModifyRequest.trim()?'not-allowed':'pointer'}]),onClick:a.handleModifyAntiCliche},[n[58]||(n[58]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingAntiCliche?'修改中...':'AI 修改'),1)],12,pp),s('button',{disabled:!a.antiClicheModifyRequest.trim(),style:g([{padding:'10px 20px',background:'#dc3545',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},{opacity:a.antiClicheModifyRequest.trim()?1:.5,cursor:a.antiClicheModifyRequest.trim()?'pointer':'not-allowed'}]),onClick:a.clearAntiClicheModifyRequest},[...n[59]||(n[59]=[s('i',{class:'fa-solid fa-eraser',style:{'margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])],12,up)])])])):r('',!0)])):r('',!0)]),s('div',gp,[s('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[6]||(n[6]=e=>a.toggleToolExpanded('worldbookEntry')),onMouseenter:n[7]||(n[7]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[8]||(n[8]=e=>e.currentTarget.style.transform='translateY(0)')},[n[63]||(n[63]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-book-atlas',style:{color:'#ffc107','font-size':'18px'}}),d(' 世界书条目生成工具 ')],-1)),s('i',{class:h(a.isToolExpanded('worldbookEntry')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),a.isToolExpanded('worldbookEntry')?(i(),o('div',fp,[n[88]||(n[88]=s('div',{class:'tool-instructions'},[s('p',{style:{margin:'0 0 8px 0',color:'#ccc','font-size':'12px'}},[s('i',{class:'fa-solid fa-info-circle',style:{'margin-right':'6px',color:'#ffc107'}}),d(' 输入你想要的世界书条目描述，AI 将自动生成符合格式的条目，并可插入到指定世界书中。 ')]),s('p',{style:{margin:'0',color:'#4a9eff','font-size':'11px',background:'#1a1a1a',padding:'6px','border-radius':'4px','border-left':'3px solid #ffc107'}},' 💡 示例：「生成一个关于魔法学院的条目，包含学院历史和规则」、「创建角色"艾莉丝"的背景条目」 ')],-1)),s('div',mp,[n[64]||(n[64]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 条目描述： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[9]||(n[9]=e=>a.worldbookDescription=e),placeholder:'请描述你想要生成的世界书条目内容...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.worldbookDescription]])]),s('div',xp,[s('label',hp,[l(s('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>a.enableWorldbookStreaming=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,a.enableWorldbookStreaming]]),n[65]||(n[65]=d(' 启用流式传输（可查看生成进度） ',-1))])]),a.isGeneratingWorldbook&&a.worldbookProgressPercent>0?(i(),o('div',bp,[s('div',yp,[n[67]||(n[67]=s('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(255, 193, 7, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),s('div',{class:'progress-fill',style:g({position:'relative',width:a.worldbookProgressPercent+'%',height:'100%',background:'linear-gradient(90deg, #ffc107 0%, #ff9800 50%, #ffc107 100%)',backgroundSize:'200% 100%',animation:a.enableWorldbookStreaming?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(255, 193, 7, 0.5)'})},[...n[66]||(n[66]=[s('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),s('div',vp,[s('span',wp,' 生成中... '+c(a.worldbookProgressPercent.toFixed(0))+'% ',1),n[68]||(n[68]=s('div',{style:{display:'flex',gap:'4px'}},[s('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):r('',!0),s('div',kp,[s('button',{class:'generate-button',disabled:a.isGeneratingWorldbook||!a.worldbookDescription.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 193, 7, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleGenerateWorldbookEntry},[n[69]||(n[69]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[70]||(n[70]=s('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(a.isGeneratingWorldbook?'生成中...':'生成条目'),1)],8,_p),s('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:a.clearWorldbookForm},[...n[71]||(n[71]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),a.worldbookEntryOutput?(i(),o('div',Tp,[n[87]||(n[87]=s('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 生成的条目： ')],-1)),s('div',Sp,[s('div',Ip,[n[72]||(n[72]=s('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'条目名称：',-1)),s('div',Ap,c(a.worldbookEntryOutput.name||'未命名'),1)]),s('div',zp,[n[73]||(n[73]=s('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'主要关键字：',-1)),s('div',Cp,c(a.worldbookEntryOutput.strategy?.keys?.join(', ')||'无'),1)]),s('div',$p,[n[74]||(n[74]=s('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'条目内容：',-1)),s('div',Ep,c(a.worldbookEntryOutput.content),1)]),s('div',Pp,[n[75]||(n[75]=s('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'激活策略：',-1)),s('div',Mp,c('constant'===a.worldbookEntryOutput.strategy?.type?'🔵 常量 (蓝灯)':'selective'===a.worldbookEntryOutput.strategy?.type?'🟢 可选项 (绿灯)':'🔗 向量化'),1)])]),s('div',Op,[n[80]||(n[80]=u('<h5 style="margin:0 0 12px 0;color:#fff;font-size:14px;font-weight:600;" data-v-ae874133><i class="fa-solid fa-edit" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 修改条目 </h5><div class="modify-instructions" style="background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:10px;margin-bottom:15px;" data-v-ae874133><p style="margin:0 0 6px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-lightbulb" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 描述你想要修改的内容，AI会根据你的需求调整条目。例如：&quot;增加更多细节&quot;、&quot;改为女性角色&quot;、&quot;添加技能说明&quot;等。 </p><p style="margin:0;color:#ffa500;font-size:11px;" data-v-ae874133>⚠️ 修改后会保持 JSON 格式。</p></div>',2)),s('div',jp,[n[76]||(n[76]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 修改需求： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[11]||(n[11]=e=>a.worldbookModifyRequest=e),placeholder:'请描述你想要修改的内容...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.worldbookModifyRequest]])]),a.isModifyingWorldbook&&a.worldbookProgressPercent>0?(i(),o('div',Dp,[s('div',Rp,[s('div',{class:'progress-fill',style:g({width:a.worldbookProgressPercent+'%',height:'100%',background:'linear-gradient(90deg, #ffa500 0%, #ff8c00 50%, #ffa500 100%)',backgroundSize:'200% 100%',animation:a.enableWorldbookStreaming?'progress-slide 2s linear infinite':'none',transition:'width 0.3s ease'})},null,4)]),s('div',Np,' 修改中... '+c(a.worldbookProgressPercent.toFixed(0))+'% ',1)])):r('',!0),s('div',Hp,[s('button',{class:'modify-button',disabled:a.isModifyingWorldbook||!a.worldbookModifyRequest.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffa500 0%, #ff8c00 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 165, 0, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleModifyWorldbookEntry},[n[77]||(n[77]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[78]||(n[78]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingWorldbook?'修改中...':'AI修改'),1)],8,Lp),s('button',{class:'clear-modify-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(108, 117, 125, 0.3)',position:'relative',overflow:'hidden'},onClick:a.clearWorldbookModifyRequest},[...n[79]||(n[79]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-eraser',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])])])]),s('div',Fp,[n[86]||(n[86]=s('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-file-import',style:{'margin-right':'6px',color:'#17a2b8'}}),d(' 插入到世界书 ')],-1)),s('div',Vp,[n[82]||(n[82]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 选择世界书： ',-1)),l(s('select',{'onUpdate:modelValue':n[12]||(n[12]=e=>a.selectedWorldbook=e),style:{width:'100%',padding:'10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},[n[81]||(n[81]=s('option',{value:'',disabled:''},'请选择世界书',-1)),(i(!0),o(m,null,x(a.availableWorldbooks,e=>(i(),o('option',{key:e,value:e},c(e),9,Up))),128))],512),[[H,a.selectedWorldbook]])]),s('div',Jp,[s('button',{class:'insert-button',disabled:!a.selectedWorldbook||a.isInsertingEntry,style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleInsertEntry},[n[83]||(n[83]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[84]||(n[84]=s('i',{class:'fa-solid fa-plus-circle',style:{'font-size':'14px'}},null,-1)),d(' '+c(a.isInsertingEntry?'插入中...':'插入条目'),1)],8,Bp),s('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #17a2b8 0%, #138496 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(23, 162, 184, 0.3)',position:'relative',overflow:'hidden'},onClick:a.copyWorldbookEntry},[...n[85]||(n[85]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制 JSON ',-1)])])])])])):r('',!0)])):r('',!0)]),s('div',Wp,[s('div',{class:'section-header viewer-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[13]||(n[13]=e=>a.toggleToolExpanded('worldbookViewer')),onMouseenter:n[14]||(n[14]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[15]||(n[15]=e=>e.currentTarget.style.transform='translateY(0)')},[n[89]||(n[89]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-list',style:{color:'#20c997','font-size':'18px'}}),d(' 世界书条目查看器 ')],-1)),s('i',{class:h(a.isToolExpanded('worldbookViewer')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888','font-size':'14px',transition:'transform 0.3s ease'}},null,2)],32),a.isToolExpanded('worldbookViewer')?(i(),o('div',Gp,[n[100]||(n[100]=s('div',{class:'tool-instructions',style:{background:'rgba(32, 201, 151, 0.1)','border-left':'3px solid #20c997',padding:'12px 15px','border-radius':'6px','margin-bottom':'20px'}},[s('p',{style:{margin:'0',color:'#a0f0e0','font-size':'13px',display:'flex','align-items':'center',gap:'8px'}},[s('i',{class:'fa-solid fa-info-circle',style:{color:'#20c997'}}),d(' 选择一个世界书，查看其中所有条目的详细信息，支持搜索和筛选。 ')])],-1)),s('div',Yp,[n[91]||(n[91]=s('label',{style:{display:'block','margin-bottom':'10px',color:'#e0e0e0','font-size':'14px','font-weight':'500','letter-spacing':'0.3px'}},' 选择世界书： ',-1)),l(s('select',{'onUpdate:modelValue':n[16]||(n[16]=e=>a.selectedViewerWorldbook=e),style:{width:'100%',padding:'12px 15px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'},onChange:a.loadWorldbookEntries,onFocus:n[17]||(n[17]=e=>e.target.style.borderColor='#20c997'),onBlur:n[18]||(n[18]=e=>e.target.style.borderColor='rgba(255, 255, 255, 0.1)')},[n[90]||(n[90]=s('option',{value:''},'请选择世界书',-1)),(i(!0),o(m,null,x(a.availableWorldbooks,e=>(i(),o('option',{key:e,value:e},c(e),9,Zp))),128))],544),[[H,a.selectedViewerWorldbook]])]),a.selectedViewerWorldbook?(i(),o('div',qp,[n[92]||(n[92]=s('label',{style:{display:'block','margin-bottom':'10px',color:'#e0e0e0','font-size':'14px','font-weight':'500','letter-spacing':'0.3px'}},' 搜索条目： ',-1)),l(s('input',{'onUpdate:modelValue':n[19]||(n[19]=e=>a.viewerSearchQuery=e),type:'text',placeholder:'搜索条目名称、关键字或内容...',style:{width:'100%',padding:'12px 15px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',transition:'all 0.3s ease','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'},onFocus:n[20]||(n[20]=e=>e.target.style.borderColor='#20c997'),onBlur:n[21]||(n[21]=e=>e.target.style.borderColor='rgba(255, 255, 255, 0.1)')},null,544),[[p,a.viewerSearchQuery]])])):r('',!0),a.selectedViewerWorldbook&&a.worldbookEntries.length>0?(i(),o('div',Xp,[s('button',{style:g({padding:'8px 16px',background:'original'===a.viewerSortBy?'#20c997':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[22]||(n[22]=e=>a.viewerSortBy='original')},' 原始顺序 ',4),s('button',{style:g({padding:'8px 16px',background:'enabled'===a.viewerSortBy?'#28a745':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[23]||(n[23]=e=>a.viewerSortBy='enabled')},' ✓ 全选 ',4),s('button',{style:g({padding:'8px 16px',background:'disabled'===a.viewerSortBy?'#dc3545':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[24]||(n[24]=e=>a.viewerSortBy='disabled')},' ✕ 取消全选 ',4)])):r('',!0),a.selectedViewerWorldbook?(i(),o('div',Kp,[a.filteredWorldbookEntries.length>0?(i(),o('span',Qp,' 共找到 '+c(a.filteredWorldbookEntries.length)+' 个条目 ',1)):(i(),o('span',eu,'未找到条目'))])):r('',!0),a.filteredWorldbookEntries.length>0?(i(),o('div',nu,[(i(!0),o(m,null,x(a.filteredWorldbookEntries,(e,t)=>(i(),o('div',{key:t,style:{background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'12px',padding:'15px',transition:'all 0.3s ease'}},[s('div',{style:{display:'flex','justify-content':'space-between','align-items':'flex-start',cursor:'pointer','user-select':'none'},onClick:e=>a.toggleEntryExpanded(t)},[s('div',au,[s('div',ou,['constant'===e.strategy?.type?(i(),o('span',ru,'🔵')):'selective'===e.strategy?.type?(i(),o('span',iu,'🟢')):(i(),o('span',su,'⚪')),s('span',lu,c(e.name||'(无名称)'),1)]),s('div',du,[e.strategy?.keys&&e.strategy.keys.length>0?(i(),o('span',cu,' 关键词: '+c(e.strategy.keys.map(e=>'string'==typeof e?e:String(e)).join(', ')),1)):(i(),o('span',pu,'关键词: (无)')),e.position?.order&&0!==e.position.order?(i(),o('span',uu,[n[93]||(n[93]=s('span',{style:{color:'#666'}},' | ',-1)),d(' 顺序: '+c(e.position.order),1)])):r('',!0),'at_depth'===e.position?.type&&e.position.depth&&0!==e.position.depth?(i(),o('span',gu,[n[94]||(n[94]=s('span',{style:{color:'#666'}},' | ',-1)),d(' 深度: '+c(e.position.depth),1)])):r('',!0)]),s('div',fu,c(e.content?e.content.length>50?e.content.substring(0,50)+'...':e.content:'(无内容)'),1)]),s('i',{class:h(a.isEntryExpanded(t)?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888','font-size':'12px','margin-top':'2px'}},null,2)],8,tu),a.isEntryExpanded(t)?(i(),o('div',mu,[s('div',xu,[n[95]||(n[95]=s('span',{style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},' ⚙️ 触发策略： ',-1)),s('div',hu,['constant'===e.strategy?.type?(i(),o('span',bu,' 🔵 蓝灯（常量）- 无需关键字匹配 ')):'selective'===e.strategy?.type?(i(),o('span',yu,' 🟢 绿灯（可选项）- 需要关键字匹配 ')):(i(),o('span',vu,' ⚪ 未知类型 '))])]),s('div',wu,[s('span',ku,[n[96]||(n[96]=d(' 🔑 关键字： ',-1)),'constant'===e.strategy?.type?(i(),o('span',_u,' (蓝灯条目通常不需要关键字) ')):r('',!0)]),s('div',Tu,[(i(!0),o(m,null,x(e.strategy?.keys||[],(e,n)=>(i(),o('span',{key:n,style:{padding:'4px 10px',background:'#667eea',color:'white','border-radius':'12px','font-size':'11px'}},c('string'==typeof e?e:String(e)),1))),128)),e.strategy?.keys&&0!==e.strategy.keys.length?r('',!0):(i(),o('span',Su,c('constant'===e.strategy?.type?'(蓝灯条目无需关键字)':'(无关键字)'),1))])]),s('div',Iu,[n[97]||(n[97]=s('span',{style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},' 📄 条目内容： ',-1)),s('div',Au,c(e.content||'(无内容)'),1)]),s('div',zu,[s('button',{style:{padding:'8px 16px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>a.editWorldbookEntry(e)},[...n[98]||(n[98]=[s('i',{class:'fa-solid fa-edit'},null,-1),d(' 编辑 ',-1)])],8,Cu),s('button',{style:{padding:'8px 16px',background:'#ff6b6b',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>a.deleteWorldbookEntry(e)},[...n[99]||(n[99]=[s('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])],8,$u)])])):r('',!0)]))),128))])):r('',!0)])):r('',!0)]),a.showEditDialog?(i(),o('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000','backdrop-filter':'blur(4px)'},onClick:n[44]||(n[44]=f(e=>a.showEditDialog=!1,['self']))},[s('div',Eu,[s('div',Pu,[n[102]||(n[102]=s('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600'}},[s('i',{class:'fa-solid fa-edit',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 编辑世界书条目 ')],-1)),s('button',{style:{background:'transparent',border:'none',color:'#888','font-size':'20px',cursor:'pointer',padding:'5px 10px',transition:'color 0.2s'},onClick:n[25]||(n[25]=e=>a.showEditDialog=!1),onMouseenter:n[26]||(n[26]=e=>e.target.style.color='#fff'),onMouseleave:n[27]||(n[27]=e=>e.target.style.color='#888')},[...n[101]||(n[101]=[s('i',{class:'fa-solid fa-times'},null,-1)])],32)]),s('div',Mu,[s('div',null,[n[103]||(n[103]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 条目名称： ',-1)),l(s('input',{'onUpdate:modelValue':n[28]||(n[28]=e=>a.editingEntry.name=e),type:'text',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'}},null,512),[[p,a.editingEntry.name]])]),s('div',Ou,[l(s('input',{id:'entry-enabled','onUpdate:modelValue':n[29]||(n[29]=e=>a.editingEntry.enabled=e),type:'checkbox',style:{width:'18px',height:'18px',cursor:'pointer'}},null,512),[[N,a.editingEntry.enabled]]),n[104]||(n[104]=s('label',{for:'entry-enabled',style:{color:'#e0e0e0','font-size':'14px',cursor:'pointer'}},' 启用此条目 ',-1))]),s('div',null,[n[105]||(n[105]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 主要关键字： ',-1)),s('input',{value:(a.editingEntry.strategy?.keys||[]).map(e=>'string'==typeof e?e:String(e)).join(','),type:'text',placeholder:'用逗号分隔，如：艾莉娅,Aria,精灵,{{char}}',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[30]||(n[30]=e=>{const n=e.target.value.split(',').filter(e=>e.trim()).map(e=>e.trim());a.editingEntry.strategy={...a.editingEntry.strategy,keys:n,keys_secondary:a.editingEntry.strategy?.keys_secondary||{logic:'and_any',keys:[]},scan_depth:a.editingEntry.strategy?.scan_depth||'same_as_global',type:a.editingEntry.strategy?.type||'selective'}})},null,40,ju)]),s('div',null,[n[107]||(n[107]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 触发类型： ',-1)),s('select',{value:a.editingEntry.strategy?.type||'selective',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer'},onChange:n[31]||(n[31]=e=>a.editingEntry.strategy={...a.editingEntry.strategy,type:e.target.value,keys:a.editingEntry.strategy?.keys||[],keys_secondary:a.editingEntry.strategy?.keys_secondary||{logic:'and_any',keys:[]},scan_depth:a.editingEntry.strategy?.scan_depth||'same_as_global'})},[...n[106]||(n[106]=[s('option',{value:'selective'},'绿灯 (可选项)',-1),s('option',{value:'constant'},'蓝灯 (常量)',-1)])],40,Du)]),s('div',null,[n[109]||(n[109]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 插入位置： ',-1)),s('select',{value:a.editingEntry.position?.type||'before_character_definition',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer'},onChange:n[32]||(n[32]=e=>a.editingEntry.position={...a.editingEntry.position,type:e.target.value,role:a.editingEntry.position?.role||'system',depth:a.editingEntry.position?.depth||0,order:a.editingEntry.position?.order||0})},[...n[108]||(n[108]=[u('<option value="before_character_definition" data-v-ae874133>角色定义之前</option><option value="after_character_definition" data-v-ae874133>角色定义之后</option><option value="before_example_messages" data-v-ae874133>示例消息之前</option><option value="after_example_messages" data-v-ae874133>示例消息之后</option><option value="before_author_note" data-v-ae874133>作者注释之前</option><option value="after_author_note" data-v-ae874133>作者注释之后</option><option value="at_depth" data-v-ae874133>插入到指定深度</option>',7)])],40,Ru)]),s('div',Nu,[s('div',null,[n[110]||(n[110]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 深度： ',-1)),s('input',{value:a.editingEntry.position?.depth||0,type:'number',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[33]||(n[33]=e=>a.editingEntry.position={...a.editingEntry.position,depth:Number(e.target.value)||0,role:a.editingEntry.position?.role||'system',order:a.editingEntry.position?.order||0,type:a.editingEntry.position?.type||'before_character_definition'})},null,40,Hu)]),s('div',null,[n[111]||(n[111]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 顺序： ',-1)),s('input',{value:a.editingEntry.position?.order||0,type:'number',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[34]||(n[34]=e=>a.editingEntry.position={...a.editingEntry.position,order:Number(e.target.value)||0,type:a.editingEntry.position?.type||'before_character_definition',role:a.editingEntry.position?.role||'system',depth:a.editingEntry.position?.depth||0})},null,40,Lu)])]),s('div',Fu,[n[115]||(n[115]=s('label',{style:{display:'block','margin-bottom':'12px',color:'#e0e0e0','font-size':'14px','font-weight':'600'}},' 递归设置： ',-1)),s('div',Vu,[s('label',Uu,[s('input',{type:'checkbox',checked:a.editingEntry.recursion?.prevent_incoming||!1,onChange:n[35]||(n[35]=e=>a.editingEntry.recursion={...a.editingEntry.recursion,prevent_incoming:e.target.checked,prevent_outgoing:a.editingEntry.recursion?.prevent_outgoing||!1,delay_until:a.editingEntry.recursion?.delay_until||null})},null,40,Ju),n[112]||(n[112]=d(' 禁止其他条目递归激活本条目 ',-1))]),s('label',Bu,[s('input',{type:'checkbox',checked:a.editingEntry.recursion?.prevent_outgoing||!1,onChange:n[36]||(n[36]=e=>a.editingEntry.recursion={...a.editingEntry.recursion,prevent_outgoing:e.target.checked,prevent_incoming:a.editingEntry.recursion?.prevent_incoming||!1,delay_until:a.editingEntry.recursion?.delay_until||null})},null,40,Wu),n[113]||(n[113]=d(' 禁止本条目递归激活其他条目 ',-1))]),s('div',null,[n[114]||(n[114]=s('label',{style:{color:'#ccc','font-size':'13px',display:'block','margin-bottom':'5px'}},' 延迟到第 n 级递归： ',-1)),s('input',{value:a.editingEntry.recursion?.delay_until||'',type:'number',placeholder:'留空表示不延迟',style:{width:'100%',padding:'8px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'6px',color:'#e0e0e0','font-size':'13px'},onInput:n[37]||(n[37]=e=>a.editingEntry.recursion={...a.editingEntry.recursion,delay_until:''===e.target.value?null:Number(e.target.value),prevent_incoming:a.editingEntry.recursion?.prevent_incoming||!1,prevent_outgoing:a.editingEntry.recursion?.prevent_outgoing||!1})},null,40,Gu)])])]),s('div',null,[n[116]||(n[116]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 条目内容： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[38]||(n[38]=e=>a.editingEntry.content=e),style:{width:'100%','min-height':'200px',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.editingEntry.content]])])]),s('div',Yu,[s('button',{style:{padding:'10px 20px',background:'#444',border:'none','border-radius':'12px',color:'white','font-size':'14px',cursor:'pointer',transition:'all 0.2s'},onClick:n[39]||(n[39]=e=>a.showEditDialog=!1),onMouseenter:n[40]||(n[40]=e=>e.target.style.background='#555'),onMouseleave:n[41]||(n[41]=e=>e.target.style.background='#444')},' 取消 ',32),s('button',{style:{padding:'10px 20px',background:'#4a9eff',border:'none','border-radius':'12px',color:'white','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.2s'},onClick:a.saveEditedEntry,onMouseenter:n[42]||(n[42]=e=>e.target.style.background='#5ba8ff'),onMouseleave:n[43]||(n[43]=e=>e.target.style.background='#4a9eff')},[...n[117]||(n[117]=[s('i',{class:'fa-solid fa-save',style:{'margin-right':'6px'}},null,-1),d(' 保存 ',-1)])],32)])])])):r('',!0),s('div',Zu,[s('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[45]||(n[45]=e=>a.toggleToolExpanded('characterCard')),onMouseenter:n[46]||(n[46]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[47]||(n[47]=e=>e.currentTarget.style.transform='translateY(0)')},[n[118]||(n[118]=s('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[s('i',{class:'fa-solid fa-user-plus',style:{color:'#17a2b8','font-size':'18px'}}),d(' 角色卡生成工具 ')],-1)),s('i',{class:h(a.isToolExpanded('characterCard')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),a.isToolExpanded('characterCard')?(i(),o('div',qu,[n[137]||(n[137]=u('<div class="tool-instructions" data-v-ae874133><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-ae874133></i> 输入角色描述，AI将自动生成角色卡（YAML 格式，纯中文）。 </p><p style="margin:0 0 6px 0;color:#4a9eff;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #17a2b8;" data-v-ae874133> 💡 包含内容：基础信息、外貌身材、核心性格、对话风格、背景经历、人际关系、演绎指导 </p><p style="margin:0 0 6px 0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-ae874133> ⚠️ 注意：身高体重使用文字描述（如&quot;高大匀称&quot;），避免AI刻板化，有性格对立面和修复机制 </p></div>',1)),s('div',Xu,[n[119]||(n[119]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 角色描述： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[48]||(n[48]=e=>a.characterDescription=e),placeholder:'请描述角色的基本信息，如外观、性格、背景等...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.characterDescription]])]),s('div',Ku,[s('label',Qu,[l(s('input',{'onUpdate:modelValue':n[49]||(n[49]=e=>a.enableCharacterStreaming=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,a.enableCharacterStreaming]]),n[120]||(n[120]=d(' 启用流式传输（可查看生成进度） ',-1))])]),a.isGeneratingCharacter&&a.characterProgressPercent>0?(i(),o('div',eg,[s('div',ng,[n[122]||(n[122]=s('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(23, 162, 184, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),s('div',{class:'progress-fill',style:g({position:'relative',width:a.characterProgressPercent+'%',height:'100%',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)',backgroundSize:'200% 100%',animation:a.enableCharacterStreaming?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(23, 162, 184, 0.5)'})},[...n[121]||(n[121]=[s('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),s('div',tg,[s('span',ag,' 生成中... '+c(a.characterProgressPercent.toFixed(0))+'% ',1),n[123]||(n[123]=s('div',{style:{display:'flex',gap:'4px'}},[s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):r('',!0),s('div',og,[s('button',{class:'generate-button',disabled:a.isGeneratingCharacter||!a.characterDescription.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #17a2b8 0%, #138496 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(23, 162, 184, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleGenerateCharacterCard},[n[124]||(n[124]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[125]||(n[125]=s('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(a.isGeneratingCharacter?'生成中...':'生成角色卡'),1)],8,rg),s('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:a.clearCharacterForm},[...n[126]||(n[126]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),a.characterCardOutput?(i(),o('div',ig,[n[136]||(n[136]=s('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[s('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 生成的角色卡： ')],-1)),s('div',sg,c(a.characterCardOutput),1),s('div',{class:'output-actions',style:{'margin-top':'12px',display:'flex',gap:'12px'}},[s('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:a.copyCharacterCard},[...n[127]||(n[127]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制角色卡 ',-1)])])]),s('div',lg,[n[135]||(n[135]=u('<h5 style="margin:0 0 12px 0;color:#fff;font-size:14px;font-weight:600;" data-v-ae874133><i class="fa-solid fa-edit" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 修改角色卡 </h5><div class="modify-instructions" style="background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:10px;margin-bottom:15px;" data-v-ae874133><p style="margin:0 0 6px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-lightbulb" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 描述你想要修改的内容，AI会根据你的需求调整角色卡。例如：&quot;让角色更活泼一些&quot;、&quot;增加魔法技能&quot;、&quot;改为女性角色&quot;等。 </p><p style="margin:0;color:#ffa500;font-size:11px;" data-v-ae874133>⚠️ 修改后会保持 YAML 格式和中文字段。</p></div>',2)),s('div',dg,[n[128]||(n[128]=s('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 修改需求： ',-1)),l(s('textarea',{'onUpdate:modelValue':n[50]||(n[50]=e=>a.modifyRequest=e),placeholder:'请描述你想要修改的内容...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,a.modifyRequest]])]),a.isModifyingCharacter&&a.characterProgressPercent>0?(i(),o('div',cg,[s('div',pg,[n[130]||(n[130]=s('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(23, 162, 184, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),s('div',{class:'progress-fill',style:g({position:'relative',width:a.characterProgressPercent+'%',height:'100%',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)',backgroundSize:'200% 100%',animation:a.enableCharacterStreaming?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(23, 162, 184, 0.5)'})},[...n[129]||(n[129]=[s('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),s('div',ug,[s('span',gg,' 修改中... '+c(a.characterProgressPercent.toFixed(0))+'% ',1),n[131]||(n[131]=s('div',{style:{display:'flex',gap:'4px'}},[s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),s('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):r('',!0),s('div',fg,[s('button',{class:'modify-button',disabled:a.isModifyingCharacter||!a.modifyRequest.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffa500 0%, #ff8c00 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 165, 0, 0.3)',position:'relative',overflow:'hidden'},onClick:a.handleModifyCharacterCard},[n[132]||(n[132]=s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[133]||(n[133]=s('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(a.isModifyingCharacter?'修改中...':'AI修改'),1)],8,mg),s('button',{class:'clear-modify-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(108, 117, 125, 0.3)',position:'relative',overflow:'hidden'},onClick:a.clearModifyRequest},[...n[134]||(n[134]=[s('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),s('i',{class:'fa-solid fa-eraser',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])])])])])):r('',!0)])):r('',!0)])])}],['__scopeId','data-v-ae874133'],['__file','ToolsTab.vue']]),hg={class:'memory-panel-container',style:{display:'flex','flex-direction':'column',height:'100%',background:'#1a1a1a',color:'#e0e0e0'}},bg={class:'panel-tabs',style:{display:'flex',background:'#222','border-bottom':'1px solid rgba(255, 255, 255, 0.05)','flex-shrink':'0','overflow-x':'auto','scrollbar-width':'none','-ms-overflow-style':'none'}},yg=['onClick'],vg={class:'tab-label'},wg={class:'panel-content',style:{flex:'1','overflow-y':'auto','overflow-x':'hidden',padding:'0','min-height':'0','scrollbar-width':'thin','scrollbar-color':'#4a9eff #2a2a2a'}};const kg=a(e({__name:'MainPanel',setup(e,{expose:t}){t();const a=n('settings'),o={settings:rd,summary:Ic,table:Bc,greetings:ur,status:sc,regex:Qs,project:Cs,tools:xg,mvu:Vr,help:br},r=w(()=>o[a.value]),i=w(()=>({activeTab:a.value})),s={tabs:[{key:'settings',label:'设置',icon:'fa-solid fa-cog'},{key:'summary',label:'历史总结',icon:'fa-solid fa-list'},{key:'table',label:'表格',icon:'fa-solid fa-table'},{key:'greetings',label:'开场白',icon:'fa-solid fa-comments'},{key:'regex',label:'界面生成器',icon:'fa-solid fa-code'},{key:'status',label:'状态栏生成',icon:'fa-solid fa-chart-bar'},{key:'project',label:'前端项目',icon:'fa-solid fa-laptop-code'},{key:'tools',label:'工具模板',icon:'fa-solid fa-tools'},{key:'mvu',label:'MVU Beta',icon:'fa-solid fa-flask'},{key:'help',label:'帮助',icon:'fa-solid fa-question-circle'}],activeTab:a,componentMap:o,currentComponent:r,componentProps:i,switchTab:e=>{console.log('切换标签页:',e),a.value=e},minimizePanel:()=>{Sg()},closePanel:()=>{$('#memoryManagementPanel').fadeOut(200)}};return Object.defineProperty(s,'__isScriptSetup',{enumerable:!1,value:!0}),s}}),[['render',function(e,n,t,a,r,l){return i(),o('div',hg,[n[3]||(n[3]=s('div',{style:{background:'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)',color:'#fff','text-align':'center',padding:'8px 16px','font-weight':'700','font-size':'13px','letter-spacing':'1px','text-shadow':'0 1px 3px rgba(0, 0, 0, 0.5)','border-bottom':'2px solid #7f1d1d','flex-shrink':'0'}},' ⚠️ 商业化死全家，贩子死全家 ⚠️ ',-1)),s('div',{class:'panel-header',style:{padding:'16px 24px',background:'#252525','border-bottom':'1px solid rgba(255, 255, 255, 0.05)',display:'flex','justify-content':'space-between','align-items':'center','flex-shrink':'0','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.15)'}},[n[2]||(n[2]=u('<div class="header-left" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;" data-v-27a46729><span class="header-icon" style="font-size:26px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));" data-v-27a46729>🐱</span><div style="display:flex;flex-direction:column;gap:4px;" data-v-27a46729><span class="panel-title" style="font-size:16px;font-weight:600;color:#fff;letter-spacing:0.5px;" data-v-27a46729>猫猫的小破烂 - 商业化死全家，贩子死全家</span><span style="font-size:11px;color:#ef4444;font-weight:700;text-shadow:0 0 8px rgba(239, 68, 68, 0.5);letter-spacing:0.5px;" data-v-27a46729>⚠️ 禁止商业化 | 禁止倒卖 ⚠️</span></div></div>',1)),s('div',{class:'header-actions',style:{display:'flex',gap:'8px','align-items':'center'}},[s('button',{class:'header-button minimize-button',title:'最小化',style:{width:'32px',height:'32px',display:'flex','align-items':'center','justify-content':'center',border:'none',background:'rgba(255, 255, 255, 0.05)',color:'#e0e0e0','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease','font-size':'14px'},onClick:a.minimizePanel},[...n[0]||(n[0]=[s('i',{class:'fa-solid fa-minus'},null,-1)])]),s('button',{class:'header-button close-button',title:'关闭',style:{width:'32px',height:'32px',display:'flex','align-items':'center','justify-content':'center',border:'none',background:'rgba(255, 255, 255, 0.05)',color:'#e0e0e0','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease','font-size':'14px'},onClick:a.closePanel},[...n[1]||(n[1]=[s('i',{class:'fa-solid fa-times'},null,-1)])])])]),s('div',bg,[(i(),o(m,null,x(a.tabs,e=>s('div',{key:e.key,class:h([{'tab-active':a.activeTab===e.key},'tab-item']),style:g({flex:'0 0 auto',minWidth:'120px',padding:'14px 20px',cursor:'pointer',textAlign:'center',transition:'all 0.25s ease',display:'flex',alignItems:'center',justifyContent:'center',gap:'8px',position:'relative',background:a.activeTab===e.key?'#1a1a1a':'transparent',color:a.activeTab===e.key?'#4a9eff':'#999',borderBottom:a.activeTab===e.key?'2px solid #4a9eff':'2px solid transparent',fontSize:'13px',fontWeight:'500'}),onClick:n=>a.switchTab(e.key)},[s('i',{class:h([e.icon,'tab-icon'])},null,2),s('span',vg,c(e.label),1)],14,yg)),64))]),s('div',wg,[(i(),V(J(a.currentComponent),U({key:a.activeTab},a.componentProps),null,16))])])}],['__scopeId','data-v-27a46729'],['__file','MainPanel.vue']]);const _g=a(e({__name:'浮动面板',setup(e,{expose:n}){n();const t={MainPanel:kg};return Object.defineProperty(t,'__isScriptSetup',{enumerable:!1,value:!0}),t}}),[['render',function(e,n,t,a,o,r){return i(),V(a.MainPanel)}],['__file','浮动面板.vue']]);function Tg(){const e=$('#memoryPanelMinimizeIcon');if(e.length>0)return e.fadeIn(200),e;const n=window.innerWidth<=768,t=$(`\n    <div id="memoryPanelQuickMenu" style="\n      position: fixed;\n      top: 0;\n      left: 0;\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 12px;\n      padding: 8px;\n      display: none;\n      z-index: 999999;\n      box-shadow: 0 8px 32px rgba(74, 158, 255, 0.6), 0 4px 16px rgba(0, 0, 0, 0.8);\n      min-width: 200px;\n      max-height: 80vh;\n      overflow-y: auto;\n    ">\n      <div style="\n        padding: 8px 12px;\n        color: #4a9eff;\n        font-size: 12px;\n        font-weight: 600;\n        border-bottom: 1px solid rgba(74, 158, 255, 0.2);\n        margin-bottom: 4px;\n      ">\n        快捷访问\n      </div>\n      ${[{key:'settings',label:'⚙️ 设置',icon:'fa-solid fa-cog'},{key:'summary',label:'📝 历史总结',icon:'fa-solid fa-list'},{key:'table',label:'📊 表格',icon:'fa-solid fa-table'},{key:'greetings',label:'💬 开场白',icon:'fa-solid fa-comments'},{key:'regex',label:'🎨 界面生成器',icon:'fa-solid fa-code'},{key:'status',label:'📈 状态栏生成',icon:'fa-solid fa-chart-bar'},{key:'project',label:'💻 前端项目',icon:'fa-solid fa-laptop-code'},{key:'tools',label:'🛠️ 工具模板',icon:'fa-solid fa-tools'},{key:'mvu',label:'🧪 MVU Beta',icon:'fa-solid fa-flask'},{key:'help',label:'❓ 帮助',icon:'fa-solid fa-question-circle'}].map(e=>`\n        <div class="quick-menu-item" data-tab="${e.key}" style="\n          padding: 10px 12px;\n          margin: 2px 0;\n          cursor: pointer;\n          border-radius: 8px;\n          transition: all 0.2s;\n          color: #e0e0e0;\n          font-size: 13px;\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          background: transparent;\n        ">\n          ${e.label}\n        </div>\n      `).join('')}\n    </div>\n  `);t.find('.quick-menu-item').hover(function(){$(this).css({background:'rgba(74, 158, 255, 0.15)',color:'#4a9eff',transform:'translateX(-3px)'})},function(){$(this).css({background:'transparent',color:'#e0e0e0',transform:'translateX(0)'})}),t.find('.quick-menu-item').on('click',function(){const e=$(this).data('tab'),n=$('#memoryManagementPanel');n.is(':visible')||n.fadeIn(200),setTimeout(()=>{const t=['settings','summary','table','greetings','regex','status','project','tools','mvu','help'].indexOf(e);if(t>=0){const e=n.find('.tab-item');e.length>t&&e.eq(t).trigger('click')}},150),t.fadeOut(200)}),t.css({'scrollbar-width':'thin','scrollbar-color':'#4a9eff #1a1a1a'});const a=$(`\n    <div id="memoryPanelMinimizeIcon" style="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      width: ${n?'64px':'72px'};\n      height: ${n?'64px':'72px'};\n      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);\n      border: 3px solid #4a9eff;\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      z-index: 999998;\n      box-shadow: 0 4px 16px rgba(74, 158, 255, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);\n      transition: all 0.3s ease;\n      font-size: ${n?'32px':'38px'};\n    ">\n      🐱\n    </div>\n  `);let o=null;return a.hover(function(){o&&(clearTimeout(o),o=null),$(this).css({transform:'scale(1.15) rotate(5deg)',boxShadow:'0 6px 24px rgba(74, 158, 255, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4)',borderColor:'#5ab0ff'}),t.css('opacity','0').show(),function(){const e=a.offset(),n=a.outerWidth()||72,o=a.outerHeight()||72,r=t.outerWidth()||200,i=t.outerHeight()||400;if(console.log('🔍 位置计算开始:',{iconPos:e,iconWidth:n,iconHeight:o,menuWidth:r,menuHeight:i}),!e)return void console.warn('⚠️ 图标位置获取失败');let s=e.left-r-10,l=e.top;console.log('📍 初始位置（图标左侧）:',{left:s,top:l}),s<10&&(s=e.left+n+10,console.log('📍 左侧不够，移到右侧:',s));const d=$(window).width()||1920;s+r>d-10&&(s=e.left-(r-n)/2,e.top>i+10?(l=e.top-i-10,console.log('📍 右侧不够，移到上方:',{left:s,top:l})):(l=e.top+o+10,console.log('📍 右侧不够，移到下方:',{left:s,top:l})));const c=$(window).height()||1080,p=Math.max(10,Math.min(s,d-r-10)),u=Math.max(10,Math.min(l,c-Math.min(i,.8*c)-10));console.log('✅ 最终位置:',{finalLeft:p,finalTop:u,windowWidth:d,windowHeight:c}),t.css({left:p+'px',top:u+'px'})}(),t.css('opacity','1').hide().fadeIn(200),console.log('🎯 快捷菜单已显示，位置:',t.offset())},function(){$(this).css({transform:'scale(1) rotate(0deg)',boxShadow:'0 4px 16px rgba(74, 158, 255, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3)',borderColor:'#4a9eff'}),o=window.setTimeout(()=>{t.is(':hover')||t.fadeOut(200)},200)}),t.hover(function(){o&&(clearTimeout(o),o=null)},function(){t.fadeOut(200)}),a.on('click',()=>{const e=$('#memoryManagementPanel');e.is(':visible')?(e.fadeOut(200),a.fadeIn(200)):e.fadeIn(200)}),a.draggable({containment:'window',scroll:!1,start:function(){$(this).css('transition','none'),t.hide()},stop:function(){$(this).css('transition','all 0.3s ease')}}),$('body').append(t),$('body').append(a),console.log('✅ 最小化图标已创建:',a),console.log('✅ 快捷菜单已创建:',t),console.log('📍 快捷菜单是否在页面中:',$('#memoryPanelQuickMenu').length>0),a}function Sg(){const e=$('#memoryManagementPanel');0!==e.length&&(e.fadeOut(200),Tg())}function Ig(){const e=$('#memoryManagementPanel');0!==e.length&&(e.is(':visible')?e.fadeOut(200):e.fadeIn(200))}$(()=>{if(console.log('浮动面板.ts 开始执行'),0===$('#memory-panel-responsive-css').length){const e='\n      <style id="memory-panel-responsive-css">\n        /* 桌面端（横屏）：隐藏移动端专用标题 */\n        .panel-title-mobile {\n          display: none;\n        }\n        \n        /* 桌面端（横屏）：显示完整标题 */\n        .panel-title {\n          display: inline;\n        }\n        \n        /* 移动端全局样式 - 改用宽度判断，适配所有小屏设备 */\n        @media (max-width: 768px) {\n          /* 移动端：面板容器全屏显示 - 使用最高优先级覆盖内联样式 */\n          body #memoryManagementPanel {\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            transform: none !important;\n            width: 100vw !important;\n            max-width: 100vw !important;\n            height: 100vh !important;\n            max-height: 100vh !important;\n            min-width: 100vw !important;\n            min-height: 100vh !important;\n            border-radius: 0 !important;\n            border: none !important;\n            margin: 0 !important;\n            padding: 0 !important;\n          }\n          \n          /* 移动端：隐藏完整标题，显示简短标题 */\n          .panel-title {\n            display: none !important;\n          }\n          \n          .panel-title-mobile {\n            display: inline !important;\n            font-size: 14px !important;\n          }\n          \n          /* 移动端：隐藏最小化按钮 */\n          .minimize-button {\n            display: none !important;\n          }\n          \n          /* 移动端：调整头部样式 */\n          .panel-header {\n            padding: 12px 16px !important;\n            border-radius: 0 !important;\n          }\n          \n          .panel-header .header-left {\n            gap: 8px !important;\n          }\n          \n          .panel-header .header-left .header-icon {\n            font-size: 24px !important;\n          }\n          \n          .panel-header .header-left .panel-title {\n            font-size: 15px !important;\n          }\n          \n          .panel-header > div:last-child {\n            gap: 8px !important;\n          }\n          \n          /* 移动端：头部按钮 */\n          .panel-header .header-button {\n            width: 40px !important;\n            height: 40px !important;\n            min-width: 40px !important;\n            min-height: 40px !important;\n            padding: 0 !important;\n            font-size: 16px !important;\n            border-radius: 8px !important;\n          }\n          \n          /* 移动端：标签栏可横向滚动 */\n          .panel-tabs {\n            overflow-x: auto !important;\n            overflow-y: hidden !important;\n            white-space: nowrap !important;\n            -webkit-overflow-scrolling: touch !important;\n            padding: 0 8px !important;\n          }\n          \n          .panel-tabs::-webkit-scrollbar {\n            height: 3px !important;\n          }\n          \n          .panel-tabs .tab-item {\n            flex: 0 0 auto !important;\n            padding: 12px 16px !important;\n            font-size: 13px !important;\n            gap: 6px !important;\n            min-width: auto !important;\n            border-radius: 0 !important; /* 移动端标签不需要圆角 */\n          }\n          \n          .panel-tabs .tab-item .tab-icon {\n            font-size: 15px !important;\n          }\n          \n          .panel-tabs .tab-item .tab-label {\n            white-space: nowrap !important;\n            font-weight: 500 !important;\n          }\n          \n          /* 移动端：内容区域优化 */\n          .memory-panel-container {\n            font-size: 14px !important;\n          }\n          \n          /* 移动端：面板内容区域滚动优化 */\n          .panel-content {\n            overflow-y: auto !important;\n            overflow-x: hidden !important;\n            -webkit-overflow-scrolling: touch !important;\n            height: 100% !important;\n            padding: 12px !important;\n          }\n          \n          /* 移动端：确保标签页内容不超出 */\n          .memory-panel-container .tab-content {\n            max-width: 100vw !important;\n            overflow-x: hidden !important;\n          }\n          \n          /* 移动端：按钮优化 */\n          .memory-panel-container button,\n          .memory-panel-container .el-button {\n            padding: 12px 18px !important;\n            font-size: 14px !important;\n            min-height: 48px !important; /* iOS推荐的最小触摸区域 */\n            border-radius: 12px !important; /* 统一圆角 */\n            font-weight: 500 !important;\n          }\n          \n          /* 移动端：小按钮优化 */\n          .memory-panel-container .mini-button,\n          .memory-panel-container .show-button {\n            padding: 10px 16px !important;\n            min-height: 44px !important;\n            font-size: 13px !important;\n            border-radius: 10px !important;\n          }\n          \n          /* 移动端：复选框优化 */\n          .memory-panel-container input[type="checkbox"] {\n            width: 20px !important;\n            height: 20px !important;\n            min-width: 20px !important;\n            min-height: 20px !important;\n            cursor: pointer !important;\n          }\n          \n          /* 移动端：按钮组堆叠（只针对按钮组，不影响主布局） */\n          .memory-panel-container .button-group,\n          .memory-panel-container .project-action-buttons {\n            flex-direction: column !important;\n            gap: 8px !important;\n          }\n          \n          .memory-panel-container .button-group > *,\n          .memory-panel-container .button-group button,\n          .memory-panel-container .project-action-buttons > button {\n            width: 100% !important;\n            margin: 0 !important;\n          }\n          \n          /* 移动端：对话框内的按钮堆叠 */\n          .memory-panel-container .dialog-actions,\n          .memory-panel-container [style*="justify-content: flex-end"] {\n            flex-direction: column !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .dialog-actions > button {\n            width: 100% !important;\n          }\n          \n          /* 移动端：输入框优化 */\n          .memory-panel-container input,\n          .memory-panel-container textarea,\n          .memory-panel-container select {\n            font-size: 16px !important; /* 防止iOS自动缩放 */\n            padding: 12px !important;\n            min-height: 44px !important;\n          }\n          \n          .memory-panel-container textarea {\n            min-height: 120px !important;\n          }\n          \n          /* 移动端：表单项间距 */\n          .memory-panel-container .form-group,\n          .memory-panel-container [style*="margin"] {\n            margin-bottom: 16px !important;\n          }\n          \n          /* 移动端：卡片/面板内边距 */\n          .memory-panel-container .card,\n          .memory-panel-container .panel,\n          .memory-panel-container .section {\n            padding: 12px !important;\n            margin: 8px 0 !important;\n          }\n          \n          /* 移动端：字段组优化 */\n          .memory-panel-container .field-group,\n          .memory-panel-container [class*="field"] {\n            padding: 8px !important;\n            margin-bottom: 12px !important;\n          }\n          \n          /* 移动端：工具区域优化 */\n          .memory-panel-container .tool-section,\n          .memory-panel-container .section-content {\n            padding: 12px 8px !important;\n          }\n          \n          /* 移动端：预览区域优化 */\n          .memory-panel-container .preview-container,\n          .memory-panel-container [class*="preview"] {\n            padding: 8px !important;\n            max-width: 100% !important;\n            overflow-x: auto !important;\n          }\n          \n          /* 移动端：标题字体 */\n          .memory-panel-container h1,\n          .memory-panel-container h2,\n          .memory-panel-container h3,\n          .memory-panel-container h4,\n          .memory-panel-container h5 {\n            font-size: 16px !important;\n            margin-bottom: 12px !important;\n          }\n          \n          /* 移动端：对话框全屏 */\n          .memory-panel-container .modal,\n          .memory-panel-container .dialog {\n            width: 100vw !important;\n            height: 100vh !important;\n            max-width: 100vw !important;\n            max-height: 100vh !important;\n            border-radius: 0 !important;\n            top: 0 !important;\n            left: 0 !important;\n            transform: none !important;\n          }\n          \n          /* 移动端：滚动条优化 */\n          .memory-panel-container ::-webkit-scrollbar {\n            width: 3px !important;\n            height: 3px !important;\n          }\n          \n          /* 移动端：减小字段间的gap */\n          .memory-panel-container [style*="gap: 1"] {\n            gap: 8px !important;\n          }\n          \n          .memory-panel-container [style*="gap: 2"] {\n            gap: 12px !important;\n          }\n          \n          /* 移动端：工具区域按钮组优化 */\n          .memory-panel-container .tool-section .button-group {\n            display: flex !important;\n            flex-direction: column !important;\n            width: 100% !important;\n          }\n          \n          /* 移动端：状态栏生成器字段优化（只针对字段，不影响主布局） */\n          .memory-panel-container .field-item {\n            flex-direction: column !important;\n            align-items: stretch !important;\n          }\n          \n          .memory-panel-container .field-item > * {\n            width: 100% !important;\n            margin-bottom: 8px !important;\n          }\n          \n          /* 移动端：两栏布局改为单列（只针对设置项，不影响主布局） */\n          .memory-panel-container [style*="display: grid"][style*="grid-template-columns: 1fr 1fr"] {\n            grid-template-columns: 1fr !important;\n          }\n          \n          /* 移动端：三栏布局改为单列！！！最重要的修复！ */\n          /* 用更通用的选择器强制覆盖所有grid布局 */\n          .memory-panel-container div[style*="display: grid"],\n          .memory-panel-container > div[style*="display: grid"],\n          .panel-content > div[style*="display: grid"],\n          body [style*="display: grid"][style*="grid-template-columns"] {\n            display: flex !important;\n            flex-direction: column !important;\n            gap: 12px !important;\n          }\n          \n          /* 移动端：所有带固定宽度的元素强制改为100%宽度 */\n          .memory-panel-container div[style*="width: 280px"],\n          .memory-panel-container div[style*="width: 300px"],\n          .memory-panel-container div[style*="width: 500px"],\n          .memory-panel-container div[style*="width: 600px"],\n          .memory-panel-container div[style*="max-width: 600px"],\n          .memory-panel-container div[style*="max-width: 90vw"],\n          body #memoryManagementPanel div[style*="width:"],\n          body #memoryManagementPanel div[style*="min-height: 600px"] {\n            width: 100% !important;\n            max-width: 100% !important;\n            min-width: auto !important;\n          }\n          \n          /* 移动端：强制所有子div在容器内正确显示 */\n          .memory-panel-container > div > div,\n          .panel-content > div > div {\n            max-width: 100% !important;\n            overflow-x: hidden !important;\n          }\n          \n          /* 移动端：开场白管理器整体布局优化 */\n          .memory-panel-container .greetings-tab > div[style*="display: flex"][style*="gap: 20px"] {\n            flex-direction: column !important;\n            gap: 15px !important;\n          }\n          \n          .memory-panel-container .greetings-tab > div > div[style*="flex: 1"] {\n            width: 100% !important;\n            flex: none !important;\n            max-height: 50vh !important;\n          }\n          \n          /* 移动端：开场白管理器顶部操作按钮优化 */\n          .memory-panel-container .header-actions {\n            flex-wrap: wrap !important;\n            justify-content: center !important;\n          }\n          \n          .memory-panel-container .header-actions .mini-button {\n            flex: 1 1 auto !important;\n            min-width: 120px !important;\n          }\n          \n          /* 移动端：开场白管理器底部操作按钮堆叠 */\n          .memory-panel-container .greetings-tab > div > div > div[style*="position: sticky"][style*="bottom: 0"] {\n            flex-direction: column !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .greetings-tab > div > div > div[style*="position: sticky"] button {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n          \n          /* 移动端：开场白管理器配置界面优化 */\n          .memory-panel-container .greeting-item > div:first-child {\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .greeting-item input[placeholder*="图标"] {\n            width: 100% !important;\n            max-width: 80px !important;\n            margin: 0 auto !important;\n          }\n          \n          .memory-panel-container .greeting-item input[placeholder*="开场白"],\n          .memory-panel-container .greeting-item input[placeholder*="默认"] {\n            width: 100% !important;\n            flex: none !important;\n          }\n          \n          .memory-panel-container .greeting-item button {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n          \n          /* 移动端：开场白选择器网格布局优化 */\n          .memory-panel-container iframe,\n          body iframe[srcdoc*="scene-grid"] {\n            width: 100% !important;\n            max-width: 100% !important;\n          }\n          \n          /* 移动端：iframe内的网格布局也要优化（开场白选择器） */\n          @supports (-webkit-touch-callout: none) {\n            /* iOS Safari特殊处理 */\n            body iframe {\n              width: 100% !important;\n              max-width: 100vw !important;\n            }\n          }\n          \n          /* 移动端：删除/操作按钮优化 */\n          .memory-panel-container .delete-button,\n          .memory-panel-container [class*="delete"],\n          .memory-panel-container .action-button {\n            min-width: 44px !important;\n            min-height: 44px !important;\n            padding: 8px !important;\n          }\n          \n          /* 移动端：表单label优化 */\n          .memory-panel-container label {\n            font-size: 13px !important;\n            margin-bottom: 6px !important;\n            display: block !important;\n          }\n          \n          /* 移动端：防止内容超出视口（只针对表单元素和文本） */\n          .memory-panel-container input,\n          .memory-panel-container textarea,\n          .memory-panel-container select,\n          .memory-panel-container button,\n          .memory-panel-container pre,\n          .memory-panel-container code {\n            max-width: 100% !important;\n            word-wrap: break-word !important;\n          }\n          \n          /* 移动端：字段标题区域 */\n          .memory-panel-container .section-header {\n            padding: 16px !important;\n            font-size: 14px !important;\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 12px !important;\n          }\n          \n          .memory-panel-container .section-header h3 {\n            font-size: 15px !important;\n            margin-bottom: 0 !important;\n          }\n          \n          /* 移动端：减少不必要的空白 */\n          .memory-panel-container .empty-space,\n          .memory-panel-container [style*="padding: 20px"],\n          .memory-panel-container [style*="padding: 25px"] {\n            padding: 12px !important;\n          }\n          \n          /* 移动端：缩小最小化图标 */\n          #memoryPanelMinimizeIcon {\n            width: 48px !important;\n            height: 48px !important;\n            top: 15px !important;\n            right: 15px !important;\n          }\n          \n          #memoryPanelMinimizeIcon i {\n            font-size: 22px !important;\n          }\n        }\n      </style>\n    ';$('head').append(e),console.log('📱 移动端响应式CSS已注入')}setTimeout(()=>{console.log('浮动面板.ts setTimeout 回调执行');const e=$('#memoryManagementPanel');e.length>0&&(console.log('mzrodyu猫猫的小破烂浮动面板已存在，强制删除并重新创建...'),e.remove(),setTimeout(()=>{console.log('旧面板已删除，开始创建新面板...')},100)),console.log('🚀🚀🚀 开始创建面板容器 - 时间戳:',(new Date).toISOString());const n=$('\n      <div id="memoryManagementPanel" style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 95vw;\n        max-width: 1600px;\n        height: 92vh;\n        max-height: 92vh;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);\n        z-index: 999999;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      ">\n      </div>\n    ');$('body').append(n),console.log('面板容器已添加到 body, 容器元素:',n[0]),console.log('准备创建新的 Vue 应用，面板容器:',n[0]);const t=B(_g).use(W);try{t.mount(n[0]),console.log('Vue 应用已成功挂载'),console.log('Vue 实例:',n[0].__vue_app__)}catch(a){console.error('Vue 应用挂载失败:',a),console.error('错误详情:',JSON.stringify(a,null,2)),console.error('错误堆栈:',a.stack)}console.log('mzrodyu猫猫的小破烂浮动面板已创建，面板元素:',n[0]),setTimeout(()=>{Tg(),console.log('📍 常驻最小化图标已创建')},500)},200)});export{Sg as minimizeMemoryPanel,Ig as toggleMemoryPanel};
//# sourceMappingURL=浮动面板.BLRKj0zn.chunk.js.map
