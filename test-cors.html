<!doctype html>
<html>
  <head>
    <title>CORS 测试</title>
  </head>
  <body>
    <h1>CORS 测试工具</h1>
    <p>测试你的 API 是否正确配置了 CORS</p>

    <input
      type="text"
      id="apiUrl"
      placeholder="输入 API 地址"
      style="width: 400px"
      value="https://520mz.zeabur.app/v1/models"
    />
    <button onclick="testCors()">测试 CORS</button>

    <h2>测试结果：</h2>
    <pre id="result"></pre>

    <script>
      async function testCors() {
        const url = document.getElementById('apiUrl').value;
        const resultEl = document.getElementById('result');

        resultEl.textContent = '正在测试...\n';

        try {
          // 测试 OPTIONS 请求（预检请求）
          resultEl.textContent += '\n1. 测试 OPTIONS 预检请求...\n';
          const optionsResponse = await fetch(url, {
            method: 'OPTIONS',
            headers: {
              Origin: window.location.origin,
              'Access-Control-Request-Method': 'GET',
              'Access-Control-Request-Headers': 'authorization,content-type',
            },
          });

          resultEl.textContent += `   状态码: ${optionsResponse.status}\n`;
          resultEl.textContent += `   响应头:\n`;

          // 检查关键的 CORS 头
          const corsHeaders = [
            'access-control-allow-origin',
            'access-control-allow-methods',
            'access-control-allow-headers',
            'access-control-allow-credentials',
          ];

          let hasCors = false;
          corsHeaders.forEach(header => {
            const value = optionsResponse.headers.get(header);
            if (value) {
              hasCors = true;
              resultEl.textContent += `   ✅ ${header}: ${value}\n`;
            } else {
              resultEl.textContent += `   ❌ ${header}: 未设置\n`;
            }
          });

          // 测试实际的 GET 请求
          resultEl.textContent += '\n2. 测试实际 GET 请求...\n';
          const getResponse = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          resultEl.textContent += `   状态码: ${getResponse.status}\n`;
          resultEl.textContent += `   Access-Control-Allow-Origin: ${getResponse.headers.get('access-control-allow-origin') || '未设置'}\n`;

          if (getResponse.ok) {
            const data = await getResponse.json();
            resultEl.textContent += `   ✅ 请求成功！\n`;
            resultEl.textContent += `   返回数据: ${JSON.stringify(data, null, 2).substring(0, 200)}...\n`;
          } else {
            resultEl.textContent += `   ❌ 请求失败: ${getResponse.statusText}\n`;
          }

          // 总结
          resultEl.textContent += '\n========== 总结 ==========\n';
          if (hasCors) {
            resultEl.textContent += '✅ API 已配置 CORS 头\n';
          } else {
            resultEl.textContent += '❌ API 未配置 CORS 头\n';
            resultEl.textContent += '\n解决方案：\n';
            resultEl.textContent += '1. 在服务器代码中添加 CORS 中间件\n';
            resultEl.textContent += '2. 确保 CORS=true 环境变量被正确读取\n';
            resultEl.textContent += '3. 重新部署应用\n';
          }
        } catch (error) {
          resultEl.textContent += `\n❌ 错误: ${error.message}\n`;
          resultEl.textContent += '\n这通常意味着：\n';
          resultEl.textContent += '1. API 服务器没有返回 CORS 头\n';
          resultEl.textContent += '2. 浏览器阻止了跨域请求\n';
          resultEl.textContent += '3. 网络连接问题\n';
        }
      }
    </script>
  </body>
</html>
